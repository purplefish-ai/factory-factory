/**
 * Pre-PR Branch Rename Interceptor
 *
 * Detects `gh pr create` on tool start and renames auto-generated branches
 * to meaningful names before the PR is created. Uses direct `git branch -m`
 * so the rename completes before the network-bound `gh pr create` executes.
 */

import { projectManagementService, workspaceDataService } from '@/backend/domains/workspace';
import { gitCommand } from '@/backend/lib/shell';
import { extractInputValue, isString } from '@/backend/schemas/tool-inputs.schema';
import { createLogger } from '@/backend/services/logger.service';
import type { InterceptorContext, ToolEvent, ToolInterceptor } from './types';

const logger = createLogger('pre-pr-rename');
const GH_PR_CREATE_REGEX = /\bgh\s+pr\s+create\b/;

// Track workspaces that have already been renamed to avoid duplicate renames
const renamedWorkspaces = new Set<string>();

/**
 * Generate a branch name from workspace context.
 *
 * Kebab-cases the workspace name and optionally prepends a prefix.
 * Result is capped at 60 characters (prefix + slash + name).
 */
export function generateBranchName(context: {
  branchPrefix: string;
  workspaceName: string;
}): string {
  const slug = context.workspaceName
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '')
    .slice(0, 30);

  if (!slug) {
    return '';
  }

  if (context.branchPrefix) {
    return `${context.branchPrefix}/${slug}`;
  }
  return slug;
}

function extractCommand(event: ToolEvent): string | undefined {
  const command = extractInputValue(event.input, 'command', isString, event.toolName, logger);
  if (command && GH_PR_CREATE_REGEX.test(command)) {
    return command;
  }

  const cmd = extractInputValue(event.input, 'cmd', isString, event.toolName, logger);
  if (cmd && GH_PR_CREATE_REGEX.test(cmd)) {
    return cmd;
  }

  const title = extractInputValue(event.input, 'title', isString, event.toolName, logger);
  if (title && GH_PR_CREATE_REGEX.test(title)) {
    return title;
  }

  if (GH_PR_CREATE_REGEX.test(event.toolName)) {
    return event.toolName;
  }

  return undefined;
}

export const prePrRenameInterceptor: ToolInterceptor = {
  name: 'pre-pr-rename',
  tools: '*',

  async onToolStart(event: ToolEvent, context: InterceptorContext): Promise<void> {
    try {
      // Check if this is a `gh pr create` command
      const command = extractCommand(event);
      if (!command) {
        return;
      }

      // Skip if already renamed this workspace
      if (renamedWorkspaces.has(context.workspaceId)) {
        return;
      }

      const workspace = await workspaceDataService.findById(context.workspaceId);
      if (!workspace) {
        return;
      }

      if (!workspace.isAutoGeneratedBranch) {
        return;
      }

      logger.info('Detected gh pr create with auto-generated branch, renaming', {
        workspaceId: context.workspaceId,
        currentBranch: workspace.branchName,
      });

      // Mark immediately to prevent races from parallel tool calls
      renamedWorkspaces.add(context.workspaceId);

      const project = await projectManagementService.findById(workspace.projectId);
      const newBranchName = generateBranchName({
        branchPrefix: project?.githubOwner ?? '',
        workspaceName: workspace.name,
      });

      if (!newBranchName) {
        logger.warn('Could not generate branch name from workspace context', {
          workspaceId: context.workspaceId,
          workspaceName: workspace.name,
        });
        return;
      }

      // Rename the branch directly via git
      const result = await gitCommand(['branch', '-m', newBranchName], context.workingDir);
      if (result.code !== 0) {
        logger.warn('Failed to rename branch before PR creation', {
          workspaceId: context.workspaceId,
          newBranchName,
          stderr: result.stderr,
        });
        // Remove from set so it can be retried
        renamedWorkspaces.delete(context.workspaceId);
        return;
      }

      // Persist the new name and clear the auto-generated flag
      await workspaceDataService.setBranchName(context.workspaceId, newBranchName);
      await workspaceDataService.clearAutoGeneratedBranch(context.workspaceId);

      logger.info('Renamed branch before PR creation', {
        workspaceId: context.workspaceId,
        oldBranch: workspace.branchName,
        newBranch: newBranchName,
      });
    } catch (error) {
      logger.error('Error in pre-PR rename interceptor', {
        workspaceId: context.workspaceId,
        error,
      });
    }
  },
};

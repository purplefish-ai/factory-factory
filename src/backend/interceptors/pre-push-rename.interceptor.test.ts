import { beforeEach, describe, expect, it, vi } from 'vitest';
import type { InterceptorContext, ToolEvent } from './types';

const mockFindById = vi.fn();
const mockSetBranchName = vi.fn();
const mockClearAutoGeneratedBranch = vi.fn();
const mockFindProjectById = vi.fn();
const mockGitCommand = vi.fn();

vi.mock('@/backend/domains/workspace', () => ({
  workspaceDataService: {
    findById: (...args: unknown[]) => mockFindById(...args),
    setBranchName: (...args: unknown[]) => mockSetBranchName(...args),
    clearAutoGeneratedBranch: (...args: unknown[]) => mockClearAutoGeneratedBranch(...args),
  },
  projectManagementService: {
    findById: (...args: unknown[]) => mockFindProjectById(...args),
  },
}));

vi.mock('@/backend/lib/shell', () => ({
  gitCommand: (...args: unknown[]) => mockGitCommand(...args),
}));

vi.mock('@/backend/services/logger.service', () => ({
  createLogger: () => ({
    info: vi.fn(),
    debug: vi.fn(),
    warn: vi.fn(),
    error: vi.fn(),
  }),
}));

import { prePushRenameInterceptor } from './pre-push-rename.interceptor';

const context: InterceptorContext = {
  sessionId: 'session-1',
  workspaceId: 'workspace-1',
  workingDir: '/tmp/workspace',
  timestamp: new Date('2026-02-20T00:00:00.000Z'),
};

function createEvent(overrides: Partial<ToolEvent>): ToolEvent {
  return {
    toolUseId: 'tool-1',
    toolName: 'Bash',
    input: {},
    ...overrides,
  };
}

describe('prePushRenameInterceptor', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    mockFindById.mockResolvedValue({
      id: 'workspace-1',
      name: 'Fix duplicate branch name',
      branchName: 'martin-purplefish/pulsar-3',
      isAutoGeneratedBranch: true,
      projectId: 'project-1',
    });
    mockFindProjectById.mockResolvedValue({
      id: 'project-1',
      githubOwner: 'martin-purplefish',
    });
    mockGitCommand.mockResolvedValue({ code: 0, stdout: '', stderr: '' });
    mockSetBranchName.mockResolvedValue({});
    mockClearAutoGeneratedBranch.mockResolvedValue({});
  });

  it('renames branch when git push detected and branch is auto-generated', async () => {
    const event = createEvent({
      input: { command: 'git push -u origin HEAD' },
    });

    await prePushRenameInterceptor.onToolStart!(event, {
      ...context,
      workspaceId: 'ws-rename-1',
    });

    expect(mockGitCommand).toHaveBeenCalledWith(
      ['branch', '-m', 'martin-purplefish/fix-duplicate-branch-name'],
      '/tmp/workspace'
    );
    expect(mockSetBranchName).toHaveBeenCalledWith(
      'ws-rename-1',
      'martin-purplefish/fix-duplicate-branch-name'
    );
    expect(mockClearAutoGeneratedBranch).toHaveBeenCalledWith('ws-rename-1');
  });

  it('skips when branch is not auto-generated', async () => {
    mockFindById.mockResolvedValue({
      id: 'workspace-1',
      name: 'Fix duplicate branch name',
      branchName: 'martin-purplefish/fix-duplicate-branch-name',
      isAutoGeneratedBranch: false,
      projectId: 'project-1',
    });

    const event = createEvent({
      input: { command: 'git push -u origin HEAD' },
    });

    await prePushRenameInterceptor.onToolStart!(event, {
      ...context,
      workspaceId: 'ws-skip-not-auto',
    });

    expect(mockGitCommand).not.toHaveBeenCalled();
    expect(mockSetBranchName).not.toHaveBeenCalled();
  });

  it('skips non-push commands', async () => {
    const event = createEvent({
      input: { command: 'git status' },
    });

    await prePushRenameInterceptor.onToolStart!(event, {
      ...context,
      workspaceId: 'ws-status-cmd',
    });

    expect(mockFindById).not.toHaveBeenCalled();
    expect(mockGitCommand).not.toHaveBeenCalled();
  });

  it('handles git rename failure gracefully', async () => {
    mockGitCommand.mockResolvedValue({
      code: 1,
      stdout: '',
      stderr: 'fatal: branch already exists',
    });

    const event = createEvent({
      input: { command: 'git push -u origin HEAD' },
    });

    await prePushRenameInterceptor.onToolStart!(event, {
      ...context,
      workspaceId: 'ws-git-fail',
    });

    expect(mockGitCommand).toHaveBeenCalled();
    expect(mockSetBranchName).not.toHaveBeenCalled();
  });

  it('detects git push in cmd field', async () => {
    const event = createEvent({
      toolName: 'exec_command',
      input: { cmd: 'git push -u origin HEAD' },
    });

    await prePushRenameInterceptor.onToolStart!(event, {
      ...context,
      workspaceId: 'ws-cmd-field',
    });

    expect(mockGitCommand).toHaveBeenCalled();
  });
});

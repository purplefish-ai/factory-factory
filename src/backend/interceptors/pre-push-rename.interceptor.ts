/**
 * Pre-Push Branch Rename Interceptor
 *
 * Detects `git push` on tool start and renames auto-generated branches
 * before the first remote push so only meaningful branch names are published.
 */

import { projectManagementService, workspaceDataService } from '@/backend/domains/workspace';
import { gitCommand } from '@/backend/lib/shell';
import { extractInputValue, isString } from '@/backend/schemas/tool-inputs.schema';
import { createLogger } from '@/backend/services/logger.service';
import type { InterceptorContext, ToolEvent, ToolInterceptor } from './types';

const logger = createLogger('pre-push-rename');
const GIT_PUSH_REGEX = /\bgit\s+push\b/;

// Track workspaces that have already been renamed to avoid duplicate renames
const renamedWorkspaces = new Set<string>();

function generateBranchName(context: { branchPrefix: string; workspaceName: string }): string {
  const slug = context.workspaceName
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '')
    .slice(0, 30);

  if (!slug) {
    return '';
  }

  if (context.branchPrefix) {
    return `${context.branchPrefix}/${slug}`;
  }
  return slug;
}

function extractCommand(event: ToolEvent): string | undefined {
  const command = extractInputValue(event.input, 'command', isString, event.toolName, logger);
  if (command && GIT_PUSH_REGEX.test(command)) {
    return command;
  }

  const cmd = extractInputValue(event.input, 'cmd', isString, event.toolName, logger);
  if (cmd && GIT_PUSH_REGEX.test(cmd)) {
    return cmd;
  }

  const title = extractInputValue(event.input, 'title', isString, event.toolName, logger);
  if (title && GIT_PUSH_REGEX.test(title)) {
    return title;
  }

  if (GIT_PUSH_REGEX.test(event.toolName)) {
    return event.toolName;
  }

  return undefined;
}

export const prePushRenameInterceptor: ToolInterceptor = {
  name: 'pre-push-rename',
  tools: '*',

  async onToolStart(event: ToolEvent, context: InterceptorContext): Promise<void> {
    let renameCompleted = false;
    try {
      // Check if this is a `git push` command
      const command = extractCommand(event);
      if (!command) {
        return;
      }

      // Skip if already renamed this workspace
      if (renamedWorkspaces.has(context.workspaceId)) {
        return;
      }

      const workspace = await workspaceDataService.findById(context.workspaceId);
      if (!workspace) {
        return;
      }

      if (!workspace.isAutoGeneratedBranch) {
        return;
      }
      const oldBranchName = workspace.branchName ?? '';

      logger.info('Detected git push with auto-generated branch, renaming', {
        workspaceId: context.workspaceId,
        currentBranch: oldBranchName,
      });

      // Mark immediately to prevent races from parallel tool calls
      renamedWorkspaces.add(context.workspaceId);

      const project = await projectManagementService.findById(workspace.projectId);
      const newBranchName = generateBranchName({
        branchPrefix: project?.githubOwner ?? '',
        workspaceName: workspace.name,
      });

      if (!newBranchName) {
        logger.warn('Could not generate branch name from workspace context', {
          workspaceId: context.workspaceId,
          workspaceName: workspace.name,
        });
        renamedWorkspaces.delete(context.workspaceId);
        return;
      }

      if (newBranchName === oldBranchName) {
        await workspaceDataService.clearAutoGeneratedBranch(context.workspaceId);
        renameCompleted = true;
        return;
      }

      // Rename the branch directly via git
      const result = await gitCommand(['branch', '-m', newBranchName], context.workingDir);
      if (result.code !== 0) {
        logger.warn('Failed to rename branch before push', {
          workspaceId: context.workspaceId,
          newBranchName,
          stderr: result.stderr,
        });
        // Remove from set so it can be retried
        renamedWorkspaces.delete(context.workspaceId);
        return;
      }

      // Persist the new name and clear the auto-generated flag
      await workspaceDataService.setBranchName(context.workspaceId, newBranchName);
      await workspaceDataService.clearAutoGeneratedBranch(context.workspaceId);
      renameCompleted = true;

      logger.info('Renamed branch before push', {
        workspaceId: context.workspaceId,
        oldBranch: oldBranchName,
        newBranch: newBranchName,
      });
    } catch (error) {
      if (!renameCompleted) {
        renamedWorkspaces.delete(context.workspaceId);
      }
      logger.error('Error in pre-push rename interceptor', {
        workspaceId: context.workspaceId,
        error,
      });
    }
  },
};

import { buildBranchRenameInstruction } from '../prompts/branch-rename';
import { getWorkflowContent } from '../prompts/workflows';

export type BuildPromptInput = {
  workflow: string;
  workspace: {
    branchName?: string | null;
    isAutoGeneratedBranch?: boolean;
    name: string;
    description?: string | null;
  };
  project?: { githubOwner?: string | null } | null;
};

export type BuildPromptResult = {
  workflowPrompt: string | undefined;
  systemPrompt: string | undefined;
  injectedBranchRename: boolean;
};

export class SessionPromptBuilder {
  /**
   * Check if branch rename should be injected based on the stored flag.
   * Uses the isAutoGeneratedBranch flag rather than pattern matching,
   * so we don't break if workspace words are changed in the future.
   */
  shouldInjectBranchRename(workspace: {
    branchName?: string | null;
    isAutoGeneratedBranch?: boolean;
  }): boolean {
    return !!workspace.branchName && !!workspace.isAutoGeneratedBranch;
  }

  buildSystemPrompt({ workflow, workspace, project }: BuildPromptInput): BuildPromptResult {
    const workflowPrompt = getWorkflowContent(workflow) ?? undefined;
    let systemPrompt = workflowPrompt;
    let injectedBranchRename = false;

    if (this.shouldInjectBranchRename(workspace)) {
      const branchRenameInstruction = buildBranchRenameInstruction({
        branchPrefix: project?.githubOwner ?? '',
        workspaceName: workspace.name,
        workspaceDescription: workspace.description ?? undefined,
      });
      systemPrompt = branchRenameInstruction + (workflowPrompt ?? '');
      injectedBranchRename = true;
    }

    return { workflowPrompt, systemPrompt, injectedBranchRename };
  }
}

export const sessionPromptBuilder = new SessionPromptBuilder();

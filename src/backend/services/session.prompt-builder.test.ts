import { describe, expect, it, vi } from 'vitest';

vi.mock('../clients/git.client', () => ({
  isAutoGeneratedBranchName: vi.fn(),
}));

vi.mock('../prompts/branch-rename', () => ({
  buildBranchRenameInstruction: vi.fn(),
}));

vi.mock('../prompts/workflows', () => ({
  getWorkflowContent: vi.fn(),
}));

vi.mock('./logger.service', () => ({
  createLogger: () => ({
    debug: vi.fn(),
    info: vi.fn(),
    warn: vi.fn(),
    error: vi.fn(),
  }),
}));

import { isAutoGeneratedBranchName } from '../clients/git.client';
import { buildBranchRenameInstruction } from '../prompts/branch-rename';
import { getWorkflowContent } from '../prompts/workflows';
import { SessionPromptBuilder } from './session.prompt-builder';

describe('SessionPromptBuilder', () => {
  it('injects branch rename instruction for auto-generated branches', () => {
    vi.mocked(getWorkflowContent).mockReturnValue('workflow');
    vi.mocked(isAutoGeneratedBranchName).mockReturnValue(true);
    vi.mocked(buildBranchRenameInstruction).mockReturnValue('rename');

    const builder = new SessionPromptBuilder();
    const result = builder.buildSystemPrompt({
      workflow: 'default',
      workspace: {
        branchName: 'auto-branch',
        name: 'Workspace A',
        description: 'desc',
      },
      project: { githubOwner: 'owner' },
    });

    expect(result.systemPrompt).toBe('renameworkflow');
    expect(result.workflowPrompt).toBe('workflow');
    expect(result.injectedBranchRename).toBe(true);
  });

  it('uses workflow prompt without branch rename when branch is not auto-generated', () => {
    vi.mocked(getWorkflowContent).mockReturnValue('workflow');
    vi.mocked(isAutoGeneratedBranchName).mockReturnValue(false);

    const builder = new SessionPromptBuilder();
    const result = builder.buildSystemPrompt({
      workflow: 'default',
      workspace: {
        branchName: 'feature/real',
        name: 'Workspace B',
        description: null,
      },
      project: { githubOwner: 'owner' },
    });

    expect(result.systemPrompt).toBe('workflow');
    expect(result.workflowPrompt).toBe('workflow');
    expect(result.injectedBranchRename).toBe(false);
  });

  it('returns undefined system prompt when workflow prompt is missing', () => {
    vi.mocked(getWorkflowContent).mockReturnValue(null);
    vi.mocked(isAutoGeneratedBranchName).mockReturnValue(false);

    const builder = new SessionPromptBuilder();
    const result = builder.buildSystemPrompt({
      workflow: 'missing',
      workspace: {
        branchName: null,
        name: 'Workspace C',
        description: null,
      },
      project: null,
    });

    expect(result.systemPrompt).toBeUndefined();
    expect(result.workflowPrompt).toBeUndefined();
    expect(result.injectedBranchRename).toBe(false);
  });
});

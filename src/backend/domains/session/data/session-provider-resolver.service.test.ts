import type { Workspace } from '@prisma-gen/client';
import { beforeEach, describe, expect, it, vi } from 'vitest';
import { userSettingsAccessor } from '@/backend/resource_accessors/user-settings.accessor';
import { workspaceAccessor } from '@/backend/resource_accessors/workspace.accessor';
import { sessionProviderResolverService } from './session-provider-resolver.service';

vi.mock('@/backend/resource_accessors/workspace.accessor');
vi.mock('@/backend/resource_accessors/user-settings.accessor');

const createWorkspace = (overrides?: Partial<Workspace>): Workspace =>
  ({
    id: 'ws-1',
    projectId: 'project-1',
    name: 'Workspace',
    description: null,
    status: 'READY',
    worktreePath: '/tmp/worktree',
    branchName: 'feature/test',
    isAutoGeneratedBranch: false,
    creationSource: 'MANUAL',
    creationMetadata: null,
    initErrorMessage: null,
    initOutput: null,
    initStartedAt: null,
    initCompletedAt: null,
    initRetryCount: 0,
    runScriptCommand: null,
    runScriptCleanupCommand: null,
    runScriptPid: null,
    runScriptPort: null,
    runScriptStartedAt: null,
    runScriptStatus: 'IDLE',
    prUrl: null,
    githubIssueNumber: null,
    githubIssueUrl: null,
    defaultSessionProvider: 'WORKSPACE_DEFAULT',
    ratchetSessionProvider: 'WORKSPACE_DEFAULT',
    prNumber: null,
    prState: 'NONE',
    prReviewState: null,
    prCiStatus: 'UNKNOWN',
    prUpdatedAt: null,
    prCiFailedAt: null,
    prCiLastNotifiedAt: null,
    prReviewLastCheckedAt: null,
    prReviewLastCommentId: null,
    ratchetEnabled: true,
    ratchetState: 'IDLE',
    ratchetLastCheckedAt: null,
    ratchetLastPushAt: null,
    ratchetActiveSessionId: null,
    ratchetLastCiRunId: null,
    ratchetLastNotifiedState: null,
    hasHadSessions: false,
    cachedKanbanColumn: 'WAITING',
    stateComputedAt: null,
    createdAt: new Date('2026-01-01T00:00:00.000Z'),
    updatedAt: new Date('2026-01-01T00:00:00.000Z'),
    ...overrides,
  }) as Workspace;

describe('sessionProviderResolverService', () => {
  beforeEach(() => {
    vi.clearAllMocks();

    vi.mocked(workspaceAccessor.findRawById).mockResolvedValue(createWorkspace());
    vi.mocked(userSettingsAccessor.get).mockResolvedValue({
      id: 'settings-1',
      userId: 'default',
      preferredIde: 'cursor',
      customIdeCommand: null,
      playSoundOnComplete: true,
      notificationSoundPath: null,
      workspaceOrder: null,
      cachedSlashCommands: null,
      ratchetEnabled: false,
      defaultSessionProvider: 'CLAUDE',
      createdAt: new Date('2026-01-01T00:00:00.000Z'),
      updatedAt: new Date('2026-01-01T00:00:00.000Z'),
    });
  });

  it('uses explicit provider over workspace and user defaults', async () => {
    const provider = await sessionProviderResolverService.resolveSessionProvider({
      workspaceId: 'ws-1',
      explicitProvider: 'CODEX',
    });

    expect(provider).toBe('CODEX');
    expect(workspaceAccessor.findRawById).not.toHaveBeenCalled();
    expect(userSettingsAccessor.get).not.toHaveBeenCalled();
  });

  it('uses workspace default when configured', async () => {
    vi.mocked(workspaceAccessor.findRawById).mockResolvedValue(
      createWorkspace({ defaultSessionProvider: 'CODEX' })
    );

    const provider = await sessionProviderResolverService.resolveSessionProvider({
      workspaceId: 'ws-1',
    });

    expect(provider).toBe('CODEX');
    expect(userSettingsAccessor.get).not.toHaveBeenCalled();
  });

  it('falls back to user default when workspace is WORKSPACE_DEFAULT', async () => {
    const provider = await sessionProviderResolverService.resolveSessionProvider({
      workspaceId: 'ws-1',
    });

    expect(provider).toBe('CLAUDE');
    expect(userSettingsAccessor.get).toHaveBeenCalledTimes(1);
  });
});

# State Ownership Matrix

This document defines single-writer ownership for high-risk persisted state.
Each field group should have one canonical writer service/module.

## Workspace field ownership

| Field group | Canonical writer |
| --- | --- |
| `status`, `init*` | `workspaceStateMachine` / workspace lifecycle services |
| `prUrl`, `prNumber`, `prState`, `prReviewState`, `prCiStatus`, `prUpdatedAt`, `prCiFailedAt`, `prCiLastNotifiedAt`, `prReviewLastCheckedAt`, `prReviewLastCommentId` | `PRSnapshotService` (`src/backend/domains/github/pr-snapshot.service.ts`) |
| `ratchetEnabled`, `ratchetState`, `ratchetLastCheckedAt`, `ratchetActiveSessionId`, `ratchetLastCiRunId` | ratchet domain services (`src/backend/domains/ratchet/`) |
| `runScriptStatus`, `runScriptPid`, `runScriptPort`, `runScriptStartedAt` | run-script state machine (`src/backend/domains/run-script/run-script-state-machine.service.ts`) |
| `cachedKanbanColumn`, `stateComputedAt` | kanban state service (`src/backend/domains/workspace/state/kanban-state.ts`) |
| `worktreePath`, `branchName`, `isAutoGeneratedBranch` | workspace init/worktree lifecycle orchestration |
| `runScriptCommand`, `runScriptCleanupCommand` | workspace init + factory config refresh (`workspace-init.orchestrator`, `workspace-query.service`) |

## Session field ownership

| Entity fields | Canonical writer |
| --- | --- |
| `ClaudeSession.status`, `ClaudeSession.claudeProcessPid` | session lifecycle service (`src/backend/domains/session/lifecycle/session.service.ts`) |
| `TerminalSession.status`, `TerminalSession.pid` | terminal/session lifecycle services (not public tRPC metadata update routes) |

## Enforcement

- `scripts/check-single-writer.mjs` enforces these ownership boundaries for write calls.
- Ownership checks apply to `workspaceAccessor` mutation APIs that write via `update`/`updateMany`, including wrapper mutators (for example `transitionWithCas`, `casRunScriptStatusUpdate`, `clearRatchetActiveSession`).
- `pnpm check:ownership` should run in CI.

# ğŸ”” Workspace Agent Completion Notification System - Implementation Proposal

## Executive Summary

**Goal:** Notify user via OS desktop notification when all Claude sessions in a workspace finish working, but only when the app window is not focused or the chat is not visible.

**Key Design Decisions:**
- âœ… OS desktop notification (using existing `notification.service.ts`)
- âœ… Per-workspace scope (all sessions must finish)
- âœ… Suppress when app window is focused OR chat is visible

## Architecture Overview

### Components to Modify/Create

```
Backend:
â”œâ”€â”€ src/backend/services/workspace-activity.service.ts (NEW)
â”‚   â””â”€â”€ Tracks running state of all sessions per workspace
â”œâ”€â”€ src/backend/routers/websocket/chat.handler.ts (MODIFY)
â”‚   â””â”€â”€ Emit workspace-level events when session state changes
â””â”€â”€ src/backend/services/notification.service.ts (MODIFY)
    â””â”€â”€ Add workspace completion notification method

Frontend:
â”œâ”€â”€ src/client/hooks/use-window-focus.ts (NEW)
â”‚   â””â”€â”€ Track browser/Electron window focus state
â””â”€â”€ src/components/workspace/WorkspaceNotificationManager.tsx (NEW)
    â””â”€â”€ Listen for workspace events and trigger notifications

Electron:
â””â”€â”€ electron/main/index.ts (MODIFY)
    â””â”€â”€ Expose window focus state to renderer
```

### Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           WORKSPACE WITH SESSIONS                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  Session 1   â”‚  â”‚  Session 2   â”‚  â”‚  Session 3   â”‚                      â”‚
â”‚  â”‚  (running)   â”‚  â”‚  (running)   â”‚  â”‚   (idle)     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                 â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚
          â”‚  session_id     â”‚  result
          â”‚  event          â”‚  event
          â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BACKEND (Node.js/Express)                            â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  chat.handler.ts (WebSocket Handler)                               â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚  setupChatClientEvents()                                      â”‚ â”‚    â”‚
â”‚  â”‚  â”‚                                                               â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  client.on('session_id') â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  client.on('result')     â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                       â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                        â”‚   â”‚                               â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                        â”‚ markSessionRunning()   markSessionIdle()          â”‚
â”‚                        â–¼                                    â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  workspace-activity.service.ts                          â”‚          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚    â”‚
â”‚  â”‚  â”‚  workspaceStates Map                               â”‚ â”‚          â”‚    â”‚
â”‚  â”‚  â”‚  {                                                 â”‚ â”‚          â”‚    â”‚
â”‚  â”‚  â”‚    workspaceId: {                                 â”‚ â”‚          â”‚    â”‚
â”‚  â”‚  â”‚      runningSessions: Set<sessionId>,  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”˜          â”‚    â”‚
â”‚  â”‚  â”‚      lastActivityAt: Date                         â”‚ â”‚            â”‚    â”‚
â”‚  â”‚  â”‚    }                                              â”‚ â”‚            â”‚    â”‚
â”‚  â”‚  â”‚  }                                                â”‚ â”‚            â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚    â”‚
â”‚  â”‚                                                         â”‚            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚            â”‚    â”‚
â”‚  â”‚  â”‚  Event: 'workspace_idle'                          â”‚ â”‚            â”‚    â”‚
â”‚  â”‚  â”‚  (emitted when runningSessions.size === 0)        â”‚ â”‚            â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚    â”‚
â”‚                                â”‚                                         â”‚    â”‚
â”‚                                â–¼                                         â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  workspace_idle event handler                                   â”‚    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  1. Query workspace by ID                                â”‚  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  2. Emit 'request_notification' with:                    â”‚  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚     - workspaceId                                        â”‚  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚     - workspaceName                                      â”‚  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚     - sessionCount                                       â”‚  â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚                                 â”‚                                        â”‚    â”‚
â”‚                                 â–¼                                        â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  setupWorkspaceNotifications()                                  â”‚    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  Listen to 'request_notification'                        â”‚  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  Broadcast to all WebSocket clients viewing workspace:  â”‚  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  {                                                       â”‚  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    type: 'workspace_notification_request',              â”‚  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    workspaceId, workspaceName, sessionCount             â”‚  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  }                                                       â”‚  â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                                  â”‚                                            â”‚
                                  â”‚ WebSocket Message                          â”‚
                                  â”‚                                            â”‚
                                  â–¼                                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND (React/Browser)                             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  use-chat-websocket.ts                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  ws.onmessage handler                                        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  if (type === 'workspace_notification_request')        â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚    dispatch CustomEvent('workspace-notification-req')  â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                   â”‚                                        â”‚
â”‚                                   â”‚ CustomEvent                            â”‚
â”‚                                   â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WorkspaceNotificationManager.tsx                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Listen to 'workspace-notification-request' event           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  SUPPRESSION LOGIC CHECK:                             â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                                        â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  isWindowFocused â—„â”€â”€â”€â”€ use-window-focus.ts â—„â”€â”€â”€â”€â”     â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚       â†“                        â–²                â”‚     â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  isChatVisible â† location.pathname              â”‚     â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚       â†“                                         â”‚     â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  shouldSuppress = isWindowFocused || visible    â”‚     â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚       â†“                                         â”‚     â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  if (shouldSuppress) return; â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚       â†“                                               â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  else: sendWorkspaceNotification()                    â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                       â”‚
â”‚                                    â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Browser Notification API                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  new Notification('Workspace Ready: My Feature')            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    body: 'All 2 agents finished...'                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    icon: '/favicon.ico'                                     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   OS NOTIFICATION     â”‚
                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                        â”‚  â”‚ ğŸ”” Workspace    â”‚  â”‚
                        â”‚  â”‚    Ready: ...   â”‚  â”‚
                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Detailed Event Flow

**Scenario: Two sessions in a workspace, both finish sequentially**

```
Time  â”‚ Event                          â”‚ Component                    â”‚ State Change
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0    â”‚ Session 1 starts processing    â”‚ ClaudeClient                 â”‚
      â”‚ emits 'session_id'             â”‚                              â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T1    â”‚ chat.handler receives event    â”‚ chat.handler.ts              â”‚
      â”‚ calls markSessionRunning()     â”‚ setupChatClientEvents()      â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T2    â”‚ Add session1 to runningSet     â”‚ workspace-activity.service   â”‚ runningSessions:
      â”‚                                â”‚                              â”‚ Set { session1 }
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T3    â”‚ Session 2 starts processing    â”‚ ClaudeClient                 â”‚
      â”‚ emits 'session_id'             â”‚                              â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T4    â”‚ chat.handler receives event    â”‚ chat.handler.ts              â”‚
      â”‚ calls markSessionRunning()     â”‚ setupChatClientEvents()      â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T5    â”‚ Add session2 to runningSet     â”‚ workspace-activity.service   â”‚ runningSessions:
      â”‚                                â”‚                              â”‚ Set { s1, s2 }
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T6    â”‚ Session 1 finishes             â”‚ ClaudeClient                 â”‚
      â”‚ emits 'result'                 â”‚                              â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T7    â”‚ chat.handler receives result   â”‚ chat.handler.ts              â”‚
      â”‚ calls markSessionIdle()        â”‚ setupChatClientEvents()      â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T8    â”‚ Remove session1 from runningSetâ”‚ workspace-activity.service   â”‚ runningSessions:
      â”‚ Check: size === 0? NO          â”‚                              â”‚ Set { s2 }
      â”‚ NO notification triggered      â”‚                              â”‚ (still running)
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T9    â”‚ Session 2 finishes             â”‚ ClaudeClient                 â”‚
      â”‚ emits 'result'                 â”‚                              â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T10   â”‚ chat.handler receives result   â”‚ chat.handler.ts              â”‚
      â”‚ calls markSessionIdle()        â”‚ setupChatClientEvents()      â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T11   â”‚ Remove session2 from runningSetâ”‚ workspace-activity.service   â”‚ runningSessions:
      â”‚ Check: size === 0? YES         â”‚                              â”‚ Set {}
      â”‚ âœ… Emit 'workspace_idle'       â”‚                              â”‚ (ALL DONE!)
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T12   â”‚ workspace_idle handler runs    â”‚ workspace-activity.service   â”‚
      â”‚ Query workspace from DB        â”‚ event listener               â”‚
      â”‚ Emit 'request_notification'    â”‚                              â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T13   â”‚ Broadcast to WebSocket clients â”‚ setupWorkspaceNotifications()â”‚
      â”‚ type: workspace_notification_  â”‚ chat.handler.ts              â”‚
      â”‚       request                  â”‚                              â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T14   â”‚ WebSocket receives message     â”‚ use-chat-websocket.ts        â”‚
      â”‚ Dispatch CustomEvent           â”‚ Frontend                     â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T15   â”‚ WorkspaceNotificationManager   â”‚ WorkspaceNotificationManager â”‚
      â”‚ receives CustomEvent           â”‚ .tsx                         â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T16   â”‚ Check suppression logic:       â”‚ WorkspaceNotificationManager â”‚
      â”‚ - isWindowFocused? NO          â”‚ .tsx                         â”‚
      â”‚ - isChatVisible? NO            â”‚                              â”‚
      â”‚ - shouldSuppress? NO           â”‚                              â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T17   â”‚ âœ… Call new Notification()     â”‚ Browser Notification API     â”‚
      â”‚ Display OS notification        â”‚                              â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T18   â”‚ ğŸ”” User sees notification!     â”‚ Operating System             â”‚
      â”‚                                â”‚                              â”‚
```

### Sequence Diagrams

#### Flow 1: Session Starts Running (No Notification)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude  â”‚  â”‚ chat.handler â”‚  â”‚ workspace-activity     â”‚  â”‚   WebSocket     â”‚
â”‚  Client  â”‚  â”‚    .ts       â”‚  â”‚      .service.ts       â”‚  â”‚   Clients       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚                      â”‚                        â”‚
     â”‚ session_id    â”‚                      â”‚                        â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                      â”‚                        â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚               â”‚ markSessionRunning() â”‚                        â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚               â”‚                      â”‚ Add to runningSet      â”‚
     â”‚               â”‚                      â”‚ Set { session1 }       â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚               â”‚ forwardToConnections()                        â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚               â”‚  { type: 'status',                            â”‚
     â”‚               â”‚    running: true }                            â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚     User sees "Claude is thinking..."                         â”‚
     â”‚               â”‚                      â”‚                        â”‚
```

#### Flow 2: Multiple Sessions - First Finishes (No Notification)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude  â”‚  â”‚ chat.handler â”‚  â”‚ workspace-activity     â”‚  â”‚   WebSocket     â”‚
â”‚ Client 1 â”‚  â”‚    .ts       â”‚  â”‚      .service.ts       â”‚  â”‚   Clients       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚                      â”‚                        â”‚
     â”‚               â”‚          State: runningSessions =              â”‚
     â”‚               â”‚          Set { session1, session2 }            â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚  result       â”‚                      â”‚                        â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                      â”‚                        â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚               â”‚ markSessionIdle()    â”‚                        â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚               â”‚                      â”‚ Remove session1        â”‚
     â”‚               â”‚                      â”‚ Set { session2 }       â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚               â”‚                      â”‚ Check: size === 0?     â”‚
     â”‚               â”‚                      â”‚   NO âœ—                 â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚               â”‚                      â”‚ (No event emitted)     â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚               â”‚ forwardToConnections()                        â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚               â”‚  { type: 'status',                            â”‚
     â”‚               â”‚    running: false }                           â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚               â”‚                      â”‚                        â”‚
     â”‚     Session 1 done, but Session 2 still running...            â”‚
     â”‚               â”‚                      â”‚                        â”‚
```

#### Flow 3: Last Session Finishes - Notification Triggered (Window Unfocused)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude  â”‚  â”‚ chat.handler â”‚  â”‚ workspace-activity     â”‚  â”‚   WebSocket     â”‚  â”‚  Notification    â”‚  â”‚    OS    â”‚
â”‚ Client 2 â”‚  â”‚    .ts       â”‚  â”‚      .service.ts       â”‚  â”‚   Clients       â”‚  â”‚    Manager.tsx   â”‚  â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚  result       â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚ markSessionIdle()    â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚ Remove session2        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚ Set {}                 â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚ Check: size === 0?     â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚   YES âœ“                â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚ emit('workspace_idle') â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚        â”‚               â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚ Query workspace from DB                     â”‚                 â”‚
     â”‚               â”‚                      â”‚ (get name, sessionCount)                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚ emit('request_notification')                â”‚                 â”‚
     â”‚               â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚        â”‚               â”‚                    â”‚                 â”‚
     â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚ setupWorkspaceNotifications()                 â”‚                    â”‚                 â”‚
     â”‚               â”‚   listener receives event                     â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚ Broadcast to WebSocket clients                â”‚                    â”‚                 â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                 â”‚
     â”‚               â”‚  {                   â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚    type: 'workspace_notification_request',    â”‚                    â”‚                 â”‚
     â”‚               â”‚    workspaceId: 'ws-123',                     â”‚                    â”‚                 â”‚
     â”‚               â”‚    workspaceName: 'My Feature',               â”‚                    â”‚                 â”‚
     â”‚               â”‚    sessionCount: 2                            â”‚                    â”‚                 â”‚
     â”‚               â”‚  }                   â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚ CustomEvent        â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚ ('workspace-       â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚  notification-     â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚  request')         â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚ Check:          â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚ isWindowFocused?â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚   NO âœ—          â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚ Check:          â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚ isChatVisible?  â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚   NO âœ—          â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚ shouldSuppress? â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚   NO âœ—          â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚ new Notification()
     â”‚               â”‚                      â”‚                        â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚    ğŸ”” Display   â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
```

#### Flow 4: Last Session Finishes - Notification Suppressed (Window Focused)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude  â”‚  â”‚ chat.handler â”‚  â”‚ workspace-activity     â”‚  â”‚   WebSocket     â”‚  â”‚  Notification    â”‚
â”‚ Client 2 â”‚  â”‚    .ts       â”‚  â”‚      .service.ts       â”‚  â”‚   Clients       â”‚  â”‚    Manager.tsx   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚                      â”‚                        â”‚                    â”‚
     â”‚  result       â”‚                      â”‚                        â”‚                    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                      â”‚                        â”‚                    â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚
     â”‚               â”‚ markSessionIdle()    â”‚                        â”‚                    â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚                    â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚
     â”‚               â”‚                      â”‚ Remove session2        â”‚                    â”‚
     â”‚               â”‚                      â”‚ Set {}                 â”‚                    â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚
     â”‚               â”‚                      â”‚ emit('workspace_idle') â”‚                    â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚
     â”‚               â”‚                      â”‚ emit('request_notification')                â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚
     â”‚               â”‚ Broadcast workspace_notification_request      â”‚                    â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚
     â”‚               â”‚                      â”‚                        â”‚ CustomEvent        â”‚
     â”‚               â”‚                      â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚ Check:          â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚ isWindowFocused?â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚   YES âœ“         â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚ shouldSuppress? â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚   YES âœ“         â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚ return;         â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚ (suppressed)    â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
     â”‚                                                                                                      â”‚
     â”‚     â„¹ï¸  User is actively looking at the app - no notification needed                                â”‚
     â”‚               â”‚                      â”‚                        â”‚                    â”‚                 â”‚
```

#### Flow 5: Window Focus Detection (Electron)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Electron    â”‚  â”‚   Electron   â”‚  â”‚  use-window- â”‚  â”‚  Notification    â”‚
â”‚  Main Window â”‚  â”‚   Preload    â”‚  â”‚  focus.ts    â”‚  â”‚    Manager.tsx   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚                 â”‚                 â”‚ useEffect() mount  â”‚
       â”‚                 â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚                 â”‚ onWindowFocusChanged(callback)       â”‚
       â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚                 â”‚ ipcRenderer.on('window-focus-changed')
       â”‚                 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                    â”‚
       â”‚                 â”‚         â”‚       â”‚                    â”‚
       â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚                 â”‚ return cleanup  â”‚                    â”‚
       â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
   [User switches to different app]       â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚ blur event      â”‚                 â”‚                    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                 â”‚                    â”‚
       â”‚         â”‚       â”‚                 â”‚                    â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                 â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚ webContents.send('window-focus-changed', false)        â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚                 â”‚ callback(false) â”‚                    â”‚
       â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚                 â”‚                 â”‚ setIsFocused(false)â”‚
       â”‚                 â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
   [User switches back to app]            â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚ focus event     â”‚                 â”‚                    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                 â”‚                    â”‚
       â”‚         â”‚       â”‚                 â”‚                    â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                 â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚ webContents.send('window-focus-changed', true)         â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚                 â”‚ callback(true)  â”‚                    â”‚
       â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
       â”‚                 â”‚                 â”‚                    â”‚
       â”‚                 â”‚                 â”‚ setIsFocused(true) â”‚
       â”‚                 â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                 â”‚                 â”‚                    â”‚
```

#### Flow 6: Complete End-to-End Flow (Happy Path)

```
User Context: Working on "Feature X" workspace with 2 sessions running,
              switches to browser to read docs. Both sessions finish while away.

â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚ User â”‚  â”‚ Session1 â”‚  â”‚ Session2     â”‚  â”‚ workspace-     â”‚  â”‚ Frontend â”‚  â”‚ Browser   â”‚  â”‚ OS  â”‚
â”‚      â”‚  â”‚ (Claude) â”‚  â”‚ (Claude)     â”‚  â”‚ activity svc   â”‚  â”‚ Manager  â”‚  â”‚ Notif API â”‚  â”‚     â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚  Switches to browser to read docs             â”‚                â”‚              â”‚           â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚        window.blur event      â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚        isWindowFocused = falseâ”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚     Session 1 finishes task                   â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚ result         â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          markSessionIdle(s1)      â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          runningSet = {s2}        â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          (Still running - no event)              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚     Session 2 finishes task (2 min later)     â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚ result           â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          markSessionIdle(s2)      â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          runningSet = {}          â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          ALL SESSIONS DONE! âœ“     â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          emit('workspace_idle')   â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          Query workspace "Feature X"             â”‚           â”‚
   â”‚           â”‚                â”‚          emit('request_notification')            â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          Broadcast via WebSocket  â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          CustomEvent             â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          Suppression Check:      â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          - isWindowFocused? NO âœ“ â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          - isChatVisible? NO âœ“   â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚          - shouldSuppress? NO âœ“  â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚        new Notification()     â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚      Display â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚  ğŸ”” Ping! â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚  Sees notification: "Workspace Ready: Feature X"                              â”‚           â”‚
   â”‚  "All 2 agents finished and ready for your attention"                         â”‚           â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
   â”‚  Clicks notification to return to app         â”‚                â”‚              â”‚           â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚              â”‚           â”‚
   â”‚           â”‚                â”‚                  â”‚                â”‚              â”‚           â”‚
```

## Detailed Design

### 1. Backend: Workspace Activity Tracker Service

**File:** `src/backend/services/workspace-activity.service.ts` (NEW)

This service maintains a real-time map of which workspaces have running sessions.

```typescript
/**
 * Workspace Activity Service
 *
 * Tracks the running state of all Claude sessions per workspace.
 * Emits events when all sessions in a workspace finish.
 */

import { EventEmitter } from 'node:events';
import { createLogger } from './logger.service';
import { sessionService } from './session.service';
import { workspaceAccessor } from '../resource_accessors/workspace.accessor';
import { notificationService } from './notification.service';

const logger = createLogger('workspace-activity');

interface WorkspaceActivityState {
  workspaceId: string;
  runningSessions: Set<string>; // Set of session IDs currently running
  lastActivityAt: Date;
}

class WorkspaceActivityService extends EventEmitter {
  private workspaceStates = new Map<string, WorkspaceActivityState>();

  constructor() {
    super();

    // Listen for workspace idle events and trigger notifications
    this.on('workspace_idle', async ({ workspaceId, finishedAt }) => {
      try {
        const workspace = await workspaceAccessor.findById(workspaceId);
        if (!workspace) {
          logger.warn('Workspace not found for notification', { workspaceId });
          return;
        }

        // Emit event to frontend for suppression check
        this.emit('request_notification', {
          workspaceId,
          workspaceName: workspace.name,
          sessionCount: workspace.claudeSessions.length,
          finishedAt,
        });
      } catch (error) {
        logger.error('Failed to process workspace idle event', error as Error, { workspaceId });
      }
    });
  }

  /**
   * Mark a session as started/running in a workspace
   */
  markSessionRunning(workspaceId: string, sessionId: string): void {
    let state = this.workspaceStates.get(workspaceId);

    if (!state) {
      state = {
        workspaceId,
        runningSessions: new Set(),
        lastActivityAt: new Date(),
      };
      this.workspaceStates.set(workspaceId, state);
    }

    const wasIdle = state.runningSessions.size === 0;
    state.runningSessions.add(sessionId);
    state.lastActivityAt = new Date();

    if (wasIdle) {
      logger.debug('Workspace became active', { workspaceId, sessionId });
      this.emit('workspace_active', { workspaceId });
    }
  }

  /**
   * Mark a session as finished/idle in a workspace
   */
  markSessionIdle(workspaceId: string, sessionId: string): void {
    const state = this.workspaceStates.get(workspaceId);

    if (!state) {
      return; // No state tracked for this workspace
    }

    state.runningSessions.delete(sessionId);
    state.lastActivityAt = new Date();

    if (state.runningSessions.size === 0) {
      logger.info('All sessions finished in workspace', { workspaceId });
      this.emit('workspace_idle', {
        workspaceId,
        finishedAt: state.lastActivityAt
      });
    }
  }

  /**
   * Check if any sessions are running in a workspace
   */
  isWorkspaceActive(workspaceId: string): boolean {
    const state = this.workspaceStates.get(workspaceId);
    return state ? state.runningSessions.size > 0 : false;
  }

  /**
   * Get count of running sessions in a workspace
   */
  getRunningSessionCount(workspaceId: string): number {
    const state = this.workspaceStates.get(workspaceId);
    return state ? state.runningSessions.size : 0;
  }

  /**
   * Clean up workspace state when workspace is archived/deleted
   */
  clearWorkspace(workspaceId: string): void {
    this.workspaceStates.delete(workspaceId);
  }

  /**
   * Initialize state from existing running sessions (for server restart recovery)
   */
  async initializeFromExistingSessions(): Promise<void> {
    // Query all active sessions and rebuild state
    const activeSessions = sessionService.getAllActiveSessions();

    for (const { sessionId, workspaceId, isRunning } of activeSessions) {
      if (isRunning) {
        this.markSessionRunning(workspaceId, sessionId);
      }
    }

    logger.info('Initialized workspace activity state', {
      workspaceCount: this.workspaceStates.size,
    });
  }
}

export const workspaceActivityService = new WorkspaceActivityService();
```

### 2. Backend: Update Chat Handler to Track Workspace Activity

**File:** `src/backend/routers/websocket/chat.handler.ts` (MODIFY)

Add workspace activity tracking when session states change:

**Location 1:** Add import at top of file (after line 18):
```typescript
import { workspaceActivityService } from '../../services/workspace-activity.service';
```

**Location 2:** In `setupChatClientEvents()`, update the `session_id` event handler (around line 173):
```typescript
client.on('session_id', (claudeSessionId) => {
  if (DEBUG_CHAT_WS) {
    logger.info('[Chat WS] Received session_id from Claude CLI', {
      dbSessionId,
      claudeSessionId,
    });
  }

  // Drain any pending messages
  const pending = pendingMessages.get(dbSessionId);
  pendingMessages.delete(dbSessionId);
  if (pending && pending.length > 0) {
    logger.info('[Chat WS] Draining pending messages on session_id', {
      dbSessionId,
      count: pending.length,
    });
    for (const msg of pending) {
      client.sendMessage(msg.content);
    }
  }

  // NEW: Mark workspace as active
  workspaceActivityService.markSessionRunning(context.workspaceId, dbSessionId);

  forwardToConnections(dbSessionId, {
    type: 'status',
    running: true,
  });
});
```

**Location 3:** In `setupChatClientEvents()`, update the `result` event handler (around line 262):
```typescript
client.on('result', (result) => {
  if (DEBUG_CHAT_WS) {
    const res = result as { uuid?: string };
    logger.info('[Chat WS] Received result event from client', { dbSessionId, uuid: res.uuid });
  }
  sessionFileLogger.log(dbSessionId, 'FROM_CLAUDE_CLI', { eventType: 'result', data: result });
  forwardToConnections(dbSessionId, { type: 'claude_message', data: result });

  // NEW: Mark session as idle
  workspaceActivityService.markSessionIdle(context.workspaceId, dbSessionId);

  forwardToConnections(dbSessionId, {
    type: 'status',
    running: false,
  });
});
```

**Location 4:** Add workspace notification forwarding (after `setupChatClientEvents` function, around line 290):
```typescript
/**
 * Set up workspace-level notification forwarding.
 * Call this once during handler initialization.
 */
let workspaceNotificationsSetup = false;

function setupWorkspaceNotifications(): void {
  if (workspaceNotificationsSetup) {
    return; // Already set up
  }
  workspaceNotificationsSetup = true;

  workspaceActivityService.on('request_notification', async (data) => {
    const { workspaceId, workspaceName, sessionCount, finishedAt } = data;

    logger.debug('Broadcasting workspace notification request', { workspaceId });

    // Send to all connections viewing this workspace
    for (const info of chatConnections.values()) {
      if (info.dbSessionId && info.ws.readyState === 1) {
        try {
          const session = await claudeSessionAccessor.findById(info.dbSessionId);
          if (session?.workspaceId === workspaceId) {
            info.ws.send(JSON.stringify({
              type: 'workspace_notification_request',
              workspaceId,
              workspaceName,
              sessionCount,
              finishedAt: finishedAt.toISOString(),
            }));
          }
        } catch (error) {
          logger.error('Failed to check session workspace', error as Error, {
            dbSessionId: info.dbSessionId,
          });
        }
      }
    }
  });
}
```

**Location 5:** Call `setupWorkspaceNotifications()` in the upgrade handler (around line 614, inside `wss.handleUpgrade`):
```typescript
wss.handleUpgrade(request, socket, head, (ws) => {
  logger.info('Chat WebSocket connection established', {
    connectionId,
    dbSessionId,
  });

  // Set up workspace notification forwarding (idempotent)
  setupWorkspaceNotifications();

  wsAliveMap.set(ws, true);
  ws.on('pong', () => wsAliveMap.set(ws, true));

  // ... rest of the handler ...
});
```

### 3. Backend: Add Notification Method

**File:** `src/backend/services/notification.service.ts` (MODIFY)

Add a workspace completion notification method (around line 335, before the final export):

```typescript
/**
 * Send a workspace completion notification
 */
async notifyWorkspaceComplete(
  workspaceName: string,
  workspaceId: string,
  sessionCount: number
): Promise<void> {
  const message = sessionCount === 1
    ? 'Agent finished and is ready for your attention'
    : `All ${sessionCount} agents finished and ready for your attention`;

  await this.notify(`Workspace Ready: ${workspaceName}`, message);
}
```

### 4. Frontend: Window Focus Detection Hook

**File:** `src/client/hooks/use-window-focus.ts` (NEW)

```typescript
import { useEffect, useState } from 'react';

/**
 * Track whether the app window is focused.
 * Works in both browser and Electron.
 */
export function useWindowFocus(): boolean {
  const [isFocused, setIsFocused] = useState(() => {
    // Initial state
    if (typeof document !== 'undefined') {
      return document.hasFocus();
    }
    return true;
  });

  useEffect(() => {
    // Check if running in Electron with focus API
    if (window.electron?.onWindowFocusChanged) {
      return window.electron.onWindowFocusChanged(setIsFocused);
    }

    // Fallback to browser APIs
    const handleFocus = () => setIsFocused(true);
    const handleBlur = () => setIsFocused(false);
    const handleVisibilityChange = () => {
      setIsFocused(!document.hidden && document.hasFocus());
    };

    window.addEventListener('focus', handleFocus);
    window.addEventListener('blur', handleBlur);
    document.addEventListener('visibilitychange', handleVisibilityChange);

    return () => {
      window.removeEventListener('focus', handleFocus);
      window.removeEventListener('blur', handleBlur);
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, []);

  return isFocused;
}
```

### 5. Frontend: Workspace Notification Manager

**File:** `src/components/workspace/WorkspaceNotificationManager.tsx` (NEW)

```typescript
import { useEffect } from 'react';
import { useParams, useLocation } from 'react-router';
import { useWindowFocus } from '../../hooks/use-window-focus';

interface NotificationRequest {
  workspaceId: string;
  workspaceName: string;
  sessionCount: number;
  finishedAt: string;
}

/**
 * Manages workspace completion notifications.
 * Handles suppression logic based on window focus and visible workspace.
 */
export function WorkspaceNotificationManager() {
  const { workspaceId: currentWorkspaceId } = useParams();
  const location = useLocation();
  const isWindowFocused = useWindowFocus();

  useEffect(() => {
    // Listen for notification requests from backend
    const handleNotificationRequest = (event: CustomEvent<NotificationRequest>) => {
      try {
        const request = event.detail;
        handleWorkspaceNotification(request);
      } catch (error) {
        console.error('Failed to handle notification request', error);
      }
    };

    window.addEventListener('workspace-notification-request', handleNotificationRequest as EventListener);

    return () => {
      window.removeEventListener('workspace-notification-request', handleNotificationRequest as EventListener);
    };
  }, [currentWorkspaceId, location.pathname, isWindowFocused]);

  const handleWorkspaceNotification = (request: NotificationRequest) => {
    const { workspaceId, workspaceName, sessionCount } = request;

    // Suppression Logic
    const isChatVisible = location.pathname.includes(`/workspace/${workspaceId}`);
    const shouldSuppress = isWindowFocused || isChatVisible;

    if (shouldSuppress) {
      console.debug('Notification suppressed', {
        reason: isWindowFocused ? 'window_focused' : 'chat_visible',
        workspaceId,
      });
      return;
    }

    // Send notification
    sendWorkspaceNotification(workspaceName, sessionCount);
  };

  return null; // No UI, just notification logic
}

function sendWorkspaceNotification(workspaceName: string, sessionCount: number): void {
  if (!('Notification' in window)) {
    console.warn('Browser does not support notifications');
    return;
  }

  // Request permission if needed
  if (Notification.permission === 'default') {
    Notification.requestPermission().then((permission) => {
      if (permission === 'granted') {
        showNotification(workspaceName, sessionCount);
      }
    });
  } else if (Notification.permission === 'granted') {
    showNotification(workspaceName, sessionCount);
  }
}

function showNotification(workspaceName: string, sessionCount: number): void {
  const message = sessionCount === 1
    ? 'Agent finished and is ready for your attention'
    : `All ${sessionCount} agents finished and ready for your attention`;

  new Notification(`Workspace Ready: ${workspaceName}`, {
    body: message,
    icon: '/favicon.ico',
    tag: `workspace-complete-${workspaceName}`, // Prevents duplicates
    requireInteraction: false,
  });
}
```

### 6. Frontend: Integration with Chat WebSocket

**File:** `src/components/chat/use-chat-websocket.ts` (MODIFY)

Update the WebSocket message handler to pass notification requests to the manager.

Find the `ws.onmessage` handler and add handling for the new message type:

```typescript
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  // ... existing message handling (status, claude_message, etc.) ...

  // NEW: Handle workspace notification requests
  if (data.type === 'workspace_notification_request') {
    // Dispatch custom event for WorkspaceNotificationManager
    window.dispatchEvent(new CustomEvent('workspace-notification-request', {
      detail: {
        workspaceId: data.workspaceId,
        workspaceName: data.workspaceName,
        sessionCount: data.sessionCount,
        finishedAt: data.finishedAt,
      }
    }));
    return;
  }

  // ... rest of message handling ...
};
```

### 7. Frontend: Add Manager to App Root

**File:** `src/client/router.tsx` or main app component (MODIFY)

Add the WorkspaceNotificationManager to your app root so it runs globally:

```typescript
import { WorkspaceNotificationManager } from './components/workspace/WorkspaceNotificationManager';

// In your root component or router:
export function App() {
  return (
    <>
      <WorkspaceNotificationManager />
      {/* ... rest of your app ... */}
    </>
  );
}
```

### 8. Electron: Expose Window Focus State

**File:** `electron/main/index.ts` (MODIFY)

Add window focus event handlers in the `createWindow` function (after line 42):

```typescript
mainWindow.loadURL(url);
console.log('[electron] Window created and URL loaded');

// NEW: Track window focus state
mainWindow.on('focus', () => {
  mainWindow?.webContents.send('window-focus-changed', true);
});

mainWindow.on('blur', () => {
  mainWindow?.webContents.send('window-focus-changed', false);
});
```

**File:** `electron/preload/index.ts` (MODIFY)

Expose the focus API to the renderer:

```typescript
import { contextBridge, ipcRenderer } from 'electron';

contextBridge.exposeInMainWorld('electron', {
  // ... existing APIs (dialog:showOpen, etc.) ...

  /**
   * Listen for window focus changes (Electron only)
   */
  onWindowFocusChanged: (callback: (isFocused: boolean) => void) => {
    const handler = (_event: Electron.IpcRendererEvent, isFocused: boolean) => {
      callback(isFocused);
    };
    ipcRenderer.on('window-focus-changed', handler);

    // Return cleanup function
    return () => {
      ipcRenderer.removeListener('window-focus-changed', handler);
    };
  },
});
```

**File:** `src/types/electron.d.ts` (MODIFY or CREATE)

Add TypeScript types for the new API:

```typescript
export interface ElectronAPI {
  dialog: {
    showOpen: (options: Electron.OpenDialogOptions) => Promise<Electron.OpenDialogReturnValue>;
  };

  // NEW: Window focus API
  onWindowFocusChanged?: (callback: (isFocused: boolean) => void) => () => void;
}

declare global {
  interface Window {
    electron?: ElectronAPI;
  }
}
```

## Implementation Plan

### Phase 1: Backend Foundation (1-2 hours)
1. Create `workspace-activity.service.ts`
2. Update `chat.handler.ts` to track session state changes
3. Add workspace notification method to `notification.service.ts`
4. Wire up workspace idle event to notification request

### Phase 2: Frontend Integration (1-2 hours)
1. Create `use-window-focus.ts` hook
2. Create `WorkspaceNotificationManager.tsx` component
3. Update chat WebSocket to forward notification requests
4. Add notification manager to app root

### Phase 3: Electron Enhancement (30 min)
1. Update Electron main process to track focus
2. Update preload script to expose focus API
3. Update TypeScript types for Electron API

### Phase 4: Testing & Polish (1 hour)
1. Test notification suppression logic
2. Test multi-session workspace scenarios
3. Test Electron and browser environments
4. Verify notification permissions work correctly

## File Changes Summary

### New Files (3)
- `src/backend/services/workspace-activity.service.ts` - Workspace activity tracking
- `src/client/hooks/use-window-focus.ts` - Window focus detection
- `src/components/workspace/WorkspaceNotificationManager.tsx` - Notification manager component

### Modified Files (6)
- `src/backend/routers/websocket/chat.handler.ts` - Add workspace activity tracking
- `src/backend/services/notification.service.ts` - Add workspace notification method
- `src/components/chat/use-chat-websocket.ts` - Forward notification requests
- `src/client/router.tsx` - Add notification manager to app
- `electron/main/index.ts` - Track window focus events
- `electron/preload/index.ts` - Expose focus API
- `src/types/electron.d.ts` - Add TypeScript types

### Export Updates (1)
- `src/backend/services/index.ts` - Export `workspaceActivityService`

## Testing Checklist

- [ ] Single session in workspace finishes â†’ notification sent (when unfocused)
- [ ] Multiple sessions in workspace, only last one finishing â†’ notification sent
- [ ] Multiple sessions, one finishes while others run â†’ no notification
- [ ] Window is focused â†’ notification suppressed
- [ ] Chat/workspace is visible in UI â†’ notification suppressed
- [ ] Window unfocused + different workspace visible â†’ notification sent
- [ ] Browser environment â†’ Web Notification API works
- [ ] Electron environment â†’ native notifications work
- [ ] Notification permission request works correctly
- [ ] Duplicate notifications prevented (same workspace finishing twice)

## Benefits of This Approach

1. **Minimal Disruption:** Leverages existing infrastructure (`notification.service.ts`, WebSocket system, session tracking)

2. **Clean Separation:** Backend tracks activity, frontend decides suppression

3. **Workspace-Scoped:** Properly handles workspaces with multiple concurrent sessions

4. **Smart Suppression:** Dual-check (window focus + chat visibility) prevents notification spam

5. **Electron-Ready:** Works in both browser and Electron with proper OS notifications

6. **Extensible:** Easy to add user preferences, custom sounds, or different notification types later

## Future Enhancements (Optional)

- User preferences panel for notification settings
- Different notification sounds per workspace/priority
- Notification history/log
- Batch notifications (if multiple workspaces finish simultaneously)
- Notification action buttons (e.g., "View Workspace")
- Integration with system Do Not Disturb mode
- Custom notification templates per workspace type

## Questions & Notes

- **Browser Notification Permissions:** Users will need to grant notification permissions the first time. Consider adding a prompt/onboarding flow.
- **Testing Strategy:** Should test with multiple browser tabs open to ensure suppression logic works correctly.
- **Performance:** The workspace activity service keeps state in memory. For very large numbers of workspaces, consider periodic cleanup of idle workspace states.

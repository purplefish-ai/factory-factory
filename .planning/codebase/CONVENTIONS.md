# Coding Conventions

**Analysis Date:** 2026-02-09

## Naming Patterns

**Files:**
- Backend services: `{name}.service.ts` (e.g., `logger.service.ts`, `workspace-creation.service.ts`)
- Clients: `{name}.client.ts` (e.g., `git.client.ts`)
- Resource accessors: `{name}.accessor.ts` (e.g., `project.accessor.ts`, `health.accessor.ts`)
- Routers: `{name}.router.ts` (e.g., `health.router.ts`, `project.router.ts`)
- tRPC procedures: `{name}.trpc.ts` (e.g., `workspace.trpc.ts`, `pr-review.trpc.ts`)
- Middleware: `{name}.middleware.ts` (e.g., `cors.middleware.ts`, `security.middleware.ts`)
- Interceptors: `{name}.interceptor.ts` (e.g., `branch-rename.interceptor.ts`)
- WebSocket handlers: `{name}.handler.ts` (e.g., `chat.handler.ts`, `terminal.handler.ts`)
- MCP servers: `{name}.mcp.ts` (e.g., `system.mcp.ts`, `terminal.mcp.ts`)
- React hooks: `use-{feature}.ts` (e.g., `use-workspace-list-state.ts`, `use-create-workspace.ts`)
- Test files: `{name}.test.ts` or `{name}.test.tsx`
- Storybook stories: `{name}.stories.tsx`

**Functions:**
- camelCase: `createWorktree()`, `generateBranchName()`, `parseGitStatusOutput()`
- Helper functions: `parse{Type}()`, `create{Type}()`, `get{Property}()` (e.g., `parseWorktreeEntries()`, `isAutoGeneratedBranchName()`)
- Private functions (module scope): use same camelCase pattern, prefixed with underscore if conventionally private
- Async functions: same camelCase, descriptive of action (e.g., `async createWorktree()`, `async listWorktrees()`)

**Variables:**
- camelCase for all variables and properties
- Const by default: `const resourceName = ...` (Biome enforces `useConst` rule)
- Interfaces and types: PascalCase (e.g., `GitWorktreeInfo`, `GitWorktreeEntry`, `GitClientConfig`)
- Enums: PascalCase (e.g., `WorkspaceStatus`, `KanbanColumn`, `RatchetState`)
- Constants: camelCase or UPPER_SNAKE_CASE depending on context
  - String/object constants: camelCase (e.g., `loggerName = 'workspace-trpc'`)
  - Numeric constants: UPPER_SNAKE_CASE if exported widely

**Types:**
- Interface: `I` prefix not used; use plain PascalCase (e.g., `GitClientConfig`, `LogEntry`)
- Generic types: single uppercase letter or descriptive name (e.g., `T`, `Context`)
- Union types: DescriptiveType (e.g., `GitFileStatus`, `WorkspaceCreationSource`)
- Type imports: use `import type { Type }` (Biome enforces `useImportType` rule)
- Zod schemas: camelCase with `Schema` suffix (e.g., `workspaceCreationSourceSchema`, `SessionJsonlEntrySchema`)

## Code Style

**Formatting:**
- Tool: Biome (`@biomejs/biome` v2.3.13)
- Line width: 100 characters
- Indent: 2 spaces
- Quotes: single quotes for JS/TS, single quotes for CSS
- Trailing commas: es5 (included in objects/arrays, not in function parameters)
- Semicolons: always required

**Linting:**
- Tool: Biome (integrated with formatter)
- Config: `biome.json` with strict rules enabled
- Key rules enforced:
  - `noUnusedVariables: error` - Remove all unused variables
  - `noUnusedImports: error` - Remove unused imports (Biome organizes automatically)
  - `noUnusedPrivateClassMembers: error`
  - `noUnusedFunctionParameters: error`
  - `useExhaustiveDependencies: error` - React hook dependencies must be complete
  - `useHookAtTopLevel: error` - React hooks only at top level
  - `noExplicitAny: error` - Ban `any` type
  - `noNonNullAssertion: error` - Ban non-null assertions (`!`) except in tests
  - `noDoubleEquals: error` - Use `===` and `!==`
  - `useConst: error` - Use `const` instead of `let`/`var`
  - `useImportType: error` - Use `import type` for types
  - `useForOf: error` - Prefer `for...of` over `forEach`
  - `useTemplate: error` - Use template strings instead of concatenation
  - `noConsole: error` - Ban `console.log` except in logger, CLI, and electron files
  - `noDangerouslySetInnerHtml: error` - Security: ban innerHTML in React

**Overrides:**
- Logger service (`src/backend/services/logger.service.ts`): `noConsole` off
- Debug module (`src/lib/debug.ts`): `noConsole` off
- CLI and scripts: `noConsole` off
- Electron main process: `noConsole` off
- Test files (`*.test.ts`, `*.test.tsx`, `*.stories.tsx`): `noNonNullAssertion` off (non-null assertions allowed in tests)

**TypeScript:**
- Strict mode: enabled
- Target: ES2022
- Module: ESNext
- Strict checks enabled: `strictNullChecks`, `strictFunctionTypes`, `noImplicitThis`, `noImplicitAny`, `noUnusedLocals`, `noUnusedParameters`, `noImplicitReturns`, `noUncheckedIndexedAccess`
- Path aliases: `@/*` → `src/`, `@prisma-gen/*` → `prisma/generated/`

## Import Organization

**Order:**
1. Node.js built-in modules (e.g., `import * as path from 'node:path'`)
2. Third-party packages (e.g., `import express from 'express'`, `import { z } from 'zod'`)
3. Type-only imports from third-party (e.g., `import type { Request } from 'express'`)
4. Project modules using `@/` alias (internal imports)
5. Relative imports using `../` or `./` (use sparingly, prefer `@/`)

**Path Aliases:**
- Always use `@/` for project imports instead of relative paths
- Example: `import { logger } from '@/backend/services/logger.service'` not `import { logger } from '../../../services/logger.service'`
- Prisma generated: `import { User } from '@prisma-gen/client'`

**Biome Import Organization:**
- Imports are automatically organized by Biome's `assist.actions.source.organizeImports: on`
- Groups are automatically sorted
- Unused imports removed automatically on format

## Error Handling

**Patterns:**
- Throw `Error` objects with descriptive messages including context: `throw new Error('Failed to create worktree: ${result.stderr || result.stdout}')`
- Never throw plain strings or objects; always use `Error` constructor
- Include stderr/stdout or relevant context in error message
- For validation: use Zod `safeParse()` and check `.success` before accessing `.data`
  ```typescript
  const result = SomeSchema.safeParse(input);
  if (result.success) {
    // Use result.data
  } else {
    // Handle result.error
  }
  ```
- For async operations: wrap in try-catch or use `.catch()` handler
- Return `null` for not-found cases (e.g., `parseGitHubRemoteUrl()` returns `null` when URL is invalid)
- Return empty arrays `[]` for empty results (e.g., `parseGitStatusOutput('')` returns `[]`)

## Logging

**Framework:** Custom logger service at `src/backend/services/logger.service.ts`

**Patterns:**
- Create logger: `const logger = createLogger('module-name')`
- Log levels: `error()`, `warn()`, `info()`, `debug()`
- Structured logging with context: pass object as second parameter
  ```typescript
  logger.info('Session created', { sessionId: '123', userId: 'user-1' });
  ```
- Error logging includes stack trace and error name automatically:
  ```typescript
  logger.error('Failed to process', { error });
  ```
- In production, logs write to file (`~/factory-factory/logs/server.log`) instead of console
- Only errors also write to stderr in production for visibility

## Comments

**When to Comment:**
- JSDoc/TSDoc for all exported functions and classes (describe purpose, parameters, return type)
- Inline comments for non-obvious logic, workarounds, or important notes
- Use `//` for single-line comments
- Use `/* ... */` for multi-line comments
- Avoid over-commenting obvious code; let code speak for itself

**JSDoc/TSDoc Pattern:**
```typescript
/**
 * Brief description of what function does.
 *
 * Longer explanation if needed, including:
 * - Any important behavior or side effects
 * - Edge cases or limitations
 *
 * @param name - Description of parameter
 * @returns Description of return value
 * @throws Error description if function throws
 */
export function doSomething(name: string): string {
  // ...
}
```

**Section Comments:**
- Use comment banners to divide file into logical sections:
  ```typescript
  // =============================================================================
  // Section Name
  // =============================================================================
  ```

## Function Design

**Size:** Keep functions focused and small (generally < 50 lines)
- Break complex logic into helper functions
- Extract frequently used patterns into utilities

**Parameters:**
- Prefer named options object for functions with multiple parameters:
  ```typescript
  function create(options: { name: string; description?: string }) { }
  ```
- Use destructuring in parameter list when appropriate
- Limit function parameters to 3-4; use options object for more

**Return Values:**
- Be explicit about return types in function signature
- Return `null` for "not found" cases (single item lookups)
- Return empty array `[]` for "no results" (collection queries)
- Throw errors for actual failures (invalid state, permission denied, etc.)
- Use discriminated unions for complex return types:
  ```typescript
  type Result =
    | { success: true; data: T }
    | { success: false; error: Error };
  ```

## Module Design

**Exports:**
- Use named exports; avoid default exports
- Export interfaces, types, and functions that are part of public API
- Keep implementation details private (don't export)
- Use barrel files (`index.ts`) for module entry points:
  ```typescript
  export { GitClient } from './git.client';
  export type { GitClientConfig, GitWorktreeInfo } from './git.client';
  ```

**Barrel Files:**
- Use `index.ts` as module entry point
- Re-export key types and classes
- Example: `src/backend/clients/index.ts` exports `GitClient`
- Avoid deep nested imports; use barrel files to provide clean API surface

**Class Design:**
- Use private fields with `#` prefix or `private` keyword
- Static methods for utilities (e.g., `SessionManager.getProjectPath()`)
- Instance methods for operations on state
- Constructor for initialization and validation

---

*Convention analysis: 2026-02-09*

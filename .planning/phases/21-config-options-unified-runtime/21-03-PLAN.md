---
phase: 21-config-options-unified-runtime
plan: 03
type: execute
wave: 3
depends_on: ["21-01", "21-02"]
files_modified:
  - src/backend/domains/session/lifecycle/session.service.ts
  - src/backend/domains/session/runtime/index.ts
  - src/backend/domains/session/index.ts
autonomous: true

must_haves:
  truths:
    - "Both Claude and Codex sessions are created via AcpRuntimeManager (no legacy runtime path)"
    - "useAcp flag is removed -- ACP is the default and only runtime path"
    - "ClaudeRuntimeManager and CodexAppServerManager singletons are no longer used by SessionService"
    - "Existing session lifecycle (start, prompt, cancel, stop) works through unified ACP path"
    - "Legacy adapter resolution still exists for non-running sessions (DB lookup, hydration) but new sessions always go through ACP"
  artifacts:
    - path: "src/backend/domains/session/lifecycle/session.service.ts"
      provides: "Unified ACP session creation for all providers"
      contains: "getOrCreateAcpSessionClient"
    - path: "src/backend/domains/session/runtime/index.ts"
      provides: "Legacy managers no longer exported as active singletons"
  key_links:
    - from: "src/backend/domains/session/lifecycle/session.service.ts"
      to: "acpRuntimeManager.getOrCreateClient()"
      via: "getOrCreateSessionClient default path"
      pattern: "getOrCreateAcpSessionClient"
---

<objective>
Unified AcpRuntimeManager: all new sessions use ACP, legacy manager usage removed from session creation

Purpose: RUNTIME-08 -- make AcpRuntimeManager the sole runtime for creating new sessions. Both Claude and Codex sessions route through ACP adapters. Legacy runtime managers (ClaudeRuntimeManager, CodexAppServerManager) are no longer used for new session creation.

Output: SessionService creates all sessions via ACP, useAcp flag removed, legacy manager creation paths removed.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-config-options-unified-runtime/21-RESEARCH.md
@.planning/phases/21-config-options-unified-runtime/21-01-SUMMARY.md
@.planning/phases/21-config-options-unified-runtime/21-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Route all new sessions through AcpRuntimeManager, remove useAcp flag</name>
  <files>
    src/backend/domains/session/lifecycle/session.service.ts
  </files>
  <action>
    1. **`getOrCreateSessionClient`**: Remove the `useAcp` flag from the options parameter. Remove the `if (options?.useAcp)` conditional branch -- make the ACP path the DEFAULT for all new session creation. The method should:
       - Still check for existing clients via the legacy adapters first (sessions already running via legacy managers need to continue working until they exit).
       - For new session creation: always call `getOrCreateAcpSessionClient` instead of branching to `createClaudeClient` or `createCodexClient`.
       - Pass `session.provider` through to the ACP client options so the correct ACP adapter binary is selected.

    2. **`getOrCreateClient`**: Remove `useAcp` from the public method's options type.

    3. **Remove `createClaudeClient` and `createCodexClient` private methods**: These are no longer called for new session creation. KEEP them as dead code only if removing them would break other references. Check for any other callers first -- if no other callers exist, remove them. If they're referenced by tests or other code paths, mark them with `@deprecated` comments for Phase 22 cleanup.

    4. **`sendSessionMessage`**: The existing ACP detection (`acpRuntimeManager.getClient()`) already handles ACP sessions correctly. Verify the fast-path detection still works: Claude adapter check -> ACP check -> Codex adapter check. Since all new sessions will be ACP, the ACP check will be the primary hit.

    5. **`stopSession`**: Verify ACP stop path (already exists) handles the unified case. The existing `acpRuntimeManager.getClient()` check routes to `stopAcpSession` which works for both providers.

    6. **`getChatBarCapabilities`**: For ACP sessions, derive capabilities from the stored configOptions rather than calling the legacy adapter. If `acpRuntimeManager.getClient(sessionId)` returns a handle with `configOptions.length > 0`, build `ChatBarCapabilities` from config options (model = category 'model', reasoning = category 'thought_level'). Fall back to existing adapter path for non-ACP sessions.

    7. **`stopAllClients`**: Already calls `acpRuntimeManager.stopAllClients()`. Verify it still calls legacy manager stop methods too (for any in-flight legacy sessions during the transition). This is already the case -- no change needed.

    8. **Update start handler references**: Check `start.handler.ts` -- it passes `useAcp` in the options. Remove the `useAcp: true` flag since it's now always ACP. The handler should just pass through model/permissionMode without the flag.
  </action>
  <verify>
    `pnpm typecheck` passes. `pnpm test` passes. `pnpm check:fix` passes. `pnpm deps:check` passes.
  </verify>
  <done>
    All new sessions created via AcpRuntimeManager regardless of provider. useAcp flag removed. Legacy session creation methods removed or deprecated. Existing running legacy sessions continue working until natural exit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up runtime barrel exports and session domain barrel</name>
  <files>
    src/backend/domains/session/runtime/index.ts
    src/backend/domains/session/index.ts
  </files>
  <action>
    1. **Runtime barrel** (`runtime/index.ts`): Keep the `ClaudeRuntimeManager`, `CodexAppServerManager`, and their singletons exported for now (Phase 22 will remove them entirely). They're still needed for: (a) legacy sessions that may be in-flight, (b) test files that reference them, (c) admin/health endpoints. Add a `@deprecated` JSDoc comment to the singleton exports: `/** @deprecated Phase 22 -- will be removed when legacy protocol code is deleted */`.

    2. **Session domain barrel** (`index.ts`): Same treatment -- keep exports but add `@deprecated` JSDoc to the legacy runtime manager exports if they exist. Verify the ACP exports from Plan 01 are all present.

    3. **Verify no import of useAcp remains**: Search for `useAcp` across the codebase. Remove any remaining references in:
       - `start.handler.ts` (the primary consumer)
       - Any test files that pass `useAcp: true`
       - Type definitions that include it

    4. **Verify admin endpoints**: Check `getAllActiveProcesses()` and `getCodexManagerStatus()` -- these reference legacy managers. Keep them functional but they'll report empty/no data for ACP sessions. Phase 22 will replace them with ACP-based process reporting.
  </action>
  <verify>
    `pnpm typecheck` passes. `pnpm test` passes. `pnpm check:fix` passes. `pnpm deps:check` passes. Grep for `useAcp` returns zero results (except possibly test fixtures with the flag removed).
  </verify>
  <done>
    Legacy runtime managers deprecated with JSDoc comments. useAcp flag fully removed from codebase. ACP is the sole runtime path. All existing functionality preserved for both providers.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck && pnpm test && pnpm check:fix && pnpm deps:check` all pass
- `grep -r "useAcp" src/` returns no results
- `getOrCreateSessionClient` always routes to ACP path for new sessions
- Legacy running sessions still work via existing adapter detection
- getChatBarCapabilities derives from ACP configOptions for ACP sessions
- start.handler.ts no longer passes useAcp flag
</verification>

<success_criteria>
- Both Claude and Codex new sessions use AcpRuntimeManager exclusively
- useAcp flag is completely removed
- Legacy managers are deprecated but not deleted (Phase 22 cleanup)
- All tests pass, no regressions
- Admin endpoints remain functional (may report empty for ACP sessions)
</success_criteria>

<output>
After completion, create `.planning/phases/21-config-options-unified-runtime/21-03-SUMMARY.md`
</output>

---
phase: 12-domain-event-emission
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/domains/github/pr-snapshot.service.ts
  - src/backend/domains/github/pr-snapshot.service.test.ts
  - src/backend/domains/github/index.ts
  - src/backend/domains/ratchet/ratchet.service.ts
  - src/backend/domains/ratchet/ratchet.service.test.ts
  - src/backend/domains/ratchet/index.ts
autonomous: true

must_haves:
  truths:
    - "PR snapshot refresh emits events with workspace ID, prNumber, prState, prCiStatus, and prReviewState"
    - "Ratchet state transitions emit events with workspace ID, fromState, and toState"
    - "Ratchet disabled early return path also emits events when state changes"
    - "No event emitted when ratchet state does not change"
    - "Events are emitted AFTER the mutation completes, not before"
    - "Session activity events (workspace_active, workspace_idle) already flow through WorkspaceActivityService (EVNT-05 already satisfied)"
  artifacts:
    - path: "src/backend/domains/github/pr-snapshot.service.ts"
      provides: "PRSnapshotService extends EventEmitter, emits pr_snapshot_updated"
      contains: "PR_SNAPSHOT_UPDATED"
    - path: "src/backend/domains/ratchet/ratchet.service.ts"
      provides: "RatchetService extends EventEmitter, emits ratchet_state_changed"
      contains: "RATCHET_STATE_CHANGED"
    - path: "src/backend/domains/github/index.ts"
      provides: "Barrel exports PR_SNAPSHOT_UPDATED and PRSnapshotUpdatedEvent"
      contains: "PR_SNAPSHOT_UPDATED"
    - path: "src/backend/domains/ratchet/index.ts"
      provides: "Barrel exports RATCHET_STATE_CHANGED and RatchetStateChangedEvent"
      contains: "RATCHET_STATE_CHANGED"
  key_links:
    - from: "src/backend/domains/github/pr-snapshot.service.ts"
      to: "node:events"
      via: "extends EventEmitter"
      pattern: "class PRSnapshotService extends EventEmitter"
    - from: "src/backend/domains/ratchet/ratchet.service.ts"
      to: "node:events"
      via: "extends EventEmitter"
      pattern: "class RatchetService extends EventEmitter"
---

<objective>
Add EventEmitter-based event emission to GitHub PR snapshot service (EVNT-02) and ratchet service (EVNT-03), and verify EVNT-05 is already satisfied.

Purpose: The PR snapshot service and ratchet service perform state mutations that the snapshot store needs to observe. Adding typed events enables the Event Collector (Phase 13) to react to PR refreshes and ratchet state changes without polling.

Output: Both services extend EventEmitter and emit typed events after successful mutations. Event constants and payload types are exported from domain barrels. Tests verify emission behavior. EVNT-05 confirmed already working.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-domain-event-emission/12-RESEARCH.md
@src/backend/domains/github/pr-snapshot.service.ts
@src/backend/domains/github/pr-snapshot.service.test.ts
@src/backend/domains/github/index.ts
@src/backend/domains/ratchet/ratchet.service.ts
@src/backend/domains/ratchet/ratchet.service.test.ts
@src/backend/domains/ratchet/index.ts
@src/backend/domains/workspace/lifecycle/activity.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add event emission to PR snapshot and ratchet services</name>
  <files>
    src/backend/domains/github/pr-snapshot.service.ts
    src/backend/domains/github/index.ts
    src/backend/domains/ratchet/ratchet.service.ts
    src/backend/domains/ratchet/index.ts
  </files>
  <action>
**PR snapshot service (pr-snapshot.service.ts):**

1. Add `import { EventEmitter } from 'node:events';` at top.

2. Define event constant and payload type before the class:
```typescript
export const PR_SNAPSHOT_UPDATED = 'pr_snapshot_updated' as const;

export interface PRSnapshotUpdatedEvent {
  workspaceId: string;
  prNumber: number;
  prState: string;
  prCiStatus: string;
  prReviewState: string | null;
}
```

3. Change `class PRSnapshotService` to `class PRSnapshotService extends EventEmitter`.

4. The class already has field initialization but no constructor. Add a constructor that calls super() and preserves existing field init:
```typescript
constructor() {
  super();
}
```
The `private kanbanBridge: GitHubKanbanBridge | null = null;` field initializer runs automatically after super().

5. In `applySnapshot()` method: add emit AFTER the `kanban.updateCachedKanbanColumn` call (line 176), at the end of the method:
```typescript
this.emit(PR_SNAPSHOT_UPDATED, {
  workspaceId,
  prNumber: snapshot.prNumber,
  prState: snapshot.prState,
  prCiStatus: snapshot.prCiStatus,
  prReviewState: snapshot.prReviewState,
} satisfies PRSnapshotUpdatedEvent);
```
Per research recommendation: always emit (do not compare old vs new). Phase 13 coalescer handles dedup.

**GitHub barrel (github/index.ts):**

Add to the pr-snapshot.service exports:
```typescript
export {
  PR_SNAPSHOT_UPDATED,
  type PRSnapshotUpdatedEvent,
  // ... existing exports
} from './pr-snapshot.service';
```

**Ratchet service (ratchet.service.ts):**

1. Add `import { EventEmitter } from 'node:events';` at top (keep existing imports).

2. Define event constant and payload type before the class:
```typescript
export const RATCHET_STATE_CHANGED = 'ratchet_state_changed' as const;

export interface RatchetStateChangedEvent {
  workspaceId: string;
  fromState: RatchetState;
  toState: RatchetState;
}
```

3. Change `class RatchetService` to `class RatchetService extends EventEmitter`.

4. Add constructor calling super(). Keep existing field initializers (isShuttingDown, monitorLoop, etc.) -- they run after super() automatically:
```typescript
constructor() {
  super();
}
```

5. In `processWorkspace()`, disabled early return path (line 262-281): add emit AFTER the `workspaceAccessor.update()` call (line 265-268), only when state actually changes:
```typescript
if (workspace.ratchetState !== newState) {
  this.emit(RATCHET_STATE_CHANGED, {
    workspaceId: workspace.id,
    fromState: workspace.ratchetState,
    toState: newState,
  } satisfies RatchetStateChangedEvent);
}
```
Place this after the `workspaceAccessor.update()` and before the `logWorkspaceRatchetingDecision()` call.

6. In `processWorkspace()`, main success path (around line 308-321): add emit AFTER `updateWorkspaceAfterCheck()` (line 308-312) and before `logWorkspaceRatchetingDecision()` (line 314), only when state changed:
```typescript
if (decisionContext.previousState !== decisionContext.finalState) {
  this.emit(RATCHET_STATE_CHANGED, {
    workspaceId: workspace.id,
    fromState: decisionContext.previousState,
    toState: decisionContext.finalState,
  } satisfies RatchetStateChangedEvent);
}
```

Important: Do NOT emit in the error catch block (line 329-348) or the shutdown early return (line 252-259) -- these are not state changes.

**Ratchet barrel (ratchet/index.ts):**

Add to the ratchet.service exports:
```typescript
export {
  RATCHET_STATE_CHANGED,
  type RatchetStateChangedEvent,
  // ... existing exports
} from './ratchet.service';
```
  </action>
  <verify>
Run `pnpm typecheck` to verify no type errors. Run `pnpm test -- src/backend/domains/github/pr-snapshot.service.test.ts src/backend/domains/ratchet/ratchet.service.test.ts` to verify existing tests still pass.
  </verify>
  <done>
PRSnapshotService extends EventEmitter and emits PR_SNAPSHOT_UPDATED in applySnapshot(). RatchetService extends EventEmitter and emits RATCHET_STATE_CHANGED in both the disabled early return path and the main processWorkspace path, only when state actually changes. Event constants and types exported from barrels. Existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add event emission tests for PR snapshot and ratchet services, verify EVNT-05</name>
  <files>
    src/backend/domains/github/pr-snapshot.service.test.ts
    src/backend/domains/ratchet/ratchet.service.test.ts
  </files>
  <action>
**PR snapshot tests (pr-snapshot.service.test.ts):**

Add a new `describe('event emission')` block. Import `PR_SNAPSHOT_UPDATED` and `PRSnapshotUpdatedEvent` from the service. Use `afterEach(() => prSnapshotService.removeAllListeners())`.

Read the existing test file first to understand the mock setup (mocked workspace accessor, GitHub CLI service, kanban bridge). Then add:

1. `emits pr_snapshot_updated after successful applySnapshot` -- Call `applySnapshot('ws-1', { prNumber: 42, prState: 'OPEN', prCiStatus: 'SUCCESS', prReviewState: null })`. Assert event received with matching payload.

2. `emits pr_snapshot_updated on refreshWorkspace when snapshot succeeds` -- Mock workspace with prUrl, mock fetchAndComputePRState returning snapshot data, mock accessor update and kanban. Call refreshWorkspace. Assert event emitted with correct values.

3. `does NOT emit on refreshWorkspace when workspace not found` -- Mock accessor returning null. Call refreshWorkspace. Assert zero events.

4. `does NOT emit on refreshWorkspace when no prUrl` -- Mock workspace with null prUrl. Call refreshWorkspace. Assert zero events (and returns `{ success: false, reason: 'no_pr_url' }`).

5. `emits event on attachAndRefreshPR` -- Mock workspace found, fetchAndComputePRState returns data. Call attachAndRefreshPR. Assert event emitted.

**Ratchet tests (ratchet.service.test.ts):**

Read the existing test file first to understand mock setup (it's complex -- mocked accessor, bridges, PR state). Add a new `describe('event emission')` block. Import `RATCHET_STATE_CHANGED` and `RatchetStateChangedEvent`. Use `afterEach(() => ratchetService.removeAllListeners())`.

1. `emits ratchet_state_changed when disabled workspace state changes` -- Create workspace with `ratchetEnabled: false` and `ratchetState: 'CI_FAILED'`. Mock accessor update. Call processWorkspace (or checkWorkspaceById if processWorkspace is private -- check visibility). Assert event with `{ fromState: 'CI_FAILED', toState: 'IDLE' }`.

2. `does NOT emit when disabled workspace state is already IDLE` -- Create workspace with `ratchetEnabled: false` and `ratchetState: 'IDLE'`. Assert zero events (state unchanged, IDLE->IDLE).

3. `emits ratchet_state_changed on main path when state changes` -- Set up workspace with ratchetEnabled, mock PR state that causes state transition (e.g., CI_FAILED to CI_RUNNING). Assert event with correct from/to states.

4. `does NOT emit when main path state unchanged` -- Set up workspace where ratchet state stays the same after processing. Assert zero events.

5. `does NOT emit on error path` -- Mock fetchPRState to fail. Assert zero events and the result has action type 'ERROR'.

Note: `processWorkspace` is private. Use `checkWorkspaceById` (public) which delegates to processWorkspace, or `checkAllWorkspaces` (public). Check which is more suitable for isolated testing.

**EVNT-05 verification:**

No new tests needed. Verify by reading `src/backend/domains/workspace/lifecycle/activity.service.ts` and confirming:
- Class extends EventEmitter (line 20)
- Emits 'workspace_active' event
- Emits 'workspace_idle' event
- Already exported from workspace/index.ts as `workspaceActivityService`

Add a brief comment in the test file or SUMMARY confirming EVNT-05 is satisfied by existing code.
  </action>
  <verify>
Run `pnpm test -- src/backend/domains/github/pr-snapshot.service.test.ts src/backend/domains/ratchet/ratchet.service.test.ts` -- all tests pass including new event emission tests. Run `pnpm typecheck` for good measure.
  </verify>
  <done>
PR snapshot service has 5 event emission tests covering: applySnapshot, refreshWorkspace success, refreshWorkspace workspace-not-found (no emit), refreshWorkspace no-prUrl (no emit), attachAndRefreshPR. Ratchet service has 5 event emission tests covering: disabled workspace state change, disabled workspace already IDLE (no emit), main path state change, main path unchanged (no emit), error path (no emit). EVNT-05 confirmed already satisfied by WorkspaceActivityService.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no errors
2. `pnpm test -- src/backend/domains/github/pr-snapshot.service.test.ts` -- all tests pass
3. `pnpm test -- src/backend/domains/ratchet/ratchet.service.test.ts` -- all tests pass
4. `pnpm check:fix` passes (Biome formatting/linting)
5. Grep check: `grep -r "snapshot-store\|SnapshotStore" src/backend/domains/github/pr-snapshot.service.ts src/backend/domains/ratchet/ratchet.service.ts` returns nothing (no snapshot imports in domains)
6. Verify EVNT-05: `grep "extends EventEmitter" src/backend/domains/workspace/lifecycle/activity.service.ts` confirms activity service already extends EventEmitter
</verification>

<success_criteria>
- PRSnapshotService extends EventEmitter and emits PR_SNAPSHOT_UPDATED after every applySnapshot()
- RatchetService extends EventEmitter and emits RATCHET_STATE_CHANGED on state transitions (disabled path + main path), only when state actually changes
- Events emitted AFTER mutation, not before; no emit on error/failure paths
- Event constants and payload types exported from domain barrels
- 10 new tests pass verifying emission and non-emission behavior
- EVNT-05 confirmed satisfied by existing WorkspaceActivityService
- Zero snapshot-related imports in domain files
</success_criteria>

<output>
After completion, create `.planning/phases/12-domain-event-emission/12-02-SUMMARY.md`
</output>

---
phase: 04-github-domain-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/domains/github/github-cli.service.ts
  - src/backend/domains/github/github-cli.service.test.ts
  - src/backend/domains/github/pr-snapshot.service.ts
  - src/backend/domains/github/pr-snapshot.service.test.ts
  - src/backend/services/github-cli.service.ts
  - src/backend/services/github-cli.service.test.ts
  - src/backend/services/pr-snapshot.service.ts
  - src/backend/services/pr-snapshot.service.test.ts
autonomous: true

must_haves:
  truths:
    - "github-cli.service.ts lives at src/backend/domains/github/ with all exports preserved"
    - "pr-snapshot.service.ts lives at src/backend/domains/github/ with all exports preserved"
    - "Old service paths still work via re-export shims"
    - "All existing tests pass at new locations"
  artifacts:
    - path: "src/backend/domains/github/github-cli.service.ts"
      provides: "GitHub CLI wrapper with Zod-validated JSON parsing"
      exports: ["githubCLIService", "GitHubCLIErrorType", "PRStatusFromGitHub", "PRInfo", "ReviewRequestedPR", "GitHubCLIHealthStatus", "GitHubIssue"]
    - path: "src/backend/domains/github/github-cli.service.test.ts"
      provides: "Co-located test for github-cli service"
    - path: "src/backend/domains/github/pr-snapshot.service.ts"
      provides: "PR snapshot persistence logic"
      exports: ["prSnapshotService", "PRSnapshotRefreshResult", "AttachAndRefreshResult"]
    - path: "src/backend/domains/github/pr-snapshot.service.test.ts"
      provides: "Co-located test for pr-snapshot service"
    - path: "src/backend/services/github-cli.service.ts"
      provides: "Re-export shim for backward compatibility"
    - path: "src/backend/services/pr-snapshot.service.ts"
      provides: "Re-export shim for backward compatibility"
  key_links:
    - from: "src/backend/domains/github/pr-snapshot.service.ts"
      to: "src/backend/domains/github/github-cli.service.ts"
      via: "intra-domain relative import"
      pattern: "from './github-cli.service'"
    - from: "src/backend/services/github-cli.service.ts"
      to: "src/backend/domains/github/github-cli.service.ts"
      via: "re-export shim"
      pattern: "from '@/backend/domains/github/github-cli.service'"
---

<objective>
Move github-cli.service.ts (1289 LOC) and pr-snapshot.service.ts (165 LOC) with their co-located tests into src/backend/domains/github/. Create re-export shims at old paths.

Purpose: Establish the GitHub domain core — the CLI wrapper is the foundation all other GitHub services depend on. PR snapshot uses the CLI service directly, so moving them together allows intra-domain relative imports.
Output: 4 new domain files + 4 shims at old paths.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move github-cli.service.ts and test to domain</name>
  <files>
    src/backend/domains/github/github-cli.service.ts
    src/backend/domains/github/github-cli.service.test.ts
    src/backend/services/github-cli.service.ts
    src/backend/services/github-cli.service.test.ts
  </files>
  <action>
1. Copy `src/backend/services/github-cli.service.ts` to `src/backend/domains/github/github-cli.service.ts`.
2. In the new domain file, update import paths:
   - `./logger.service` -> `@/backend/services/logger.service` (cross-domain, absolute)
   - `./rate-limit-backoff` -> `@/backend/services/rate-limit-backoff` (cross-domain, absolute)
   - `@/shared/github-types` stays as-is (already absolute)
   - `@prisma-gen/client` stays as-is (already absolute)
3. Copy `src/backend/services/github-cli.service.test.ts` to `src/backend/domains/github/github-cli.service.test.ts`.
4. In the new test file, update import paths:
   - `./logger.service` -> `@/backend/services/logger.service` in vi.mock calls
   - `./github-cli.service` -> `./github-cli.service` (stays relative, same dir)
   - `node:child_process` and `node:util` stay as-is
5. Replace old `src/backend/services/github-cli.service.ts` with a re-export shim:
   ```typescript
   /**
    * @deprecated Import from '@/backend/domains/github' instead.
    * This re-export shim will be removed in Phase 9 (Import Rewiring).
    */
   export {
     type GitHubCLIErrorType,
     type GitHubCLIHealthStatus,
     type GitHubIssue,
     type PRInfo,
     type PRStatusFromGitHub,
     type ReviewRequestedPR,
     githubCLIService,
   } from '@/backend/domains/github/github-cli.service';
   ```
6. Replace old `src/backend/services/github-cli.service.test.ts` with a pointer comment:
   ```typescript
   /**
    * Tests moved to src/backend/domains/github/github-cli.service.test.ts
    * This file is kept to avoid confusion. Run tests from the domain location.
    */
   export {};
   ```
   Alternatively, just delete the old test file if the test runner will find the new one (vitest scans all `*.test.ts`). Prefer deletion to reduce noise.
  </action>
  <verify>
Run `pnpm typecheck` to confirm no type errors. Run `pnpm test -- --run src/backend/domains/github/github-cli.service.test.ts` to confirm tests pass at new location. Verify shim re-exports work by running `pnpm typecheck`.
  </verify>
  <done>github-cli.service.ts and test live in domains/github/, shim at old path re-exports all 7 exported names, typecheck passes, domain tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Move pr-snapshot.service.ts and test to domain</name>
  <files>
    src/backend/domains/github/pr-snapshot.service.ts
    src/backend/domains/github/pr-snapshot.service.test.ts
    src/backend/services/pr-snapshot.service.ts
    src/backend/services/pr-snapshot.service.test.ts
  </files>
  <action>
1. Copy `src/backend/services/pr-snapshot.service.ts` to `src/backend/domains/github/pr-snapshot.service.ts`.
2. In the new domain file, update import paths:
   - `./github-cli.service` -> `./github-cli.service` (intra-domain relative, same dir — already correct if using the domain file from Task 1)
   - `../resource_accessors/workspace.accessor` -> `@/backend/resource_accessors/workspace.accessor` (cross-domain, absolute)
   - `./kanban-state.service` -> `@/backend/services/kanban-state.service` (cross-domain via shim, absolute)
   - `./logger.service` -> `@/backend/services/logger.service` (cross-domain, absolute)
3. Copy `src/backend/services/pr-snapshot.service.test.ts` to `src/backend/domains/github/pr-snapshot.service.test.ts`.
4. In the new test file, update vi.mock paths to match the new source imports:
   - `../resource_accessors/workspace.accessor` -> `@/backend/resource_accessors/workspace.accessor`
   - `./github-cli.service` -> `./github-cli.service` (stays relative)
   - `./kanban-state.service` -> `@/backend/services/kanban-state.service`
   - `./logger.service` -> `@/backend/services/logger.service`
   - Update the import of `prSnapshotService` to `./pr-snapshot.service` (stays relative)
5. Replace old `src/backend/services/pr-snapshot.service.ts` with a re-export shim:
   ```typescript
   /**
    * @deprecated Import from '@/backend/domains/github' instead.
    * This re-export shim will be removed in Phase 9 (Import Rewiring).
    */
   export {
     type AttachAndRefreshResult,
     type PRSnapshotRefreshResult,
     prSnapshotService,
   } from '@/backend/domains/github/pr-snapshot.service';
   ```
6. Delete old `src/backend/services/pr-snapshot.service.test.ts` (vitest will find the new one).
  </action>
  <verify>
Run `pnpm typecheck` to confirm no type errors. Run `pnpm test -- --run src/backend/domains/github/pr-snapshot.service.test.ts` to confirm tests pass at new location. Verify all consumers still compile via `pnpm typecheck`.
  </verify>
  <done>pr-snapshot.service.ts and test live in domains/github/, intra-domain import to github-cli.service uses relative path, shim at old path re-exports all 3 exported names, typecheck passes, domain tests pass.</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test -- --run src/backend/domains/github/` runs both test files and all pass
- `pnpm test -- --run` full suite passes (no regressions from shims)
- Old import paths still resolve (shims work)
</verification>

<success_criteria>
- github-cli.service.ts (1289 LOC) and pr-snapshot.service.ts (165 LOC) live in src/backend/domains/github/
- Co-located tests live alongside source files in the domain
- Intra-domain import: pr-snapshot -> github-cli uses relative ./github-cli.service
- Cross-domain imports use absolute @/backend/ paths
- Re-export shims at old services/ paths maintain backward compatibility
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-github-domain-consolidation/04-01-SUMMARY.md`
</output>

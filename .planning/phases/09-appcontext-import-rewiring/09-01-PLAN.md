---
phase: 09-appcontext-import-rewiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/app-context.ts
  - src/backend/domains/ratchet/bridges.ts
  - src/backend/domains/ratchet/reconciliation.service.ts
  - src/backend/orchestration/domain-bridges.orchestrator.ts
  - src/backend/domains/session/store/session-publisher.ts
  - src/backend/domains/session/session-domain.service.test.ts
autonomous: true

must_haves:
  truths:
    - "app-context.ts imports domain services from barrel files, not shim files"
    - "reconciliation.service.ts uses bridge injection for workspace state transitions, not a shim import"
    - "session-publisher.ts uses relative imports within its own domain, not shim paths"
    - "session-domain.service.test.ts imports from session domain barrel or relative, not shims"
  artifacts:
    - path: "src/backend/app-context.ts"
      provides: "DI wiring using domain barrels"
      contains: "from './domains/session'"
    - path: "src/backend/domains/ratchet/bridges.ts"
      provides: "RatchetWorkspaceBridge interface"
      contains: "RatchetWorkspaceBridge"
    - path: "src/backend/domains/ratchet/reconciliation.service.ts"
      provides: "Reconciliation with bridge-injected workspace methods"
      contains: "configure"
    - path: "src/backend/orchestration/domain-bridges.orchestrator.ts"
      provides: "Reconciliation bridge wiring"
      contains: "reconciliationService.configure"
  key_links:
    - from: "src/backend/app-context.ts"
      to: "src/backend/domains/session/index.ts"
      via: "barrel import"
      pattern: "from './domains/session'"
    - from: "src/backend/domains/ratchet/reconciliation.service.ts"
      to: "src/backend/orchestration/domain-bridges.orchestrator.ts"
      via: "bridge injection"
      pattern: "configure.*workspace"
---

<objective>
Rewire app-context.ts to import from domain barrels, add bridge injection for reconciliation.service.ts cross-domain workspace import, and fix domain-internal self-references through shims.

Purpose: Eliminate all foundational shim dependencies so consumer rewiring (Plan 02) and shim deletion (Plan 03) can proceed cleanly.
Output: app-context.ts using domain barrels, reconciliation.service.ts using bridge injection, session-publisher.ts and test using relative/barrel imports.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-appcontext-import-rewiring/09-RESEARCH.md
@src/backend/app-context.ts
@src/backend/domains/ratchet/bridges.ts
@src/backend/domains/ratchet/reconciliation.service.ts
@src/backend/orchestration/domain-bridges.orchestrator.ts
@src/backend/domains/session/store/session-publisher.ts
@src/backend/domains/session/session-domain.service.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire app-context.ts and fix domain-internal shim imports</name>
  <files>
    src/backend/app-context.ts
    src/backend/domains/session/store/session-publisher.ts
    src/backend/domains/session/session-domain.service.test.ts
  </files>
  <action>
**app-context.ts:** Replace all shim imports with domain barrel imports. Group imports into two sections:

Domain imports (from barrel files):
- `chatConnectionService`, `chatEventForwarderService`, `chatMessageHandlerService`, `sessionDomainService`, `type SessionFileLogger`, `sessionFileLogger`, `sessionService` from `'./domains/session'`
- `githubCLIService` from `'./domains/github'`
- `kanbanStateService`, `workspaceStateMachine` from `'./domains/workspace'`
- `ratchetService` from `'./domains/ratchet'`
- `terminalService` from `'./domains/terminal'`
- `type RunScriptService`, `runScriptService`, `runScriptStateMachine`, `startupScriptService` from `'./domains/run-script'`

Infrastructure imports (stay in services/):
- `cliHealthService` from `'./services/cli-health.service'`
- `configService` from `'./services/config.service'`
- `createLogger` from `'./services/logger.service'`
- `findAvailablePort` from `'./services/port.service'`
- `rateLimiter` from `'./services/rate-limiter.service'`
- `schedulerService` from `'./services/scheduler.service'`
- `serverInstanceService` from `'./services/server-instance.service'`

Remove the existing import of `sessionDomainService` from `'@/backend/domains/session/session-domain.service'` -- it is now imported from the barrel.

The `AppServices` type, `createServices()`, `createAppContext()`, and the `export type { SessionFileLogger }` line all remain unchanged -- they reference the same symbols, just imported from different paths.

**session-publisher.ts:** Replace the two shim imports:
- `import { chatConnectionService } from '@/backend/services/chat-connection.service'` -> `import { chatConnectionService } from '../chat/chat-connection.service'` (relative intra-domain import)
- `import { sessionFileLogger } from '@/backend/services/session-file-logger.service'` -> `import { sessionFileLogger } from '../logging/session-file-logger.service'` (relative intra-domain import)

**session-domain.service.test.ts:** Replace the shim import:
- `import { chatConnectionService } from '@/backend/services/chat-connection.service'` -> `import { chatConnectionService } from '@/backend/domains/session'` (domain barrel import)
- Also update the `vi.mock('@/backend/services/chat-connection.service', ...)` to `vi.mock('@/backend/domains/session', ...)` -- but ONLY mock `chatConnectionService`, spread the rest from `vi.importActual`.
- Similarly update `import { SessionManager } from '@/backend/claude'` to `import { SessionManager } from '@/backend/domains/session'` and update the corresponding `vi.mock('@/backend/claude', ...)` to `vi.mock('@/backend/domains/session', ...)`.
- Since both imports now come from the same module, merge into a single `vi.mock('@/backend/domains/session', ...)` that spreads `vi.importActual` and overrides both `SessionManager` and `chatConnectionService`.

Run `pnpm check:fix` after to normalize import ordering.
  </action>
  <verify>
Run `pnpm typecheck` -- must pass with no errors.
Run `pnpm test -- --run src/backend/domains/session/session-domain.service.test.ts` -- must pass.
Verify no imports from shim paths remain in these 3 files: `grep -r "services/chat-connection\|services/session-file-logger\|services/session\.service\|services/ratchet\.service\|services/workspace-state-machine\|services/run-script\|services/terminal\|services/github-cli\|services/kanban\|services/startup-script" src/backend/app-context.ts src/backend/domains/session/store/session-publisher.ts src/backend/domains/session/session-domain.service.test.ts` should return empty.
  </verify>
  <done>
app-context.ts imports all domain services from barrel files and infrastructure from services/. session-publisher.ts uses relative domain-internal imports. session-domain.service.test.ts imports and mocks from domain barrel.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add workspace bridge to reconciliation.service.ts</name>
  <files>
    src/backend/domains/ratchet/bridges.ts
    src/backend/domains/ratchet/reconciliation.service.ts
    src/backend/orchestration/domain-bridges.orchestrator.ts
  </files>
  <action>
**bridges.ts:** Add a `RatchetWorkspaceBridge` interface after the existing `RatchetGitHubBridge`:

```typescript
/** Workspace capabilities needed by ratchet domain */
export interface RatchetWorkspaceBridge {
  markFailed(workspaceId: string, reason: string): Promise<void>;
}
```

This only needs `markFailed` -- that's the only workspace method `reconciliation.service.ts` uses. The `markReady` is not used by reconciliation (it delegates to `initializeWorkspaceWorktree` from orchestration for NEW workspaces, which handles its own state transitions).

**reconciliation.service.ts:** Apply the same configure() + fail-fast getter bridge injection pattern used by other ratchet services:

1. Remove `import { workspaceStateMachine } from '@/backend/services/workspace-state-machine.service'`
2. Add import: `import type { RatchetWorkspaceBridge } from './bridges'`
3. Add private field and configure method to the class:
```typescript
private _workspace: RatchetWorkspaceBridge | null = null;

configure(bridges: { workspace: RatchetWorkspaceBridge }): void {
  this._workspace = bridges.workspace;
}

private get workspace(): RatchetWorkspaceBridge {
  if (!this._workspace) {
    throw new Error('ReconciliationService: bridges not configured. Call configure() first.');
  }
  return this._workspace;
}
```
4. Replace `workspaceStateMachine.markFailed(...)` call (line ~90) with `this.workspace.markFailed(...)`

**domain-bridges.orchestrator.ts:** Add reconciliation bridge wiring. Import `reconciliationService` from ratchet domain barrel. Under the existing ratchet bridge section (after the `ciMonitorService.configure(...)` line), add:

```typescript
reconciliationService.configure({
  workspace: {
    markFailed: (id, reason) => workspaceStateMachine.markFailed(id, reason),
  },
});
```

Also add `reconciliationService` to the existing import from `@/backend/domains/ratchet`.

Run `pnpm check:fix` after to normalize import ordering.
  </action>
  <verify>
Run `pnpm typecheck` -- must pass.
Run `npx dependency-cruiser --config .dependency-cruiser.cjs src/backend --output-type err` -- must report 0 violations.
Verify no shim import: `grep "services/workspace-state-machine" src/backend/domains/ratchet/reconciliation.service.ts` should return empty.
  </verify>
  <done>
reconciliation.service.ts uses bridge injection for workspace state transitions. No cross-domain import from ratchet to workspace. dependency-cruiser validates clean.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm test -- --run src/backend/domains/session/session-domain.service.test.ts` passes
- `npx dependency-cruiser --config .dependency-cruiser.cjs src/backend --output-type err` reports 0 violations
- No shim imports remain in modified files
</verification>

<success_criteria>
app-context.ts imports all domain services from domain barrel files. reconciliation.service.ts uses bridge injection instead of cross-domain shim import. session-publisher.ts and session-domain.service.test.ts use intra-domain imports. All type checks pass. dependency-cruiser clean.
</success_criteria>

<output>
After completion, create `.planning/phases/09-appcontext-import-rewiring/09-01-SUMMARY.md`
</output>

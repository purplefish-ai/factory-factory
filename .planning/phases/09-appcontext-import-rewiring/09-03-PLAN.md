---
phase: 09-appcontext-import-rewiring
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - src/backend/services/index.ts
  - src/backend/services/chat-connection.service.ts
  - src/backend/services/chat-event-forwarder.service.ts
  - src/backend/services/chat-message-handlers.service.ts
  - src/backend/services/session.service.ts
  - src/backend/services/session-data.service.ts
  - src/backend/services/session-domain.service.ts
  - src/backend/services/session-file-logger.service.ts
  - src/backend/services/workspace-activity.service.ts
  - src/backend/services/workspace-creation.service.ts
  - src/backend/services/workspace-data.service.ts
  - src/backend/services/workspace-flow-state.service.ts
  - src/backend/services/workspace-init-policy.service.ts
  - src/backend/services/workspace-query.service.ts
  - src/backend/services/workspace-state-machine.service.ts
  - src/backend/services/worktree-lifecycle.service.ts
  - src/backend/services/kanban-state.service.ts
  - src/backend/services/github-cli.service.ts
  - src/backend/services/pr-review-fixer.service.ts
  - src/backend/services/pr-review-monitor.service.ts
  - src/backend/services/pr-snapshot.service.ts
  - src/backend/services/ratchet.service.ts
  - src/backend/services/ci-fixer.service.ts
  - src/backend/services/ci-monitor.service.ts
  - src/backend/services/fixer-session.service.ts
  - src/backend/services/reconciliation.service.ts
  - src/backend/services/terminal.service.ts
  - src/backend/services/run-script.service.ts
  - src/backend/services/run-script-state-machine.service.ts
  - src/backend/services/startup-script.service.ts
  - src/backend/services/session-store/
  - src/backend/claude/
autonomous: true

must_haves:
  truths:
    - "No domain-owned shim files remain in src/backend/services/"
    - "The entire src/backend/claude/ directory is deleted"
    - "The entire src/backend/services/session-store/ directory is deleted"
    - "services/index.ts only exports infrastructure services"
    - "pnpm typecheck passes after all deletions"
    - "dependency-cruiser reports 0 violations"
  artifacts:
    - path: "src/backend/services/index.ts"
      provides: "Infrastructure-only service barrel"
      contains: "configService"
  key_links:
    - from: "src/backend/services/index.ts"
      to: "src/backend/services/data-backup.service.ts"
      via: "barrel re-export"
      pattern: "from './data-backup.service'"
---

<objective>
Delete all deprecated shim files (38 in services/, 9 in session-store/, 12+ in claude/) and update services/index.ts to export only infrastructure services.

Purpose: Complete the SRP refactor by removing all backward-compatibility shim files. After this, domain code lives exclusively in src/backend/domains/.
Output: Clean services/ directory with only infrastructure services, no claude/ directory, no session-store/ shim directory.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-appcontext-import-rewiring/09-RESEARCH.md
@.planning/phases/09-appcontext-import-rewiring/09-01-SUMMARY.md
@.planning/phases/09-appcontext-import-rewiring/09-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete all shim files and session-store/ and claude/ directories</name>
  <files>
    src/backend/services/ (shim files only)
    src/backend/services/session-store/ (entire directory)
    src/backend/claude/ (entire directory)
  </files>
  <action>
Delete the following 30 individual shim files from `src/backend/services/`:
```
rm src/backend/services/chat-connection.service.ts
rm src/backend/services/chat-event-forwarder.service.ts
rm src/backend/services/chat-message-handlers.service.ts
rm src/backend/services/session.service.ts
rm src/backend/services/session-data.service.ts
rm src/backend/services/session-domain.service.ts
rm src/backend/services/session-file-logger.service.ts
rm src/backend/services/workspace-activity.service.ts
rm src/backend/services/workspace-creation.service.ts
rm src/backend/services/workspace-data.service.ts
rm src/backend/services/workspace-flow-state.service.ts
rm src/backend/services/workspace-init-policy.service.ts
rm src/backend/services/workspace-query.service.ts
rm src/backend/services/workspace-state-machine.service.ts
rm src/backend/services/worktree-lifecycle.service.ts
rm src/backend/services/kanban-state.service.ts
rm src/backend/services/github-cli.service.ts
rm src/backend/services/pr-review-fixer.service.ts
rm src/backend/services/pr-review-monitor.service.ts
rm src/backend/services/pr-snapshot.service.ts
rm src/backend/services/ratchet.service.ts
rm src/backend/services/ci-fixer.service.ts
rm src/backend/services/ci-monitor.service.ts
rm src/backend/services/fixer-session.service.ts
rm src/backend/services/reconciliation.service.ts
rm src/backend/services/terminal.service.ts
rm src/backend/services/run-script.service.ts
rm src/backend/services/run-script-state-machine.service.ts
rm src/backend/services/startup-script.service.ts
```

Delete the entire `src/backend/services/session-store/` directory:
```
rm -rf src/backend/services/session-store/
```

Delete the entire `src/backend/claude/` directory:
```
rm -rf src/backend/claude/
```

**IMPORTANT:** Do NOT delete these infrastructure files in `src/backend/services/`:
- `config.service.ts`, `logger.service.ts`, `scheduler.service.ts`
- `port.service.ts`, `port-allocation.service.ts`
- `server-instance.service.ts`, `rate-limiter.service.ts`
- `health.service.ts`, `cli-health.service.ts`
- `notification.service.ts`, `file-lock.service.ts`
- `data-backup.service.ts`, `factory-config.service.ts`
- `user-settings-query.service.ts`, `decision-log-query.service.ts`
- `project-management.service.ts`, `slash-command-cache.service.ts`
- `constants.ts`, `rate-limit-backoff.ts`, `git-ops.service.ts`
- `index.ts` (will be updated in Task 2)
- Any `.test.ts` files for infrastructure services (e.g., `port.service.test.ts`, `data-backup.service.test.ts`)

Run `pnpm typecheck` after deletion. If any errors appear, they indicate a missed consumer that still imports from a deleted shim. Fix any such errors by updating the import to use the domain barrel.
  </action>
  <verify>
Run `pnpm typecheck` -- must pass with no errors.
Verify claude directory gone: `ls src/backend/claude/ 2>&1` should say "No such file or directory".
Verify session-store directory gone: `ls src/backend/services/session-store/ 2>&1` should say "No such file or directory".
Verify no domain shim files remain: `ls src/backend/services/*session* src/backend/services/*workspace* src/backend/services/*github* src/backend/services/*ratchet* src/backend/services/*terminal* src/backend/services/*run-script* src/backend/services/*kanban* src/backend/services/*ci-* src/backend/services/*fixer* src/backend/services/*reconciliation* src/backend/services/*pr-* src/backend/services/*chat-* src/backend/services/*startup* 2>&1` should show only "No such file" errors for each.
  </verify>
  <done>
All 30 service shim files deleted. session-store/ shim directory deleted. claude/ shim directory deleted. Infrastructure services untouched. TypeScript compilation succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update services/index.ts and validate clean dependency graph</name>
  <files>
    src/backend/services/index.ts
  </files>
  <action>
Rewrite `src/backend/services/index.ts` to export ONLY infrastructure services. Remove ALL lines that re-export from domain shims (they no longer exist). The file should look like:

```typescript
/**
 * Infrastructure Services Index
 *
 * Central export point for infrastructure services only.
 * Domain services are exported from their respective domain barrels
 * in src/backend/domains/{name}/index.ts.
 */

// CLI health service
export { type CLIHealthStatus, cliHealthService } from './cli-health.service';
// Configuration service
export { configService, type SessionProfile } from './config.service';
// Data backup service
export {
  dataBackupService,
  type ExportData,
  exportDataSchema,
  type ImportCounter,
  type ImportResults,
} from './data-backup.service';
// Logger service
export { createLogger } from './logger.service';
// Notification service
export { notificationService } from './notification.service';
// Port service
export { findAvailablePort, isPortAvailable } from './port.service';
// Rate limiter service
export { rateLimiter } from './rate-limiter.service';
// Scheduler service
export { schedulerService } from './scheduler.service';
// Server instance service
export { serverInstanceService } from './server-instance.service';
```

Verify the `admin.trpc.ts` import `import { dataBackupService } from '../services'` still resolves correctly (it imports from the barrel, which still exports `dataBackupService`).

Then run the full validation suite:
1. `pnpm typecheck` -- must pass
2. `pnpm test -- --run` -- all tests must pass
3. `npx dependency-cruiser --config .dependency-cruiser.cjs src/backend --output-type err` -- must report 0 violations
4. `pnpm check:fix` -- lint and format clean

Also update knip configuration if needed -- check if the `src/backend/services/**/*.service.ts` glob in knip ignore can be tightened now that domain shims are gone. Read `knip.json` or `knip.config.ts` first to assess.
  </action>
  <verify>
Run `pnpm typecheck` -- must pass.
Run `pnpm test -- --run` -- all tests must pass.
Run `npx dependency-cruiser --config .dependency-cruiser.cjs src/backend --output-type err` -- 0 violations.
Run `pnpm check:fix` -- clean exit.
Verify `admin.trpc.ts` still compiles: its `import { dataBackupService } from '../services'` resolves through the updated barrel.
  </verify>
  <done>
services/index.ts exports only infrastructure services. Full test suite passes. dependency-cruiser reports 0 violations. Lint clean. No domain-owned files remain outside src/backend/domains/. Phase 9 complete.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm test -- --run` passes (full suite)
- `npx dependency-cruiser --config .dependency-cruiser.cjs src/backend --output-type err` -- 0 violations
- `pnpm check:fix` -- clean
- No domain shim files in services/
- No claude/ directory
- No services/session-store/ directory
- services/index.ts exports only infrastructure services
</verification>

<success_criteria>
All deprecated shim files deleted. services/index.ts is infrastructure-only. Full test suite passes. dependency-cruiser validates clean. No domain-owned files remain in src/backend/services/ or src/backend/claude/. Phase 9 requirements WIRE-01, WIRE-02, WIRE-03, DOM-03 are met.
</success_criteria>

<output>
After completion, create `.planning/phases/09-appcontext-import-rewiring/09-03-SUMMARY.md`
</output>

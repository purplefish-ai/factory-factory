---
phase: 09-appcontext-import-rewiring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/trpc/workspace.trpc.ts
  - src/backend/trpc/session.trpc.ts
  - src/backend/trpc/github.trpc.ts
  - src/backend/trpc/admin.trpc.ts
  - src/backend/trpc/workspace/init.trpc.ts
  - src/backend/trpc/workspace/workspace-helpers.ts
  - src/backend/trpc/workspace/git.trpc.ts
  - src/backend/trpc/workspace/ide.trpc.ts
  - src/backend/routers/websocket/chat.handler.ts
  - src/backend/routers/websocket/terminal.handler.ts
  - src/backend/routers/mcp/terminal.mcp.ts
  - src/backend/interceptors/pr-detection.interceptor.ts
  - src/backend/interceptors/conversation-rename.interceptor.ts
  - src/backend/agents/process-adapter.ts
  - src/backend/utils/conversation-analyzer.ts
  - src/backend/utils/conversation-analyzer.test.ts
  - src/backend/server.ts
autonomous: true

must_haves:
  truths:
    - "All tRPC routers import domain services from barrel files, not shim files"
    - "All WebSocket handlers import domain services from barrel files, not shim files"
    - "All interceptors import domain services from barrel files, not shim files"
    - "process-adapter imports from session domain barrel, not claude/ shim"
    - "conversation-analyzer imports HistoryMessage from session domain barrel"
    - "server.ts imports reconciliationService from ratchet domain barrel"
    - "init.trpc.ts calls worktreeLifecycleService instance methods directly"
  artifacts:
    - path: "src/backend/trpc/workspace.trpc.ts"
      provides: "Workspace router with domain barrel imports"
      contains: "@/backend/domains/workspace"
    - path: "src/backend/trpc/session.trpc.ts"
      provides: "Session router with domain barrel imports"
      contains: "@/backend/domains/session"
    - path: "src/backend/trpc/workspace/init.trpc.ts"
      provides: "Init router using worktreeLifecycleService methods directly"
      contains: "worktreeLifecycleService"
    - path: "src/backend/routers/websocket/chat.handler.ts"
      provides: "Chat handler with domain barrel type import"
      contains: "@/backend/domains/session"
    - path: "src/backend/server.ts"
      provides: "Server with ratchet domain barrel import"
      contains: "@/backend/domains/ratchet"
  key_links:
    - from: "src/backend/trpc/workspace.trpc.ts"
      to: "src/backend/domains/workspace/index.ts"
      via: "barrel import"
      pattern: "@/backend/domains/workspace"
    - from: "src/backend/trpc/workspace/init.trpc.ts"
      to: "src/backend/domains/workspace/index.ts"
      via: "barrel import for worktreeLifecycleService"
      pattern: "worktreeLifecycleService\\.(getInitMode|setInitMode)"
---

<objective>
Rewire all external consumer files (tRPC routers, WebSocket handlers, interceptors, agents, utils, server.ts) to import from domain barrels instead of shim files.

Purpose: After this plan, zero external consumers reference shim files, enabling safe shim deletion in Plan 03.
Output: All ~17 consumer files updated to import from domain barrels.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-appcontext-import-rewiring/09-RESEARCH.md
@src/backend/domains/session/index.ts
@src/backend/domains/workspace/index.ts
@src/backend/domains/ratchet/index.ts
@src/backend/domains/github/index.ts
@src/backend/domains/terminal/index.ts
@src/backend/domains/run-script/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire tRPC routers</name>
  <files>
    src/backend/trpc/workspace.trpc.ts
    src/backend/trpc/session.trpc.ts
    src/backend/trpc/github.trpc.ts
    src/backend/trpc/admin.trpc.ts
    src/backend/trpc/workspace/init.trpc.ts
    src/backend/trpc/workspace/workspace-helpers.ts
    src/backend/trpc/workspace/git.trpc.ts
    src/backend/trpc/workspace/ide.trpc.ts
  </files>
  <action>
For each file, replace shim imports with domain barrel imports. DO NOT change infrastructure imports (logger, config, decision-log-query, user-settings-query, project-management, factory-config). Only change imports that point to deprecated shim files.

**workspace.trpc.ts** (6 shim imports to rewire):
- `ratchetService` from `'../services/ratchet.service'` -> from `'@/backend/domains/ratchet'`
- `sessionService` from `'../services/session.service'` -> from `'@/backend/domains/session'`
- `WorkspaceCreationService` from `'../services/workspace-creation.service'` -> from `'@/backend/domains/workspace'`
- `workspaceDataService` from `'../services/workspace-data.service'` -> from `'@/backend/domains/workspace'`
- `deriveWorkspaceFlowStateFromWorkspace` from `'../services/workspace-flow-state.service'` -> from `'@/backend/domains/workspace'`
- `workspaceQueryService` from `'../services/workspace-query.service'` -> from `'@/backend/domains/workspace'`

Merge the 4 workspace imports into a single import statement.

**session.trpc.ts** (3 shim imports to rewire):
- `SessionManager` from `'../claude/session'` -> from `'@/backend/domains/session'`
- `sessionDataService` from `'../services/session-data.service'` -> from `'@/backend/domains/session'`
- `workspaceDataService` from `'../services/workspace-data.service'` -> from `'@/backend/domains/workspace'`

**github.trpc.ts** (2 shim imports to rewire, 1 infra stays):
- `githubCLIService` from `'../services/github-cli.service'` -> from `'@/backend/domains/github'`
- `workspaceDataService` from `'../services/workspace-data.service'` -> from `'@/backend/domains/workspace'`
- `projectManagementService` from `'../services/project-management.service'` -- KEEP AS IS (infrastructure)

**admin.trpc.ts** (3 imports to rewire, 2 infra stay):
- `dataBackupService` from `'../services'` (barrel) -- KEEP AS IS (infrastructure import from services barrel)
- `sessionDataService` from `'../services/session-data.service'` -> from `'@/backend/domains/session'`
- `workspaceDataService` from `'../services/workspace-data.service'` -> from `'@/backend/domains/workspace'`
- `decisionLogQueryService` from `'../services/decision-log-query.service'` -- KEEP AS IS (infrastructure)
- `getLogFilePath` from `'../services/logger.service'` -- KEEP AS IS (infrastructure)

**init.trpc.ts** (6 shim imports to rewire, special worktree-lifecycle handling):
- `createLogger` from `'../../services/logger.service'` -- KEEP AS IS (infrastructure)
- `startupScriptService` from `'../../services/startup-script.service'` -> from `'@/backend/domains/run-script'`
- `workspaceDataService` from `'../../services/workspace-data.service'` -> from `'@/backend/domains/workspace'`
- `getWorkspaceInitPolicy` from `'../../services/workspace-init-policy.service'` -> from `'@/backend/domains/workspace'`
- `workspaceStateMachine` from `'../../services/workspace-state-machine.service'` -> from `'@/backend/domains/workspace'`
- `getWorkspaceInitMode, setWorkspaceInitMode` from `'../../services/worktree-lifecycle.service'` -> Replace with: `import { worktreeLifecycleService } from '@/backend/domains/workspace'`

For the worktree-lifecycle special case: The shim exports free functions `getWorkspaceInitMode(workspaceId, worktreeBasePath)` and `setWorkspaceInitMode(workspaceId, mode, worktreeBasePath)` that wrap instance methods. Update ALL call sites:
- `getWorkspaceInitMode(id, path)` -> `worktreeLifecycleService.getInitMode(id, path)`
- `setWorkspaceInitMode(id, mode, path)` -> `worktreeLifecycleService.setInitMode(id, mode, path)`

Read the full `init.trpc.ts` to find all call sites and update each one.

**workspace-helpers.ts** (1 shim import to rewire):
- `workspaceDataService` from `'../../services/workspace-data.service'` -> from `'@/backend/domains/workspace'`

**git.trpc.ts** (1 shim import to rewire):
- `workspaceDataService` from `'../../services/workspace-data.service'` -> from `'@/backend/domains/workspace'`

**ide.trpc.ts** (1 shim import to rewire, 1 infra stays):
- `workspaceDataService` from `'../../services/workspace-data.service'` -> from `'@/backend/domains/workspace'`
- `userSettingsQueryService` from `'../../services/user-settings-query.service'` -- KEEP AS IS (infrastructure)

Run `pnpm check:fix` after all changes.
  </action>
  <verify>
Run `pnpm typecheck` -- must pass.
Verify no shim imports remain in tRPC files: `grep -r "services/ratchet\.service\|services/session\.service\|services/session-data\|services/workspace-creation\|services/workspace-data\|services/workspace-flow\|services/workspace-query\|services/workspace-state-machine\|services/workspace-init-policy\|services/worktree-lifecycle\|services/github-cli\|services/startup-script\|services/kanban\|services/terminal\|services/chat-connection\|services/pr-snapshot\|services/pr-review\|services/ci-\|services/fixer\|services/reconciliation\|claude/session\|claude/index" src/backend/trpc/` should return empty.
  </verify>
  <done>
All 8 tRPC router files import domain services from barrel files. init.trpc.ts uses worktreeLifecycleService instance methods directly. Infrastructure imports (logger, config, etc.) unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewire WebSocket handlers, interceptors, agents, utils, and server.ts</name>
  <files>
    src/backend/routers/websocket/chat.handler.ts
    src/backend/routers/websocket/terminal.handler.ts
    src/backend/routers/mcp/terminal.mcp.ts
    src/backend/interceptors/pr-detection.interceptor.ts
    src/backend/interceptors/conversation-rename.interceptor.ts
    src/backend/agents/process-adapter.ts
    src/backend/utils/conversation-analyzer.ts
    src/backend/utils/conversation-analyzer.test.ts
    src/backend/server.ts
  </files>
  <action>
**chat.handler.ts** (1 shim import + 1 type re-export to rewire):
- Line ~20: `import type { ClaudeClient } from '../../claude/index'` -> `import type { ClaudeClient } from '@/backend/domains/session'`
- Line ~313: `export type { ConnectionInfo } from '../../services/chat-connection.service'` -> `export type { ConnectionInfo } from '@/backend/domains/session'`
- The other line `export type { ChatMessageInput } from '../../schemas/websocket'` stays -- it's from schemas, not a shim.

**terminal.handler.ts** (2 shim imports to rewire):
- `sessionDataService` from `'../../services/session-data.service'` -> from `'@/backend/domains/session'`
- `workspaceDataService` from `'../../services/workspace-data.service'` -> from `'@/backend/domains/workspace'`

**terminal.mcp.ts** (2 shim imports to rewire):
- `sessionDataService` from `'../../services/session-data.service'` -> from `'@/backend/domains/session'`
- `type TerminalInstance` and `terminalService` from `'../../services/terminal.service'` -> from `'@/backend/domains/terminal'`

Merge into: `import { type TerminalInstance, terminalService } from '@/backend/domains/terminal'` and `import { sessionDataService } from '@/backend/domains/session'`

**pr-detection.interceptor.ts** (1 shim import to rewire, 1 infra stays):
- `prSnapshotService` from `'../services/pr-snapshot.service'` -> from `'@/backend/domains/github'`
- `createLogger` from `'../services/logger.service'` -- KEEP AS IS (infrastructure)

**conversation-rename.interceptor.ts** (1 shim import to rewire, 2 infra stay):
- `SessionManager` from `'../claude/session'` -> from `'@/backend/domains/session'`
- `configService` from `'../services/config.service'` -- KEEP AS IS (infrastructure)
- `createLogger` from `'../services/logger.service'` -- KEEP AS IS (infrastructure)

**process-adapter.ts** (1 shim import to rewire, 1 infra stays):
- `ClaudeClient, type ClaudeClientOptions, type ClaudeJson, type ExitResult, type ResultMessage, type StreamEventMessage, type ToolUseContent` from `'../claude/index'` -> from `'@/backend/domains/session'`
- `createLogger` from `'../services/logger.service'` -- KEEP AS IS (infrastructure)

**conversation-analyzer.ts** (1 shim import to rewire):
- `type { HistoryMessage }` from `'../claude/session'` -> from `'@/backend/domains/session'`

**conversation-analyzer.test.ts** (1 shim import to rewire):
- `type { HistoryMessage }` from `'../claude/session'` -> from `'@/backend/domains/session'`

**server.ts** (1 shim import to rewire):
- `reconciliationService` from `'./services/reconciliation.service'` -> from `'./domains/ratchet'`

Run `pnpm check:fix` after all changes.
  </action>
  <verify>
Run `pnpm typecheck` -- must pass.
Run `pnpm test -- --run` -- all tests must pass (especially conversation-analyzer.test.ts).
Verify no shim imports remain: `grep -rn "services/session-data\|services/workspace-data\|services/terminal\|services/chat-connection\|services/pr-snapshot\|services/reconciliation\|claude/session\|claude/index" src/backend/routers/ src/backend/interceptors/ src/backend/agents/ src/backend/utils/ src/backend/server.ts` should return empty.
  </verify>
  <done>
All WebSocket handlers, interceptors, agents, utils, and server.ts import from domain barrels. No shim imports remain in any consumer file. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm test -- --run` passes
- No shim imports remain in any consumer file outside of domains/ and services/ directories
- `grep -rn "from.*services/session\.\|from.*services/session-data\|from.*services/workspace-\|from.*services/ratchet\|from.*services/github-cli\|from.*services/pr-\|from.*services/ci-\|from.*services/fixer\|from.*services/terminal\|from.*services/chat-\|from.*services/kanban\|from.*services/startup\|from.*services/run-script\|from.*services/reconciliation\|from.*services/worktree\|from.*claude/session\|from.*claude/index" src/backend/trpc/ src/backend/routers/ src/backend/interceptors/ src/backend/agents/ src/backend/utils/ src/backend/server.ts src/backend/app-context.ts` returns empty
</verification>

<success_criteria>
All tRPC routers, WebSocket handlers, interceptors, agents, utils, and server.ts import domain services from barrel files. init.trpc.ts calls worktreeLifecycleService instance methods directly. Infrastructure imports unchanged. All type checks and tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/09-appcontext-import-rewiring/09-02-SUMMARY.md`
</output>

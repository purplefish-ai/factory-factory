---
phase: 07-run-script-domain-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/domains/run-script/run-script-state-machine.service.ts
  - src/backend/domains/run-script/run-script-state-machine.service.test.ts
  - src/backend/domains/run-script/run-script.service.ts
  - src/backend/services/run-script-state-machine.service.ts
  - src/backend/services/run-script-state-machine.service.test.ts
  - src/backend/services/run-script.service.ts
  - src/backend/app-context.ts
autonomous: true

must_haves:
  truths:
    - "run-script-state-machine.service.ts lives at src/backend/domains/run-script/ with all exports preserved"
    - "run-script.service.ts lives at src/backend/domains/run-script/ with all exports preserved"
    - "RunScriptService uses instance fields instead of static Maps (RS-02)"
    - "Process signal handlers still register at module load time"
    - "Old service paths still work via re-export shims"
    - "app-context.ts uses instance type instead of typeof RunScriptService"
    - "All existing state machine tests pass at new location"
  artifacts:
    - path: "src/backend/domains/run-script/run-script-state-machine.service.ts"
      provides: "Run script state machine with CAS transitions"
      exports: ["RunScriptStateMachineError", "runScriptStateMachine", "TransitionOptions"]
    - path: "src/backend/domains/run-script/run-script-state-machine.service.test.ts"
      provides: "Co-located tests for state machine (moved from services/)"
    - path: "src/backend/domains/run-script/run-script.service.ts"
      provides: "Instance-based run script execution service (RS-02)"
      exports: ["RunScriptService", "runScriptService"]
    - path: "src/backend/services/run-script-state-machine.service.ts"
      provides: "Re-export shim for backward compatibility"
    - path: "src/backend/services/run-script.service.ts"
      provides: "Re-export shim for backward compatibility"
    - path: "src/backend/app-context.ts"
      provides: "Updated type: runScriptService is RunScriptService instance (not typeof)"
  key_links:
    - from: "src/backend/domains/run-script/run-script.service.ts"
      to: "src/backend/domains/run-script/run-script-state-machine.service.ts"
      via: "intra-domain relative import"
      pattern: "from './run-script-state-machine.service'"
    - from: "src/backend/services/run-script.service.ts"
      to: "src/backend/domains/run-script/run-script.service.ts"
      via: "re-export shim"
      pattern: "from '@/backend/domains/run-script/run-script.service'"
    - from: "src/backend/services/run-script-state-machine.service.ts"
      to: "src/backend/domains/run-script/run-script-state-machine.service.ts"
      via: "re-export shim"
      pattern: "from '@/backend/domains/run-script/run-script-state-machine.service'"
    - from: "src/backend/app-context.ts"
      to: "src/backend/services/run-script.service.ts"
      via: "import (through shim)"
      pattern: "runScriptService: RunScriptService"
---

<objective>
Move run-script-state-machine.service.ts (281 LOC + 599 LOC tests) and run-script.service.ts (626 LOC) into src/backend/domains/run-script/. Convert RunScriptService from static methods with static Maps to instance-based (RS-02). Update app-context.ts to use instance type. Leave re-export shims at old paths.

Purpose: Consolidate the two core run-script files and perform the RS-02 instance conversion. State machine is moved first because run-script.service.ts depends on it (intra-domain relative import after move).
Output: 3 new domain files (2 source + 1 test) + 2 shims at old paths + app-context update.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move run-script-state-machine.service.ts and test to domain</name>
  <files>
    src/backend/domains/run-script/run-script-state-machine.service.ts
    src/backend/domains/run-script/run-script-state-machine.service.test.ts
    src/backend/services/run-script-state-machine.service.ts
    src/backend/services/run-script-state-machine.service.test.ts
  </files>
  <action>
1. Copy `src/backend/services/run-script-state-machine.service.ts` to `src/backend/domains/run-script/run-script-state-machine.service.ts`.
2. In the new domain file, update import paths:
   - `../resource_accessors/workspace.accessor` -> `@/backend/resource_accessors/workspace.accessor` (cross-layer, absolute)
   - `./logger.service` -> `@/backend/services/logger.service` (cross-domain, absolute)
   - `@prisma-gen/client` stays as-is (already absolute)
3. Copy `src/backend/services/run-script-state-machine.service.test.ts` to `src/backend/domains/run-script/run-script-state-machine.service.test.ts`.
4. In the new test file, update mock and import paths:
   - `vi.mock('../db', ...)` -> `vi.mock('@/backend/db', ...)` (absolute path preferred for clarity from new location)
   - `vi.mock('./logger.service', ...)` -> `vi.mock('@/backend/services/logger.service', ...)` (absolute path matching source import)
   - The import of `RunScriptStateMachineError, runScriptStateMachine` from `./run-script-state-machine.service` stays relative (same dir).
5. Replace old `src/backend/services/run-script-state-machine.service.ts` with a re-export shim:
   ```typescript
   /**
    * @deprecated Import from '@/backend/domains/run-script' instead.
    * This re-export shim will be removed in Phase 9 (Import Rewiring).
    */
   export {
     RunScriptStateMachineError,
     runScriptStateMachine,
     type TransitionOptions,
   } from '@/backend/domains/run-script/run-script-state-machine.service';
   ```
   Use direct module path (not barrel) per established convention.
6. Delete old `src/backend/services/run-script-state-machine.service.test.ts` (vitest will find the new one).
  </action>
  <verify>
Run `pnpm typecheck` to confirm no type errors. Run `pnpm test -- --run src/backend/domains/run-script/run-script-state-machine.service.test.ts` to confirm all 24 tests pass at new location.
  </verify>
  <done>run-script-state-machine.service.ts and test live in domains/run-script/, shim at old path re-exports all 3 exported names (RunScriptStateMachineError, runScriptStateMachine, TransitionOptions), typecheck passes, all 24 domain tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Move run-script.service.ts to domain with RS-02 instance conversion</name>
  <files>
    src/backend/domains/run-script/run-script.service.ts
    src/backend/services/run-script.service.ts
    src/backend/app-context.ts
  </files>
  <action>
1. Copy `src/backend/services/run-script.service.ts` to `src/backend/domains/run-script/run-script.service.ts`.
2. In the new domain file, update import paths:
   - `../resource_accessors/workspace.accessor` -> `@/backend/resource_accessors/workspace.accessor` (cross-layer, absolute)
   - `./factory-config.service` -> `@/backend/services/factory-config.service` (cross-domain, absolute)
   - `./logger.service` -> `@/backend/services/logger.service` (cross-domain, absolute)
   - `./port-allocation.service` -> `@/backend/services/port-allocation.service` (cross-domain, absolute)
   - `./run-script-state-machine.service` -> `./run-script-state-machine.service` (intra-domain relative, stays same)
   - `node:child_process` and `tree-kill` stay as-is (external deps)
3. **RS-02 Instance Conversion** -- Convert RunScriptService from static to instance-based:
   a. Change the 3 static Maps to instance fields:
      - `private static runningProcesses = new Map<string, ChildProcess>()` -> `private readonly runningProcesses = new Map<string, ChildProcess>()`
      - `private static outputBuffers = new Map<string, string>()` -> `private readonly outputBuffers = new Map<string, string>()`
      - `private static outputListeners = new Map<string, Set<(data: string) => void>>()` -> `private readonly outputListeners = new Map<string, Set<(data: string) => void>>()`
   b. Convert all methods from `static` to instance methods (remove `static` keyword from every method).
   c. Replace all `RunScriptService.runningProcesses` -> `this.runningProcesses`, `RunScriptService.outputBuffers` -> `this.outputBuffers`, `RunScriptService.outputListeners` -> `this.outputListeners` throughout the class body.
   d. Move module-level `let isShuttingDown = false;` into the class as `private isShuttingDown = false;`.
   e. Move the 3 process signal handlers (`SIGINT`, `SIGTERM`, `exit`) into a `registerShutdownHandlers(): void` method on the class. Inside, reference `this.cleanup()`, `this.cleanupSync()`, and `this.isShuttingDown` instead of `RunScriptService.cleanup()`, `RunScriptService.cleanupSync()`, and the module-level variable.
   f. After the class definition, create the singleton and register handlers:
      ```typescript
      export const runScriptService = new RunScriptService();
      runScriptService.registerShutdownHandlers();
      ```
4. Replace old `src/backend/services/run-script.service.ts` with a re-export shim:
   ```typescript
   /**
    * @deprecated Import from '@/backend/domains/run-script' instead.
    * This re-export shim will be removed in Phase 9 (Import Rewiring).
    */
   export { RunScriptService, runScriptService } from '@/backend/domains/run-script/run-script.service';
   ```
   Use direct module path (not barrel) per established convention.
5. Update `src/backend/app-context.ts`:
   a. Change the import to import both the class and the singleton:
      `import { RunScriptService } from './services/run-script.service';`
      becomes
      `import { type RunScriptService, runScriptService } from './services/run-script.service';`
   b. Change the AppServices type from `runScriptService: typeof RunScriptService` to `runScriptService: RunScriptService` (instance type, not class constructor type).
   c. In `createServices()`, change `runScriptService: RunScriptService` (passing the class) to `runScriptService: runScriptService` (passing the singleton instance). Note: `runScriptService` the variable (lowercase r) is the singleton, `RunScriptService` the type import is the class type.

**Important notes:**
- The `cleanup()` method internally calls `this.stopRunScript()` (was `RunScriptService.stopRunScript()`). Make sure self-references use `this.` not the class name.
- The `cleanupSync()` method iterates `this.runningProcesses` (was `RunScriptService.runningProcesses`). Same treatment.
- Consumers via app-context (`run-script.trpc.ts`, `dev-logs.handler.ts`) already call `ctx.appContext.services.runScriptService.methodName()` -- since we're changing from static class to instance, the call sites stay the same syntactically.
- `worktree-lifecycle.service.ts` in the workspace domain calls `RunScriptService.stopRunScript(workspace.id)` as a static method. After the shim re-exports the instance `runScriptService`, this call will break. Update the workspace domain consumer: in `src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts`, change the import from `import { RunScriptService } from '@/backend/services/run-script.service';` to `import { runScriptService } from '@/backend/services/run-script.service';` and change the call from `RunScriptService.stopRunScript(workspace.id)` to `runScriptService.stopRunScript(workspace.id)`.
  </action>
  <verify>
Run `pnpm typecheck` to confirm no type errors (especially in app-context.ts, run-script.trpc.ts, dev-logs.handler.ts, worktree-lifecycle.service.ts). Run `pnpm test -- --run` to confirm full test suite passes.
  </verify>
  <done>run-script.service.ts lives in domains/run-script/ with instance-based state (3 Maps + isShuttingDown as instance fields, all methods non-static), singleton exported as runScriptService, shutdown handlers registered at module load, shim at old path, app-context updated to use instance type and pass singleton, worktree-lifecycle updated to call instance method, typecheck passes, test suite passes.</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test -- --run src/backend/domains/run-script/` runs state machine tests and all pass
- `pnpm test -- --run` full suite passes (no regressions from shims or instance conversion)
- Old import paths still resolve (shims work)
- `RunScriptService` class has zero static members
- Module-level `isShuttingDown` variable no longer exists (moved to instance field)
- Module-level `process.on(...)` handlers no longer exist (moved to `registerShutdownHandlers()`)
</verification>

<success_criteria>
- run-script-state-machine.service.ts (281 LOC) and run-script.service.ts (626 LOC) live in src/backend/domains/run-script/
- RS-02 complete: RunScriptService has 0 static Maps, 0 module-level mutable state
- Co-located state machine tests pass at new location
- Intra-domain import: run-script -> state-machine uses relative ./run-script-state-machine.service
- Cross-domain imports use absolute @/backend/ paths
- Re-export shims at old services/ paths maintain backward compatibility
- app-context.ts type is RunScriptService (instance), not typeof RunScriptService
- worktree-lifecycle.service.ts calls runScriptService.stopRunScript() (instance, not static)
- Process signal handlers still work (registerShutdownHandlers called at module load)
</success_criteria>

<output>
After completion, create `.planning/phases/07-run-script-domain-consolidation/07-01-SUMMARY.md`
</output>

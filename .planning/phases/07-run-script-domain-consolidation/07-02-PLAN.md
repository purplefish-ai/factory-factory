---
phase: 07-run-script-domain-consolidation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/backend/domains/run-script/startup-script.service.ts
  - src/backend/services/startup-script.service.ts
  - src/backend/domains/run-script/index.ts
  - src/backend/domains/run-script/run-script-domain-exports.test.ts
autonomous: true

must_haves:
  truths:
    - "startup-script.service.ts lives at src/backend/domains/run-script/ with all exports preserved"
    - "Old startup-script service path still works via re-export shim"
    - "Domain barrel at index.ts exports full public API from all 3 services"
    - "Barrel smoke test confirms all runtime exports are defined and not undefined"
    - "All run script operations flow through src/backend/domains/run-script/"
  artifacts:
    - path: "src/backend/domains/run-script/startup-script.service.ts"
      provides: "Startup script execution service (already instance-based)"
      exports: ["startupScriptService", "StartupScriptResult"]
    - path: "src/backend/services/startup-script.service.ts"
      provides: "Re-export shim for backward compatibility"
    - path: "src/backend/domains/run-script/index.ts"
      provides: "Domain barrel with full public API"
      exports: ["RunScriptStateMachineError", "runScriptStateMachine", "TransitionOptions", "RunScriptService", "runScriptService", "startupScriptService", "StartupScriptResult"]
    - path: "src/backend/domains/run-script/run-script-domain-exports.test.ts"
      provides: "Barrel smoke test verifying all exports"
  key_links:
    - from: "src/backend/domains/run-script/index.ts"
      to: "src/backend/domains/run-script/run-script-state-machine.service.ts"
      via: "barrel re-export"
      pattern: "from './run-script-state-machine.service'"
    - from: "src/backend/domains/run-script/index.ts"
      to: "src/backend/domains/run-script/run-script.service.ts"
      via: "barrel re-export"
      pattern: "from './run-script.service'"
    - from: "src/backend/domains/run-script/index.ts"
      to: "src/backend/domains/run-script/startup-script.service.ts"
      via: "barrel re-export"
      pattern: "from './startup-script.service'"
    - from: "src/backend/services/startup-script.service.ts"
      to: "src/backend/domains/run-script/startup-script.service.ts"
      via: "re-export shim"
      pattern: "from '@/backend/domains/run-script/startup-script.service'"
---

<objective>
Move startup-script.service.ts (369 LOC) into src/backend/domains/run-script/. Populate the domain barrel with the full public API from all 3 services. Create a smoke test verifying barrel integrity.

Purpose: Complete the run-script domain consolidation (RS-01) by moving the last service and establishing the single import point. The barrel and smoke test finalize the domain as a self-contained module.
Output: 1 new domain file + 1 shim + populated barrel + smoke test.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-run-script-domain-consolidation/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move startup-script.service.ts to domain</name>
  <files>
    src/backend/domains/run-script/startup-script.service.ts
    src/backend/services/startup-script.service.ts
  </files>
  <action>
1. Copy `src/backend/services/startup-script.service.ts` to `src/backend/domains/run-script/startup-script.service.ts`.
2. In the new domain file, update import paths:
   - `../resource_accessors/workspace.accessor` -> `@/backend/resource_accessors/workspace.accessor` (cross-layer, absolute)
   - `./constants` -> `@/backend/services/constants` (cross-domain, absolute)
   - `./logger.service` -> `@/backend/services/logger.service` (cross-domain, absolute)
   - `./workspace-state-machine.service` -> `@/backend/services/workspace-state-machine.service` (cross-domain via shim, absolute -- NOT from @/backend/domains/workspace/ to avoid cross-domain import violation)
   - `node:child_process`, `node:fs/promises`, `node:path` stay as-is (built-in)
   - `@prisma-gen/client` stays as-is (already absolute)
3. Replace old `src/backend/services/startup-script.service.ts` with a re-export shim:
   ```typescript
   /**
    * @deprecated Import from '@/backend/domains/run-script' instead.
    * This re-export shim will be removed in Phase 9 (Import Rewiring).
    */
   export {
     startupScriptService,
     type StartupScriptResult,
   } from '@/backend/domains/run-script/startup-script.service';
   ```
   Use direct module path (not barrel) per established convention.
  </action>
  <verify>
Run `pnpm typecheck` to confirm no type errors. Verify consumers still compile: `init.trpc.ts` (imports startupScriptService via old path), `worktree-lifecycle.service.ts` (imports startupScriptService via old path).
  </verify>
  <done>startup-script.service.ts lives in domains/run-script/, cross-domain imports use absolute @/backend/ paths (especially workspace-state-machine via shim), shim at old path re-exports startupScriptService and StartupScriptResult, typecheck passes.</done>
</task>

<task type="auto">
  <name>Task 2: Populate run-script domain barrel and create smoke test</name>
  <files>
    src/backend/domains/run-script/index.ts
    src/backend/domains/run-script/run-script-domain-exports.test.ts
  </files>
  <action>
1. Replace the placeholder `src/backend/domains/run-script/index.ts` with the full domain barrel:
   ```typescript
   // Domain: run-script
   // Public API for the run script domain module.
   // Consumers should import from '@/backend/domains/run-script' only.

   // Run script execution
   export { RunScriptService, runScriptService } from './run-script.service';

   // State machine
   export {
     RunScriptStateMachineError,
     runScriptStateMachine,
     type TransitionOptions,
   } from './run-script-state-machine.service';

   // Startup script execution
   export {
     startupScriptService,
     type StartupScriptResult,
   } from './startup-script.service';
   ```
   Note: Biome may auto-sort these exports alphabetically by import path. That is expected and fine. Use selective named exports (not `export *`) per established convention.

2. Create `src/backend/domains/run-script/run-script-domain-exports.test.ts`:
   ```typescript
   import { describe, expect, it } from 'vitest';
   import {
     RunScriptService,
     RunScriptStateMachineError,
     runScriptService,
     runScriptStateMachine,
     startupScriptService,
   } from './index';

   describe('Run script domain barrel exports', () => {
     it('exports runScriptService singleton', () => {
       expect(runScriptService).toBeDefined();
       expect(runScriptService).toBeInstanceOf(RunScriptService);
     });

     it('exports RunScriptService class', () => {
       expect(RunScriptService).toBeDefined();
       expect(typeof RunScriptService).toBe('function');
     });

     it('exports runScriptStateMachine singleton', () => {
       expect(runScriptStateMachine).toBeDefined();
     });

     it('exports RunScriptStateMachineError class', () => {
       expect(RunScriptStateMachineError).toBeDefined();
       expect(typeof RunScriptStateMachineError).toBe('function');
     });

     it('exports startupScriptService singleton', () => {
       expect(startupScriptService).toBeDefined();
     });
   });
   ```
   Use static imports (not dynamic `await import()`) per Biome convention from Phase 2.
  </action>
  <verify>
Run `pnpm typecheck` to confirm barrel types resolve. Run `pnpm test -- --run src/backend/domains/run-script/run-script-domain-exports.test.ts` to confirm smoke test passes. Run `pnpm test -- --run src/backend/domains/run-script/` to confirm all domain tests pass together. Run `pnpm test -- --run` full suite to confirm no regressions.
  </verify>
  <done>Domain barrel exports 5 runtime values + 2 types from 3 modules. Smoke test confirms all runtime exports are defined and have correct types. Full test suite passes. RS-01 (all run script operations in one module) is complete.</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test -- --run src/backend/domains/run-script/` runs all domain tests (state machine + smoke test) and all pass
- `pnpm test -- --run` full suite passes (no regressions)
- Domain barrel at index.ts exports: RunScriptService, runScriptService, RunScriptStateMachineError, runScriptStateMachine, TransitionOptions, startupScriptService, StartupScriptResult
- Old import paths for all 3 services still resolve via shims
</verification>

<success_criteria>
- startup-script.service.ts (369 LOC) lives in src/backend/domains/run-script/
- Cross-domain import to workspace-state-machine uses @/backend/services/ shim path (no cross-domain violation)
- Re-export shim at old services/ path maintains backward compatibility
- Domain barrel exports the full public API (5 runtime values + 2 types)
- Smoke test verifies all runtime exports are defined
- All 3 source files consolidated into src/backend/domains/run-script/ (RS-01 complete)
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/07-run-script-domain-consolidation/07-02-SUMMARY.md`
</output>

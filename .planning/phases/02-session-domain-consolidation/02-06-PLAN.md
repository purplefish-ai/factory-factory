---
phase: 02-session-domain-consolidation
plan: 06
type: execute
wave: 4
depends_on: ["02-04", "02-05"]
files_modified:
  - src/backend/domains/session/index.ts
  - src/backend/domains/session/session-domain.test.ts
  - knip.json
autonomous: true

must_haves:
  truths:
    - "Session domain barrel exports all public API types and service singletons"
    - "Consumers can import everything they need from '@/backend/domains/session'"
    - "Domain-level integration test verifies public API exports are real (not undefined)"
    - "pnpm typecheck passes"
    - "pnpm test passes (full suite including new domain test)"
    - "All DOM-04 violations eliminated (no module-level Maps or counters)"
  artifacts:
    - path: "src/backend/domains/session/index.ts"
      provides: "Complete session domain barrel file"
      exports: ["sessionDomainService", "sessionService", "sessionDataService", "chatConnectionService", "chatEventForwarderService", "chatMessageHandlerService", "sessionFileLogger", "SessionManager", "ClaudeClient", "ProcessRegistry"]
    - path: "src/backend/domains/session/session-domain.test.ts"
      provides: "Domain public API smoke test"
      contains: "describe.*session domain"
  key_links:
    - from: "src/backend/domains/session/index.ts"
      to: "src/backend/domains/session/lifecycle/session.service.ts"
      via: "barrel re-export"
      pattern: "export.*sessionService.*from.*lifecycle"
    - from: "src/backend/domains/session/index.ts"
      to: "src/backend/domains/session/claude/index.ts"
      via: "barrel re-export"
      pattern: "export.*ClaudeClient.*from.*claude"
    - from: "src/backend/domains/session/index.ts"
      to: "src/backend/domains/session/chat/chat-connection.service.ts"
      via: "barrel re-export"
      pattern: "export.*chatConnectionService.*from.*chat"
---

<objective>
Update the session domain barrel file to export all public APIs and create a domain-level smoke test verifying exports are real (not undefined from circular dependency issues).

Purpose: Completes the session domain consolidation by providing a single import point for all consumers and verifying the entire domain works as an integrated unit. This satisfies SESS-05 (co-located unit tests covering public API).

Output: Complete barrel file at `src/backend/domains/session/index.ts`, domain smoke test, updated knip config if needed.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-session-domain-consolidation/02-RESEARCH.md
@.planning/phases/02-session-domain-consolidation/02-04-SUMMARY.md
@.planning/phases/02-session-domain-consolidation/02-05-SUMMARY.md
@src/backend/domains/session/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update session domain barrel file with complete public API</name>
  <files>
    src/backend/domains/session/index.ts
  </files>
  <action>
    Replace the current placeholder barrel at `src/backend/domains/session/index.ts` with the complete public API. Follow the research-provided barrel template (Code Examples section) as a guide, but adjust based on what actually got moved.

    The barrel should export:

    ```typescript
    // Domain: session
    // Public API for the session domain module.
    // Consumers should import from '@/backend/domains/session' only.

    // Core domain service (in-memory state management)
    export { sessionDomainService } from './session-domain.service';

    // Session lifecycle (start/stop/create)
    export { sessionService } from './lifecycle/session.service';
    export type { ClientCreatedCallback } from './lifecycle/session.service';
    export { sessionProcessManager } from './lifecycle/session.process-manager';
    export type { SessionProcessManager } from './lifecycle/session.process-manager';
    export { sessionRepository } from './lifecycle/session.repository';
    export { sessionPromptBuilder } from './lifecycle/session.prompt-builder';

    // Session data access
    export { sessionDataService } from './data/session-data.service';

    // Chat services
    export { chatConnectionService } from './chat/chat-connection.service';
    export type { ConnectionInfo } from './chat/chat-connection.service';
    export { chatEventForwarderService } from './chat/chat-event-forwarder.service';
    export { chatMessageHandlerService } from './chat/chat-message-handlers.service';
    export type { ChatMessage } from './chat/chat-message-handlers.service';

    // Session file logging
    export { sessionFileLogger, SessionFileLogger } from './logging/session-file-logger.service';

    // Claude client (primary type for consumers)
    export type { ClaudeClient, ClaudeClientOptions } from './claude';
    export { ClaudeProcess } from './claude';
    export type { ExitResult } from './claude';
    export { ProcessRegistry, processRegistry } from './claude';
    export type { RegisteredProcess, ResourceUsage, ProcessStatus } from './claude';

    // Session history
    export { SessionManager } from './claude';
    export type { HistoryMessage, SessionInfo } from './claude';

    // Protocol types (commonly used by consumers)
    export type {
      AssistantMessage,
      ClaudeJson,
      ControlRequest,
      InitializeResponseData,
      PermissionMode,
      ResultMessage,
      StreamEventMessage,
      SystemMessage,
      ToolUseContent,
      UserMessage,
    } from './claude';
    ```

    **Important notes:**
    - Only export what external consumers actually need. Do NOT `export *` from subdirectories (Pitfall 1: circular deps).
    - Export instances (singletons) by name, not just types.
    - Use `export type` for types that are only used as type annotations.
    - Verify each export resolves by checking the source files exist at the referenced paths.

    **Verify the barrel doesn't create circular dependencies:**
    - The barrel imports from subdirectories (claude/, lifecycle/, chat/, data/, logging/, store/)
    - Subdirectories should NOT import from the barrel (they use direct relative imports)
    - Check: `grep -r "from '@/backend/domains/session'" src/backend/domains/session/` should return only the barrel itself and possibly session-domain.service.ts
    - If any subdirectory file imports from the barrel, change it to a direct relative import

    Run `pnpm typecheck` to verify.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `import { sessionService, chatConnectionService, sessionDomainService } from '@/backend/domains/session'` resolves in TypeScript.
    No circular dependency warnings from the barrel.
  </verify>
  <done>
    Session domain barrel exports complete public API. pnpm typecheck passes. No circular dependencies from barrel.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create domain smoke test and update knip config for shims</name>
  <files>
    src/backend/domains/session/session-domain.test.ts
    knip.json
  </files>
  <action>
    1. **Create domain smoke test** at `src/backend/domains/session/session-domain.test.ts` (or extend the existing test file if appropriate -- check if `session-domain.service.test.ts` already exists and whether this should be separate).

    Create a NEW test file `src/backend/domains/session/session-domain-exports.test.ts` that verifies the barrel exports are real values (not undefined):

    ```typescript
    import { describe, it, expect } from 'vitest';

    describe('session domain barrel exports', () => {
      it('exports core domain service', async () => {
        const mod = await import('./index');
        expect(mod.sessionDomainService).toBeDefined();
      });

      it('exports session lifecycle service', async () => {
        const mod = await import('./index');
        expect(mod.sessionService).toBeDefined();
      });

      it('exports session data service', async () => {
        const mod = await import('./index');
        expect(mod.sessionDataService).toBeDefined();
      });

      it('exports chat connection service', async () => {
        const mod = await import('./index');
        expect(mod.chatConnectionService).toBeDefined();
      });

      it('exports chat event forwarder service', async () => {
        const mod = await import('./index');
        expect(mod.chatEventForwarderService).toBeDefined();
      });

      it('exports chat message handler service', async () => {
        const mod = await import('./index');
        expect(mod.chatMessageHandlerService).toBeDefined();
      });

      it('exports session file logger', async () => {
        const mod = await import('./index');
        expect(mod.sessionFileLogger).toBeDefined();
      });

      it('exports ProcessRegistry class', async () => {
        const mod = await import('./index');
        expect(mod.ProcessRegistry).toBeDefined();
        // Verify it's a class, not a plain object
        expect(typeof mod.ProcessRegistry).toBe('function');
      });

      it('exports SessionManager', async () => {
        const mod = await import('./index');
        expect(mod.SessionManager).toBeDefined();
      });
    });
    ```

    This catches Pitfall 1 (circular deps causing undefined exports) at test time.

    2. **Update knip.json** to add re-export shim paths to the ignore list so knip doesn't flag them as unused:

    Read the current `knip.json`. Add ignore entries for the re-export shims created in Plans 01-05. The shims will have real consumers until Phase 9, but knip might flag them because the canonical imports now come from the domain paths.

    Add these patterns to the `ignore` array:
    - `src/backend/claude/types.ts`
    - `src/backend/claude/types/process-types.ts`
    - `src/backend/claude/constants.ts`
    - `src/backend/claude/protocol.ts`
    - `src/backend/claude/protocol-io.ts`
    - `src/backend/claude/registry.ts`
    - `src/backend/claude/process.ts`
    - `src/backend/claude/monitoring.ts`
    - `src/backend/claude/permissions.ts`
    - `src/backend/claude/permission-coordinator.ts`
    - `src/backend/claude/session.ts`
    - `src/backend/claude/index.ts`

    Actually, use a glob: `src/backend/claude/**/*.ts` to cover all shims in the claude directory.

    Similarly for services shims:
    - `src/backend/services/session.service.ts`
    - `src/backend/services/session.repository.ts`
    - `src/backend/services/session.prompt-builder.ts`
    - `src/backend/services/session.process-manager.ts`
    - `src/backend/services/session-data.service.ts`
    - `src/backend/services/session-file-logger.service.ts`
    - `src/backend/services/chat-connection.service.ts`
    - `src/backend/services/chat-event-forwarder.service.ts`
    - `src/backend/services/chat-message-handlers.service.ts`
    - `src/backend/services/session-store/**/*.ts`

    Use globs where possible to keep the config clean.

    **Only add to knip ignore if the shims actually trigger knip warnings.** Run `pnpm typecheck` first, then check if knip passes. If it does, skip knip changes.

    3. **Final validation:**
    - Run `pnpm typecheck`
    - Run `pnpm test`
    - Run `pnpm check:fix` (Biome lint/format)

    Verify all pass.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test` passes (full suite, including new domain smoke test).
    `pnpm check:fix` passes.
    Domain smoke test at `src/backend/domains/session/session-domain-exports.test.ts` verifies all barrel exports are defined.
  </verify>
  <done>
    Session domain barrel is complete. Domain smoke test passes. All CI checks (typecheck, test, lint) pass. Phase 2 session domain consolidation is complete.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test` passes (full suite)
- `pnpm check:fix` passes
- Session domain barrel at index.ts exports all public services and types
- Domain smoke test verifies exports are real (not undefined)
- No module-level Maps or counters remain (DOM-04 complete)
- All session-related source files live under src/backend/domains/session/
- All old paths have re-export shims
</verification>

<success_criteria>
Phase 2 is complete. All session operations are accessible through `@/backend/domains/session`. The domain has co-located tests (SESS-05). DOM-04 violations eliminated. All CI checks pass.
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-domain-consolidation/02-06-SUMMARY.md`
</output>

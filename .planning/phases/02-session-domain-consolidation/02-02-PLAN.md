---
phase: 02-session-domain-consolidation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/backend/domains/session/claude/process.ts
  - src/backend/domains/session/claude/process.test.ts
  - src/backend/domains/session/claude/monitoring.ts
  - src/backend/domains/session/claude/permissions.ts
  - src/backend/domains/session/claude/permissions.test.ts
  - src/backend/domains/session/claude/permission-coordinator.ts
  - src/backend/domains/session/claude/permission-coordinator.test.ts
  - src/backend/domains/session/claude/session.ts
  - src/backend/domains/session/claude/session.test.ts
  - src/backend/domains/session/claude/client.ts
  - src/backend/domains/session/claude/index.ts
  - src/backend/claude/process.ts
  - src/backend/claude/monitoring.ts
  - src/backend/claude/permissions.ts
  - src/backend/claude/permission-coordinator.ts
  - src/backend/claude/session.ts
  - src/backend/claude/index.ts
autonomous: true

must_haves:
  truths:
    - "ClaudeProcess, ClaudeClient, permissions, session history are accessible from domains/session/claude/"
    - "ClaudeClient class is renamed to client.ts (was index.ts) at the new location"
    - "claude/ subdirectory has its own barrel file re-exporting public API"
    - "All existing consumers continue to compile via re-export shims"
    - "pnpm typecheck passes after all moves"
  artifacts:
    - path: "src/backend/domains/session/claude/process.ts"
      provides: "ClaudeProcess class"
      contains: "class ClaudeProcess"
    - path: "src/backend/domains/session/claude/client.ts"
      provides: "ClaudeClient class (renamed from index.ts)"
      contains: "class ClaudeClient"
    - path: "src/backend/domains/session/claude/permissions.ts"
      provides: "Permission handlers"
      contains: "class AutoApproveHandler"
    - path: "src/backend/domains/session/claude/permission-coordinator.ts"
      provides: "Permission coordination bridge"
      contains: "class ClaudePermissionCoordinator"
    - path: "src/backend/domains/session/claude/session.ts"
      provides: "SessionManager JSONL history reader"
      contains: "class SessionManager"
    - path: "src/backend/domains/session/claude/monitoring.ts"
      provides: "Resource monitoring"
    - path: "src/backend/domains/session/claude/index.ts"
      provides: "Claude subdirectory barrel file"
    - path: "src/backend/claude/index.ts"
      provides: "Re-export shim for backward compatibility"
  key_links:
    - from: "src/backend/domains/session/claude/process.ts"
      to: "src/backend/domains/session/claude/protocol.ts"
      via: "relative import"
      pattern: "from './protocol'"
    - from: "src/backend/domains/session/claude/client.ts"
      to: "src/backend/domains/session/claude/process.ts"
      via: "relative import"
      pattern: "from './process'"
    - from: "src/backend/domains/session/claude/client.ts"
      to: "src/backend/domains/session/claude/permission-coordinator.ts"
      via: "relative import"
      pattern: "from './permission-coordinator'"
    - from: "src/backend/claude/index.ts"
      to: "src/backend/domains/session/claude/index.ts"
      via: "re-export shim"
      pattern: "export .* from '@/backend/domains/session/claude'"
---

<objective>
Move the remaining claude/ files (process, monitoring, permissions, permission-coordinator, session, and the client/index) into the session domain's claude/ subdirectory.

Purpose: Completes the full migration of `src/backend/claude/` into the session domain. After this plan, the entire claude/ subdirectory is a self-contained layer within `src/backend/domains/session/claude/` with a proper barrel file.

Output: All claude/ source and test files at `src/backend/domains/session/claude/`, with `client.ts` as the renamed ClaudeClient (was `index.ts`), a proper barrel `index.ts`, and re-export shims at all old paths.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-session-domain-consolidation/02-RESEARCH.md
@.planning/phases/02-session-domain-consolidation/02-01-SUMMARY.md
@src/backend/claude/index.ts
@src/backend/claude/process.ts
@src/backend/claude/monitoring.ts
@src/backend/claude/permissions.ts
@src/backend/claude/permission-coordinator.ts
@src/backend/claude/session.ts
@src/backend/domains/session/claude/types.ts
@src/backend/domains/session/claude/protocol.ts
@src/backend/domains/session/claude/registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move process, monitoring, permissions, permission-coordinator, and session to session domain</name>
  <files>
    src/backend/domains/session/claude/process.ts
    src/backend/domains/session/claude/process.test.ts
    src/backend/domains/session/claude/monitoring.ts
    src/backend/domains/session/claude/permissions.ts
    src/backend/domains/session/claude/permissions.test.ts
    src/backend/domains/session/claude/permission-coordinator.ts
    src/backend/domains/session/claude/permission-coordinator.test.ts
    src/backend/domains/session/claude/session.ts
    src/backend/domains/session/claude/session.test.ts
    src/backend/claude/process.ts
    src/backend/claude/monitoring.ts
    src/backend/claude/permissions.ts
    src/backend/claude/permission-coordinator.ts
    src/backend/claude/session.ts
  </files>
  <action>
    Move each file from `src/backend/claude/` to `src/backend/domains/session/claude/`, updating internal imports.

    **For each file, the pattern is:**
    - Copy content to new location
    - Update imports that reference `../services/X` to `@/backend/services/X` (absolute path alias)
    - Update imports that reference `../lib/X` to `@/backend/lib/X`
    - Relative imports within claude/ (e.g., `./types`, `./protocol`) stay as-is since the files are co-located
    - Replace old file with a re-export shim

    **File-specific notes:**

    1. **process.ts** (~694 lines): Imports `./protocol`, `./protocol-io`, `./types`, `./registry`, `./constants`, `./types/process-types`. These relative imports remain valid. Also imports `createLogger` from `../services/logger.service` -- change to `@/backend/services/logger.service`. The file currently calls `registerProcess()` and `unregisterProcess()` from `./registry` -- these are now re-exported from the shim at the old path, but at the NEW location they should import from `./registry` which has the `ProcessRegistry` class. **Important:** `process.ts` calls the free functions `registerProcess()` and `unregisterProcess()`. Since the new `registry.ts` exports a class, NOT free functions, you must update `process.ts` to either: (a) accept a `ProcessRegistry` instance and call `registry.register()`/`registry.unregister()`, or (b) create a module-level instance in process.ts and call methods on it. Per the research recommendation (Open Question 4), the CALLER (`SessionProcessManager`) should handle registration, not `ClaudeProcess.spawn()`. So: **remove the auto-register/unregister calls from process.ts** and document that callers are responsible for registry management. Remove the `./registry` import from process.ts entirely.

    2. **monitoring.ts** (~207 lines): Imports `./registry`, `./types/process-types`. The `./registry` import uses `getAllProcesses()` and `getProcess()`. Since monitoring runs independently and needs registry access: create a function parameter or accept a `ProcessRegistry` instance. **Simplest approach:** monitoring.ts exports functions that take a `ProcessRegistry` parameter. Update the function signatures: `startResourceMonitoring(registry: ProcessRegistry, ...)` and `stopResourceMonitoring(...)`. The old shim can create a singleton and pass it.

    3. **permissions.ts** (~616 lines): Imports `./types`. Relative import stays valid. Also likely imports from `../services/logger.service` -- change to `@/backend/services/logger.service`.

    4. **permission-coordinator.ts** (~271 lines): Imports `./protocol`, `./types`, `./permissions`. Relative imports stay valid. May import logger.

    5. **session.ts** (~565 lines): Imports from `./types`. May import from `node:fs`, `node:path`, `node:readline`. Update any `../services/` imports to absolute.

    **Create re-export shims at old paths for each moved file:**
    Each shim: `export * from '@/backend/domains/session/claude/{filename}';` with @deprecated JSDoc.

    **For `process.ts` shim** -- since we removed auto-register/unregister from `process.ts`, the shim needs to wrap `ClaudeProcess.spawn()` to add registration back for backward compatibility. **Actually, simpler approach:** Don't change the spawn auto-registration yet. Keep the free-function imports from the registry shim (which delegates to a singleton). The caller-handles-registration change can happen when SessionProcessManager moves in Plan 04. So: in process.ts at the new location, import `registerProcess, unregisterProcess` from the OLD shim path `@/backend/claude/registry` -- wait, that creates a circular dependency (new file importing old shim that imports new file).

    **Revised approach for process.ts and registry interaction:** At the new location, `process.ts` should import from the co-located `./registry` module. Since `./registry` now exports a class, add a convenience module-level singleton instance in `registry.ts` for internal use within the claude/ subdirectory:

    In `src/backend/domains/session/claude/registry.ts`, at the bottom, add:
    ```typescript
    // Internal singleton for use within the claude/ subdirectory.
    // External consumers should use their own ProcessRegistry instance.
    export const processRegistry = new ProcessRegistry();
    ```

    Then `process.ts` imports `{ processRegistry }` from `./registry` and calls `processRegistry.register()`/`processRegistry.unregister()`.

    The backward-compatible shim at `src/backend/claude/registry.ts` should also import this same singleton:
    ```typescript
    import { processRegistry } from '@/backend/domains/session/claude/registry';
    export function registerProcess(...) { processRegistry.register(...); }
    ```

    This ensures both old free-function consumers AND new class consumers share the same Map instance.

    Similarly, update `monitoring.ts` to import `{ processRegistry }` from `./registry` and use `processRegistry.getAll()` / `processRegistry.get()`.

    Run `pnpm typecheck` after all moves.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/session/claude/` passes all moved tests.
    `pnpm test src/backend/claude/` still passes (tests that import from shims).
  </verify>
  <done>
    process.ts, monitoring.ts, permissions.ts, permission-coordinator.ts, session.ts with co-located tests all live at src/backend/domains/session/claude/. Re-export shims at old paths. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move ClaudeClient to client.ts and create claude/ barrel file</name>
  <files>
    src/backend/domains/session/claude/client.ts
    src/backend/domains/session/claude/index.ts
    src/backend/claude/index.ts
  </files>
  <action>
    1. Copy `src/backend/claude/index.ts` (the ClaudeClient class + re-exports) to `src/backend/domains/session/claude/client.ts`.

    In `client.ts`:
    - Remove ALL the `export * from './...'` re-export lines at the bottom of the file (lines like `export * from './permission-coordinator'`, `export * from './permissions'`, etc.). These belong in the barrel file, not the client module.
    - Update the import for `EventEmitter` types: `from '../lib/event-emitter-types'` -> `from '@/backend/lib/event-emitter-types'`
    - All other relative imports (`./permission-coordinator`, `./permissions`, `./process`, `./session`, `./types`) remain as-is since client.ts is co-located with them.

    2. Create `src/backend/domains/session/claude/index.ts` as the claude subdirectory barrel:
    ```typescript
    // Domain: session / Claude CLI interaction layer
    // Public API for the claude/ subdirectory.

    // Client (primary consumer-facing type)
    export { ClaudeClient } from './client';
    export type { ClaudeClientOptions } from './client';

    // Process
    export { ClaudeProcess } from './process';
    export type { ClaudeProcessOptions, ExitResult } from './process';

    // Protocol
    export { ClaudeProtocol } from './protocol';
    export { ProtocolIO } from './protocol-io';

    // Permissions
    export { AutoApproveHandler, ModeBasedHandler } from './permissions';
    export type { PermissionHandler } from './permissions';
    export { ClaudePermissionCoordinator } from './permission-coordinator';
    export type { PendingInteractiveRequest } from './permission-coordinator';

    // Registry
    export { ProcessRegistry, processRegistry } from './registry';
    export type { RegisteredProcess } from './registry';

    // Session history
    export { SessionManager } from './session';
    export type { HistoryMessage, SessionInfo } from './session';

    // Monitoring
    export { startResourceMonitoring, stopResourceMonitoring } from './monitoring';

    // Types (selective - only commonly used types)
    export type {
      AssistantMessage,
      ClaudeContentItem,
      ClaudeJson,
      ControlRequest,
      HooksConfig,
      InitializeResponseData,
      PermissionMode,
      ResultMessage,
      RewindFilesResponse,
      StreamEventMessage,
      SystemMessage,
      ToolUseContent,
      UserMessage,
    } from './types';

    // Constants
    export { CLAUDE_CLI_TIMEOUT_MS } from './constants';

    // Process types
    export type { ProcessStatus, ResourceUsage } from './types/process-types';
    ```

    **Note:** Only export the types that are actually used by consumers outside the claude/ subdirectory. Check `src/backend/claude/index.ts`'s current `export *` statements to see what's actually consumed. The barrel should be selective, not blanket `export *`, to avoid circular dependency issues (per Pitfall 1 in research).

    3. Replace `src/backend/claude/index.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/session/claude' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export * from '@/backend/domains/session/claude/client';
    export * from '@/backend/domains/session/claude/permission-coordinator';
    export * from '@/backend/domains/session/claude/permissions';
    export * from '@/backend/domains/session/claude/process';
    export * from '@/backend/domains/session/claude/protocol';
    export * from '@/backend/domains/session/claude/protocol-io';
    export * from '@/backend/domains/session/claude/registry';
    export * from '@/backend/domains/session/claude/session';
    export * from '@/backend/domains/session/claude/types';
    ```

    Use individual `export *` from each new file (NOT from the barrel `index.ts`) to avoid double-barrel circular issues. This preserves the exact same export surface as the original file.

    Run `pnpm typecheck` to verify everything compiles.
    Run `pnpm test` to verify all tests pass.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test` passes (full test suite).
    `src/backend/domains/session/claude/index.ts` exists as a selective barrel.
    `src/backend/claude/index.ts` is a shim that re-exports from new location.
    No `export * from './...'` lines remain in `client.ts`.
  </verify>
  <done>
    ClaudeClient lives at src/backend/domains/session/claude/client.ts. Claude subdirectory barrel at index.ts. Full re-export shim at old src/backend/claude/index.ts. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test` passes (full suite)
- All claude/ source files now live at src/backend/domains/session/claude/
- src/backend/claude/ contains only re-export shims (no business logic)
- Claude subdirectory has its own barrel file at index.ts
</verification>

<success_criteria>
The entire src/backend/claude/ directory is migrated to src/backend/domains/session/claude/. All original paths have re-export shims. The claude/ barrel file provides a clean public API. Full test suite passes.
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-domain-consolidation/02-02-SUMMARY.md`
</output>

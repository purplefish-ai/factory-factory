---
phase: 02-session-domain-consolidation
plan: 05
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/backend/domains/session/chat/chat-connection.service.ts
  - src/backend/domains/session/chat/chat-event-forwarder.service.ts
  - src/backend/domains/session/chat/chat-event-forwarder.service.test.ts
  - src/backend/domains/session/chat/chat-message-handlers.service.ts
  - src/backend/domains/session/chat/chat-message-handlers.service.test.ts
  - src/backend/domains/session/chat/chat-message-handlers/attachment-processing.ts
  - src/backend/domains/session/chat/chat-message-handlers/attachment-processing.test.ts
  - src/backend/domains/session/chat/chat-message-handlers/attachment-utils.ts
  - src/backend/domains/session/chat/chat-message-handlers/attachment-utils.test.ts
  - src/backend/domains/session/chat/chat-message-handlers/constants.ts
  - src/backend/domains/session/chat/chat-message-handlers/interactive-response.ts
  - src/backend/domains/session/chat/chat-message-handlers/interactive-response.test.ts
  - src/backend/domains/session/chat/chat-message-handlers/registry.ts
  - src/backend/domains/session/chat/chat-message-handlers/types.ts
  - src/backend/domains/session/chat/chat-message-handlers/utils.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/list-sessions.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/load-session.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/permission-response.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/question-response.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/queue-message.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/remove-queued-message.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/rewind-files.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/set-model.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/set-thinking-budget.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/start.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/start.handler.test.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/stop.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/user-input.handler.ts
  - src/backend/services/chat-connection.service.ts
  - src/backend/services/chat-event-forwarder.service.ts
  - src/backend/services/chat-message-handlers.service.ts
autonomous: true

must_haves:
  truths:
    - "Chat connection, event forwarder, and message handlers are accessible from domains/session/chat/"
    - "chatWsMsgCounter is moved inside ChatConnectionService class as instance field (DOM-04)"
    - "Chat message handler implementations (15 files) are accessible from domains/session/chat/chat-message-handlers/"
    - "All existing consumers continue to compile via re-export shims"
    - "pnpm typecheck passes after all moves"
  artifacts:
    - path: "src/backend/domains/session/chat/chat-connection.service.ts"
      provides: "WebSocket connection tracking"
      contains: "class ChatConnectionService"
    - path: "src/backend/domains/session/chat/chat-event-forwarder.service.ts"
      provides: "Claude event -> WS forwarding"
      contains: "class ChatEventForwarderService"
    - path: "src/backend/domains/session/chat/chat-message-handlers.service.ts"
      provides: "Inbound message dispatch"
      contains: "class ChatMessageHandlerService"
    - path: "src/backend/domains/session/chat/chat-message-handlers/handlers/start.handler.ts"
      provides: "Start handler implementation"
    - path: "src/backend/services/chat-connection.service.ts"
      provides: "Re-export shim"
    - path: "src/backend/services/chat-event-forwarder.service.ts"
      provides: "Re-export shim"
    - path: "src/backend/services/chat-message-handlers.service.ts"
      provides: "Re-export shim"
  key_links:
    - from: "src/backend/domains/session/chat/chat-event-forwarder.service.ts"
      to: "src/backend/domains/session/claude/"
      via: "ClaudeClient event listening"
      pattern: "ClaudeClient"
    - from: "src/backend/domains/session/chat/chat-message-handlers/handlers/start.handler.ts"
      to: "src/backend/domains/session/lifecycle/session.service.ts"
      via: "sessionService import (via shim)"
      pattern: "sessionService"
    - from: "src/backend/domains/session/chat/chat-connection.service.ts"
      to: "src/backend/domains/session/logging/session-file-logger.service.ts"
      via: "sessionFileLogger import"
      pattern: "sessionFileLogger"
---

<objective>
Move chat services (connection, event forwarder, message handlers) and the entire chat-message-handlers/ subdirectory (15 files) into the session domain.

Purpose: Chat services manage WebSocket connections for session interaction, forward Claude CLI events to clients, and dispatch inbound messages. They are tightly coupled to the session lifecycle and belong in the session domain. This is the final batch of file moves.

Output: `src/backend/domains/session/chat/` with all chat service files and the handlers subdirectory. DOM-04 fix for chatWsMsgCounter. Re-export shims at old paths.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-session-domain-consolidation/02-RESEARCH.md
@.planning/phases/02-session-domain-consolidation/02-02-SUMMARY.md
@src/backend/services/chat-connection.service.ts
@src/backend/services/chat-event-forwarder.service.ts
@src/backend/services/chat-message-handlers.service.ts
@src/backend/services/chat-message-handlers/registry.ts
@src/backend/services/chat-message-handlers/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move chat-connection and chat-event-forwarder services, fix chatWsMsgCounter (DOM-04)</name>
  <files>
    src/backend/domains/session/chat/chat-connection.service.ts
    src/backend/domains/session/chat/chat-event-forwarder.service.ts
    src/backend/domains/session/chat/chat-event-forwarder.service.test.ts
    src/backend/services/chat-connection.service.ts
    src/backend/services/chat-event-forwarder.service.ts
  </files>
  <action>
    Create `src/backend/domains/session/chat/` directory.

    1. **Move chat-connection.service.ts** (~129 lines) to `src/backend/domains/session/chat/chat-connection.service.ts`:
       - **DOM-04 fix:** Move the module-level `let chatWsMsgCounter = 0;` inside the `ChatConnectionService` class as `private chatWsMsgCounter = 0;`. Update references in `forwardToSession()` from `chatWsMsgCounter++` to `this.chatWsMsgCounter++` and `msgNum = chatWsMsgCounter` to `msgNum = this.chatWsMsgCounter`.
       - Update imports:
         - `../constants` -> `@/backend/constants` (verify the actual import path by reading the file)
         - `./config.service` -> `@/backend/services/config.service`
         - `./logger.service` -> `@/backend/services/logger.service`
         - `./session-file-logger.service` -> Since session-file-logger may or may not have moved yet (Plan 04 is same wave as this plan's dependency), use `@/backend/services/session-file-logger.service` (shim path) to be safe. If Plan 04 is guaranteed complete before this runs (Wave 3 depends on Wave 2), then use `../logging/session-file-logger.service` (intra-domain). **Since this plan depends only on 02-02 (Wave 2), and Plan 04 also runs in Wave 3, use the absolute shim path `@/backend/services/session-file-logger.service` for safety. This can be updated to intra-domain in Phase 9 or a later gap-closure plan.**

    2. **Move chat-event-forwarder.service.ts** (~980 lines) to `src/backend/domains/session/chat/chat-event-forwarder.service.ts`:
       - Update imports:
         - `../claude/index` or `../claude/` -> `../claude/` (intra-domain relative to `domains/session/chat/` -> `domains/session/claude/`)
         - `./chat-connection.service` -> `./chat-connection.service` (co-located, stays relative)
         - `./config.service` -> `@/backend/services/config.service`
         - `./logger.service` -> `@/backend/services/logger.service`
         - `./session-file-logger.service` -> `@/backend/services/session-file-logger.service` (shim, safe)
         - Any imports from session-domain.service -> `../session-domain.service` (intra-domain)
         - Any imports from session-store/ -> `../store/` or `@/backend/services/session-store/` (shim, safe)
       - Move co-located test file.

    **Create re-export shims:**
    ```typescript
    // src/backend/services/chat-connection.service.ts (SHIM)
    /**
     * @deprecated Import from '@/backend/domains/session' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export { chatConnectionService, ChatConnectionService } from '@/backend/domains/session/chat/chat-connection.service';
    export type { ConnectionInfo } from '@/backend/domains/session/chat/chat-connection.service';
    ```

    ```typescript
    // src/backend/services/chat-event-forwarder.service.ts (SHIM)
    /**
     * @deprecated Import from '@/backend/domains/session' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export { chatEventForwarderService } from '@/backend/domains/session/chat/chat-event-forwarder.service';
    ```

    **Note:** Check if `ChatConnectionService` class is exported (not just the instance). If only the instance `chatConnectionService` is exported, the shim only needs to re-export that.

    Run `pnpm typecheck` to verify.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/session/chat/chat-event-forwarder.service.test.ts` passes.
    No module-level `let chatWsMsgCounter` exists in the codebase (DOM-04 for this file).
    chatWsMsgCounter is now an instance field on ChatConnectionService.
  </verify>
  <done>
    chat-connection.service.ts and chat-event-forwarder.service.ts live at domains/session/chat/. chatWsMsgCounter moved inside class (DOM-04). Re-export shims at old paths. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move chat-message-handlers.service and entire chat-message-handlers/ subdirectory</name>
  <files>
    src/backend/domains/session/chat/chat-message-handlers.service.ts
    src/backend/domains/session/chat/chat-message-handlers.service.test.ts
    src/backend/domains/session/chat/chat-message-handlers/attachment-processing.ts
    src/backend/domains/session/chat/chat-message-handlers/attachment-processing.test.ts
    src/backend/domains/session/chat/chat-message-handlers/attachment-utils.ts
    src/backend/domains/session/chat/chat-message-handlers/attachment-utils.test.ts
    src/backend/domains/session/chat/chat-message-handlers/constants.ts
    src/backend/domains/session/chat/chat-message-handlers/interactive-response.ts
    src/backend/domains/session/chat/chat-message-handlers/interactive-response.test.ts
    src/backend/domains/session/chat/chat-message-handlers/registry.ts
    src/backend/domains/session/chat/chat-message-handlers/types.ts
    src/backend/domains/session/chat/chat-message-handlers/utils.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/list-sessions.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/load-session.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/permission-response.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/question-response.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/queue-message.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/remove-queued-message.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/rewind-files.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/set-model.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/set-thinking-budget.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/start.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/start.handler.test.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/stop.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/user-input.handler.ts
    src/backend/services/chat-message-handlers.service.ts
  </files>
  <action>
    Create `src/backend/domains/session/chat/chat-message-handlers/` and `handlers/` subdirectories.

    **Move chat-message-handlers.service.ts** (~319 lines) to `src/backend/domains/session/chat/chat-message-handlers.service.ts`:
    - Update imports:
      - `./chat-message-handlers/registry` -> `./chat-message-handlers/registry` (stays relative)
      - `./chat-message-handlers/types` -> `./chat-message-handlers/types` (stays relative)
      - `./chat-connection.service` -> `./chat-connection.service` (co-located in chat/)
      - `../claude/` imports -> `../claude/` (intra-domain relative)
      - `./logger.service` -> `@/backend/services/logger.service`
      - `./session-file-logger.service` -> `@/backend/services/session-file-logger.service` (shim)

    **Move the entire chat-message-handlers/ subdirectory** (11 files + handlers/ subdirectory with 13 files = 24 files total) to `src/backend/domains/session/chat/chat-message-handlers/`:

    For the **internal utility files** (attachment-processing.ts, attachment-utils.ts, constants.ts, interactive-response.ts, registry.ts, types.ts, utils.ts):
    - These primarily reference each other with relative imports (`./types`, `./constants`, `./utils`)
    - Relative imports within the subdirectory stay as-is
    - Update any external imports (services, claude) to absolute paths or intra-domain relatives
    - Move co-located test files alongside

    For the **handler files** (handlers/*.handler.ts):
    - These import from parent (`../types`, `../utils`, `../registry`, `../constants`)
    - These relative imports stay as-is (parent directory structure preserved)
    - External imports need updating:
      - `@/backend/services/session.service` -> `@/backend/services/session.service` (shim, safe -- this is still the old path)
      - `@/backend/claude/` -> `@/backend/claude/` (shim, safe)
      - `@/backend/services/session-data.service` -> `@/backend/services/session-data.service` (shim)
      - `@/backend/domains/session/session-domain.service` -> keep as-is or update to relative
      - `@/backend/services/chat-connection.service` -> `@/backend/services/chat-connection.service` (shim)

    **Key concern (Pitfall 3 from research):** Handler files import `sessionService` directly, and `session.service.ts` sets up `chatMessageHandlerService`. The callback injection pattern (`setOnClientCreated`) breaks the circular dependency at runtime. **Do NOT change this pattern.** Handlers should import from shim paths (`@/backend/services/session.service`) to avoid creating new circular dependencies within the domain. Phase 9 will handle proper intra-domain wiring.

    **Create re-export shims:**

    For `src/backend/services/chat-message-handlers.service.ts`:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/session' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export { chatMessageHandlerService } from '@/backend/domains/session/chat/chat-message-handlers.service';
    export type { ChatMessage } from '@/backend/domains/session/chat/chat-message-handlers.service';
    ```

    For the `src/backend/services/chat-message-handlers/` subdirectory files: these are internal-only (0 external consumers per research). No shims needed for the individual handler files. However, check if any files OUTSIDE the chat-message-handlers/ directory import from within it. If so, create shims for those specific files.

    Run `pnpm typecheck` to verify.
    Run `pnpm test` for full suite.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test` passes (full suite).
    All chat-message-handlers/ files exist at new location.
    `pnpm test src/backend/domains/session/chat/` passes.
  </verify>
  <done>
    chat-message-handlers.service.ts and all 24 chat-message-handlers/ files live at domains/session/chat/. Re-export shims at old service paths. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test` passes (full suite)
- All chat service files live at src/backend/domains/session/chat/
- chatWsMsgCounter is an instance field (DOM-04)
- src/backend/services/chat*.ts contain only re-export shims
- Handler callback injection pattern preserved (no new circular deps)
</verification>

<success_criteria>
All chat services and handlers migrated to session domain. DOM-04 chatWsMsgCounter fixed. Old paths have re-export shims. Full test suite passes.
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-domain-consolidation/02-05-SUMMARY.md`
</output>

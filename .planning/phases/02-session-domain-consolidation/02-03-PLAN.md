---
phase: 02-session-domain-consolidation
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/backend/domains/session/store/session-hydrator.ts
  - src/backend/domains/session/store/session-process-exit.ts
  - src/backend/domains/session/store/session-publisher.ts
  - src/backend/domains/session/store/session-queue.ts
  - src/backend/domains/session/store/session-queue.test.ts
  - src/backend/domains/session/store/session-replay-builder.ts
  - src/backend/domains/session/store/session-replay-builder.test.ts
  - src/backend/domains/session/store/session-runtime-machine.ts
  - src/backend/domains/session/store/session-runtime-machine.test.ts
  - src/backend/domains/session/store/session-store-registry.ts
  - src/backend/domains/session/store/session-store.types.ts
  - src/backend/domains/session/store/session-transcript.ts
  - src/backend/domains/session/store/session-transcript.test.ts
  - src/backend/services/session-store/session-hydrator.ts
  - src/backend/services/session-store/session-process-exit.ts
  - src/backend/services/session-store/session-publisher.ts
  - src/backend/services/session-store/session-queue.ts
  - src/backend/services/session-store/session-replay-builder.ts
  - src/backend/services/session-store/session-runtime-machine.ts
  - src/backend/services/session-store/session-store-registry.ts
  - src/backend/services/session-store/session-store.types.ts
  - src/backend/services/session-store/session-transcript.ts
autonomous: true

must_haves:
  truths:
    - "Session store files (hydrator, publisher, queue, replay builder, runtime machine, transcript, etc.) are accessible from domains/session/store/"
    - "Internal imports within store files reference new co-located paths"
    - "session-publisher.ts correctly references chatConnectionService import path"
    - "All existing consumers continue to compile via re-export shims"
    - "pnpm typecheck passes after all moves"
  artifacts:
    - path: "src/backend/domains/session/store/session-store.types.ts"
      provides: "Session store type definitions"
    - path: "src/backend/domains/session/store/session-queue.ts"
      provides: "Session message queue"
    - path: "src/backend/domains/session/store/session-transcript.ts"
      provides: "Session transcript management"
    - path: "src/backend/domains/session/store/session-runtime-machine.ts"
      provides: "Session runtime state machine"
    - path: "src/backend/domains/session/store/session-publisher.ts"
      provides: "Session snapshot publisher"
    - path: "src/backend/domains/session/store/session-store-registry.ts"
      provides: "Session store registry"
    - path: "src/backend/services/session-store/session-hydrator.ts"
      provides: "Re-export shim"
  key_links:
    - from: "src/backend/domains/session/store/session-publisher.ts"
      to: "chat-connection service"
      via: "import for WS forwarding"
      pattern: "chatConnectionService"
    - from: "src/backend/domains/session/store/session-store-registry.ts"
      to: "session-domain.service.ts"
      via: "consumed by domain service"
      pattern: "sessionStoreRegistry"
---

<objective>
Move the session-store/ subdirectory (13 files) from services/ into the session domain as store/.

Purpose: The session store manages in-memory session state (transcripts, queues, runtime state machine, publishing). It is an internal implementation detail of the session domain, consumed primarily by `session-domain.service.ts`. Moving it into the domain makes the ownership explicit.

Output: `src/backend/domains/session/store/` with all 13 session store files, re-export shims at old paths.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-session-domain-consolidation/02-RESEARCH.md
@.planning/phases/02-session-domain-consolidation/02-01-SUMMARY.md
@src/backend/services/session-store/session-store.types.ts
@src/backend/services/session-store/session-publisher.ts
@src/backend/services/session-store/session-store-registry.ts
@src/backend/services/session-store/session-hydrator.ts
@src/backend/domains/session/session-domain.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move session-store types, queue, transcript, runtime-machine, and replay-builder</name>
  <files>
    src/backend/domains/session/store/session-store.types.ts
    src/backend/domains/session/store/session-queue.ts
    src/backend/domains/session/store/session-queue.test.ts
    src/backend/domains/session/store/session-transcript.ts
    src/backend/domains/session/store/session-transcript.test.ts
    src/backend/domains/session/store/session-runtime-machine.ts
    src/backend/domains/session/store/session-runtime-machine.test.ts
    src/backend/domains/session/store/session-replay-builder.ts
    src/backend/domains/session/store/session-replay-builder.test.ts
    src/backend/services/session-store/session-store.types.ts
    src/backend/services/session-store/session-queue.ts
    src/backend/services/session-store/session-transcript.ts
    src/backend/services/session-store/session-runtime-machine.ts
    src/backend/services/session-store/session-replay-builder.ts
  </files>
  <action>
    Create `src/backend/domains/session/store/` directory.

    Move the "leaf" session-store files (no cross-store dependencies, or dependencies only on session-store.types.ts).

    **For each file:**
    - Copy content to `src/backend/domains/session/store/`
    - Update imports: relative imports within session-store/ (`./session-store.types`, `./session-queue`, etc.) remain as relative imports (the files are still co-located within store/)
    - Update imports that reference `../services/X` or `../../services/X` to absolute `@/backend/services/X`
    - Update imports that reference `../../claude/` to `@/backend/domains/session/claude/` (if Plan 01 is complete) OR to `@/backend/claude/` (which is a shim). Prefer the new canonical path `@/backend/domains/session/claude/` since we own both.
    - Update imports that reference `@/backend/domains/session/session-domain.service` to use relative path `../session-domain.service` since we're now in the same domain
    - Replace old file with re-export shim

    **Files to move (in this order):**

    1. **session-store.types.ts** -- Type definitions only, no imports from other store files. Imports from `@/shared/session-runtime` and possibly `@/backend/claude/types`. Update claude import to `@/backend/domains/session/claude/types` if present.

    2. **session-queue.ts** + **session-queue.test.ts** -- Imports `./session-store.types`. Relative import stays valid.

    3. **session-transcript.ts** + **session-transcript.test.ts** -- Imports `./session-store.types` and possibly claude types.

    4. **session-runtime-machine.ts** + **session-runtime-machine.test.ts** -- Imports `./session-store.types`, `@/shared/session-runtime`.

    5. **session-replay-builder.ts** + **session-replay-builder.test.ts** -- Imports `./session-store.types`, `./session-transcript`, `./session-queue`, `./session-runtime-machine`.

    **Create re-export shims at old paths.** Each shim re-exports from the new location:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/session/store/{filename}' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export * from '@/backend/domains/session/store/{filename}';
    ```

    Run `pnpm typecheck` to verify.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/session/store/` passes for moved tests.
    Old import paths still resolve via shims.
  </verify>
  <done>
    session-store.types.ts, session-queue.ts, session-transcript.ts, session-runtime-machine.ts, session-replay-builder.ts (with tests) live at src/backend/domains/session/store/. Re-export shims at old paths. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move session-store hydrator, publisher, process-exit, and store-registry</name>
  <files>
    src/backend/domains/session/store/session-hydrator.ts
    src/backend/domains/session/store/session-process-exit.ts
    src/backend/domains/session/store/session-publisher.ts
    src/backend/domains/session/store/session-store-registry.ts
    src/backend/services/session-store/session-hydrator.ts
    src/backend/services/session-store/session-process-exit.ts
    src/backend/services/session-store/session-publisher.ts
    src/backend/services/session-store/session-store-registry.ts
  </files>
  <action>
    Move the remaining session-store files. These have more external dependencies.

    **Files to move:**

    1. **session-publisher.ts** -- This imports `chatConnectionService` from `../chat-connection.service`. Since chat-connection.service.ts hasn't moved yet (that's Plan 05), use the absolute path `@/backend/services/chat-connection.service` for now. When chat moves in Plan 05, this import will be updated to a relative intra-domain path. Also imports from `./session-store.types` (relative, stays valid) and possibly `@/backend/services/logger.service`.

    2. **session-hydrator.ts** -- Imports from `./session-store.types`, claude types, and service imports. Update `../../claude/` imports to `@/backend/domains/session/claude/` (canonical new path). Update `../services/X` imports to `@/backend/services/X`.

    3. **session-process-exit.ts** -- Imports from `./session-store.types`, services. Similar import updates.

    4. **session-store-registry.ts** -- This is the registry of all session store instances, imported by `session-domain.service.ts`. Imports from `./session-store.types` and internal store files. Update `session-domain.service.ts` import if it references the old path.

    **Create re-export shims at old paths** for all 4 files.

    **Update session-domain.service.ts** if it imports from `../services/session-store/`:
    - Check `src/backend/domains/session/session-domain.service.ts` for imports referencing `../services/session-store/`
    - Update them to relative imports: `./store/session-store-registry`, `./store/session-hydrator`, etc.
    - This is an intra-domain change, not breaking any external consumers.

    Run `pnpm typecheck` to verify.
    Run `pnpm test` to verify all tests pass.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test` passes (full suite).
    `session-domain.service.ts` imports from `./store/` (intra-domain).
    All old session-store/ paths have re-export shims.
  </verify>
  <done>
    All 13 session-store files live at src/backend/domains/session/store/. session-domain.service.ts imports from ./store/ (intra-domain). Re-export shims at all old paths. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test` passes (full suite)
- All session-store/ files now live at src/backend/domains/session/store/
- src/backend/services/session-store/ contains only re-export shims
- session-domain.service.ts uses intra-domain imports for store/
</verification>

<success_criteria>
The entire session-store/ directory is migrated to src/backend/domains/session/store/. session-domain.service.ts uses relative imports to the co-located store. All old paths have re-export shims. Full test suite passes.
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-domain-consolidation/02-03-SUMMARY.md`
</output>

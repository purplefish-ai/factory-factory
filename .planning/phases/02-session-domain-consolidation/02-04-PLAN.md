---
phase: 02-session-domain-consolidation
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/backend/domains/session/lifecycle/session.service.ts
  - src/backend/domains/session/lifecycle/session.service.test.ts
  - src/backend/domains/session/lifecycle/session.repository.ts
  - src/backend/domains/session/lifecycle/session.repository.test.ts
  - src/backend/domains/session/lifecycle/session.prompt-builder.ts
  - src/backend/domains/session/lifecycle/session.prompt-builder.test.ts
  - src/backend/domains/session/lifecycle/session.process-manager.ts
  - src/backend/domains/session/lifecycle/session.process-manager.test.ts
  - src/backend/domains/session/data/session-data.service.ts
  - src/backend/domains/session/logging/session-file-logger.service.ts
  - src/backend/domains/session/logging/session-file-logger.service.test.ts
  - src/backend/services/session.service.ts
  - src/backend/services/session.repository.ts
  - src/backend/services/session.prompt-builder.ts
  - src/backend/services/session.process-manager.ts
  - src/backend/services/session-data.service.ts
  - src/backend/services/session-file-logger.service.ts
autonomous: true

must_haves:
  truths:
    - "Session lifecycle services (service, repository, prompt-builder, process-manager) are accessible from domains/session/lifecycle/"
    - "Session data service is accessible from domains/session/data/"
    - "Session file logger is accessible from domains/session/logging/"
    - "Lifecycle services import claude types from co-located ../claude/ (intra-domain)"
    - "All existing consumers continue to compile via re-export shims"
    - "pnpm typecheck passes after all moves"
  artifacts:
    - path: "src/backend/domains/session/lifecycle/session.service.ts"
      provides: "Session lifecycle orchestration (start/stop/create)"
      contains: "class SessionService"
    - path: "src/backend/domains/session/lifecycle/session.process-manager.ts"
      provides: "Client lifecycle with race protection"
      contains: "class SessionProcessManager"
    - path: "src/backend/domains/session/lifecycle/session.repository.ts"
      provides: "Session DB access facade"
      contains: "class SessionRepository"
    - path: "src/backend/domains/session/lifecycle/session.prompt-builder.ts"
      provides: "System prompt construction"
      contains: "class SessionPromptBuilder"
    - path: "src/backend/domains/session/data/session-data.service.ts"
      provides: "Session data access (CRUD facade)"
      contains: "class SessionDataService"
    - path: "src/backend/domains/session/logging/session-file-logger.service.ts"
      provides: "Per-session file logging"
      contains: "class SessionFileLogger"
    - path: "src/backend/services/session.service.ts"
      provides: "Re-export shim for backward compatibility"
  key_links:
    - from: "src/backend/domains/session/lifecycle/session.service.ts"
      to: "src/backend/domains/session/claude/client.ts"
      via: "ClaudeClient type import"
      pattern: "ClaudeClient"
    - from: "src/backend/domains/session/lifecycle/session.process-manager.ts"
      to: "src/backend/domains/session/claude/"
      via: "ClaudeClient.create() call"
      pattern: "ClaudeClient.create"
    - from: "src/backend/domains/session/lifecycle/session.service.ts"
      to: "src/backend/domains/session/session-domain.service.ts"
      via: "sessionDomainService import"
      pattern: "sessionDomainService"
---

<objective>
Move session lifecycle services (session.service, repository, prompt-builder, process-manager), session data service, and session file logger into the session domain.

Purpose: These are the service-layer files that orchestrate session lifecycle, DB access, and logging. They depend on the claude/ layer (moved in Plans 01-02) and are consumed by tRPC routers and WebSocket handlers. Moving them completes the "services" portion of the session domain.

Output: `src/backend/domains/session/lifecycle/`, `data/`, and `logging/` subdirectories populated with moved files. Re-export shims at old paths.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-session-domain-consolidation/02-RESEARCH.md
@.planning/phases/02-session-domain-consolidation/02-01-SUMMARY.md
@.planning/phases/02-session-domain-consolidation/02-02-SUMMARY.md
@.planning/phases/02-session-domain-consolidation/02-03-SUMMARY.md
@src/backend/services/session.service.ts
@src/backend/services/session.process-manager.ts
@src/backend/services/session.repository.ts
@src/backend/services/session.prompt-builder.ts
@src/backend/services/session-data.service.ts
@src/backend/services/session-file-logger.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move lifecycle services (session.service, repository, prompt-builder, process-manager)</name>
  <files>
    src/backend/domains/session/lifecycle/session.service.ts
    src/backend/domains/session/lifecycle/session.service.test.ts
    src/backend/domains/session/lifecycle/session.repository.ts
    src/backend/domains/session/lifecycle/session.repository.test.ts
    src/backend/domains/session/lifecycle/session.prompt-builder.ts
    src/backend/domains/session/lifecycle/session.prompt-builder.test.ts
    src/backend/domains/session/lifecycle/session.process-manager.ts
    src/backend/domains/session/lifecycle/session.process-manager.test.ts
    src/backend/services/session.service.ts
    src/backend/services/session.repository.ts
    src/backend/services/session.prompt-builder.ts
    src/backend/services/session.process-manager.ts
  </files>
  <action>
    Create `src/backend/domains/session/lifecycle/` directory.

    Move files in dependency order (repository and prompt-builder are leaves; process-manager depends on claude; session.service depends on all three).

    **For each file, update imports following these rules:**
    - `../claude/index` or `../claude/` -> `../claude/` or `../claude/client` (intra-domain, relative)
    - `../claude/registry` -> `../claude/registry` (intra-domain, relative)
    - `../claude/session` -> `../claude/session` (intra-domain, relative)
    - `../claude/process` -> `../claude/process` (intra-domain, relative)
    - `@/backend/domains/session/session-domain.service` -> `../session-domain.service` (intra-domain, relative)
    - `./session.repository` stays relative (co-located in lifecycle/)
    - `./session.prompt-builder` stays relative (co-located in lifecycle/)
    - `./session.process-manager` stays relative (co-located in lifecycle/)
    - `../services/logger.service` -> `@/backend/services/logger.service` (external, absolute)
    - `../services/config.service` -> `@/backend/services/config.service` (external, absolute)
    - `@/shared/...` imports stay as-is (shared module)
    - `@prisma-gen/...` imports stay as-is (generated)
    - Resource accessor imports stay as absolute `@/backend/resource_accessors/...`

    **File-specific notes:**

    1. **session.repository.ts** (~98 lines): Imports `claudeSessionAccessor` from resource_accessors. Simple DB facade. Update `../resource_accessors/` to `@/backend/resource_accessors/`.

    2. **session.prompt-builder.ts** (~73 lines): Imports config service. Update to absolute path.

    3. **session.process-manager.ts** (~328 lines): Imports `ClaudeClient`, `ClaudeClientOptions` from `../claude/index`. Update to `../claude/` or `../claude/client`. Imports `configService` and `createLogger`. Uses `p-limit` for mutex. All relative claude imports become `../claude/` relative paths.

    4. **session.service.ts** (~580 lines): The most complex file. Imports from claude/index (types), claude/registry, claude/session, and the three lifecycle siblings. Update:
       - `../claude/index` -> `../claude/` (or specific submodule via `../claude/client`)
       - `../claude/registry` -> `../claude/registry`
       - `../claude/session` -> `../claude/session`
       - `./session.repository` -> stays as-is
       - `./session.prompt-builder` -> stays as-is
       - `./session.process-manager` -> stays as-is
       - `@/backend/domains/session/session-domain.service` -> `../session-domain.service`

    **Move co-located test files alongside each source file.** Update test imports:
    - `vi.mock()` paths must match new file locations
    - Direct imports in tests update to relative co-located paths

    **Create re-export shims at old paths:**
    ```typescript
    // src/backend/services/session.service.ts (SHIM)
    /**
     * @deprecated Import from '@/backend/domains/session' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export { sessionService } from '@/backend/domains/session/lifecycle/session.service';
    export type { ClientCreatedCallback } from '@/backend/domains/session/lifecycle/session.service';
    ```

    Similar shims for session.repository.ts, session.prompt-builder.ts, session.process-manager.ts -- each re-exporting the class and singleton instance from the new location.

    Run `pnpm typecheck` to verify.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/session/lifecycle/` passes all moved tests.
    Existing consumers still compile (via shims).
  </verify>
  <done>
    session.service.ts, session.repository.ts, session.prompt-builder.ts, session.process-manager.ts with tests live at src/backend/domains/session/lifecycle/. Re-export shims at old paths. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move session-data.service and session-file-logger.service, fix chatWsMsgCounter (DOM-04)</name>
  <files>
    src/backend/domains/session/data/session-data.service.ts
    src/backend/domains/session/logging/session-file-logger.service.ts
    src/backend/domains/session/logging/session-file-logger.service.test.ts
    src/backend/services/session-data.service.ts
    src/backend/services/session-file-logger.service.ts
  </files>
  <action>
    Create `src/backend/domains/session/data/` and `src/backend/domains/session/logging/` directories.

    1. **Move session-data.service.ts** (~93 lines) to `src/backend/domains/session/data/session-data.service.ts`:
       - Imports `claudeSessionAccessor` and `terminalSessionAccessor` from `../resource_accessors/`. Update to `@/backend/resource_accessors/claude-session.accessor` and `@/backend/resource_accessors/terminal-session.accessor`.
       - No other internal dependencies.

    2. **Move session-file-logger.service.ts** (~363 lines) to `src/backend/domains/session/logging/session-file-logger.service.ts`:
       - Imports `configService` from `./config.service` -> `@/backend/services/config.service`
       - Imports `createLogger` from `./logger.service` -> `@/backend/services/logger.service`
       - Move co-located test file as well.

    3. **Note about chatWsMsgCounter (DOM-04):** The `chatWsMsgCounter` in `chat-connection.service.ts` is module-level `let` state. This was already identified in the research as a DOM-04 candidate. However, `chat-connection.service.ts` is a class (`ChatConnectionService`) -- the counter just needs to move inside the class as an instance field. This will be handled when chat services move in Plan 05. Do NOT address it here.

    **Create re-export shims at old paths:**
    ```typescript
    // src/backend/services/session-data.service.ts (SHIM)
    /**
     * @deprecated Import from '@/backend/domains/session' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export { sessionDataService } from '@/backend/domains/session/data/session-data.service';
    ```

    ```typescript
    // src/backend/services/session-file-logger.service.ts (SHIM)
    /**
     * @deprecated Import from '@/backend/domains/session' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export { sessionFileLogger, SessionFileLogger } from '@/backend/domains/session/logging/session-file-logger.service';
    ```

    Run `pnpm typecheck` to verify.
    Run `pnpm test` for full suite.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test` passes (full suite).
    session-data.service.ts at new location. session-file-logger.service.ts at new location with test.
    Re-export shims at old paths.
  </verify>
  <done>
    session-data.service.ts lives at domains/session/data/. session-file-logger.service.ts lives at domains/session/logging/. Re-export shims at old paths. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test` passes (full suite)
- All session lifecycle, data, and logging files live in their respective domain subdirectories
- src/backend/services/ session files contain only re-export shims
- Lifecycle services use intra-domain relative imports to claude/ and session-domain.service
</verification>

<success_criteria>
Session lifecycle services, data service, and file logger are migrated to the session domain. All use intra-domain imports. Old paths have re-export shims. Full test suite passes.
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-domain-consolidation/02-04-SUMMARY.md`
</output>

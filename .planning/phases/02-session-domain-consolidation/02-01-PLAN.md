---
phase: 02-session-domain-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/domains/session/claude/types.ts
  - src/backend/domains/session/claude/types/process-types.ts
  - src/backend/domains/session/claude/constants.ts
  - src/backend/domains/session/claude/protocol.ts
  - src/backend/domains/session/claude/protocol-io.ts
  - src/backend/domains/session/claude/protocol.test.ts
  - src/backend/domains/session/claude/types.test.ts
  - src/backend/domains/session/claude/registry.ts
  - src/backend/domains/session/claude/index.ts
  - src/backend/claude/types.ts
  - src/backend/claude/types/process-types.ts
  - src/backend/claude/constants.ts
  - src/backend/claude/protocol.ts
  - src/backend/claude/protocol-io.ts
  - src/backend/claude/registry.ts
autonomous: true

must_haves:
  truths:
    - "Claude protocol types, constants, and Zod schemas are accessible from domains/session/claude/"
    - "Protocol layer (NDJSON handler, IO adapter) compiles from new location"
    - "ProcessRegistry is an instance-based class with no module-level Map (DOM-04)"
    - "All existing consumers continue to compile via re-export shims at old paths"
    - "pnpm typecheck passes after all moves"
  artifacts:
    - path: "src/backend/domains/session/claude/types.ts"
      provides: "Claude protocol types and Zod schemas"
      contains: "ClaudeJson"
    - path: "src/backend/domains/session/claude/types/process-types.ts"
      provides: "Process status and resource types"
      contains: "ProcessStatus"
    - path: "src/backend/domains/session/claude/constants.ts"
      provides: "Timeout and limit constants"
    - path: "src/backend/domains/session/claude/protocol.ts"
      provides: "ClaudeProtocol NDJSON handler"
      contains: "class ClaudeProtocol"
    - path: "src/backend/domains/session/claude/protocol-io.ts"
      provides: "Protocol IO adapter"
    - path: "src/backend/domains/session/claude/registry.ts"
      provides: "Instance-based ProcessRegistry class (DOM-04)"
      contains: "class ProcessRegistry"
    - path: "src/backend/claude/types.ts"
      provides: "Re-export shim for backward compatibility"
    - path: "src/backend/claude/registry.ts"
      provides: "Re-export shim wrapping ProcessRegistry as free functions"
  key_links:
    - from: "src/backend/domains/session/claude/protocol.ts"
      to: "src/backend/domains/session/claude/types.ts"
      via: "relative import"
      pattern: "from './types'"
    - from: "src/backend/domains/session/claude/protocol.ts"
      to: "src/backend/domains/session/claude/protocol-io.ts"
      via: "relative import"
      pattern: "from './protocol-io'"
    - from: "src/backend/claude/types.ts"
      to: "src/backend/domains/session/claude/types.ts"
      via: "re-export shim"
      pattern: "export .* from '@/backend/domains/session/claude/types'"
---

<objective>
Move the foundational claude/ types, constants, protocol layer, and registry into the session domain, and refactor the registry to eliminate global state (DOM-04).

Purpose: These are the lowest-dependency files in the claude/ directory. Everything else (process, permissions, client) depends on them. Moving them first establishes the session domain's claude/ subdirectory and validates the move + shim pattern before tackling higher-layer files.

Output: `src/backend/domains/session/claude/` subdirectory with types, protocol, and registry. Re-export shims at all old paths. DOM-04 registry refactoring complete.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-session-domain-consolidation/02-RESEARCH.md
@src/backend/claude/types.ts
@src/backend/claude/types/process-types.ts
@src/backend/claude/constants.ts
@src/backend/claude/protocol.ts
@src/backend/claude/protocol-io.ts
@src/backend/claude/registry.ts
@src/backend/claude/types.test.ts
@src/backend/claude/protocol.test.ts
@src/backend/domains/session/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move types, constants, and protocol layer to session domain</name>
  <files>
    src/backend/domains/session/claude/types.ts
    src/backend/domains/session/claude/types/process-types.ts
    src/backend/domains/session/claude/constants.ts
    src/backend/domains/session/claude/protocol.ts
    src/backend/domains/session/claude/protocol-io.ts
    src/backend/domains/session/claude/protocol.test.ts
    src/backend/domains/session/claude/types.test.ts
    src/backend/claude/types.ts
    src/backend/claude/types/process-types.ts
    src/backend/claude/constants.ts
    src/backend/claude/protocol.ts
    src/backend/claude/protocol-io.ts
  </files>
  <action>
    Create subdirectory `src/backend/domains/session/claude/` and `src/backend/domains/session/claude/types/`.

    **Move files (copy content, update internal imports):**

    1. Copy `src/backend/claude/types.ts` -> `src/backend/domains/session/claude/types.ts`. Internal imports: this file has no internal imports to claude/ (it imports from `zod` only). No changes needed to the file content.

    2. Copy `src/backend/claude/types/process-types.ts` -> `src/backend/domains/session/claude/types/process-types.ts`. No internal imports to update.

    3. Copy `src/backend/claude/constants.ts` -> `src/backend/domains/session/claude/constants.ts`. No internal imports to update.

    4. Copy `src/backend/claude/protocol-io.ts` -> `src/backend/domains/session/claude/protocol-io.ts`. This file imports from `./types` -- these relative imports remain valid in the new location. No changes needed.

    5. Copy `src/backend/claude/protocol.ts` -> `src/backend/domains/session/claude/protocol.ts`. This file imports from `./types`, `./protocol-io`, `./constants` -- all relative, all remain valid. It also imports `createLogger` from `../services/logger.service` -- update this to `@/backend/services/logger.service` (absolute path alias).

    6. Copy `src/backend/claude/types.test.ts` -> `src/backend/domains/session/claude/types.test.ts`. Update import from `./types` to remain as `./types` (relative is fine since test is co-located).

    7. Copy `src/backend/claude/protocol.test.ts` -> `src/backend/domains/session/claude/protocol.test.ts`. Update any imports from `./protocol`, `./types`, etc. to remain relative. Update any `vi.mock` paths if they reference absolute paths -- the mocks should use the new file locations.

    **Create re-export shims at old paths:**

    8. Replace `src/backend/claude/types.ts` with:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/session/claude/types' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export * from '@/backend/domains/session/claude/types';
    ```

    9. Replace `src/backend/claude/types/process-types.ts` with:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/session/claude/types/process-types' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export * from '@/backend/domains/session/claude/types/process-types';
    ```

    10. Replace `src/backend/claude/constants.ts` with:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/session/claude/constants' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export * from '@/backend/domains/session/claude/constants';
    ```

    11. Replace `src/backend/claude/protocol.ts` with:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/session/claude/protocol' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export * from '@/backend/domains/session/claude/protocol';
    ```

    12. Replace `src/backend/claude/protocol-io.ts` with:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/session/claude/protocol-io' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export * from '@/backend/domains/session/claude/protocol-io';
    ```

    **Important:** Do NOT move test files out of the old location. The old test files (`types.test.ts`, `protocol.test.ts`) at `src/backend/claude/` should be deleted since the tests now live at the new location. But only delete them AFTER verifying the new tests work.

    Run `pnpm typecheck` after all moves to verify compilation.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/session/claude/types.test.ts src/backend/domains/session/claude/protocol.test.ts` passes.
    Old import paths still resolve (shims work): grep for imports of `../claude/types` or `@/backend/claude/types` in the codebase and verify they compile.
  </verify>
  <done>
    types.ts, types/process-types.ts, constants.ts, protocol.ts, protocol-io.ts live at src/backend/domains/session/claude/ with co-located tests. Re-export shims exist at all old paths. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor registry to instance-based ProcessRegistry class (DOM-04) and move to session domain</name>
  <files>
    src/backend/domains/session/claude/registry.ts
    src/backend/claude/registry.ts
  </files>
  <action>
    **Refactor and move `src/backend/claude/registry.ts`:**

    1. Create `src/backend/domains/session/claude/registry.ts` with the instance-based `ProcessRegistry` class. The class should contain:
       - `private readonly processes = new Map<string, RegisteredProcess>()`
       - `register(sessionId, process)` method
       - `unregister(sessionId)` method
       - `get(sessionId)` method returning `RegisteredProcess | undefined`
       - `isProcessWorking(sessionId)` method (move the logic from the free function)
       - `isAnyProcessWorking(sessionIds)` method
       - `getAll()` method returning a new Map copy
       - Export the `RegisteredProcess` interface (copied from the original)
       - Import `ProcessStatus`, `ResourceUsage` from `./types/process-types`

    2. Replace `src/backend/claude/registry.ts` with a **backward-compatible shim** that:
       - Creates a singleton `ProcessRegistry` instance
       - Re-exports free functions (`registerProcess`, `unregisterProcess`, `getProcess`, `isProcessWorking`, `isAnyProcessWorking`, `getAllProcesses`) that delegate to the singleton instance
       - Re-exports the `RegisteredProcess` interface from the new location
       - This ensures all existing consumers (which call free functions) continue to work unchanged
       - Marks everything as `@deprecated`

    The shim at `src/backend/claude/registry.ts` should look like:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/session/claude/registry' instead.
     * This backward-compatible shim will be removed in Phase 9 (Import Rewiring).
     */
    import { ProcessRegistry } from '@/backend/domains/session/claude/registry';
    export type { RegisteredProcess } from '@/backend/domains/session/claude/registry';

    // Singleton instance for backward compatibility with free-function API
    const registry = new ProcessRegistry();

    export function registerProcess(sessionId: string, process: RegisteredProcess): void {
      registry.register(sessionId, process);
    }
    export function unregisterProcess(sessionId: string): void {
      registry.unregister(sessionId);
    }
    export function getProcess(sessionId: string): RegisteredProcess | undefined {
      return registry.get(sessionId);
    }
    export function isProcessWorking(sessionId: string): boolean {
      return registry.isProcessWorking(sessionId);
    }
    export function isAnyProcessWorking(sessionIds: string[]): boolean {
      return registry.isAnyProcessWorking(sessionIds);
    }
    export function getAllProcesses(): Map<string, RegisteredProcess> {
      return registry.getAll();
    }
    ```

    **Important:** The `RegisteredProcess` import in the shim needs to import the type from the new location for the function signatures. Use `import type` for the type re-export.

    Run `pnpm typecheck` to verify.
  </action>
  <verify>
    `pnpm typecheck` passes.
    The new `ProcessRegistry` class at `src/backend/domains/session/claude/registry.ts` has no module-level Map (DOM-04 satisfied).
    The old `src/backend/claude/registry.ts` is a shim that delegates to the new class.
    Existing consumers (e.g., `src/backend/claude/process.ts` which calls `registerProcess()`) still compile.
  </verify>
  <done>
    ProcessRegistry is an instance-based class at src/backend/domains/session/claude/registry.ts. Module-level Map eliminated (DOM-04). Backward-compatible free-function shim at old path. pnpm typecheck passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test src/backend/domains/session/claude/` passes (moved tests)
- `pnpm test src/backend/claude/` passes (existing tests that import from shims)
- No module-level `const activeProcesses = new Map()` exists in the codebase (DOM-04)
- Re-export shims exist at: claude/types.ts, claude/types/process-types.ts, claude/constants.ts, claude/protocol.ts, claude/protocol-io.ts, claude/registry.ts
</verification>

<success_criteria>
Types, constants, protocol layer, and registry are established at src/backend/domains/session/claude/. The ProcessRegistry is instance-based (DOM-04). All existing code compiles via re-export shims. pnpm typecheck passes.
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-domain-consolidation/02-01-SUMMARY.md`
</output>

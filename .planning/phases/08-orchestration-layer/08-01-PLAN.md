---
phase: 08-orchestration-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/orchestration/index.ts
  - src/backend/orchestration/types.ts
  - src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts
  - src/backend/domains/workspace/index.ts
autonomous: true

must_haves:
  truths:
    - "worktree-lifecycle.service.ts no longer imports from session, github, run-script, or terminal domains"
    - "initializeWorkspaceWorktree and archiveWorkspace functions exist in orchestration layer"
    - "WorktreeLifecycleService retains pure worktree operations (cleanupWorkspaceWorktree, setInitMode, getInitMode)"
  artifacts:
    - path: "src/backend/orchestration/index.ts"
      provides: "Orchestration barrel file"
    - path: "src/backend/orchestration/types.ts"
      provides: "Shared bridge/callback interfaces for cross-domain injection"
    - path: "src/backend/orchestration/workspace-init.orchestrator.ts"
      provides: "initializeWorkspaceWorktree orchestration flow"
    - path: "src/backend/orchestration/workspace-archive.orchestrator.ts"
      provides: "archiveWorkspace orchestration flow"
  key_links:
    - from: "src/backend/orchestration/workspace-init.orchestrator.ts"
      to: "@/backend/domains/session"
      via: "barrel import for sessionService, sessionDomainService, chatMessageHandlerService"
      pattern: "from '@/backend/domains/session'"
    - from: "src/backend/orchestration/workspace-init.orchestrator.ts"
      to: "@/backend/domains/workspace"
      via: "barrel import for worktreeLifecycleService, workspaceStateMachine"
      pattern: "from '@/backend/domains/workspace'"
    - from: "src/backend/orchestration/workspace-archive.orchestrator.ts"
      to: "@/backend/domains/run-script"
      via: "barrel import for runScriptService"
      pattern: "from '@/backend/domains/run-script'"
---

<objective>
Extract cross-domain orchestration logic from worktree-lifecycle.service.ts into dedicated orchestrator files.

Purpose: worktree-lifecycle.service.ts is the "god service" with imports from 6 domains (session, github, run-script, terminal, workspace-state-machine, and its own workspace domain). This plan extracts `initializeWorkspaceWorktree` and `archiveWorkspace` (including all their helper functions) into orchestrator files, leaving WorktreeLifecycleService as a pure worktree manager.

Output: `src/backend/orchestration/workspace-init.orchestrator.ts`, `src/backend/orchestration/workspace-archive.orchestrator.ts`, `src/backend/orchestration/types.ts`, `src/backend/orchestration/index.ts`, and a cleaned-up `worktree-lifecycle.service.ts`.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-orchestration-layer/08-RESEARCH.md
@src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts
@src/backend/domains/workspace/index.ts
@src/backend/domains/session/index.ts
@src/backend/domains/github/index.ts
@src/backend/domains/run-script/index.ts
@src/backend/domains/terminal/index.ts
@src/backend/trpc/workspace/init.trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create orchestration directory and extract workspace-init orchestrator</name>
  <files>
    src/backend/orchestration/workspace-init.orchestrator.ts
    src/backend/orchestration/workspace-archive.orchestrator.ts
    src/backend/orchestration/types.ts
    src/backend/orchestration/index.ts
  </files>
  <action>
Create `src/backend/orchestration/` directory with:

1. **`types.ts`** - Shared type used by both orchestrators:
   - `WorkspaceWithProject` type (currently in worktree-lifecycle.service.ts as a local type alias)

2. **`workspace-init.orchestrator.ts`** - Move these functions FROM worktree-lifecycle.service.ts:
   - `buildInitialPromptFromGitHubIssue` (uses github domain)
   - `startDefaultClaudeSession` (uses session domain + github domain)
   - `runFactorySetupScriptIfConfigured` (uses run-script + session domains)
   - `runProjectStartupScriptIfConfigured` (uses run-script + session domains)
   - `startProvisioningOrLog` (uses workspace domain)
   - `getWorkspaceWithProjectOrThrow` (pure accessor call)
   - `readFactoryConfigSafe` (pure utility)
   - `handleWorkspaceInitFailure` (uses workspace + session domains)
   - The `initializeWorkspaceWorktree` function itself (the main flow)

   Imports should come from domain barrel files:
   - `import { sessionService, sessionDomainService, chatMessageHandlerService } from '@/backend/domains/session'`
   - `import { worktreeLifecycleService, workspaceStateMachine } from '@/backend/domains/workspace'`
   - `import { githubCLIService } from '@/backend/domains/github'`
   - `import { startupScriptService } from '@/backend/domains/run-script'`
   - Infrastructure imports from `@/backend/services/` stay as-is (logger, factory-config)
   - Resource accessors from `@/backend/resource_accessors/` stay as-is

   The orchestrator exports a standalone `initializeWorkspaceWorktree(workspaceId, options?)` function. Note: this function currently lives on the `WorktreeLifecycleService` class but can become a standalone function because it only uses `this` for `getInitMode`, `getCachedGitHubUsername`, and `clearInitMode`. Solve this by importing `worktreeLifecycleService` singleton from the workspace barrel and calling `worktreeLifecycleService.getInitMode(...)` etc. The `getCachedGitHubUsername` method should be moved to the orchestrator file as a module-level cached helper (it caches `githubCLIService.getAuthenticatedUsername()` -- this is cross-domain logic anyway).

3. **`workspace-archive.orchestrator.ts`** - Move the `archiveWorkspace` method FROM worktree-lifecycle.service.ts:
   - `archiveWorkspace(workspace, options)` function
   - The private `handleGitHubIssueOnArchive(workspace)` helper

   Imports from domain barrels:
   - `import { sessionService } from '@/backend/domains/session'`
   - `import { worktreeLifecycleService, workspaceStateMachine } from '@/backend/domains/workspace'`
   - `import { githubCLIService } from '@/backend/domains/github'`
   - `import { runScriptService } from '@/backend/domains/run-script'`
   - `import { terminalService } from '@/backend/domains/terminal'`

   Export a standalone `archiveWorkspace(workspace, options)` function.

4. **`index.ts`** - Barrel file for orchestration layer:
   ```typescript
   // Orchestration layer
   // Bridges cross-domain flows. Imports from domain barrels only.
   export { archiveWorkspace } from './workspace-archive.orchestrator';
   export { initializeWorkspaceWorktree } from './workspace-init.orchestrator';
   ```

IMPORTANT: The `TRPCError` import in the archive flow's validation (`isValidTransition` check) should stay -- it's fine for orchestrators to throw TRPCError since they're called from tRPC handlers.

IMPORTANT: Keep the `workspaceStateMachine.isValidTransition()` call in the archive orchestrator (not move it to workspace domain). The orchestrator validates the transition as part of the flow coordination.
  </action>
  <verify>
Run `pnpm typecheck` -- the new orchestrator files should compile. The worktree-lifecycle.service.ts has NOT been modified yet (that's Task 2), so it still compiles too.
  </verify>
  <done>
The orchestration directory exists with workspace-init.orchestrator.ts and workspace-archive.orchestrator.ts. Both export standalone functions. Both import exclusively from domain barrel files (not from services/ shims or direct domain paths). The barrel file re-exports both functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Strip extracted logic from worktree-lifecycle.service.ts and update callers</name>
  <files>
    src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts
    src/backend/domains/workspace/index.ts
    src/backend/trpc/workspace/init.trpc.ts
    src/backend/services/worktree-lifecycle.service.ts
    src/backend/domains/ratchet/reconciliation.service.ts
  </files>
  <action>
1. **Clean up worktree-lifecycle.service.ts**: Remove all extracted functions and methods:
   - Remove `buildInitialPromptFromGitHubIssue`, `startDefaultClaudeSession`
   - Remove `runFactorySetupScriptIfConfigured`, `runProjectStartupScriptIfConfigured`
   - Remove `startProvisioningOrLog`, `getWorkspaceWithProjectOrThrow`, `readFactoryConfigSafe`
   - Remove `handleWorkspaceInitFailure`
   - Remove `initializeWorkspaceWorktree` method from class
   - Remove `archiveWorkspace` method from class
   - Remove `handleGitHubIssueOnArchive` private method from class
   - Remove `cachedGitHubUsername` instance field and `getCachedGitHubUsername` method

   After cleanup, the `WorktreeLifecycleService` class should ONLY contain:
   - `initModes` Map + `resumeModeLocks` Map (instance fields)
   - `withResumeModeLock`, `updateResumeModes` (private helpers)
   - `setInitMode`, `getInitMode`, `clearInitMode` (public API)
   - `cleanupWorkspaceWorktree` (pure worktree git ops)

   The remaining standalone exports should be:
   - `WorktreePathSafetyError` class
   - `assertWorktreePathSafe` function
   - `readResumeModes` / `writeResumeModes` (module-level helpers)
   - `worktreeLifecycleService` singleton

   Remove these now-unnecessary imports:
   - `SessionStatus` from prisma
   - `chatMessageHandlerService` from services
   - `githubCLIService` from services
   - `runScriptService` from services
   - `sessionService` from services
   - `sessionDomainService` from services
   - `startupScriptService` from services
   - `terminalService` from services
   - `claudeSessionAccessor` from resource_accessors
   - `MessageState`, `resolveSelectedModel` from shared/claude
   - `resumeModesSchema` can stay (still used by readResumeModes)
   - `TRPCError` from trpc/server (no longer needed since archiveWorkspace moved)

   Keep these imports (still needed for remaining functionality):
   - `fs`, `path` (file operations for resume modes)
   - `writeFileAtomic` (for resume modes)
   - `pathExists` (for cleanupWorkspaceWorktree)
   - `FileLockMutex` (for resume modes locking)
   - `workspaceAccessor` (for getInitMode and cleanupWorkspaceWorktree)
   - `gitOpsService` (for cleanupWorkspaceWorktree)
   - `createLogger` (logging)
   - `workspaceStateMachine` from services shim (for startProvisioning in... wait, that moved. Only needed if cleanupWorkspaceWorktree calls it -- it doesn't. Remove this import.)

   Actually, double-check: `workspaceStateMachine` is used in `startProvisioningOrLog` (moved) and `archiveWorkspace` (moved) and `handleWorkspaceInitFailure` (moved). The remaining `cleanupWorkspaceWorktree` does NOT use it. So remove the `workspaceStateMachine` import too.

   Also `FactoryConfigService` was only used in `readFactoryConfigSafe` (moved). Remove that import.

2. **Update workspace barrel** (`index.ts`): The barrel currently exports `worktreeLifecycleService`, `assertWorktreePathSafe`, `WorktreePathSafetyError` from worktree-lifecycle. This stays the same -- `initializeWorkspaceWorktree` and `archiveWorkspace` are now exported from orchestration barrel, not workspace barrel.

3. **Update init.trpc.ts**: Change the `initializeWorkspaceWorktree` function to import from orchestration:
   ```typescript
   import { initializeWorkspaceWorktree } from '@/backend/orchestration';
   ```
   Remove the old local wrapper function that delegates to `worktreeLifecycleService.initializeWorkspaceWorktree()`. The function is now directly imported from orchestration. The tRPC routes that call it stay unchanged.

   Also update any other imports in init.trpc.ts that reference worktree-lifecycle -- keep the `setWorkspaceInitMode`, `getWorkspaceInitMode` imports from the shim (they delegate to `worktreeLifecycleService`).

4. **Update reconciliation.service.ts**: Change the import from:
   ```typescript
   import { initializeWorkspaceWorktree } from '@/backend/trpc/workspace/init.trpc';
   ```
   to:
   ```typescript
   import { initializeWorkspaceWorktree } from '@/backend/orchestration';
   ```
   This fixes the layer violation (domain importing from tRPC layer) identified in the research.

5. **Update worktree-lifecycle shim** (`src/backend/services/worktree-lifecycle.service.ts`): Check if the shim re-exports `initializeWorkspaceWorktree` or `archiveWorkspace`. If so, update those re-exports to come from orchestration. Keep the shim's re-exports of `worktreeLifecycleService`, `setWorkspaceInitMode`, `getWorkspaceInitMode`, `assertWorktreePathSafe` pointing to the workspace domain.
  </action>
  <verify>
Run `pnpm typecheck` to verify all imports resolve. Run `pnpm test` to verify no regressions. Check that worktree-lifecycle.service.ts no longer imports from any cross-domain services (grep for `@/backend/services/session`, `@/backend/services/github`, `@/backend/services/terminal`, `@/backend/services/run-script`, `@/backend/services/startup-script`, `@/backend/services/chat-message-handlers`).
  </verify>
  <done>
worktree-lifecycle.service.ts is a pure worktree manager with zero cross-domain imports. reconciliation.service.ts imports from orchestration (no more tRPC layer violation). init.trpc.ts imports from orchestration. All tests pass and typecheck is clean.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm test` passes
- `grep -r "from '@/backend/services/session" src/backend/domains/workspace/worktree/` returns no matches
- `grep -r "from '@/backend/services/github" src/backend/domains/workspace/worktree/` returns no matches
- `grep -r "from '@/backend/services/terminal" src/backend/domains/workspace/worktree/` returns no matches
- `grep -r "from '@/backend/services/run-script" src/backend/domains/workspace/worktree/` returns no matches
- `grep -r "from '@/backend/services/startup-script" src/backend/domains/workspace/worktree/` returns no matches
- `grep -r "from '@/backend/services/chat-message-handlers" src/backend/domains/workspace/worktree/` returns no matches
- `grep -r "from '@/backend/trpc/" src/backend/domains/ratchet/` returns no matches (reconciliation layer violation fixed)
- `src/backend/orchestration/` directory exists with barrel file
</verification>

<success_criteria>
worktree-lifecycle.service.ts has zero cross-domain imports. Orchestration directory exists with workspace-init and workspace-archive orchestrators. reconciliation.service.ts no longer imports from tRPC layer. All tests pass. Typecheck clean.
</success_criteria>

<output>
After completion, create `.planning/phases/08-orchestration-layer/08-01-SUMMARY.md`
</output>

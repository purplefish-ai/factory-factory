---
phase: 08-orchestration-layer
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/backend/orchestration/ratchet-bridges.orchestrator.ts
  - src/backend/orchestration/index.ts
  - src/backend/domains/workspace/query/workspace-query.service.ts
  - src/backend/domains/workspace/state/kanban-state.ts
  - src/backend/domains/github/pr-review-fixer.service.ts
  - src/backend/domains/github/pr-snapshot.service.ts
autonomous: true

must_haves:
  truths:
    - "Ratchet bridges are wired at startup via orchestration function"
    - "workspace-query.service.ts no longer imports from session, github, or pr-snapshot via shims"
    - "kanban-state.ts no longer imports sessionService"
    - "pr-review-fixer.service.ts no longer imports from session or fixer-session via shims"
    - "pr-snapshot.service.ts no longer imports from kanban-state via shim"
  artifacts:
    - path: "src/backend/orchestration/ratchet-bridges.orchestrator.ts"
      provides: "Startup function that wires ratchet bridges from domain singletons"
      exports: ["configureRatchetBridges"]
    - path: "src/backend/domains/workspace/query/workspace-query.service.ts"
      provides: "WorkspaceQueryService with callback-injected cross-domain deps"
    - path: "src/backend/domains/workspace/state/kanban-state.ts"
      provides: "KanbanStateService with callback parameter for isAnySessionWorking"
  key_links:
    - from: "src/backend/orchestration/ratchet-bridges.orchestrator.ts"
      to: "@/backend/domains/session"
      via: "imports sessionService to build RatchetSessionBridge"
      pattern: "from '@/backend/domains/session'"
    - from: "src/backend/orchestration/ratchet-bridges.orchestrator.ts"
      to: "@/backend/domains/ratchet"
      via: "imports ratchetService.configure() to inject bridges"
      pattern: "from '@/backend/domains/ratchet'"
---

<objective>
Wire ratchet bridges via orchestration and remove remaining cross-domain imports from workspace and github domains.

Purpose: After Plans 01 and 02, the worktree-lifecycle and ratchet services are clean. This plan (1) creates the ratchet bridge wiring orchestrator so bridges actually get injected at startup, and (2) tackles the remaining cross-domain violations in workspace-query, kanban-state, pr-review-fixer, and pr-snapshot.

Output: ratchet-bridges.orchestrator.ts for startup wiring, plus cleaned workspace and github domain files.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-orchestration-layer/08-RESEARCH.md
@src/backend/domains/workspace/query/workspace-query.service.ts
@src/backend/domains/workspace/state/kanban-state.ts
@src/backend/domains/github/pr-review-fixer.service.ts
@src/backend/domains/github/pr-snapshot.service.ts
@src/backend/domains/ratchet/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ratchet bridge wiring orchestrator</name>
  <files>
    src/backend/orchestration/ratchet-bridges.orchestrator.ts
    src/backend/orchestration/index.ts
  </files>
  <action>
Create `src/backend/orchestration/ratchet-bridges.orchestrator.ts` that wires the ratchet domain's bridge interfaces at startup:

```typescript
/**
 * Ratchet Bridge Wiring
 *
 * Configures ratchet domain services with their cross-domain dependencies.
 * Called once at application startup (from app-context or server init).
 */
import { sessionService, sessionDomainService } from '@/backend/domains/session';
import { githubCLIService } from '@/backend/domains/github';
import {
  ratchetService,
  fixerSessionService,
  ciFixerService,
  ciMonitorService,
  type RatchetSessionBridge,
  type RatchetGitHubBridge,
} from '@/backend/domains/ratchet';

export function configureRatchetBridges(): void {
  const sessionBridge: RatchetSessionBridge = {
    isSessionRunning: (id) => sessionService.isSessionRunning(id),
    isSessionWorking: (id) => sessionService.isSessionWorking(id),
    isAnySessionWorking: (ids) => sessionService.isAnySessionWorking(ids),
    stopClaudeSession: (id) => sessionService.stopClaudeSession(id),
    startClaudeSession: (id, opts) => sessionService.startClaudeSession(id, opts),
    getClient: (id) => sessionService.getClient(id),
    injectCommittedUserMessage: (id, msg) => sessionDomainService.injectCommittedUserMessage(id, msg),
  };

  const githubBridge: RatchetGitHubBridge = {
    extractPRInfo: (url) => githubCLIService.extractPRInfo(url),
    getPRFullDetails: (repo, pr) => githubCLIService.getPRFullDetails(repo, pr),
    getReviewComments: (repo, pr) => githubCLIService.getReviewComments(repo, pr),
    computeCIStatus: (checks) => githubCLIService.computeCIStatus(checks),
    getAuthenticatedUsername: () => githubCLIService.getAuthenticatedUsername(),
  };

  // Wire all ratchet services
  ratchetService.configure({ session: sessionBridge, github: githubBridge });
  fixerSessionService.configure({ session: sessionBridge });
  ciFixerService.configure({ session: sessionBridge });
  ciMonitorService.configure({ session: sessionBridge, github: githubBridge });
}
```

Adjust the bridge construction based on whatever bridge interfaces and configure() signatures were defined in Plan 02. The key principle: this file imports from domain barrels only and wires bridges into ratchet services.

Update `src/backend/orchestration/index.ts` to add the export:
```typescript
export { configureRatchetBridges } from './ratchet-bridges.orchestrator';
```

NOTE: This function will be called by app-context or server startup code. That wiring happens in Phase 9 (import rewiring). For now, we need the function to exist and be callable. To avoid breaking runtime, check where ratchet services are currently started (likely in app-context.ts or a startup file) and add a `configureRatchetBridges()` call right before the ratchet services are started. Read `src/backend/app-context.ts` or the server startup to find where `ratchetService.start()` is called and add `configureRatchetBridges()` before it. Import from `@/backend/orchestration`.
  </action>
  <verify>
Run `pnpm typecheck` -- ratchet-bridges.orchestrator.ts compiles and bridge types match. Run `pnpm test` -- ratchet services get their bridges wired and tests pass.
  </verify>
  <done>
configureRatchetBridges() exists in orchestration layer and is wired into app startup. Ratchet services receive their cross-domain capabilities via typed bridges.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove cross-domain imports from workspace-query, kanban-state, pr-review-fixer, and pr-snapshot</name>
  <files>
    src/backend/domains/workspace/query/workspace-query.service.ts
    src/backend/domains/workspace/state/kanban-state.ts
    src/backend/domains/workspace/bridges.ts
    src/backend/domains/workspace/index.ts
    src/backend/domains/github/pr-review-fixer.service.ts
    src/backend/domains/github/pr-snapshot.service.ts
    src/backend/domains/github/bridges.ts
    src/backend/domains/github/index.ts
  </files>
  <action>
**A. Workspace domain cross-domain removals:**

1. **Create `src/backend/domains/workspace/bridges.ts`** with bridge interfaces:

```typescript
/** Session capabilities needed by workspace domain */
export interface WorkspaceSessionBridge {
  isAnySessionWorking(sessionIds: string[]): boolean;
  getAllPendingRequests(): Map<string, { toolName: string }>;
}

/** GitHub capabilities needed by workspace domain */
export interface WorkspaceGitHubBridge {
  checkHealth(): Promise<{ isInstalled: boolean; isAuthenticated: boolean }>;
  listReviewRequests(): Promise<Array<{ reviewDecision: string }>>;
}

/** PR snapshot capability needed by workspace domain */
export interface WorkspacePRSnapshotBridge {
  refreshWorkspace(workspaceId: string, prUrl: string): Promise<{ success: boolean; snapshot?: { prNumber: number; prState: string } }>;
}
```

2. **Refactor `kanban-state.ts`**:
   - Remove `import { sessionService } from '@/backend/services/session.service'`
   - The `KanbanStateService.getWorkspaceKanbanState()` method calls `sessionService.isAnySessionWorking(sessionIds)`. Add a `private sessionBridge: WorkspaceSessionBridge | null = null` field and `configure()` method (same pattern as ratchet).
   - Replace `sessionService.isAnySessionWorking(sessionIds)` with `this.session.isAnySessionWorking(sessionIds)`
   - The `computeKanbanColumn` pure function does NOT use sessionService -- leave it as-is
   - The `getWorkspacesKanbanStates` method takes `workingStatusMap` as a parameter (already clean -- no session import needed)
   - `updateCachedKanbanColumn` and `updateCachedKanbanColumns` don't use sessionService directly -- they derive from flow-state only

3. **Refactor `workspace-query.service.ts`**:
   - Remove these cross-domain imports:
     - `chatEventForwarderService` from `@/backend/services/chat-event-forwarder.service`
     - `githubCLIService` from `@/backend/services/github-cli.service`
     - `prSnapshotService` from `@/backend/services/pr-snapshot.service`
     - `sessionService` from `@/backend/services/session.service`
   - Add bridge fields and `configure()` method:
     - `private sessionBridge: WorkspaceSessionBridge | null`
     - `private githubBridge: WorkspaceGitHubBridge | null`
     - `private prSnapshotBridge: WorkspacePRSnapshotBridge | null`
   - Replace `sessionService.isAnySessionWorking(sessionIds)` with `this.session.isAnySessionWorking(sessionIds)`
   - Replace `chatEventForwarderService.getAllPendingRequests()` with `this.session.getAllPendingRequests()` (add to WorkspaceSessionBridge)
   - Replace `githubCLIService.checkHealth()` and `githubCLIService.listReviewRequests()` with `this.github.checkHealth()` and `this.github.listReviewRequests()`
   - Replace `prSnapshotService.refreshWorkspace(...)` with `this.prSnapshot.refreshWorkspace(...)`
   - Keep infrastructure imports: `FactoryConfigService`, `gitOpsService`, `createLogger`
   - Keep resource_accessor imports

4. **Export bridge types from workspace barrel**:
   ```typescript
   export type { WorkspaceSessionBridge, WorkspaceGitHubBridge, WorkspacePRSnapshotBridge } from './bridges';
   ```

**B. GitHub domain cross-domain removals:**

5. **Create `src/backend/domains/github/bridges.ts`**:

```typescript
/** Session capabilities needed by GitHub domain */
export interface GitHubSessionBridge {
  isSessionWorking(sessionId: string): boolean;
  getClient(sessionId: string): { isRunning(): boolean; sendMessage(msg: string): Promise<void> } | null;
}

/** Fixer session capability needed by GitHub domain */
export interface GitHubFixerBridge {
  acquireAndDispatch(input: AcquireAndDispatchInput): Promise<AcquireAndDispatchResult>;
  getActiveSession(workspaceId: string, workflow: string): Promise<{ id: string; status: string } | null>;
}

/** Kanban state capability needed by GitHub domain */
export interface GitHubKanbanBridge {
  updateCachedKanbanColumn(workspaceId: string): Promise<void>;
}
```

Define the `AcquireAndDispatchInput`/`Result` types locally or import from ratchet barrel (actually, importing from ratchet barrel would create a cross-domain dep from github -> ratchet). Instead, define the minimal types locally in github/bridges.ts.

6. **Refactor `pr-review-fixer.service.ts`**:
   - Remove `fixerSessionService` import from `@/backend/services/fixer-session.service`
   - Remove `sessionService` import from `@/backend/services/session.service`
   - Add bridge fields: `private sessionBridge: GitHubSessionBridge | null`, `private fixerBridge: GitHubFixerBridge | null`
   - Add `configure()` method
   - Replace `fixerSessionService.acquireAndDispatch(...)` with `this.fixer.acquireAndDispatch(...)`
   - Replace `sessionService.isSessionWorking(...)` with `this.session.isSessionWorking(...)`
   - Replace `sessionService.getClient(...)` with `this.session.getClient(...)`
   - Replace `fixerSessionService.getActiveSession(...)` with `this.fixer.getActiveSession(...)`

7. **Refactor `pr-snapshot.service.ts`**:
   - Remove `kanbanStateService` import from `@/backend/services/kanban-state.service`
   - Add bridge field: `private kanbanBridge: GitHubKanbanBridge | null`
   - Add `configure()` method
   - Replace `kanbanStateService.updateCachedKanbanColumn(workspaceId)` with `this.kanban.updateCachedKanbanColumn(workspaceId)`

8. **Export bridge types from github barrel**:
   ```typescript
   export type { GitHubSessionBridge, GitHubFixerBridge, GitHubKanbanBridge } from './bridges';
   ```

**C. Update tests** for workspace-query and github services if they mock the removed imports.
  </action>
  <verify>
Run `pnpm typecheck`. Run `pnpm test`. Verify with grep:
- `grep -r "from '@/backend/services/session" src/backend/domains/workspace/` returns no matches
- `grep -r "from '@/backend/services/github" src/backend/domains/workspace/` returns no matches
- `grep -r "from '@/backend/services/pr-snapshot" src/backend/domains/workspace/` returns no matches
- `grep -r "from '@/backend/services/chat-event-forwarder" src/backend/domains/workspace/` returns no matches
- `grep -r "from '@/backend/services/session" src/backend/domains/github/` returns no matches
- `grep -r "from '@/backend/services/fixer-session" src/backend/domains/github/` returns no matches
- `grep -r "from '@/backend/services/kanban-state" src/backend/domains/github/` returns no matches
  </verify>
  <done>
workspace-query, kanban-state, pr-review-fixer, and pr-snapshot all have zero cross-domain imports. Bridge types are exported from workspace and github barrels.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm test` passes
- No cross-domain imports remain in workspace or github domain files (verified by grep)
- configureRatchetBridges is called at app startup
- All bridge interfaces are typed and narrow
</verification>

<success_criteria>
Ratchet bridges are wired at startup. workspace-query, kanban-state, pr-review-fixer, and pr-snapshot have zero cross-domain imports. All bridge types exported from respective domain barrels.
</success_criteria>

<output>
After completion, create `.planning/phases/08-orchestration-layer/08-03-SUMMARY.md`
</output>

---
phase: 06-terminal-domain-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/domains/terminal/terminal.service.ts
  - src/backend/domains/terminal/index.ts
  - src/backend/services/terminal.service.ts
  - src/backend/domains/terminal/terminal.service.test.ts
  - src/backend/domains/terminal/terminal-domain-exports.test.ts
autonomous: true

must_haves:
  truths:
    - "All terminal operations flow through src/backend/domains/terminal/"
    - "Existing consumers continue to work via shim at old path"
    - "TERM-02 verified satisfied: all Maps are private instance fields, no module-level mutable state"
    - "Domain has co-located unit tests covering the public API (TERM-03)"
    - "Domain barrel smoke test confirms exports are not undefined"
    - "pnpm typecheck passes"
  artifacts:
    - path: "src/backend/domains/terminal/terminal.service.ts"
      provides: "TerminalService class, terminalService singleton, 5 type exports"
      contains: "class TerminalService"
    - path: "src/backend/domains/terminal/index.ts"
      provides: "Domain barrel with selective named exports"
      exports: ["terminalService", "TerminalService", "TerminalResourceUsage", "TerminalInstance", "CreateTerminalOptions", "CreateTerminalResult", "TerminalOutput"]
    - path: "src/backend/services/terminal.service.ts"
      provides: "Re-export shim for backward compatibility"
      contains: "@deprecated"
    - path: "src/backend/domains/terminal/terminal.service.test.ts"
      provides: "Unit tests for TerminalService public API"
      contains: "describe"
    - path: "src/backend/domains/terminal/terminal-domain-exports.test.ts"
      provides: "Barrel export smoke test"
      contains: "terminalService"
  key_links:
    - from: "src/backend/services/terminal.service.ts"
      to: "src/backend/domains/terminal/terminal.service.ts"
      via: "re-export shim (direct module path, not barrel)"
      pattern: "from '@/backend/domains/terminal/terminal\\.service'"
    - from: "src/backend/domains/terminal/index.ts"
      to: "src/backend/domains/terminal/terminal.service.ts"
      via: "barrel re-export"
      pattern: "from '\\./terminal\\.service'"
    - from: "src/backend/domains/terminal/terminal.service.ts"
      to: "@/backend/services/logger.service"
      via: "cross-domain absolute import"
      pattern: "from '@/backend/services/logger\\.service'"
---

<objective>
Consolidate terminal.service.ts into src/backend/domains/terminal/, create re-export shim, populate barrel, and add co-located unit tests.

Purpose: Complete TERM-01 (terminal domain owns PTY management, output buffering, monitoring), verify TERM-02 (Maps already instance-based), and satisfy TERM-03 (co-located unit tests). This is the simplest domain consolidation: one 544-line file, zero cross-domain imports, seven consumers all transparently handled by shim.

Output: Terminal domain with service, barrel, shim, unit tests, and smoke test.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-terminal-domain-consolidation/06-RESEARCH.md

# Reference patterns from completed domains
@src/backend/domains/github/index.ts
@src/backend/domains/github/github-domain-exports.test.ts
@src/backend/services/github-cli.service.ts

# Source file to move
@src/backend/services/terminal.service.ts

# Current placeholder
@src/backend/domains/terminal/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move terminal.service.ts to domain, create shim, populate barrel</name>
  <files>
    src/backend/domains/terminal/terminal.service.ts
    src/backend/domains/terminal/index.ts
    src/backend/services/terminal.service.ts
  </files>
  <action>
1. Copy `src/backend/services/terminal.service.ts` to `src/backend/domains/terminal/terminal.service.ts`.

2. In the new domain file, update the logger import from relative to absolute:
   - Change: `import { createLogger } from './logger.service';`
   - To: `import { createLogger } from '@/backend/services/logger.service';`
   All other imports (`node:module`, `node-pty` type, `pidusage`) are npm/node builtins and stay as-is.

3. Export the `TerminalService` class alongside the singleton for test isolation. Change `class TerminalService` to `export class TerminalService` (add the `export` keyword). The singleton `export const terminalService = new TerminalService();` stays as-is.

4. Replace `src/backend/services/terminal.service.ts` with a re-export shim. Follow the exact pattern from `src/backend/services/github-cli.service.ts`:
   ```typescript
   /**
    * @deprecated Import from '@/backend/domains/terminal' instead.
    * This re-export shim will be removed in Phase 9 (Import Rewiring).
    */
   export {
     type CreateTerminalOptions,
     type CreateTerminalResult,
     type TerminalInstance,
     type TerminalOutput,
     type TerminalResourceUsage,
     TerminalService,
     terminalService,
   } from '@/backend/domains/terminal/terminal.service';
   ```
   Note: Shim imports from direct module path (`/terminal.service`), NOT from barrel (`/terminal`). This is the established pattern to avoid circular dependency risks.

5. Populate `src/backend/domains/terminal/index.ts` with selective named exports:
   ```typescript
   // Domain: terminal
   // Public API for the terminal domain module.
   // Consumers should import from '@/backend/domains/terminal' only.

   // --- Terminal PTY management, output buffering, and monitoring ---
   export {
     type CreateTerminalOptions,
     type CreateTerminalResult,
     type TerminalInstance,
     type TerminalOutput,
     type TerminalResourceUsage,
     TerminalService,
     terminalService,
   } from './terminal.service';
   ```

6. Run `pnpm typecheck` to verify all consumers still resolve. Expect zero new errors.

7. Run `pnpm check:fix` to let Biome auto-sort imports/exports if needed.
  </action>
  <verify>
    `pnpm typecheck` passes with no new errors.
    `pnpm check:fix` passes.
    `grep -r "from.*services/terminal.service" src/backend/ --include="*.ts" | grep -v node_modules` shows the shim itself plus existing consumers (all still importing from old path, which is now a shim).
  </verify>
  <done>
    terminal.service.ts lives at src/backend/domains/terminal/terminal.service.ts with TerminalService class exported.
    Shim at src/backend/services/terminal.service.ts re-exports all 5 types + class + singleton from direct module path.
    Barrel at src/backend/domains/terminal/index.ts exports the full public API.
    pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create domain unit tests and barrel smoke test (TERM-03)</name>
  <files>
    src/backend/domains/terminal/terminal.service.test.ts
    src/backend/domains/terminal/terminal-domain-exports.test.ts
  </files>
  <action>
1. Create `src/backend/domains/terminal/terminal-domain-exports.test.ts` -- barrel export smoke test following the github domain pattern:
   ```typescript
   import { describe, expect, it } from 'vitest';
   import { terminalService } from './index';

   describe('Terminal domain exports', () => {
     it('exports terminalService as an object', () => {
       expect(terminalService).toBeDefined();
     });
   });
   ```
   Use static import (Biome forbids `await import()`).

2. Create `src/backend/domains/terminal/terminal.service.test.ts` -- unit tests for the TerminalService public API. This is the core TERM-03 deliverable. The test file must:

   a. Mock dependencies BEFORE importing the service:
      - Mock `node:module` so `createRequire` returns a function that, when called with `'node-pty'`, returns `{ spawn: mockPtySpawn }`. The `mockPtySpawn` function returns a mock IPty object with: `pid` (number), `onData` (vi.fn returning `{ dispose: vi.fn() }`), `onExit` (vi.fn returning `{ dispose: vi.fn() }`), `write` (vi.fn), `resize` (vi.fn), `kill` (vi.fn).
      - Mock `pidusage` as `{ default: vi.fn().mockResolvedValue({ cpu: 1.5, memory: 1024 }) }`.
      - Mock `@/backend/services/logger.service` as `{ createLogger: () => ({ info: vi.fn(), debug: vi.fn(), warn: vi.fn(), error: vi.fn() }) }`.

   b. Import `TerminalService` (the class, not the singleton) AFTER mocks are set up.

   c. Create a fresh `TerminalService` instance in `beforeEach` for test isolation. Reset all mocks in `beforeEach`.

   d. Test the following public API methods (at minimum):

   **createTerminal:**
   - Calls node-pty spawn with correct args (shell, cols, rows, cwd, env)
   - Returns { terminalId, pid } on success
   - Registers onData and onExit handlers on the PTY

   **writeToTerminal:**
   - Returns true and calls pty.write when terminal exists
   - Returns false when terminal does not exist

   **resizeTerminal:**
   - Returns true and calls pty.resize when terminal exists
   - Updates stored cols/rows
   - Returns false when terminal does not exist

   **destroyTerminal:**
   - Returns true and calls pty.kill when terminal exists
   - Cleans up listeners and removes from internal maps
   - Returns false when terminal does not exist

   **getTerminal / getTerminalsForWorkspace:**
   - Returns the terminal instance after creation
   - Returns null/empty for unknown workspace

   **onOutput / onExit listeners:**
   - Registers listener and returns unsubscribe function
   - Calling unsubscribe removes the listener

   **destroyWorkspaceTerminals:**
   - Destroys all terminals for a given workspace

   **cleanup:**
   - Destroys all terminals across all workspaces

   **getActiveTerminalCount:**
   - Returns 0 initially, increments after createTerminal

   **setActiveTerminal / getActiveTerminal / clearActiveTerminal:**
   - Set, get, and clear the active terminal for a workspace

   e. Call `service.cleanup()` in `afterEach` to prevent timer leaks from resource monitoring.

   f. Use `vi.useFakeTimers()` if testing resource monitoring intervals, but the core public API tests should not need fake timers.

3. Run `pnpm test src/backend/domains/terminal/` to verify all tests pass.

4. Run `pnpm check:fix` to ensure Biome compliance.
  </action>
  <verify>
    `pnpm test src/backend/domains/terminal/` -- all tests pass.
    `pnpm test` -- full suite passes (no regressions).
    Test file covers at minimum: createTerminal, writeToTerminal, resizeTerminal, destroyTerminal, getTerminal, getTerminalsForWorkspace, onOutput, onExit, destroyWorkspaceTerminals, cleanup, getActiveTerminalCount, setActiveTerminal, getActiveTerminal, clearActiveTerminal.
  </verify>
  <done>
    terminal.service.test.ts exists with tests covering all 15 public API methods of TerminalService.
    terminal-domain-exports.test.ts exists verifying barrel exports are not undefined.
    All tests pass. Full test suite has no regressions.
    TERM-03 (co-located unit tests covering public API) is satisfied.
  </done>
</task>

</tasks>

<verification>
Phase 06 requirements check:

- TERM-01: `src/backend/domains/terminal/` owns terminal PTY management, output buffering, and monitoring.
  Verify: `src/backend/domains/terminal/terminal.service.ts` exists with the full TerminalService class.

- TERM-02: Static Maps in terminal service replaced with instance-based state.
  Verify: All 4 Maps (`terminals`, `outputListeners`, `exitListeners`, `activeTerminals`) are `private` instance fields on the class (lines 77-86 of original). `monitoringInterval` is also an instance field. The only `static` members are `static readonly` constants (stateless config). TERM-02 was already satisfied before consolidation. Confirm with: `grep -n "private.*= new Map" src/backend/domains/terminal/terminal.service.ts` shows 4 instance fields.

- TERM-03: Terminal domain has co-located unit tests covering its public API.
  Verify: `src/backend/domains/terminal/terminal.service.test.ts` exists and `pnpm test src/backend/domains/terminal/` passes.

Cross-cutting:
- `pnpm typecheck` passes with no new errors.
- `pnpm test` full suite passes.
- `pnpm check:fix` passes.
- Shim at old path preserves backward compatibility for all 7 consumers.
</verification>

<success_criteria>
1. terminal.service.ts lives in src/backend/domains/terminal/ with TerminalService class exported
2. Barrel index.ts exports all public API: terminalService, TerminalService, and 5 type interfaces
3. Shim at src/backend/services/terminal.service.ts re-exports everything from direct module path
4. Unit tests cover all 15 public API methods of TerminalService
5. Barrel smoke test confirms exports are not undefined
6. pnpm typecheck, pnpm test, and pnpm check:fix all pass
7. TERM-01, TERM-02 (verified), and TERM-03 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-terminal-domain-consolidation/06-01-SUMMARY.md`
</output>

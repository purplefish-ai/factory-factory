---
phase: 22-cleanup-polish
plan: 03
type: execute
wave: 3
depends_on: ["22-02"]
files_modified:
  - AGENTS.md
  - src/backend/domains/session/acp/acp-runtime-manager.test.ts
autonomous: true

must_haves:
  truths:
    - "AGENTS.md reflects ACP-only architecture with no references to removed protocol code"
    - "pnpm typecheck passes with zero errors"
    - "pnpm test passes with zero failures"
    - "pnpm build succeeds"
    - "No references to deleted modules remain in the codebase"
  artifacts:
    - path: "AGENTS.md"
      provides: "Updated contributor documentation reflecting ACP-only architecture"
      contains: "ACP"
  key_links:
    - from: "AGENTS.md"
      to: "src/backend/domains/session/acp/"
      via: "Documentation references"
      pattern: "acp"
---

<objective>
Update contributor docs, add ACP integration tests for session lifecycle, and perform final codebase verification.

Purpose: AGENTS.md still references the legacy Claude NDJSON protocol architecture. The ACP runtime manager needs additional integration test coverage for session start/stop, permission roundtrip, and config option updates. A full build + test + typecheck verification ensures the codebase is clean after the deletions.

Output: Updated AGENTS.md, expanded ACP test coverage, verified clean build.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cleanup-polish/22-RESEARCH.md
@.planning/phases/22-cleanup-polish/22-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AGENTS.md for ACP-only architecture</name>
  <files>AGENTS.md</files>
  <action>
Read the current AGENTS.md and update it to reflect the ACP-only architecture. Specific changes:

**Project Structure section:**
- Update the session domain description. Currently says "session (Claude process lifecycle, chat, event forwarding)". Change to describe ACP: "session (ACP agent runtime, chat services, event translation, permission handling)"
- If there are references to "Claude subprocess management", replace with "ACP subprocess management"

**Session Lifecycle Flow:**
- The Architecture section (in `Session Lifecycle Flow`) mentions "SessionManager spawns Claude subprocess via `claudeClient.run()` and registers in `ProcessRegistry`". Replace with:
  "Session domain creates ACP subprocess via `AcpRuntimeManager.getOrCreateClient()`, which spawns the agent adapter binary, completes ACP initialize handshake, and manages the per-session process lifecycle."
- Update step 5 from "SessionManager spawns Claude subprocess" to "SessionService delegates to AcpRuntimeManager which spawns an ACP adapter subprocess per session"
- Update step 8 about message forwarding: "Session messages forwarded via AcpEventTranslator and AcpClientHandler to client"

**Feature Notes section:**
- If there are references to Claude CLI protocol, Codex app-server, or NDJSON, update to reference ACP protocol
- Add or update entry about ACP: "**ACP Runtime:** All agent sessions use the Agent Client Protocol (ACP) via `@agentclientprotocol/sdk`. Each session spawns an adapter subprocess (e.g., `claude-adapter`, `codex-adapter`) with stdio-based JSON-RPC communication. Permission requests present multi-option selection (allow_once, allow_always, deny_once, deny_always). Model/mode/reasoning controls driven by agent-provided configOptions."

**Backend Domain Module Pattern section:**
- Ensure the session domain description matches reality: 6 domains still, session now has acp/, lifecycle/, chat/, data/, store/, logging/ subdirectories

**Do NOT change:**
- Build/test commands (unchanged)
- Git/GitHub CLI instructions (unchanged)
- Coding style (unchanged)
- Contributor checklist (unchanged)
- Security notes (unchanged)

Also run a global grep for leftover references to removed concepts:
- `grep -r "ClaudeClient" AGENTS.md` -- should be zero
- `grep -r "NDJSON" AGENTS.md` -- should be zero
- `grep -r "ProcessRegistry" AGENTS.md` -- should be zero
- `grep -r "codex-app-server" AGENTS.md` -- should be zero
  </action>
  <verify>
Read the updated AGENTS.md and confirm it accurately describes the ACP-only session architecture. Run `grep -r "ClaudeClient\|NDJSON\|ProcessRegistry\|codex-app-server" AGENTS.md` -- returns nothing.
  </verify>
  <done>AGENTS.md accurately describes the ACP-only architecture with no references to removed legacy protocol code.</done>
</task>

<task type="auto">
  <name>Task 2: Final codebase verification and stale reference cleanup</name>
  <files>
    (any files with stale references)
  </files>
  <action>
Run a comprehensive verification sweep to ensure no stale references remain after the cleanup:

**1. Full build verification:**
- `pnpm typecheck` -- must pass with zero errors
- `pnpm test` -- must pass with zero failures
- `pnpm build` -- must produce a successful build

**2. Stale reference scan:**
Run these grep checks and fix any remaining references:
- `grep -r "from.*session/claude" src/` -- should return zero (except @/shared/claude which is fine)
- `grep -r "from.*session/codex" src/` -- should return zero
- `grep -r "from.*session/providers" src/` -- should return zero
- `grep -r "ClaudeRuntimeManager" src/` -- should return zero
- `grep -r "CodexAppServerManager" src/` -- should return zero
- `grep -r "claudeSessionProviderAdapter" src/` -- should return zero
- `grep -r "codexSessionProviderAdapter" src/` -- should return zero
- `grep -r "SessionProcessManager" src/` -- should return zero (the type and value)
- `grep -r "CODEX_APP_SERVER" src/` -- should return zero
- `grep -r "processRegistry" src/backend/` -- should return zero (the singleton from claude/registry)

For each stale reference found, update the import to the correct new location or remove dead code.

**3. Dependency cruiser check:**
- Run `pnpm check:fix` (includes lint + format) to ensure Biome is happy
- If dependency-cruiser rules reference claude/ or codex/ paths, update them

**4. Verify test count:**
- Note the total test count. Some tests were deleted with the legacy files. The remaining tests should all pass.
  </action>
  <verify>
`pnpm typecheck` passes. `pnpm test` passes. `pnpm build` succeeds. `pnpm check:fix` passes. No stale references found by grep sweep.
  </verify>
  <done>Codebase is clean: zero stale references, all builds pass, all tests pass, linting clean. The v1.2 ACP Cutover milestone is complete.</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes (zero errors)
- `pnpm test` passes (all tests)
- `pnpm build` succeeds
- `pnpm check:fix` passes
- `grep -r "from.*session/claude[^-]" src/backend/` returns nothing (exclude shared/claude)
- `grep -r "from.*session/codex" src/` returns nothing
- `grep -r "ClaudeRuntimeManager\|CodexAppServerManager\|claudeSessionProviderAdapter\|codexSessionProviderAdapter" src/` returns nothing
- AGENTS.md has no references to removed protocol code
</verification>

<success_criteria>
AGENTS.md reflects ACP-only architecture (CLEAN-06). Full build + typecheck + test suite passes. No stale references to deleted modules remain. The v1.2 ACP Cutover milestone is complete with all 6 CLEAN requirements satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/22-cleanup-polish/22-03-SUMMARY.md`
</output>

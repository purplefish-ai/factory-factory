---
phase: 22-cleanup-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/domains/session/data/session-file-reader.ts
  - src/backend/domains/session/data/session-file-reader.test.ts
  - src/backend/domains/session/lifecycle/session.service.ts
  - src/backend/domains/session/lifecycle/session.service.test.ts
autonomous: true

must_haves:
  truths:
    - "SessionManager JSONL reading methods are preserved in a new location independent of claude/ directory"
    - "SessionService has zero imports from claude/, codex/, or legacy provider/runtime modules"
    - "SessionService has no legacy adapter fields, codex event translator, or codex handler setup"
    - "All session.service.test.ts tests use ACP mocks exclusively"
    - "pnpm typecheck passes with zero errors"
    - "pnpm test passes with zero failures"
  artifacts:
    - path: "src/backend/domains/session/data/session-file-reader.ts"
      provides: "SessionManager static methods relocated from claude/session.ts"
      contains: "class SessionFileReader"
    - path: "src/backend/domains/session/data/session-file-reader.test.ts"
      provides: "Tests for relocated SessionFileReader"
      contains: "SessionFileReader"
    - path: "src/backend/domains/session/lifecycle/session.service.ts"
      provides: "ACP-only session service with no legacy imports"
      min_lines: 500
    - path: "src/backend/domains/session/lifecycle/session.service.test.ts"
      provides: "ACP-only test suite"
  key_links:
    - from: "src/backend/domains/session/data/session-file-reader.ts"
      to: "@/backend/lib/claude-paths"
      via: "getClaudeProjectPath import"
      pattern: "getClaudeProjectPath"
    - from: "src/backend/domains/session/lifecycle/session.service.ts"
      to: "src/backend/domains/session/acp"
      via: "ACP runtime imports only"
      pattern: "from.*session/acp"
---

<objective>
Relocate SessionManager to a standalone utility and refactor SessionService to ACP-only.

Purpose: SessionManager provides JSONL history reading used by 5 consumers -- it must be preserved before claude/ can be deleted. SessionService (1425 lines) has ~20 legacy methods interleaved with ACP paths that must be removed to eliminate all claude/ and codex/ imports. This plan prepares the codebase for the bulk file deletion in Plan 02.

Output: session-file-reader.ts (relocated SessionManager), ACP-only session.service.ts, updated test suite.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cleanup-polish/22-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Relocate SessionManager to session-file-reader.ts</name>
  <files>
    src/backend/domains/session/data/session-file-reader.ts
    src/backend/domains/session/data/session-file-reader.test.ts
  </files>
  <action>
Create `src/backend/domains/session/data/session-file-reader.ts` containing the `SessionFileReader` class (renamed from `SessionManager`) with all static methods from `src/backend/domains/session/claude/session.ts`:
- `getProjectPath(workingDir)` -- delegates to `getClaudeProjectPath`
- `getSessionPath(claudeSessionId, workingDir)`
- `getSessionPathFromProjectPath(claudeSessionId, projectPath)`
- `hasSessionFileFromProjectPath(claudeSessionId, projectPath)`
- `getHistory(claudeSessionId, workingDir)`
- `getHistoryFromProjectPath(claudeSessionId, projectPath)`
- `getSessionModel(claudeSessionId, workingDir)`
- `getSessionGitBranch(claudeSessionId, workingDir)`
- `listSessions(workingDir)` -- returns `SessionInfo[]`
- `extractClaudeSessionId(msg)` -- used by consumers

Also move the `parseHistoryEntry` export and all supporting private functions (`inferImageExtension`, `estimateBase64Bytes`, `createImageAttachment`, `parseUserContentItem`, `flushUserAccumulator`, `normalizeUserContent`, `parseAssistantContentItem`, `parseUserStringContent`, `parseToolResultOnlyContent`, `parseUserTextAndAttachmentContent`, `parseUserArrayContent`, `parseUserEntry`, `parseAssistantEntry`, `isSystemContent`), the `SessionJsonlEntrySchema`, the `SessionInfo` interface, the `EntryMetadata` interface, and the `ParsedUserContentAccumulator` interface.

Import types from `@/shared/claude` (for `HistoryMessage`, `ClaudeContentItem`, `ClaudeJson`, `ClaudeMessage`) instead of from `./types` -- the shared types are the WebSocket protocol types that stay.

Also export a backward-compatible `SessionManager` alias: `export { SessionFileReader as SessionManager }` so consumers can migrate incrementally.

Copy the existing test file `src/backend/domains/session/claude/session.test.ts` to `src/backend/domains/session/data/session-file-reader.test.ts`, updating imports to reference the new location. The test should import `SessionFileReader` and verify all static methods work identically.
  </action>
  <verify>
Run `pnpm typecheck` -- the new file compiles. Run `pnpm test src/backend/domains/session/data/session-file-reader.test.ts` -- all relocated tests pass.
  </verify>
  <done>SessionFileReader exists at data/session-file-reader.ts with all SessionManager methods, tests pass at new location.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor SessionService to ACP-only</name>
  <files>
    src/backend/domains/session/lifecycle/session.service.ts
    src/backend/domains/session/lifecycle/session.service.test.ts
  </files>
  <action>
Refactor `session.service.ts` to remove ALL legacy protocol imports and adapter logic. This is the critical refactoring step.

**Remove these imports (top of file):**
- `import type { RewindFilesResponse } from '@/backend/domains/session/claude'`
- `import type { ClaudeClient } from '@/backend/domains/session/claude/client'`
- `import type { ResourceUsage } from '@/backend/domains/session/claude/process'`
- `import type { RegisteredProcess } from '@/backend/domains/session/claude/registry'`
- `import { SessionManager } from '@/backend/domains/session/claude/session'` -- replace with `import { SessionFileReader } from '@/backend/domains/session/data/session-file-reader'`
- `import { CodexEventTranslator } from '@/backend/domains/session/codex/codex-event-translator'`
- `import { parseCodexThreadReadTranscript } from '@/backend/domains/session/codex/codex-thread-read-transcript'`
- `import { parseTurnId } from '@/backend/domains/session/codex/payload-utils'`
- `import { claudeSessionProviderAdapter, codexSessionProviderAdapter, type SessionProvider } from '@/backend/domains/session/providers'`
- `import type { CodexAppServerManager } from '@/backend/domains/session/runtime/codex-app-server-manager'`
- `import { resolveSessionModelForProvider } from '@/backend/lib/session-model'`

**Remove these class fields:**
- `private readonly claudeAdapter = claudeSessionProviderAdapter`
- `private readonly codexAdapter = codexSessionProviderAdapter`
- `private readonly sessionProviderCache = new Map<string, SessionProvider>()`
- `private readonly codexEventTranslator = new CodexEventTranslator({...})`
- `private onCodexTerminalTurn: CodexTerminalTurnCallback | null = null`

**Remove these types:**
- `ClientCreatedCallback` type alias
- `CodexTerminalTurnCallback` type alias
- `SessionAdapter` type alias
- `LoadedSessionAdapter` type alias

**Remove these private methods:**
- `cacheSessionProvider` / `clearSessionProvider`
- `resolveAdapterForProvider`
- `resolveKnownAdapterForSessionSync`
- `resolveAdapterForSessionSync`
- `notifyCodexTerminalTurn`
- `initializeCodexManagerHandlers` (the entire codex notification/event handler block)
- `normalizeCodexDeltaEvent`
- `isTerminalCodexTurnMethod`
- `loadSessionWithAdapter`
- `toCodexTextContent`
- `shouldStopWorkspaceSession` / `waitForPendingClient`

**Remove these public methods:**
- `setOnClientCreated(callback)` -- legacy callback for ClaudeClient event forwarding
- `setOnCodexTerminalTurn(callback)` -- codex terminal turn callback
- `getClient(sessionId)` -- returns ClaudeClient
- `toPublicMessageDelta(message, order)` -- delegates to claudeAdapter
- `tryHydrateCodexTranscript(sessionId)` -- codex transcript hydration
- `rewindSessionFiles(sessionId, userMessageId, dryRun)` -- delegates to legacy adapter
- `getClaudeProcess(sessionId)` -- gets from claudeAdapter
- `getAllActiveProcesses()` -- gets from claudeAdapter
- `getCodexManagerStatus()` -- gets from codexAdapter
- `getAllCodexActiveProcesses()` -- gets from codexAdapter
- `getAllClients()` -- returns ClaudeClient iterator

**Simplify these methods to ACP-only:**
- `getRuntimeSnapshot(sessionId)` -- remove legacy adapter checks, check only `acpRuntimeManager.getClient()` / `acpRuntimeManager.isStopInProgress()` then fall through to persisted state
- `isSessionRunning(sessionId)` -- keep ACP check, remove legacy adapter fallback
- `isSessionWorking(sessionId)` -- keep ACP check, remove legacy adapter fallback
- `isAnySessionWorking(sessionIds)` -- use only `acpRuntimeManager.isAnySessionWorking(sessionIds)`
- `respondToPermissionRequest(sessionId, requestId, allow)` -- remove legacy adapter path, only keep for backward compat or remove if no callers left (check if any consumer still calls this vs `respondToAcpPermission`)
- `respondToQuestionRequest(sessionId, requestId, answers)` -- same analysis
- `sendSessionMessage(sessionId, content)` -- remove codexAdapter/claudeAdapter paths, always use ACP. Normalize ClaudeContentItem[] to text string for ACP.
- `setSessionModel(sessionId, model)` -- remove legacy adapter fallback
- `setSessionReasoningEffort(sessionId, effort)` -- remove codex adapter path
- `setSessionThinkingBudget(sessionId, maxTokens)` -- remove legacy adapter fallback
- `getChatBarCapabilities(sessionId)` -- remove legacy adapter fallback, always use `buildAcpChatBarCapabilities`
- `startSession(sessionId, options)` -- simplify to always use ACP (remove legacy adapter check)
- `stopSession(sessionId, options)` -- remove legacy adapter path (keep only ACP stop)
- `stopAllClients(timeoutMs)` -- remove claude/codex adapter stop calls, keep only ACP
- `stopWorkspaceSessions(workspaceId)` -- simplify to use `stopSession` directly per session
- `getOrCreateSessionClient(sessionId, options)` -- remove legacy adapter fallback, always ACP
- `getSessionClient(sessionId)` -- remove legacy adapter fallback, only ACP
- `getSessionConversationHistory(sessionId, workingDir)` -- replace `SessionManager.getHistory` with `SessionFileReader.getHistory`

**Remove the constructor's `this.initializeCodexManagerHandlers()` call.** Simplify constructor to just assign repository and promptBuilder.

**In the test file** (`session.service.test.ts`):
- Remove all `vi.mock` entries for claude/, codex/, providers/ modules
- Remove all `claudeSessionProviderAdapter` and `codexSessionProviderAdapter` mock references
- Remove tests that specifically test codex or claude adapter paths
- Ensure all remaining tests use `acpRuntimeManager` mocks (many were updated in Phase 21-03)
- Keep tests for ACP session creation, sending messages, stopping sessions, permission handling, config options
  </action>
  <verify>
Run `pnpm typecheck` -- zero errors. Run `pnpm test src/backend/domains/session/lifecycle/` -- all tests pass. Verify with `grep -r "from.*session/claude" src/backend/domains/session/lifecycle/session.service.ts` returns zero results. Verify with `grep -r "from.*session/codex" src/backend/domains/session/lifecycle/session.service.ts` returns zero results. Verify with `grep -r "from.*session/providers" src/backend/domains/session/lifecycle/session.service.ts` returns zero results.
  </verify>
  <done>SessionService has zero imports from claude/, codex/, providers/, or legacy runtime. All legacy adapter fields and methods removed. Constructor no longer initializes codex handlers. Test suite passes with ACP-only mocks. Typecheck clean.</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes (zero errors)
- `pnpm test` passes (all test files)
- `grep -r "from.*session/claude" src/backend/domains/session/lifecycle/session.service.ts` returns nothing
- `grep -r "from.*session/codex" src/backend/domains/session/lifecycle/session.service.ts` returns nothing
- `grep -r "from.*session/providers" src/backend/domains/session/lifecycle/session.service.ts` returns nothing
- SessionFileReader at data/session-file-reader.ts has all original SessionManager methods
</verification>

<success_criteria>
SessionManager methods are safely relocated to data/session-file-reader.ts. SessionService is a pure ACP-only service with no legacy protocol imports. All tests pass. The claude/ and codex/ directories are now fully dead code ready for deletion in Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/22-cleanup-polish/22-01-SUMMARY.md`
</output>

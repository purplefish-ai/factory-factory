---
phase: 22-cleanup-polish
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/backend/domains/session/claude/  # DELETE entire directory
  - src/backend/domains/session/codex/  # DELETE entire directory
  - src/backend/domains/session/runtime/claude-runtime-manager.ts  # DELETE
  - src/backend/domains/session/runtime/claude-runtime-manager.test.ts  # DELETE
  - src/backend/domains/session/runtime/codex-app-server-manager.ts  # DELETE
  - src/backend/domains/session/runtime/codex-app-server-manager.test.ts  # DELETE
  - src/backend/domains/session/runtime/index.ts  # REWRITE
  - src/backend/domains/session/providers/  # DELETE entire directory
  - src/backend/domains/session/lifecycle/session.process-manager.ts  # DELETE
  - src/backend/domains/session/lifecycle/session.process-manager.test.ts  # DELETE
  - src/backend/domains/session/index.ts  # REWRITE barrel
  - src/backend/domains/session/store/session-hydrator.ts
  - src/backend/domains/session/chat/chat-event-forwarder.service.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/load-session.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/list-sessions.handler.ts
  - src/backend/domains/session/chat/chat-message-handlers/attachment-processing.ts
  - src/backend/domains/session/chat/chat-message-handlers/handlers/user-input.handler.ts
  - src/backend/domains/session/session-domain.service.test.ts
  - src/backend/routers/websocket/chat.handler.ts
  - src/backend/trpc/admin.trpc.ts
  - src/backend/trpc/session.trpc.ts
  - src/backend/services/env-schemas.ts
  - src/backend/services/config.service.ts
  - src/backend/services/constants.ts
  - src/client/routes/admin/ProcessesSection.tsx
autonomous: true

must_haves:
  truths:
    - "The claude/ directory no longer exists in the session domain"
    - "The codex/ directory no longer exists in the session domain"
    - "The providers/ directory no longer exists in the session domain"
    - "Legacy runtime managers (claude-runtime-manager, codex-app-server-manager) are deleted"
    - "session.process-manager.ts (thin alias) is deleted"
    - "No CODEX_APP_SERVER_* env vars remain in config"
    - "Admin process reporting shows ACP session data instead of legacy Claude/Codex data"
    - "pnpm typecheck passes with zero errors"
    - "pnpm test passes with zero failures"
  artifacts:
    - path: "src/backend/domains/session/index.ts"
      provides: "Rewritten barrel with ACP-only exports"
      contains: "AcpRuntimeManager"
    - path: "src/backend/domains/session/runtime/index.ts"
      provides: "Runtime barrel with only ACP + interface exports"
      contains: "AcpRuntimeManager"
  key_links:
    - from: "src/backend/domains/session/store/session-hydrator.ts"
      to: "src/backend/domains/session/data/session-file-reader.ts"
      via: "SessionFileReader import"
      pattern: "SessionFileReader"
    - from: "src/backend/trpc/admin.trpc.ts"
      to: "src/backend/domains/session/acp/acp-runtime-manager.ts"
      via: "acpRuntimeManager.getAllActiveProcesses"
      pattern: "getAllActiveProcesses"
---

<objective>
Delete all legacy protocol stacks, fix all consumers, clean config, and update admin reporting.

Purpose: With SessionService already ACP-only (Plan 01), the claude/, codex/, providers/, legacy runtime, and session.process-manager files are dead code. This plan deletes them, updates all remaining consumers to import from the relocated SessionFileReader, rewrites barrel exports, removes legacy config knobs, and updates admin/health reporting to use ACP process data.

Output: ~40 files deleted, all consumers updated, barrel rewritten, config cleaned, admin reporting on ACP.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cleanup-polish/22-RESEARCH.md
@.planning/phases/22-cleanup-polish/22-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete legacy protocol stacks and fix all consumer imports</name>
  <files>
    src/backend/domains/session/claude/  (DELETE)
    src/backend/domains/session/codex/  (DELETE)
    src/backend/domains/session/providers/  (DELETE)
    src/backend/domains/session/runtime/claude-runtime-manager.ts  (DELETE)
    src/backend/domains/session/runtime/claude-runtime-manager.test.ts  (DELETE)
    src/backend/domains/session/runtime/codex-app-server-manager.ts  (DELETE)
    src/backend/domains/session/runtime/codex-app-server-manager.test.ts  (DELETE)
    src/backend/domains/session/lifecycle/session.process-manager.ts  (DELETE)
    src/backend/domains/session/lifecycle/session.process-manager.test.ts  (DELETE)
    src/backend/domains/session/runtime/index.ts
    src/backend/domains/session/index.ts
    src/backend/domains/session/store/session-hydrator.ts
    src/backend/domains/session/chat/chat-event-forwarder.service.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/load-session.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/list-sessions.handler.ts
    src/backend/domains/session/chat/chat-message-handlers/attachment-processing.ts
    src/backend/domains/session/chat/chat-message-handlers/handlers/user-input.handler.ts
    src/backend/domains/session/session-domain.service.test.ts
    src/backend/routers/websocket/chat.handler.ts
    src/backend/trpc/session.trpc.ts
  </files>
  <action>
**Step 1: Delete directories and files.**

Delete these ENTIRE directories:
- `src/backend/domains/session/claude/` (21 files, ~260KB)
- `src/backend/domains/session/codex/` (19 files, ~70KB)
- `src/backend/domains/session/providers/` (6 files)

Delete these individual files:
- `src/backend/domains/session/runtime/claude-runtime-manager.ts` + `.test.ts`
- `src/backend/domains/session/runtime/codex-app-server-manager.ts` + `.test.ts`
- `src/backend/domains/session/lifecycle/session.process-manager.ts` + `.test.ts`

**Step 2: Rewrite `src/backend/domains/session/runtime/index.ts`.**

Keep only:
```typescript
export type { AcpClientOptions } from '@/backend/domains/session/acp';
export { AcpProcessHandle, AcpRuntimeManager, acpRuntimeManager } from '@/backend/domains/session/acp';
export type { AcpRuntimeEventHandlers } from '@/backend/domains/session/acp/acp-runtime-manager';
export type { ProviderRuntimeManager, RuntimeCreatedCallback, RuntimeEventHandlers } from './provider-runtime-manager';
```

Remove all ClaudeRuntimeManager and CodexAppServerManager exports.

**Step 3: Rewrite `src/backend/domains/session/index.ts` barrel.**

Remove ALL exports from claude/, codex/, providers/, and legacy runtime. Keep:
- ACP exports (AcpClientHandler, AcpProcessHandle, AcpRuntimeManager, acpRuntimeManager, types)
- Bridge types (SessionInitPolicyBridge, SessionWorkspaceBridge)
- Chat services (chatConnectionService, chatEventForwarderService, chatMessageHandlerService, ConnectionInfo, EventForwarderContext)
- SessionFileReader (and backward-compat SessionManager alias) from data/session-file-reader
- sessionDataService, sessionProviderResolverService from data/
- sessionPromptBuilder, sessionRepository from lifecycle/
- sessionService from lifecycle/
- SessionFileLogger, sessionFileLogger from logging/
- sessionDomainService
- Runtime types (ProviderRuntimeManager, RuntimeCreatedCallback, RuntimeEventHandlers)
- Keep re-exporting `SessionInfo` type from data/session-file-reader

Remove these exports entirely (no longer exist):
- ClaudeClient, ClaudeProcess, ProcessRegistry, processRegistry, SessionManager (from claude)
- All Claude protocol types (AssistantMessage, ClaudeClientOptions, ClaudeJson, ControlRequest, ExitResult, HistoryMessage, InitializeResponseData, PermissionMode, ProcessStatus, RegisteredProcess, ResourceUsage, ResultMessage, SessionInfo from claude, StreamEventMessage, SystemMessage, ToolUseContent, UserMessage)
- ClaudeSessionProviderAdapter, CodexSessionProviderAdapter, claudeSessionProviderAdapter, codexSessionProviderAdapter
- CanonicalAgentMessageEvent, CanonicalAgentMessageKind, SessionProvider (type), SessionProviderAdapter
- ClaudeRuntimeManager, CodexAppServerManager, claudeRuntimeManager, codexAppServerManager
- ClaudeRuntimeCreatedCallback, ClaudeRuntimeEventHandlers
- SessionProcessManager, sessionProcessManager
- ClientCreatedCallback

NOTE: Some types like `HistoryMessage`, `ClaudeContentItem`, `ClaudeMessage` etc. already live in `@/shared/claude` and are used by external consumers directly. Those consumers should import from `@/shared/claude`, NOT from the session barrel. Check each removed type to see if it's re-exported from `@/shared/claude` -- if so, consumers already have a path.

**Step 4: Fix consumer imports.**

For each file that imported from `claude/session` (SessionManager):
- `src/backend/domains/session/store/session-hydrator.ts` -- change `import { SessionManager } from '@/backend/domains/session/claude/session'` to `import { SessionFileReader } from '@/backend/domains/session/data/session-file-reader'`, update all `SessionManager.` calls to `SessionFileReader.`
- `src/backend/domains/session/session-domain.service.test.ts` -- update SessionManager import to SessionFileReader
- `src/backend/trpc/session.trpc.ts` -- change `SessionManager` import to `SessionFileReader` from barrel or direct path
- `src/backend/domains/session/chat/chat-message-handlers/handlers/load-session.handler.ts` -- change `SessionManager` import to `SessionFileReader`
- `src/backend/domains/session/chat/chat-message-handlers/handlers/list-sessions.handler.ts` -- change `SessionManager` import to `SessionFileReader`

For `src/backend/domains/session/chat/chat-message-handlers/attachment-processing.ts` and `src/backend/domains/session/chat/chat-message-handlers/handlers/user-input.handler.ts`:
- If they import `ClaudeContentItem` from `claude/types`, change to import from `@/shared/claude`

For `src/backend/domains/session/chat/chat-event-forwarder.service.ts`:
- This service is ENTIRELY about forwarding ClaudeClient events to WebSocket. With ACP, events come through AcpClientHandler/AcpEventTranslator instead. The entire `setupClientEvents` method and all ClaudeClient-related logic is dead code.
- **However**, the service also manages pending interactive requests, workspace notifications, and is referenced by the chat handler. The non-ClaudeClient functionality (pending requests, workspace notifications) must be preserved.
- Remove `import type { ClaudeClient } from '@/backend/domains/session/claude/index'`
- Remove `import { claudeSessionProviderAdapter } from '@/backend/domains/session/providers'`
- Remove the `private clientEventSetup = new Map<string, ClaudeClient>()` field
- Remove the `private registeredListeners` field
- Remove the `private lastCompactBoundaryAt` field
- Remove `forwardClaudeMessage`, `removeForwardingListeners`, `setupClientEvents`, `routeInteractiveRequest`, `routeSupportedInteractiveRequest`, `storePendingInteractiveRequest`, `handleMessageEvent`, `forwardAssistantTextMessage`, `buildToolUseFallbackStreamEvents`, `normalizeAssistantMessageToTextOnly`, `forwardUserMessageWithToolResult`, `extractPlanContent`, `readPlanFileContent`, `notifyToolResultInterceptors`, `syncRuntimeFromClient`
- Keep: `isSetup` (update to always return false or remove), `getPendingRequest`, `clearPendingRequest`, `clearPendingRequestIfMatches`, `setupWorkspaceNotifications`, `getAllPendingRequests`, `configure` and bridge getter
- The `isSetup` method is called by chat.handler.ts to determine if event forwarding is active. Since ACP handles events through AcpClientHandler, this should return `false` (or check acpRuntimeManager instead). Simplest: make it check if the session has an ACP handle.

For `src/backend/routers/websocket/chat.handler.ts`:
- Remove `import type { ClaudeClient, ConnectionInfo } from '@/backend/domains/session'` -- keep only `ConnectionInfo` if still needed, import from barrel
- Remove the `isClaudeClient()` type guard function entirely
- In `getOrCreateChatClient`, remove the `if (session?.provider === 'CLAUDE' && isClaudeClient(client))` block that calls `chatEventForwarderService.setupClientEvents`. ACP sessions handle events via AcpClientHandler, not through ChatEventForwarderService.
  </action>
  <verify>
Run `pnpm typecheck` -- zero errors. Run `pnpm test` -- all tests pass. Verify directories deleted: `ls src/backend/domains/session/claude/` should fail. `ls src/backend/domains/session/codex/` should fail. `ls src/backend/domains/session/providers/` should fail.
  </verify>
  <done>All legacy protocol files deleted (~40 files). All consumer imports updated to SessionFileReader or @/shared/claude. Barrel rewritten with ACP-only exports. chat-event-forwarder stripped of ClaudeClient logic. chat.handler stripped of isClaudeClient guard. Typecheck and tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Clean config knobs and update admin process reporting</name>
  <files>
    src/backend/services/env-schemas.ts
    src/backend/services/config.service.ts
    src/backend/services/constants.ts
    src/backend/trpc/admin.trpc.ts
    src/backend/domains/session/acp/acp-runtime-manager.ts
    src/client/routes/admin/ProcessesSection.tsx
  </files>
  <action>
**Config cleanup (CLEAN-03):**

In `src/backend/services/env-schemas.ts`, remove these Codex env vars:
- `CODEX_APP_SERVER_COMMAND`
- `CODEX_APP_SERVER_ARGS`
- `CODEX_APP_SERVER_REQUEST_TIMEOUT_MS`
- `CODEX_APP_SERVER_HANDSHAKE_TIMEOUT_MS`
- `CODEX_REQUEST_USER_INPUT_ENABLED`

Also evaluate `CLAUDE_HUNG_TIMEOUT_MS` -- if it was only used by `ClaudeProcessMonitor` (now deleted), remove it too. Check if any remaining code references it.

In `src/backend/services/config.service.ts`:
- Remove `CodexAppServerConfig` interface
- Remove `buildCodexAppServerConfig()` function
- Remove `codexAppServer` field from `SystemConfig` interface
- Remove `getCodexAppServerConfig()` method
- Also remove `ClaudeProcessConfig`/`buildClaudeProcessConfig()`/`getClaudeProcessConfig()` if only used by deleted code

In `src/backend/services/constants.ts`:
- Remove `codexAppServerHandshake` and `codexAppServerRequest` timeout constants
- Remove `claudeHungProcess` if only used by deleted code

**Admin process reporting (CLEAN-05):**

In `src/backend/domains/session/acp/acp-runtime-manager.ts`, add a `getAllActiveProcesses()` method:
```typescript
getAllActiveProcesses(): Array<{
  sessionId: string;
  pid: number | undefined;
  status: string;
  isRunning: boolean;
  isPromptInFlight: boolean;
  provider: string;
}> {
  const processes: Array<{
    sessionId: string;
    pid: number | undefined;
    status: string;
    isRunning: boolean;
    isPromptInFlight: boolean;
    provider: string;
  }> = [];
  for (const [sessionId, handle] of this.sessions) {
    processes.push({
      sessionId,
      pid: handle.getPid() ?? undefined,
      status: handle.isRunning() ? 'running' : 'stopped',
      isRunning: handle.isRunning(),
      isPromptInFlight: handle.isPromptInFlight,
      provider: handle.provider,
    });
  }
  return processes;
}
```

Check AcpProcessHandle to confirm it has `getPid()`, `isRunning()`, `isPromptInFlight`, and `provider` properties. If `provider` doesn't exist on the handle, derive it from the stored options.

In `src/backend/trpc/admin.trpc.ts`, update `getActiveProcesses`:
- Remove `sessionService.getAllActiveProcesses()` (deleted method)
- Remove `sessionService.getCodexManagerStatus()` (deleted method)
- Remove `sessionService.getAllCodexActiveProcesses()` (deleted method)
- Instead, import `acpRuntimeManager` from the session barrel and call `acpRuntimeManager.getAllActiveProcesses()`
- Map ACP process data to the existing `claudeProcesses` response shape so the frontend doesn't break:
  - Use ACP `pid`, `status`, `isRunning` fields
  - `memoryStatus` can be the ACP status string
  - `cpuPercent`, `memoryBytes`, `idleTimeMs` are not available from ACP -- set to null
- Remove the `codex` section from the response entirely (no more codex manager status)
- Update the `summary` to remove `totalCodexSessions`

In `src/client/routes/admin/ProcessesSection.tsx`:
- The component already only renders `claude` and `terminal` sections -- the codex data was returned but never displayed
- Update the `hasNoProcesses` check to not reference codex
- If the summary type changes (removing `totalCodexSessions`), update accordingly
- The "Claude Processes" header label could be updated to "Agent Sessions" since they're now ACP sessions
  </action>
  <verify>
Run `pnpm typecheck` -- zero errors. Run `pnpm test` -- all tests pass. Verify no CODEX_APP_SERVER references remain: `grep -r "CODEX_APP_SERVER" src/backend/` should return nothing. Verify admin endpoint compiles.
  </verify>
  <done>All Codex config knobs removed. Claude config knobs evaluated and removed if dead. Admin process reporting uses ACP data. Frontend ProcessesSection updated. No legacy config references remain.</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes (zero errors)
- `pnpm test` passes (all test files)
- `ls src/backend/domains/session/claude/` fails (directory deleted)
- `ls src/backend/domains/session/codex/` fails (directory deleted)
- `ls src/backend/domains/session/providers/` fails (directory deleted)
- `grep -r "CODEX_APP_SERVER" src/backend/` returns nothing
- `grep -r "ClaudeRuntimeManager" src/backend/domains/session/` returns nothing
- `grep -r "CodexAppServerManager" src/backend/domains/session/` returns nothing
- `grep -r "claudeSessionProviderAdapter" src/backend/` returns nothing
- `grep -r "codexSessionProviderAdapter" src/backend/` returns nothing
</verification>

<success_criteria>
The Claude NDJSON protocol stack (CLEAN-01) and Codex app-server stack (CLEAN-02) no longer exist in the codebase. Obsolete config knobs are removed (CLEAN-03). Admin/health reporting shows ACP session data (CLEAN-05). All consumers updated to new import paths. Typecheck and all tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/22-cleanup-polish/22-02-SUMMARY.md`
</output>

---
phase: 10-validation-stabilization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .dependency-cruiser.cjs
  - knip.json
  - src/backend/interceptors/conversation-rename.interceptor.ts
  - src/backend/orchestration/workspace-init.orchestrator.ts
  - src/backend/orchestration/workspace-archive.orchestrator.ts
autonomous: true

must_haves:
  truths:
    - "Dependency-cruiser enforces barrel-only imports for domain consumers"
    - "Dependency-cruiser prevents domains from importing orchestration, routers, tRPC, or agents"
    - "All barrel bypass violations are fixed — external consumers use domain barrels only"
    - "Knip reports zero configuration hints after stale entry cleanup"
    - "pnpm deps:check passes with zero violations under the new stricter rules"
  artifacts:
    - path: ".dependency-cruiser.cjs"
      provides: "Tightened architectural rules enforcing domain barrel boundaries"
      contains: "no-deep-domain-imports"
    - path: "knip.json"
      provides: "Clean Knip configuration with no stale ignore entries"
  key_links:
    - from: ".dependency-cruiser.cjs"
      to: "src/backend/domains/"
      via: "no-deep-domain-imports rule"
      pattern: "barrel"
    - from: "pnpm deps:check"
      to: "0 violations"
      via: "dependency-cruiser"
      pattern: "0 dependency violations"
---

<objective>
Tighten dependency-cruiser rules to enforce domain barrel boundaries, fix existing barrel bypass violations, and clean up Knip configuration.

Purpose: Lock down the architectural boundaries established by the SRP refactor so they can't silently degrade. The refactor moved code into domain modules with barrel files — now enforce that consumers actually use the barrels.
Output: Stricter dep-cruiser config, fixed imports, clean knip config.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-validation-stabilization/10-RESEARCH.md
@.dependency-cruiser.cjs
@knip.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix barrel bypass violations in interceptors and orchestration</name>
  <files>src/backend/interceptors/conversation-rename.interceptor.ts, src/backend/orchestration/workspace-init.orchestrator.ts, src/backend/orchestration/workspace-archive.orchestrator.ts</files>
  <action>
  Fix 5 imports that bypass domain barrel files:

  1. **`src/backend/interceptors/conversation-rename.interceptor.ts`**:
     Change: `from '@/backend/domains/session/lifecycle/session.service'`
     To: `from '@/backend/domains/session'`
     Verify the needed export (sessionService or similar) is available from the session barrel.

  2. **`src/backend/orchestration/workspace-init.orchestrator.ts`**:
     Change: `from '@/backend/domains/workspace/lifecycle/state-machine.service'`
     To: `from '@/backend/domains/workspace'`
     Change: `from '@/backend/domains/workspace/worktree/worktree-lifecycle.service'`
     To: `from '@/backend/domains/workspace'`
     These can be combined into a single barrel import if both exports come from the same domain.

  3. **`src/backend/orchestration/workspace-archive.orchestrator.ts`**:
     Change: `from '@/backend/domains/workspace/lifecycle/state-machine.service'`
     To: `from '@/backend/domains/workspace'`
     Change: `from '@/backend/domains/workspace/worktree/worktree-lifecycle.service'`
     To: `from '@/backend/domains/workspace'`
     Same approach — combine into a single barrel import.

  Before changing each file, verify the needed exports exist in the domain barrel:
  - Check `src/backend/domains/session/index.ts` exports the needed session service
  - Check `src/backend/domains/workspace/index.ts` exports state machine and worktree lifecycle services

  If any export is missing from a barrel, add it to the barrel first.

  After all fixes, run `pnpm typecheck` to verify no type errors introduced.
  </action>
  <verify>`pnpm typecheck` passes. No imports from `domains/*/lifecycle/`, `domains/*/worktree/`, or `domains/*/claude/` exist outside their own domain (except `domains/session/claude` sub-barrel which is re-exported).</verify>
  <done>All 5 barrel bypass violations fixed. External consumers use domain barrels only.</done>
</task>

<task type="auto">
  <name>Task 2: Add dependency-cruiser rules and clean Knip configuration</name>
  <files>.dependency-cruiser.cjs, knip.json</files>
  <action>
  **Add 4 new dependency-cruiser rules to `.dependency-cruiser.cjs`:**

  1. **`no-deep-domain-imports`** — Enforce barrel-only imports for domain consumers:
     ```javascript
     {
       name: "no-deep-domain-imports",
       severity: "error",
       comment:
         "External consumers must import from domain barrel files (domains/{name}/), " +
         "not from internal paths (domains/{name}/subfolder/). " +
         "This keeps domain internals encapsulated.",
       from: {
         path: "^src/backend",
         pathNot: "^src/backend/domains/([^/]+)/",
       },
       to: {
         path: "^src/backend/domains/[^/]+/.+/",
       },
     }
     ```
     This rule says: from anything in `src/backend` that is NOT inside a domain, you cannot import a path that goes deeper than `domains/{name}/`. The barrel at `domains/{name}/index.ts` resolves as `domains/{name}/` (no subfolder), so it's allowed.

     NOTE: Intra-domain imports (e.g., session importing from session/claude/) are excluded by the `pathNot` on `from`. Cross-domain deep imports are already blocked by `no-cross-domain-imports`.

  2. **`no-domains-importing-orchestration`** — Domains must not depend on orchestration:
     ```javascript
     {
       name: "no-domains-importing-orchestration",
       severity: "error",
       comment:
         "Domain modules must not import from orchestration layer. " +
         "Orchestration coordinates domains, not the other way around.",
       from: {
         path: "^src/backend/domains/",
         pathNot: "\\.test\\.ts$",
       },
       to: { path: "^src/backend/orchestration/" },
     }
     ```
     Test files are excluded since they may test orchestrators directly.

  3. **`no-domains-importing-routers`** — Domains must not depend on routing layer:
     ```javascript
     {
       name: "no-domains-importing-routers",
       severity: "error",
       comment:
         "Domain modules must not import from routers or tRPC layer. " +
         "Routers depend on domains, not the other way around.",
       from: { path: "^src/backend/domains/" },
       to: { path: "^src/backend/(routers|trpc)/" },
     }
     ```

  4. **`no-domains-importing-agents`** — Domains must not depend on agent layer:
     ```javascript
     {
       name: "no-domains-importing-agents",
       severity: "error",
       comment:
         "Domain modules must not import from agents. " +
         "Agents depend on domains, not the other way around.",
       from: { path: "^src/backend/domains/" },
       to: { path: "^src/backend/agents/" },
     }
     ```

  Add these 4 rules to the `forbidden` array after the existing `no-cross-domain-imports` rule.

  **After adding rules, run `pnpm deps:check`** to verify 0 violations. If any violations appear, the barrel fixes in Task 1 should have resolved them. If new violations surface, investigate and fix.

  **Clean Knip configuration in `knip.json`:**

  1. Remove `"date-fns"` from `ignoreDependencies` array
  2. Remove `"react-day-picker"` from `ignoreDependencies` array
  3. Remove `"src/cli/index.ts"` from `entry` array (redundant)
  4. Remove `"src/backend/index.ts"` from `entry` array (redundant)

  After fixing, run `pnpm knip --include files,dependencies,unlisted` to verify 0 issues and 0 configuration hints.
  </action>
  <verify>`pnpm deps:check` passes with 0 violations (now with 18 rules instead of 14). `pnpm knip` reports no configuration hints. The new rules appear in dependency-cruiser output.</verify>
  <done>4 new dependency-cruiser rules enforce domain barrel boundaries. Knip config cleaned. All checks pass.</done>
</task>

</tasks>

<verification>
- `.dependency-cruiser.cjs` has `no-deep-domain-imports` rule
- `.dependency-cruiser.cjs` has `no-domains-importing-orchestration` rule
- `.dependency-cruiser.cjs` has `no-domains-importing-routers` rule
- `.dependency-cruiser.cjs` has `no-domains-importing-agents` rule
- `pnpm deps:check` passes with 0 violations under all 18 rules
- No imports from `domains/*/internal-path/` exist outside their own domain
- `pnpm knip` reports 0 issues and 0 configuration hints
- `pnpm typecheck` passes after import rewiring
</verification>

<success_criteria>
Domain barrel boundaries are enforced by dependency-cruiser. No external consumer can bypass barrel files without triggering a CI error. Knip configuration is clean. All existing checks still pass.
</success_criteria>

<output>
After completion, create `.planning/phases/10-validation-stabilization/10-01-SUMMARY.md`
</output>

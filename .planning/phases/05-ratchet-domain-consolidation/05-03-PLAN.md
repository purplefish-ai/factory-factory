---
phase: 05-ratchet-domain-consolidation
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - src/backend/domains/ratchet/index.ts
  - src/backend/domains/ratchet/ratchet-domain-exports.test.ts
autonomous: true

must_haves:
  truths:
    - "All ratchet domain exports are accessible from '@/backend/domains/ratchet'"
    - "Barrel file exports all 5 service singletons and their public types"
    - "Domain smoke test verifies every export is defined (not undefined)"
    - "pnpm typecheck passes"
    - "Full test suite passes with no regressions"
  artifacts:
    - path: "src/backend/domains/ratchet/index.ts"
      provides: "Complete ratchet domain barrel file"
      contains: "ratchetService"
    - path: "src/backend/domains/ratchet/ratchet-domain-exports.test.ts"
      provides: "Barrel integrity smoke test"
      contains: "Ratchet domain exports"
  key_links:
    - from: "src/backend/domains/ratchet/index.ts"
      to: "src/backend/domains/ratchet/ratchet.service.ts"
      via: "barrel re-export"
      pattern: "from './ratchet.service'"
    - from: "src/backend/domains/ratchet/index.ts"
      to: "src/backend/domains/ratchet/ci-fixer.service.ts"
      via: "barrel re-export"
      pattern: "from './ci-fixer.service'"
    - from: "src/backend/domains/ratchet/index.ts"
      to: "src/backend/domains/ratchet/ci-monitor.service.ts"
      via: "barrel re-export"
      pattern: "from './ci-monitor.service'"
    - from: "src/backend/domains/ratchet/index.ts"
      to: "src/backend/domains/ratchet/fixer-session.service.ts"
      via: "barrel re-export"
      pattern: "from './fixer-session.service'"
    - from: "src/backend/domains/ratchet/index.ts"
      to: "src/backend/domains/ratchet/reconciliation.service.ts"
      via: "barrel re-export"
      pattern: "from './reconciliation.service'"
---

<objective>
Populate the ratchet domain barrel file (`index.ts`) with all public API exports and create a domain smoke test verifying barrel integrity.

Purpose: This finalizes the ratchet domain consolidation (RATCH-01, RATCH-02, RATCH-03). The barrel file becomes the single import point for all ratchet domain consumers. The smoke test ensures all exports are real (not undefined) and prevents future regressions from circular dependency breakage.

Output: Complete `src/backend/domains/ratchet/index.ts` barrel and `ratchet-domain-exports.test.ts` smoke test.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ratchet-domain-consolidation/05-RESEARCH.md

# Prior plan summaries needed: all prior plans to know exact exports
@.planning/phases/05-ratchet-domain-consolidation/05-01-SUMMARY.md
@.planning/phases/05-ratchet-domain-consolidation/05-02-SUMMARY.md

# Read the actual files to discover exact exports
@src/backend/domains/ratchet/ratchet.service.ts
@src/backend/domains/ratchet/ci-fixer.service.ts
@src/backend/domains/ratchet/ci-monitor.service.ts
@src/backend/domains/ratchet/fixer-session.service.ts
@src/backend/domains/ratchet/reconciliation.service.ts
@src/backend/domains/ratchet/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Populate ratchet domain barrel file with complete public API</name>
  <files>
    src/backend/domains/ratchet/index.ts
  </files>
  <action>
    Replace the placeholder barrel file at `src/backend/domains/ratchet/index.ts` with the complete public API.

    **Read each domain file** to discover all exported names (functions, classes, types, interfaces, constants, instances). Use `grep "^export" <file>` on each of the 5 domain files to get the exact export list.

    **Expected structure** following the Phase 2/3 barrel patterns -- grouped by concern with section comments, using selective named exports (not `export *`):

    ```typescript
    // Domain: ratchet
    // Public API for the ratchet domain module.
    // Consumers should import from '@/backend/domains/ratchet' only.

    // Core ratchet polling and dispatch
    export { ratchetService } from './ratchet.service';
    export type {
      RatchetAction,
      RatchetCheckResult,
      WorkspaceRatchetResult,
    } from './ratchet.service';

    // CI fixer
    export { ciFixerService } from './ci-fixer.service';
    export type { CIFailureDetails, CIFixResult } from './ci-fixer.service';

    // CI monitor (legacy, deprecated in favor of ratchet service)
    export { ciMonitorService } from './ci-monitor.service';

    // Shared fixer session acquisition
    export { fixerSessionService } from './fixer-session.service';
    export type {
      AcquireAndDispatchInput,
      AcquireAndDispatchResult,
      RunningIdleSessionAction,
    } from './fixer-session.service';

    // Reconciliation (workspace/session cleanup)
    export { reconciliationService } from './reconciliation.service';
    ```

    **Important:** The above is the expected structure from research. You MUST verify the actual exports by reading each file. If a file exports additional items, include them. If a file exports fewer items, adjust. Use selective named exports -- do NOT use `export *`. Biome may auto-sort exports alphabetically by import path; that is acceptable.

    After writing the barrel, run `pnpm typecheck` to verify all re-exports resolve correctly.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `grep "^export" src/backend/domains/ratchet/index.ts` shows all expected exports.
    The barrel does NOT use `export *` (selective exports only).
  </verify>
  <done>
    Barrel file at src/backend/domains/ratchet/index.ts exports the complete ratchet domain public API. Organized by concern with section comments. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ratchet domain smoke test and run full verification</name>
  <files>
    src/backend/domains/ratchet/ratchet-domain-exports.test.ts
  </files>
  <action>
    Create `src/backend/domains/ratchet/ratchet-domain-exports.test.ts` following the Phase 2/3 pattern (static imports, verify each export is defined).

    ```typescript
    import { describe, expect, it } from 'vitest';
    import {
      // Core ratchet
      ratchetService,
      // CI fixer
      ciFixerService,
      // CI monitor
      ciMonitorService,
      // Fixer session
      fixerSessionService,
      // Reconciliation
      reconciliationService,
    } from './index';

    describe('Ratchet domain exports', () => {
      it('exports ratchetService as an object', () => {
        expect(ratchetService).toBeDefined();
      });

      it('exports ciFixerService as an object', () => {
        expect(ciFixerService).toBeDefined();
      });

      it('exports ciMonitorService as an object', () => {
        expect(ciMonitorService).toBeDefined();
      });

      it('exports fixerSessionService as an object', () => {
        expect(fixerSessionService).toBeDefined();
      });

      it('exports reconciliationService as an object', () => {
        expect(reconciliationService).toBeDefined();
      });
    });
    ```

    **Important:** Adjust the import list and assertions based on the actual barrel exports (from Task 1). Every runtime export in the barrel should have a corresponding test assertion. Use static imports only (Biome forbids `await import()`). Type-only exports do not need assertions (types are erased at runtime).

    After creating the smoke test, run the full verification suite:

    1. `pnpm test src/backend/domains/ratchet/ratchet-domain-exports.test.ts` -- smoke test passes
    2. `pnpm test src/backend/domains/ratchet/` -- all domain tests pass
    3. `pnpm typecheck` -- full type checking passes
    4. `pnpm test` -- full test suite passes (no regressions)
  </action>
  <verify>
    `pnpm test src/backend/domains/ratchet/ratchet-domain-exports.test.ts` passes -- all 5 runtime exports verified defined.
    `pnpm test src/backend/domains/ratchet/` passes -- all domain tests pass (smoke + fixer-session + ci-fixer + ratchet + reconciliation).
    `pnpm typecheck` passes.
    `pnpm test` passes -- no regressions across the full test suite.
  </verify>
  <done>
    Ratchet domain smoke test verifies all barrel exports are real (not undefined). Full test suite passes. Phase 5 ratchet domain consolidation is complete. RATCH-01, RATCH-02, RATCH-03 are all satisfied.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test src/backend/domains/ratchet/` passes all domain tests (smoke test + 4 service tests)
- `pnpm test` passes -- full test suite, no regressions
- Barrel file exports: ratchetService, ciFixerService, ciMonitorService, fixerSessionService, reconciliationService (plus types)
- All re-export shims at old service paths work correctly
- No cross-domain imports from `@/backend/domains/session/` or `@/backend/domains/workspace/` in any ratchet domain file (only via shims)
- All 5 source files in flat structure at src/backend/domains/ratchet/
</verification>

<success_criteria>
Complete ratchet domain barrel file with all public API exports. Smoke test verifies all 5 runtime exports. Full test suite passes with zero regressions. All Phase 5 requirements (RATCH-01, RATCH-02, RATCH-03) satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/05-ratchet-domain-consolidation/05-03-SUMMARY.md`
</output>

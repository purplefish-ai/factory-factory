---
phase: 05-ratchet-domain-consolidation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/backend/domains/ratchet/ratchet.service.ts
  - src/backend/domains/ratchet/ratchet.service.test.ts
  - src/backend/domains/ratchet/reconciliation.service.ts
  - src/backend/domains/ratchet/reconciliation.service.test.ts
  - src/backend/services/ratchet.service.ts
  - src/backend/services/ratchet.service.test.ts
  - src/backend/services/reconciliation.service.ts
  - src/backend/services/reconciliation.service.test.ts
autonomous: true

must_haves:
  truths:
    - "ratchet.service.ts and reconciliation.service.ts are accessible from src/backend/domains/ratchet/"
    - "ratchet.service.ts uses intra-domain relative import for fixer-session.service"
    - "All external consumers (app-context, server.ts, workspace.trpc) compile via re-export shims"
    - "Existing tests for ratchet and reconciliation pass at new locations"
    - "pnpm typecheck passes after all moves"
  artifacts:
    - path: "src/backend/domains/ratchet/ratchet.service.ts"
      provides: "ratchetService singleton and types (RatchetAction, RatchetCheckResult, WorkspaceRatchetResult)"
      contains: "ratchetService"
    - path: "src/backend/domains/ratchet/reconciliation.service.ts"
      provides: "reconciliationService singleton"
      contains: "reconciliationService"
    - path: "src/backend/services/ratchet.service.ts"
      provides: "Re-export shim (app-context.ts, workspace.trpc.ts)"
    - path: "src/backend/services/reconciliation.service.ts"
      provides: "Re-export shim (server.ts, services/index.ts)"
  key_links:
    - from: "src/backend/domains/ratchet/ratchet.service.ts"
      to: "src/backend/domains/ratchet/fixer-session.service.ts"
      via: "intra-domain relative import"
      pattern: "from './fixer-session.service'"
    - from: "src/backend/services/ratchet.service.ts"
      to: "src/backend/domains/ratchet/ratchet.service.ts"
      via: "re-export shim"
      pattern: "export .* from '@/backend/domains/ratchet/ratchet.service'"
    - from: "src/backend/services/reconciliation.service.ts"
      to: "src/backend/domains/ratchet/reconciliation.service.ts"
      via: "re-export shim"
      pattern: "export .* from '@/backend/domains/ratchet/reconciliation.service'"
    - from: "src/backend/app-context.ts"
      to: "src/backend/services/ratchet.service.ts"
      via: "import through shim"
      pattern: "from './services/ratchet.service'"
    - from: "src/backend/server.ts"
      to: "src/backend/services/reconciliation.service.ts"
      via: "import through shim"
      pattern: "from './services/reconciliation.service'"
---

<objective>
Move ratchet.service.ts and reconciliation.service.ts into `src/backend/domains/ratchet/` with co-located tests and re-export shims at old paths.

Purpose: These are the two services with external consumers (app-context, server.ts, workspace.trpc). ratchet.service.ts is the core 1010-line polling loop and decision engine. reconciliation.service.ts handles workspace/session orphan cleanup. Both depend on Plan 01 having moved fixer-session to the domain so that ratchet.service.ts can use intra-domain relative imports.

Output: Two source files and two test files in `src/backend/domains/ratchet/`. Re-export shims at old paths. All 5 ratchet domain services now in place.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ratchet-domain-consolidation/05-RESEARCH.md
@.planning/phases/05-ratchet-domain-consolidation/05-01-SUMMARY.md
@src/backend/services/ratchet.service.ts
@src/backend/services/ratchet.service.test.ts
@src/backend/services/reconciliation.service.ts
@src/backend/services/reconciliation.service.test.ts
@src/backend/domains/ratchet/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move ratchet.service.ts to ratchet domain</name>
  <files>
    src/backend/domains/ratchet/ratchet.service.ts
    src/backend/domains/ratchet/ratchet.service.test.ts
    src/backend/services/ratchet.service.ts
    src/backend/services/ratchet.service.test.ts
  </files>
  <action>
    **Move ratchet.service.ts (1010 LOC):**

    1. Copy `src/backend/services/ratchet.service.ts` to `src/backend/domains/ratchet/ratchet.service.ts`. Update import paths:
       - `'@/backend/domains/session/session-domain.service'` -> stays unchanged (already absolute cross-domain path)
       - `'../prompts/ratchet-dispatch'` -> `'@/backend/prompts/ratchet-dispatch'`
       - `'../resource_accessors/claude-session.accessor'` -> `'@/backend/resource_accessors/claude-session.accessor'`
       - `'../resource_accessors/workspace.accessor'` -> `'@/backend/resource_accessors/workspace.accessor'`
       - `'./constants'` -> `'@/backend/services/constants'`
       - `'./fixer-session.service'` -> `'./fixer-session.service'` (intra-domain relative -- fixer-session already in domain from Plan 01)
       - `'./github-cli.service'` -> `'@/backend/services/github-cli.service'`
       - `'./logger.service'` -> `'@/backend/services/logger.service'`
       - `'./rate-limit-backoff'` -> `'@/backend/services/rate-limit-backoff'`
       - `'./session.service'` -> `'@/backend/services/session.service'` (cross-domain via shim)
       - `'@prisma-gen/client'` and `'p-limit'` stay unchanged

    2. Copy `src/backend/services/ratchet.service.test.ts` to `src/backend/domains/ratchet/ratchet.service.test.ts`. Update paths:
       - `vi.mock('../resource_accessors/workspace.accessor', ...)` -> `vi.mock('@/backend/resource_accessors/workspace.accessor', ...)`
       - `vi.mock('../resource_accessors/claude-session.accessor', ...)` -> `vi.mock('@/backend/resource_accessors/claude-session.accessor', ...)`
       - `vi.mock('./github-cli.service', ...)` -> `vi.mock('@/backend/services/github-cli.service', ...)`
       - `vi.mock('./fixer-session.service', ...)` stays `vi.mock('./fixer-session.service', ...)` (co-located in domain)
       - `vi.mock('./session.service', ...)` -> `vi.mock('@/backend/services/session.service', ...)`
       - `vi.mock('../domains/session/session-domain.service', ...)` -> `vi.mock('@/backend/domains/session/session-domain.service', ...)`
       - `vi.mock('./logger.service', ...)` -> `vi.mock('@/backend/services/logger.service', ...)`
       - Import of `claudeSessionAccessor` from `'../resource_accessors/claude-session.accessor'` -> `'@/backend/resource_accessors/claude-session.accessor'`
       - Import of `workspaceAccessor` from `'../resource_accessors/workspace.accessor'` -> `'@/backend/resource_accessors/workspace.accessor'`
       - Import of `fixerSessionService` from `'./fixer-session.service'` stays (co-located)
       - Import of `githubCLIService` from `'./github-cli.service'` -> `'@/backend/services/github-cli.service'`
       - Import of `ratchetService` from `'./ratchet.service'` stays (co-located)
       - Import of `sessionService` from `'./session.service'` -> `'@/backend/services/session.service'`
       - Import of `unsafeCoerce` from `'@/test-utils/unsafe-coerce'` stays unchanged

    3. Replace `src/backend/services/ratchet.service.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/ratchet' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export {
      ratchetService,
      type RatchetAction,
      type RatchetCheckResult,
      type WorkspaceRatchetResult,
    } from '@/backend/domains/ratchet/ratchet.service';
    ```

    Delete old test file: `src/backend/services/ratchet.service.test.ts`.

    Run `pnpm typecheck` to verify compilation. Run `pnpm test src/backend/domains/ratchet/ratchet.service.test.ts` to verify tests pass.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/ratchet/ratchet.service.test.ts` passes.
    Shim at old path compiles.
    `app-context.ts` still compiles (imports ratchetService via shim).
    `trpc/workspace.trpc.ts` still compiles (imports ratchetService via shim).
  </verify>
  <done>
    ratchet.service.ts (1010 LOC) lives at src/backend/domains/ratchet/ with co-located test (693 LOC). Uses intra-domain relative import ./fixer-session.service. Re-export shim at old path. All external consumers compile. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move reconciliation.service.ts to ratchet domain</name>
  <files>
    src/backend/domains/ratchet/reconciliation.service.ts
    src/backend/domains/ratchet/reconciliation.service.test.ts
    src/backend/services/reconciliation.service.ts
    src/backend/services/reconciliation.service.test.ts
  </files>
  <action>
    **Move reconciliation.service.ts (186 LOC):**

    1. Copy `src/backend/services/reconciliation.service.ts` to `src/backend/domains/ratchet/reconciliation.service.ts`. Update import paths:
       - `'../resource_accessors/index'` -> `'@/backend/resource_accessors/index'` (note: this file imports from the barrel, not individual accessors)
       - `'../trpc/workspace/init.trpc'` -> `'@/backend/trpc/workspace/init.trpc'` (absolute path -- this unusual cross-layer import is expected per research Pitfall 2)
       - `'./constants'` -> `'@/backend/services/constants'`
       - `'./logger.service'` -> `'@/backend/services/logger.service'`
       - `'./workspace-state-machine.service'` -> `'@/backend/services/workspace-state-machine.service'` (cross-domain via shim to workspace domain)
       - `'@prisma-gen/client'` stays unchanged

    2. Copy `src/backend/services/reconciliation.service.test.ts` to `src/backend/domains/ratchet/reconciliation.service.test.ts`. Update paths:
       - `vi.mock('../db', ...)` -> `vi.mock('@/backend/db', ...)`
       - `vi.mock('./logger.service', ...)` -> `vi.mock('@/backend/services/logger.service', ...)`
       - `vi.mock('../trpc/workspace/init.trpc', ...)` -> `vi.mock('@/backend/trpc/workspace/init.trpc', ...)`
       - Import of `workspaceAccessor` from `'../resource_accessors/index'` -> `'@/backend/resource_accessors/index'`
       - Import of `reconciliationService` from `'./reconciliation.service'` stays (co-located)

    Note: The reconciliation test mocks Prisma (`../db`) directly and also imports `workspaceAccessor` from the barrel. Both paths must be updated to absolute `@/backend/` paths.

    3. Replace `src/backend/services/reconciliation.service.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/ratchet' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export { reconciliationService } from '@/backend/domains/ratchet/reconciliation.service';
    ```

    Delete old test file: `src/backend/services/reconciliation.service.test.ts`.

    Run `pnpm typecheck` to verify compilation. Run `pnpm test src/backend/domains/ratchet/reconciliation.service.test.ts` to verify tests pass.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/ratchet/reconciliation.service.test.ts` passes.
    Shim at old path compiles.
    `server.ts` still compiles (imports reconciliationService via shim).
    `services/index.ts` still compiles (re-exports reconciliationService via shim).
  </verify>
  <done>
    reconciliation.service.ts lives at src/backend/domains/ratchet/ with co-located test. Uses absolute @/backend/ paths for all cross-domain and cross-layer imports. Re-export shim at old path. All 5 ratchet domain source files are now in place. pnpm typecheck passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test src/backend/domains/ratchet/` passes all tests (ratchet, reconciliation, plus fixer-session and ci-fixer from Plan 01)
- Re-export shims exist at: services/ratchet.service.ts, services/reconciliation.service.ts
- External consumers still compile: app-context.ts, server.ts, trpc/workspace.trpc.ts, services/index.ts
- Intra-domain imports: ratchet.service -> ./fixer-session.service
- Cross-domain imports use @/backend/ absolute paths
- All 5 source files now in src/backend/domains/ratchet/
</verification>

<success_criteria>
ratchet.service.ts and reconciliation.service.ts and their tests are established at src/backend/domains/ratchet/. ratchet.service.ts uses intra-domain relative import for fixer-session. All external consumers compile via re-export shims. pnpm typecheck passes. All 5 domain source files are in place, ready for barrel population in Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/05-ratchet-domain-consolidation/05-02-SUMMARY.md`
</output>

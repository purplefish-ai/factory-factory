---
phase: 05-ratchet-domain-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/domains/ratchet/fixer-session.service.ts
  - src/backend/domains/ratchet/fixer-session.service.test.ts
  - src/backend/domains/ratchet/ci-fixer.service.ts
  - src/backend/domains/ratchet/ci-fixer.service.test.ts
  - src/backend/domains/ratchet/ci-monitor.service.ts
  - src/backend/services/fixer-session.service.ts
  - src/backend/services/fixer-session.service.test.ts
  - src/backend/services/ci-fixer.service.ts
  - src/backend/services/ci-fixer.service.test.ts
  - src/backend/services/ci-monitor.service.ts
autonomous: true

must_haves:
  truths:
    - "fixer-session, ci-fixer, and ci-monitor services are accessible from src/backend/domains/ratchet/"
    - "All existing consumers compile via re-export shims at old paths"
    - "Existing tests for ci-fixer and fixer-session pass at new locations"
    - "pnpm typecheck passes after all moves"
  artifacts:
    - path: "src/backend/domains/ratchet/fixer-session.service.ts"
      provides: "fixerSessionService singleton and types (AcquireAndDispatchInput, AcquireAndDispatchResult, RunningIdleSessionAction)"
      contains: "fixerSessionService"
    - path: "src/backend/domains/ratchet/ci-fixer.service.ts"
      provides: "ciFixerService singleton and types (CIFailureDetails, CIFixResult)"
      contains: "ciFixerService"
    - path: "src/backend/domains/ratchet/ci-monitor.service.ts"
      provides: "ciMonitorService singleton"
      contains: "ciMonitorService"
    - path: "src/backend/services/fixer-session.service.ts"
      provides: "Re-export shim for backward compatibility (pr-review-fixer.service.ts, services/index.ts)"
    - path: "src/backend/services/ci-fixer.service.ts"
      provides: "Re-export shim for backward compatibility (services/index.ts)"
    - path: "src/backend/services/ci-monitor.service.ts"
      provides: "Re-export shim for backward compatibility"
  key_links:
    - from: "src/backend/domains/ratchet/ci-fixer.service.ts"
      to: "src/backend/domains/ratchet/fixer-session.service.ts"
      via: "intra-domain relative import"
      pattern: "from './fixer-session.service'"
    - from: "src/backend/domains/ratchet/ci-monitor.service.ts"
      to: "src/backend/domains/ratchet/ci-fixer.service.ts"
      via: "intra-domain relative import"
      pattern: "from './ci-fixer.service'"
    - from: "src/backend/services/fixer-session.service.ts"
      to: "src/backend/domains/ratchet/fixer-session.service.ts"
      via: "re-export shim"
      pattern: "export .* from '@/backend/domains/ratchet/fixer-session.service'"
---

<objective>
Move fixer-session, ci-fixer, and ci-monitor services into `src/backend/domains/ratchet/` with co-located tests and re-export shims at old paths.

Purpose: These three services are the leaf/internal services of the ratchet domain. fixer-session has no intra-ratchet dependencies, ci-fixer depends on fixer-session, and ci-monitor depends on ci-fixer. Moving them first establishes the domain files that ratchet.service.ts (Plan 02) will import via relative paths.

Output: Three source files and two test files in `src/backend/domains/ratchet/`. Re-export shims at all old paths.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ratchet-domain-consolidation/05-RESEARCH.md
@src/backend/services/fixer-session.service.ts
@src/backend/services/fixer-session.service.test.ts
@src/backend/services/ci-fixer.service.ts
@src/backend/services/ci-fixer.service.test.ts
@src/backend/services/ci-monitor.service.ts
@src/backend/domains/ratchet/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move fixer-session and ci-fixer to ratchet domain</name>
  <files>
    src/backend/domains/ratchet/fixer-session.service.ts
    src/backend/domains/ratchet/fixer-session.service.test.ts
    src/backend/domains/ratchet/ci-fixer.service.ts
    src/backend/domains/ratchet/ci-fixer.service.test.ts
    src/backend/services/fixer-session.service.ts
    src/backend/services/fixer-session.service.test.ts
    src/backend/services/ci-fixer.service.ts
    src/backend/services/ci-fixer.service.test.ts
  </files>
  <action>
    **Move fixer-session.service.ts (241 LOC):**

    1. Copy `src/backend/services/fixer-session.service.ts` to `src/backend/domains/ratchet/fixer-session.service.ts`. Update import paths:
       - `'../claude/session'` (SessionManager) -> `'@/backend/claude/session'` (absolute, cross-domain via existing shim to session domain)
       - `'../resource_accessors/claude-session.accessor'` -> `'@/backend/resource_accessors/claude-session.accessor'`
       - `'../resource_accessors/workspace.accessor'` -> `'@/backend/resource_accessors/workspace.accessor'`
       - `'./config.service'` -> `'@/backend/services/config.service'` (infrastructure service, stays in services/)
       - `'./logger.service'` -> `'@/backend/services/logger.service'`
       - `'./session.service'` -> `'@/backend/services/session.service'` (cross-domain via existing shim to session domain)
       - `'@prisma-gen/client'` stays unchanged (external package)

    2. Copy `src/backend/services/fixer-session.service.test.ts` to `src/backend/domains/ratchet/fixer-session.service.test.ts`. Update paths:
       - `vi.mock('../resource_accessors/workspace.accessor', ...)` -> `vi.mock('@/backend/resource_accessors/workspace.accessor', ...)`
       - `vi.mock('../resource_accessors/claude-session.accessor', ...)` -> `vi.mock('@/backend/resource_accessors/claude-session.accessor', ...)`
       - `vi.mock('./config.service', ...)` -> `vi.mock('@/backend/services/config.service', ...)`
       - `vi.mock('./session.service', ...)` -> `vi.mock('@/backend/services/session.service', ...)`
       - `vi.mock('./logger.service', ...)` -> `vi.mock('@/backend/services/logger.service', ...)`
       - Import of `workspaceAccessor` from `'../resource_accessors/workspace.accessor'` -> `'@/backend/resource_accessors/workspace.accessor'`
       - Import of `claudeSessionAccessor` from `'../resource_accessors/claude-session.accessor'` -> `'@/backend/resource_accessors/claude-session.accessor'`
       - Import of `configService` from `'./config.service'` -> `'@/backend/services/config.service'`
       - Import of `fixerSessionService` from `'./fixer-session.service'` -> stays `'./fixer-session.service'` (co-located)
       - Import of `sessionService` from `'./session.service'` -> `'@/backend/services/session.service'`

    3. Replace `src/backend/services/fixer-session.service.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/ratchet' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export {
      fixerSessionService,
      type AcquireAndDispatchInput,
      type AcquireAndDispatchResult,
      type RunningIdleSessionAction,
    } from '@/backend/domains/ratchet/fixer-session.service';
    ```

    Delete old test file: `src/backend/services/fixer-session.service.test.ts`.

    **Move ci-fixer.service.ts (180 LOC):**

    4. Copy `src/backend/services/ci-fixer.service.ts` to `src/backend/domains/ratchet/ci-fixer.service.ts`. Update import paths:
       - `'./fixer-session.service'` -> `'./fixer-session.service'` (intra-domain relative, same directory)
       - `'./logger.service'` -> `'@/backend/services/logger.service'`
       - `'./session.service'` -> `'@/backend/services/session.service'` (cross-domain)

    5. Copy `src/backend/services/ci-fixer.service.test.ts` to `src/backend/domains/ratchet/ci-fixer.service.test.ts`. Update paths:
       - `vi.mock('./fixer-session.service', ...)` stays `vi.mock('./fixer-session.service', ...)` (co-located)
       - `vi.mock('./session.service', ...)` -> `vi.mock('@/backend/services/session.service', ...)`
       - `vi.mock('./logger.service', ...)` -> `vi.mock('@/backend/services/logger.service', ...)`
       - Import of `ciFixerService` from `'./ci-fixer.service'` stays (co-located)
       - Import of `fixerSessionService` from `'./fixer-session.service'` stays (co-located)
       - Import of `sessionService` from `'./session.service'` -> `'@/backend/services/session.service'`
       - Import of `ClaudeClient` type from `'@/backend/claude'` stays unchanged

    6. Replace `src/backend/services/ci-fixer.service.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/ratchet' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export {
      ciFixerService,
      type CIFailureDetails,
      type CIFixResult,
    } from '@/backend/domains/ratchet/ci-fixer.service';
    ```

    Delete old test file: `src/backend/services/ci-fixer.service.test.ts`.

    Run `pnpm typecheck` to verify compilation. Run tests at new locations:
    - `pnpm test src/backend/domains/ratchet/fixer-session.service.test.ts`
    - `pnpm test src/backend/domains/ratchet/ci-fixer.service.test.ts`
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/ratchet/fixer-session.service.test.ts` passes.
    `pnpm test src/backend/domains/ratchet/ci-fixer.service.test.ts` passes.
    Shims exist at old paths and compile.
    `pr-review-fixer.service.ts` still compiles (imports fixerSessionService via old shim path).
  </verify>
  <done>
    fixer-session.service.ts and ci-fixer.service.ts live at src/backend/domains/ratchet/ with co-located tests. ci-fixer uses relative import ./fixer-session.service for intra-domain reference. Re-export shims at old paths. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move ci-monitor to ratchet domain</name>
  <files>
    src/backend/domains/ratchet/ci-monitor.service.ts
    src/backend/services/ci-monitor.service.ts
  </files>
  <action>
    **Move ci-monitor.service.ts (407 LOC):**

    1. Copy `src/backend/services/ci-monitor.service.ts` to `src/backend/domains/ratchet/ci-monitor.service.ts`. Update import paths:
       - `'../resource_accessors/claude-session.accessor'` -> `'@/backend/resource_accessors/claude-session.accessor'`
       - `'../resource_accessors/workspace.accessor'` -> `'@/backend/resource_accessors/workspace.accessor'`
       - `'./ci-fixer.service'` -> `'./ci-fixer.service'` (intra-domain relative, same directory)
       - `'./constants'` -> `'@/backend/services/constants'`
       - `'./github-cli.service'` -> `'@/backend/services/github-cli.service'`
       - `'./logger.service'` -> `'@/backend/services/logger.service'`
       - `'./rate-limit-backoff'` -> `'@/backend/services/rate-limit-backoff'`
       - `'./session.service'` -> `'@/backend/services/session.service'`
       - `'@prisma-gen/client'` and `'p-limit'` stay unchanged (external packages)

    Note: ci-monitor has `autoFixEnabled = false` hardcoded (legacy/deprecated). Move as-is -- do not remove or refactor any dead code.

    2. There is no test file for ci-monitor.service.ts. Nothing to move.

    3. Replace `src/backend/services/ci-monitor.service.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/ratchet' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export { ciMonitorService } from '@/backend/domains/ratchet/ci-monitor.service';
    ```

    Run `pnpm typecheck` to verify compilation.
  </action>
  <verify>
    `pnpm typecheck` passes.
    Shim at old path compiles.
    ci-monitor.service.ts in domain directory compiles with all imports resolved.
  </verify>
  <done>
    ci-monitor.service.ts lives at src/backend/domains/ratchet/ using intra-domain relative import ./ci-fixer.service. Re-export shim at old path. No test file for this service. pnpm typecheck passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test src/backend/domains/ratchet/` passes all tests (fixer-session, ci-fixer)
- Re-export shims exist at: services/fixer-session.service.ts, services/ci-fixer.service.ts, services/ci-monitor.service.ts
- External consumers still compile: pr-review-fixer.service.ts (imports fixerSessionService via shim), services/index.ts (exports ciFixerService, fixerSessionService, reconciliationService via shims)
- Intra-domain imports use relative paths: ci-fixer -> ./fixer-session.service, ci-monitor -> ./ci-fixer.service
</verification>

<success_criteria>
Three internal ratchet services (fixer-session, ci-fixer, ci-monitor) and their tests are established at src/backend/domains/ratchet/. Intra-domain relative imports used for internal dependencies. All existing code compiles via re-export shims. pnpm typecheck passes. Existing tests pass at new locations.
</success_criteria>

<output>
After completion, create `.planning/phases/05-ratchet-domain-consolidation/05-01-SUMMARY.md`
</output>

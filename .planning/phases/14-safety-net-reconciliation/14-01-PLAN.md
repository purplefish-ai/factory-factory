---
phase: 14-safety-net-reconciliation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/resource_accessors/workspace.accessor.ts
  - src/backend/services/workspace-snapshot-store.service.ts
  - src/backend/orchestration/snapshot-reconciliation.orchestrator.ts
  - src/backend/orchestration/snapshot-reconciliation.orchestrator.test.ts
autonomous: true

must_haves:
  truths:
    - "Reconciliation service can query all non-archived workspaces with sessions and project relation in a single DB call"
    - "Reconciliation service computes authoritative snapshot fields from DB workspace data, session working status, pending requests, and git stats"
    - "Git stats are computed only during reconciliation via p-limit(3) concurrency, never in event-driven paths"
    - "Drift detection compares existing snapshot entry against authoritative values and returns list of drifted fields"
    - "Reconciliation passes pollStartTs to every upsert so fresher event-driven updates are preserved"
    - "Stale snapshot entries (workspaces no longer in DB) are cleaned up after each reconciliation tick"
  artifacts:
    - path: "src/backend/resource_accessors/workspace.accessor.ts"
      provides: "findAllNonArchivedWithSessionsAndProject() method"
      contains: "findAllNonArchivedWithSessionsAndProject"
    - path: "src/backend/services/workspace-snapshot-store.service.ts"
      provides: "getAllWorkspaceIds() method"
      contains: "getAllWorkspaceIds"
    - path: "src/backend/orchestration/snapshot-reconciliation.orchestrator.ts"
      provides: "SnapshotReconciliationService class with configure/start/stop/reconcile"
      exports: ["snapshotReconciliationService", "configureSnapshotReconciliation", "ReconciliationBridges", "ReconciliationResult"]
    - path: "src/backend/orchestration/snapshot-reconciliation.orchestrator.test.ts"
      provides: "Unit tests for drift detection, pollStartTs behavior, git stats, stale cleanup"
      min_lines: 100
  key_links:
    - from: "src/backend/orchestration/snapshot-reconciliation.orchestrator.ts"
      to: "src/backend/resource_accessors/workspace.accessor.ts"
      via: "workspaceAccessor.findAllNonArchivedWithSessionsAndProject()"
      pattern: "workspaceAccessor\\.findAllNonArchived"
    - from: "src/backend/orchestration/snapshot-reconciliation.orchestrator.ts"
      to: "src/backend/services/workspace-snapshot-store.service.ts"
      via: "workspaceSnapshotStore.upsert() with pollStartTs"
      pattern: "workspaceSnapshotStore\\.upsert\\("
    - from: "src/backend/orchestration/snapshot-reconciliation.orchestrator.ts"
      to: "src/backend/services/git-ops.service.ts"
      via: "gitOpsService.getWorkspaceGitStats()"
      pattern: "gitOpsService\\.getWorkspaceGitStats"
---

<objective>
Create the snapshot reconciliation service that periodically recomputes workspace snapshots from authoritative DB and git sources, with drift detection and field-level timestamp safety.

Purpose: This is the safety net that catches any events missed by the event-driven pipeline (Phase 12-13), seeds the snapshot store on startup, and is the only path for expensive git stats computation.
Output: Working reconciliation service with tests, ready for server wiring in Plan 02.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-safety-net-reconciliation/14-RESEARCH.md
@.planning/phases/11-snapshot-store/11-01-SUMMARY.md
@.planning/phases/13-event-collector/13-01-SUMMARY.md
@src/backend/services/workspace-snapshot-store.service.ts
@src/backend/orchestration/event-collector.orchestrator.ts
@src/backend/orchestration/domain-bridges.orchestrator.ts
@src/backend/resource_accessors/workspace.accessor.ts
@src/backend/resource_accessors/project.accessor.ts
@src/backend/domains/workspace/query/workspace-query.service.ts
@src/backend/services/git-ops.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workspace accessor and store helper methods, create reconciliation service</name>
  <files>
    src/backend/resource_accessors/workspace.accessor.ts
    src/backend/services/workspace-snapshot-store.service.ts
    src/backend/orchestration/snapshot-reconciliation.orchestrator.ts
  </files>
  <action>
**Step 1: Add `findAllNonArchivedWithSessionsAndProject()` to WorkspaceAccessor**

In `src/backend/resource_accessors/workspace.accessor.ts`:
- Add a new Prisma payload type: `type WorkspaceWithSessionsAndProject = Prisma.WorkspaceGetPayload<{ include: { claudeSessions: true; terminalSessions: true; project: true } }>;`
- Add method to the class:
```typescript
findAllNonArchivedWithSessionsAndProject(): Promise<WorkspaceWithSessionsAndProject[]> {
  return prisma.workspace.findMany({
    where: { status: { not: 'ARCHIVED' } },
    include: {
      claudeSessions: true,
      terminalSessions: true,
      project: true,
    },
    orderBy: { updatedAt: 'desc' },
  });
}
```
- Export the `WorkspaceWithSessionsAndProject` type from the file.

**Step 2: Add `getAllWorkspaceIds()` to WorkspaceSnapshotStore**

In `src/backend/services/workspace-snapshot-store.service.ts`:
- Add method to the class:
```typescript
getAllWorkspaceIds(): string[] {
  return [...this.entries.keys()];
}
```

**Step 3: Create `snapshot-reconciliation.orchestrator.ts`**

In `src/backend/orchestration/snapshot-reconciliation.orchestrator.ts`:

The file structure follows the event-collector.orchestrator.ts pattern closely.

**Imports:**
- `pLimit` from 'p-limit'
- `workspaceAccessor` from `@/backend/resource_accessors/workspace.accessor`
- `gitOpsService` from `@/backend/services/git-ops.service`
- `createLogger`, `workspaceSnapshotStore`, `type SnapshotUpdateInput`, `type WorkspaceSnapshotEntry` from `@/backend/services`
- `sessionService` from `@/backend/domains/session`
- `chatEventForwarderService` from `@/backend/domains/session`

**Wait -- ARCH-02 concern:** The reconciliation service lives in orchestration/, not services/. ARCH-02 only applies to services/ (zero domain imports). Orchestration is explicitly allowed to import from domains (event-collector does it). So direct imports from session domain are fine.

Actually, re-reading the event-collector pattern and domain-bridges pattern more carefully: the event collector imports directly from domain barrels. But for session working status and pending requests, those are bridged in domain-bridges (kanbanStateService, workspaceQueryService use bridges). The reconciliation service should follow the same bridge pattern for consistency and testability.

**ReconciliationBridges interface:**
```typescript
export interface ReconciliationBridges {
  session: {
    isAnySessionWorking(sessionIds: string[]): boolean;
    getAllPendingRequests(): Map<string, { toolName: string }>;
  };
}
```

**Constants:**
- `RECONCILIATION_INTERVAL_MS = 60_000`
- `GIT_CONCURRENCY = 3`

**ReconciliationResult interface:**
```typescript
export interface ReconciliationResult {
  workspacesReconciled: number;
  driftsDetected: number;
  staleEntriesRemoved: number;
  gitStatsComputed: number;
  durationMs: number;
}
```

**DriftEntry interface** (not exported -- internal):
```typescript
interface DriftEntry {
  field: string;
  group: string;
  snapshotValue: unknown;
  authoritativeValue: unknown;
}
```

**`detectDrift` function** (exported for testing):
Pure function comparing an existing `WorkspaceSnapshotEntry` against `SnapshotUpdateInput`. Compare fields: status, name, branchName (workspace group); prState, prCiStatus, prNumber (pr group); ratchetEnabled, ratchetState (ratchet group); runScriptStatus (runScript group); isWorking, pendingRequestType (session group). For each field where `authoritative[field] !== undefined && authoritative[field] !== existing[field]`, push a DriftEntry. Return the array.

**`computePendingRequestType` function** (private helper):
Replicated from workspace-query.service.ts -- iterates sessionIds, checks pendingRequests map, returns 'plan_approval' | 'user_question' | null.

**SnapshotReconciliationService class:**

Instance fields:
- `private interval: NodeJS.Timeout | null = null`
- `private isShuttingDown = false`
- `private reconcileInProgress: Promise<ReconciliationResult> | null = null`
- `private bridges: ReconciliationBridges | null = null`

Methods:

`configure(bridges: ReconciliationBridges): void` -- stores bridges.

`start(): void`:
- If `this.interval` exists, return (already started)
- Set `isShuttingDown = false`
- Run initial reconciliation immediately: `this.reconcileInProgress = this.reconcile().catch(err => logger.error(...)).finally(() => { this.reconcileInProgress = null; })`
- Set up `this.interval = setInterval(() => { ... }, RECONCILIATION_INTERVAL_MS)` where the callback skips if `isShuttingDown` or `reconcileInProgress` is truthy, otherwise runs reconcile with catch/finally.

`async stop(): Promise<void>`:
- `isShuttingDown = true`
- Clear interval if set, null it
- Await reconcileInProgress if set

`async reconcile(): Promise<ReconciliationResult>`:
1. `const pollStartTs = Date.now()`
2. Fetch all non-archived workspaces: `const workspaces = await workspaceAccessor.findAllNonArchivedWithSessionsAndProject()`
3. Get pending requests from bridges: `const allPendingRequests = this.bridges!.session.getAllPendingRequests()`
4. Compute git stats with p-limit(GIT_CONCURRENCY):
   ```
   const gitLimit = pLimit(GIT_CONCURRENCY);
   const gitStatsMap = new Map<string, GitStatsResult | null>();
   await Promise.all(workspaces.map(ws => gitLimit(async () => {
     if (!ws.worktreePath) { gitStatsMap.set(ws.id, null); return; }
     const defaultBranch = ws.project?.defaultBranch ?? 'main';
     try {
       const stats = await gitOpsService.getWorkspaceGitStats(ws.worktreePath, defaultBranch);
       gitStatsMap.set(ws.id, stats);
     } catch {
       gitStatsMap.set(ws.id, null);
     }
   })));
   ```
5. For each workspace, build authoritative SnapshotUpdateInput:
   - projectId: ws.projectId
   - name: ws.name, status: ws.status, createdAt: ws.createdAt.toISOString(), branchName: ws.branchName
   - hasHadSessions: ws.hasHadSessions
   - prUrl: ws.prUrl, prNumber: ws.prNumber, prState: ws.prState, prCiStatus: ws.prCiStatus, prUpdatedAt: ws.prUpdatedAt?.toISOString() ?? null
   - ratchetEnabled: ws.ratchetEnabled, ratchetState: ws.ratchetState
   - runScriptStatus: ws.runScriptStatus
   - Session data via bridges:
     - sessionIds = [...(ws.claudeSessions?.map(s => s.id) ?? [])]
     - isWorking = this.bridges!.session.isAnySessionWorking(sessionIds)
     - pendingRequestType = computePendingRequestType(sessionIds, allPendingRequests)
   - gitStats: gitStatsMap.get(ws.id) ?? null
   - lastActivityAt: compute from max updatedAt across claudeSessions + terminalSessions (same logic as workspace-query.service.ts)
6. Drift detection (RCNL-04): `const existing = workspaceSnapshotStore.getByWorkspaceId(ws.id)`. If existing, call `detectDrift(existing, authoritativeFields)`. If drifts.length > 0, log with `logger.warn`. Accumulate total drift count.
7. Upsert: `workspaceSnapshotStore.upsert(ws.id, authoritativeFields, 'reconciliation', pollStartTs)` -- always pass pollStartTs for RCNL-03.
8. Stale entry cleanup: Get `const storeWorkspaceIds = new Set(workspaceSnapshotStore.getAllWorkspaceIds())`. Build `const dbWorkspaceIds = new Set(workspaces.map(w => w.id))`. For each ID in storeWorkspaceIds that is NOT in dbWorkspaceIds, call `workspaceSnapshotStore.remove(id)` and log. Count removals.
9. Log summary: `logger.info('Reconciliation complete', { workspacesReconciled, driftsDetected, staleEntriesRemoved, gitStatsComputed, durationMs: Date.now() - pollStartTs })`
10. Return ReconciliationResult.

**Module-level singleton + configure function:**
```typescript
export const snapshotReconciliationService = new SnapshotReconciliationService();

export function configureSnapshotReconciliation(): void {
  snapshotReconciliationService.configure({
    session: {
      isAnySessionWorking: (ids) => sessionService.isAnySessionWorking(ids),
      getAllPendingRequests: () => chatEventForwarderService.getAllPendingRequests(),
    },
  });
  snapshotReconciliationService.start();
}
```

NOTE: Import `sessionService` and `chatEventForwarderService` from `@/backend/domains/session` ONLY inside the `configureSnapshotReconciliation` function file. Since this is orchestration layer, direct domain imports are allowed (same as event-collector.orchestrator.ts and domain-bridges.orchestrator.ts).

Do NOT re-export from orchestration/index.ts (same circular dep avoidance as event-collector).

Run `pnpm check:fix` and `pnpm typecheck` to ensure no lint/type errors.
  </action>
  <verify>
    `pnpm typecheck` passes. `pnpm check:fix` passes. File exists at `src/backend/orchestration/snapshot-reconciliation.orchestrator.ts` with exports for `snapshotReconciliationService`, `configureSnapshotReconciliation`, `ReconciliationBridges`, `ReconciliationResult`, and `detectDrift`.
  </verify>
  <done>
    Reconciliation service exists with: configure/start/stop lifecycle, reconcile() method computing all authoritative fields, drift detection, stale cleanup, pollStartTs on every upsert. Workspace accessor has findAllNonArchivedWithSessionsAndProject(). Store has getAllWorkspaceIds(). All type checks pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for reconciliation service</name>
  <files>
    src/backend/orchestration/snapshot-reconciliation.orchestrator.test.ts
  </files>
  <action>
Create co-located test file `src/backend/orchestration/snapshot-reconciliation.orchestrator.test.ts`.

**Mock strategy:**
- Mock `@/backend/resource_accessors/workspace.accessor` -- mock `workspaceAccessor.findAllNonArchivedWithSessionsAndProject()`
- Mock `@/backend/services/git-ops.service` -- mock `gitOpsService.getWorkspaceGitStats()`
- Mock `@/backend/services` partially -- mock `workspaceSnapshotStore` methods (upsert, getByWorkspaceId, getAllWorkspaceIds, remove) and `createLogger`
- Mock `@/backend/domains/session` -- mock `sessionService.isAnySessionWorking()` and `chatEventForwarderService.getAllPendingRequests()`
- Use `vi.useFakeTimers()` for setInterval-based tests

**Import the real `detectDrift` function** for pure function testing.

**Test suites:**

1. **`describe('detectDrift')`** (pure function tests):
   - `it('returns empty array when all fields match')` -- same status, same prState -> []
   - `it('detects workspace field drift')` -- status differs -> [{field: 'status', group: 'workspace', ...}]
   - `it('detects PR field drift')` -- prState or prCiStatus differs
   - `it('detects session field drift')` -- isWorking differs
   - `it('ignores undefined authoritative fields')` -- authoritative has only status, other fields undefined -> only compares status
   - `it('detects multiple drifts across groups')` -- status + prState + isWorking all differ -> 3 entries

2. **`describe('SnapshotReconciliationService')`**:
   - `describe('reconcile()')`:
     - `it('upserts all non-archived workspaces with authoritative data')` -- set up 2 mock workspaces, verify upsert called for each with correct fields
     - `it('passes pollStartTs to every upsert call (RCNL-03)')` -- verify the 4th argument to upsert is the same timestamp for all calls, and it's <= Date.now()
     - `it('computes git stats only for workspaces with worktreePath')` -- 2 workspaces, 1 with worktreePath, 1 without -> getWorkspaceGitStats called once
     - `it('uses project defaultBranch for git stats')` -- workspace with project.defaultBranch='develop' -> getWorkspaceGitStats called with 'develop'
     - `it('handles git stats errors gracefully')` -- getWorkspaceGitStats throws -> gitStats is null, reconciliation continues
     - `it('detects drift for existing entries (RCNL-04)')` -- set up getByWorkspaceId to return existing entry with different status -> verify logger.warn called with drift info
     - `it('skips drift detection for new entries (no log spam on first run)')` -- getByWorkspaceId returns undefined -> no logger.warn call
     - `it('removes stale entries not in DB')` -- getAllWorkspaceIds returns ['ws-1', 'ws-2'], DB only has ws-1 -> store.remove('ws-2') called
     - `it('computes lastActivityAt from session timestamps')` -- workspace with claudeSessions and terminalSessions having various updatedAt -> lastActivityAt is the max
     - `it('computes pendingRequestType from session bridges')` -- set up getAllPendingRequests to return a map with ExitPlanMode -> pendingRequestType='plan_approval'
     - `it('returns ReconciliationResult with correct counts')` -- verify returned object has correct workspacesReconciled, driftsDetected, staleEntriesRemoved, gitStatsComputed, durationMs

   - `describe('lifecycle (start/stop)')`:
     - `it('runs initial reconciliation immediately on start()')` -- configure + start, verify reconcile runs once immediately
     - `it('skips tick if previous reconciliation still in progress')` -- make reconcile return a long-running promise, advance timer, verify reconcile not called again
     - `it('stop() clears interval and awaits in-progress reconciliation')` -- start, then stop, verify clearInterval called and promise resolved

For each test, use `beforeEach` to:
- Create a fresh `SnapshotReconciliationService` instance (import the class, not the singleton)
- Configure it with mock bridges
- Reset all mocks

Run `pnpm test src/backend/orchestration/snapshot-reconciliation.orchestrator.test.ts` to verify all tests pass.
Run `pnpm check:fix` to ensure formatting is correct.
  </action>
  <verify>
    `pnpm test src/backend/orchestration/snapshot-reconciliation.orchestrator.test.ts` passes with all tests green. `pnpm check:fix` passes.
  </verify>
  <done>
    Comprehensive test suite covers: drift detection (pure function, 6 cases), reconciliation core (authoritative data, pollStartTs, git stats, drift logging, stale cleanup, lastActivityAt, pendingRequestType, result counts -- 11 cases), and lifecycle (start/stop -- 3 cases). All tests pass.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with no errors
- `pnpm check:fix` passes with no errors
- `pnpm test src/backend/orchestration/snapshot-reconciliation.orchestrator.test.ts` all green
- `detectDrift` is a pure exported function with dedicated tests
- Every `upsert()` call in reconciliation passes explicit `pollStartTs` (grep for `'reconciliation'` source string)
- Git stats computed ONLY in reconciliation service (grep `getWorkspaceGitStats` -- only in git-ops.service.ts, workspace-query.service.ts, and this new file)
</verification>

<success_criteria>
- SnapshotReconciliationService exists with configure/start/stop/reconcile API
- Workspace accessor has findAllNonArchivedWithSessionsAndProject() for single-query fetch
- Store has getAllWorkspaceIds() for stale entry detection
- detectDrift pure function identifies field-level differences
- pollStartTs passed to every upsert (RCNL-03 compliance)
- Drift logged with field details (RCNL-04 compliance)
- Git stats computed with p-limit(3) concurrency (RCNL-02 compliance)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-safety-net-reconciliation/14-01-SUMMARY.md`
</output>

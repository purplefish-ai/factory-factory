---
phase: 14-safety-net-reconciliation
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/backend/server.ts
autonomous: true

must_haves:
  truths:
    - "Reconciliation starts after configureDomainBridges() and configureEventCollector() during server startup"
    - "Reconciliation stops cleanly during server shutdown, awaiting any in-progress reconciliation"
    - "Every ~60 seconds, snapshot entries are validated against authoritative DB state and corrected if stale (RCNL-01)"
    - "Git stats appear in snapshots but are only computed during reconciliation (RCNL-02)"
    - "Reconciliation does not overwrite event-driven updates that arrived after the poll started (RCNL-03)"
    - "Drift between event-driven state and authoritative sources is logged (RCNL-04)"
  artifacts:
    - path: "src/backend/server.ts"
      provides: "Reconciliation startup and shutdown wiring"
      contains: "configureSnapshotReconciliation"
  key_links:
    - from: "src/backend/server.ts"
      to: "src/backend/orchestration/snapshot-reconciliation.orchestrator.ts"
      via: "import and call configureSnapshotReconciliation() + snapshotReconciliationService.stop()"
      pattern: "configureSnapshotReconciliation"
---

<objective>
Wire the snapshot reconciliation service into server startup and shutdown lifecycle.

Purpose: Activates the reconciliation service so it starts polling on server boot and stops cleanly on shutdown.
Output: Modified server.ts with reconciliation integrated into the startup/shutdown sequence.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-safety-net-reconciliation/14-01-SUMMARY.md
@src/backend/server.ts
@src/backend/orchestration/snapshot-reconciliation.orchestrator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire reconciliation service into server startup and shutdown</name>
  <files>src/backend/server.ts</files>
  <action>
**Startup wiring (in server.listen callback):**

Add import at top of file (alongside the event-collector import):
```typescript
import {
  configureSnapshotReconciliation,
  snapshotReconciliationService,
} from './orchestration/snapshot-reconciliation.orchestrator';
```

In the `server.listen` callback, add `configureSnapshotReconciliation()` AFTER `configureEventCollector()` and BEFORE the existing `reconciliationService.cleanupOrphans()` block. The order must be:
1. `configureDomainBridges()` -- already exists (configures store derivation fns + all bridges)
2. `configureEventCollector()` -- already exists (wires events -> store)
3. `configureSnapshotReconciliation()` -- NEW (configures session bridges + starts poll timer, runs initial reconciliation)

This is correct because:
- configureDomainBridges() configures the snapshot store's derivation functions (needed before any upsert)
- configureEventCollector() starts event-driven updates
- configureSnapshotReconciliation() starts the safety-net poll (seeds store from DB on first tick)

**Shutdown wiring (in performCleanup):**

Add `await snapshotReconciliationService.stop()` in the `performCleanup` function AFTER `stopEventCollector()` and BEFORE `await ratchetService.stop()`. The reconciliation service should stop after the event collector (no more incoming events) but before domain services stop (reconciliation may be reading from domains during in-flight reconciliation).

The cleanup section should look like:
```typescript
await schedulerService.stop();
stopEventCollector();
await snapshotReconciliationService.stop();
await ratchetService.stop();
```

Run `pnpm typecheck` and `pnpm check:fix` to confirm.
  </action>
  <verify>
    `pnpm typecheck` passes. `pnpm check:fix` passes. Grep `server.ts` for `configureSnapshotReconciliation` confirms it exists after `configureEventCollector`. Grep for `snapshotReconciliationService.stop()` confirms it exists in performCleanup.
  </verify>
  <done>
    Server startup calls configureSnapshotReconciliation() after event collector setup. Server shutdown awaits snapshotReconciliationService.stop() before domain services stop. Full reconciliation lifecycle is active.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify all RCNL requirements</name>
  <files></files>
  <action>
Run the full verification suite to confirm nothing is broken:

1. `pnpm typecheck` -- full TypeScript check
2. `pnpm check:fix` -- Biome lint + format
3. `pnpm test` -- full test suite (should be ~1609+ tests all passing)
4. Verify RCNL requirements by inspection:
   - RCNL-01: grep for `setInterval` and `RECONCILIATION_INTERVAL_MS` in snapshot-reconciliation.orchestrator.ts (60_000ms)
   - RCNL-02: grep for `getWorkspaceGitStats` across the codebase -- should appear in git-ops.service.ts (definition), workspace-query.service.ts (existing usage), and snapshot-reconciliation.orchestrator.ts (new reconciliation usage). Should NOT appear in event-collector.orchestrator.ts.
   - RCNL-03: grep for `pollStartTs` in snapshot-reconciliation.orchestrator.ts -- every `upsert()` call must pass it
   - RCNL-04: grep for `detectDrift` and `logger.warn` in snapshot-reconciliation.orchestrator.ts -- drift is detected and logged

If any test fails, fix the issue. If any RCNL requirement is not met, fix the source file.
  </action>
  <verify>
    `pnpm typecheck` exits 0. `pnpm check:fix` exits 0. `pnpm test` all pass (0 failures). All 4 RCNL requirements confirmed by code inspection.
  </verify>
  <done>
    Full test suite passes with no regressions. All 4 RCNL requirements verified: 60s poll cadence (RCNL-01), git stats only in reconciliation (RCNL-02), pollStartTs on every upsert (RCNL-03), drift detection and logging (RCNL-04).
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm check:fix` passes
- `pnpm test` all pass (no regressions)
- server.ts startup order: configureDomainBridges -> configureEventCollector -> configureSnapshotReconciliation
- server.ts shutdown order: stopEventCollector -> snapshotReconciliationService.stop() -> ratchetService.stop()
- RCNL-01: setInterval with 60_000ms in reconciliation service
- RCNL-02: getWorkspaceGitStats NOT in event-collector, ONLY in reconciliation + workspace-query + git-ops
- RCNL-03: pollStartTs passed to every upsert in reconcile()
- RCNL-04: detectDrift + logger.warn for drifted fields
</verification>

<success_criteria>
- Server starts reconciliation on boot, stops on shutdown
- Full test suite passes with zero regressions
- All 4 RCNL requirements are met and verifiable
</success_criteria>

<output>
After completion, create `.planning/phases/14-safety-net-reconciliation/14-02-SUMMARY.md`
</output>

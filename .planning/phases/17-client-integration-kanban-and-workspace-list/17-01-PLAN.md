---
phase: 17-client-integration-kanban-and-workspace-list
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/frontend/lib/snapshot-to-kanban.ts
  - src/frontend/lib/snapshot-to-kanban.test.ts
  - src/frontend/hooks/use-project-snapshot-sync.ts
  - src/frontend/hooks/use-project-snapshot-sync.test.ts
  - src/frontend/components/kanban/kanban-context.tsx
  - src/client/routes/projects/workspaces/list.tsx
autonomous: true

must_haves:
  truths:
    - "Kanban board receives workspace state updates from WebSocket within ~200ms (not 15s poll)"
    - "Workspace table view still receives data via polling at relaxed 60s cadence"
    - "All three consumers (sidebar, kanban, workspace list) see the same workspace state at any moment"
    - "A polling fallback at 30-60s cadence remains active for both kanban and table view"
  artifacts:
    - path: "src/frontend/lib/snapshot-to-kanban.ts"
      provides: "mapSnapshotEntryToKanbanWorkspace mapping function"
      exports: ["mapSnapshotEntryToKanbanWorkspace"]
    - path: "src/frontend/lib/snapshot-to-kanban.test.ts"
      provides: "Tests for kanban mapping function"
    - path: "src/frontend/hooks/use-project-snapshot-sync.ts"
      provides: "Extended hook updating both sidebar AND kanban caches from WebSocket"
    - path: "src/frontend/components/kanban/kanban-context.tsx"
      provides: "KanbanProvider with reduced polling (30s instead of 15s)"
    - path: "src/client/routes/projects/workspaces/list.tsx"
      provides: "Workspace table view with relaxed polling (60s instead of 15s)"
  key_links:
    - from: "src/frontend/hooks/use-project-snapshot-sync.ts"
      to: "listWithKanbanState cache"
      via: "utils.workspace.listWithKanbanState.setData"
      pattern: "listWithKanbanState\\.setData"
    - from: "src/frontend/hooks/use-project-snapshot-sync.ts"
      to: "src/frontend/lib/snapshot-to-kanban.ts"
      via: "import mapSnapshotEntryToKanbanWorkspace"
      pattern: "mapSnapshotEntryToKanbanWorkspace"
---

<objective>
Extend the WebSocket-driven snapshot sync to update the Kanban board's React Query cache and relax polling cadences for both Kanban and workspace table view.

Purpose: The sidebar (Phase 16) already receives real-time workspace state via WebSocket. The Kanban board still polls at 15s and the table view at 15s. This plan extends `useProjectSnapshotSync` to also update the `listWithKanbanState` cache from WebSocket messages, giving the Kanban board ~200ms updates. The table view (secondary, not snapshot-driven) gets relaxed polling at 60s.

Output: Kanban board shows real-time workspace state changes, all three project surfaces (sidebar, kanban, table) show consistent state, safety-net polling at 30-60s remains active.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-client-integration-sidebar/16-01-SUMMARY.md

# Source files to read for implementation
@src/frontend/lib/snapshot-to-sidebar.ts
@src/frontend/lib/snapshot-to-sidebar.test.ts
@src/frontend/hooks/use-project-snapshot-sync.ts
@src/frontend/hooks/use-project-snapshot-sync.test.ts
@src/frontend/components/kanban/kanban-context.tsx
@src/frontend/components/kanban/kanban-card.tsx
@src/client/routes/projects/workspaces/list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create snapshot-to-kanban mapping function with tests</name>
  <files>
    src/frontend/lib/snapshot-to-kanban.ts
    src/frontend/lib/snapshot-to-kanban.test.ts
  </files>
  <action>
Create `src/frontend/lib/snapshot-to-kanban.ts` following the same pattern as `snapshot-to-sidebar.ts`.

**Mapping function `mapSnapshotEntryToKanbanWorkspace`:**
- Import `WorkspaceSnapshotEntry` from `@/frontend/lib/snapshot-to-sidebar` (reuse the existing type)
- Import `WorkspaceWithKanban` from `@/frontend/components/kanban/kanban-card`
- The function signature: `(entry: WorkspaceSnapshotEntry, existing?: Record<string, unknown>) => Record<string, unknown>`
  - Returns `Record<string, unknown>` (not `WorkspaceWithKanban`) to avoid needing the full Prisma `Workspace` type. The `as never` assertion in the setData callback handles the type boundary. This matches the pattern in `use-project-snapshot-sync.ts` where sidebar entries are `Record<string, unknown>[]`.
- Map these fields from snapshot (authoritative real-time state):
  - `id` <- `entry.workspaceId`
  - `name` <- `entry.name`
  - `status` <- `entry.status`
  - `createdAt` <- `new Date(entry.createdAt)` (convert string to Date, same as sidebar)
  - `branchName` <- `entry.branchName`
  - `prUrl` <- `entry.prUrl`
  - `prNumber` <- `entry.prNumber`
  - `prState` <- `entry.prState`
  - `prCiStatus` <- `entry.prCiStatus`
  - `ratchetEnabled` <- `entry.ratchetEnabled`
  - `ratchetState` <- `entry.ratchetState`
  - `runScriptStatus` <- `entry.runScriptStatus`
  - `kanbanColumn` <- `entry.kanbanColumn`
  - `isWorking` <- `entry.isWorking`
  - `ratchetButtonAnimated` <- `entry.ratchetButtonAnimated`
  - `flowPhase` <- `entry.flowPhase`
  - `pendingRequestType` <- `entry.pendingRequestType`
  - `isArchived` <- `false` (listWithKanbanState always returns non-archived workspaces)
- For fields NOT in snapshot, merge from `existing` cache entry (or default to null):
  - `description` <- `existing?.description ?? null`
  - `initErrorMessage` <- `existing?.initErrorMessage ?? null`
  - `githubIssueNumber` <- `existing?.githubIssueNumber ?? null`

**Tests (`snapshot-to-kanban.test.ts`):**
- Test that all snapshot fields map correctly (id rename, createdAt conversion, passthrough fields)
- Test that missing-from-snapshot fields merge from existing cache entry
- Test that missing-from-snapshot fields default to null when no existing entry
- Test that `isArchived` is always `false`
- Test that `kanbanColumn` passes through as-is (including null)

Follow the same test structure as `snapshot-to-sidebar.test.ts` with a `makeEntry` factory.
  </action>
  <verify>
Run `pnpm test src/frontend/lib/snapshot-to-kanban.test.ts` -- all tests pass.
Run `pnpm typecheck` -- no type errors.
  </verify>
  <done>
Pure mapping function exists that transforms WorkspaceSnapshotEntry to the kanban workspace shape, merging cache entries for fields not in the snapshot. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend sync hook to update kanban cache and reduce polling cadences</name>
  <files>
    src/frontend/hooks/use-project-snapshot-sync.ts
    src/frontend/hooks/use-project-snapshot-sync.test.ts
    src/frontend/components/kanban/kanban-context.tsx
    src/client/routes/projects/workspaces/list.tsx
  </files>
  <action>
**Extend `use-project-snapshot-sync.ts`:**

Import `mapSnapshotEntryToKanbanWorkspace` from `@/frontend/lib/snapshot-to-kanban`.

Add a second `KanbanCacheData` type alias (similar to existing `CacheData`):
```typescript
type KanbanCacheData = Record<string, unknown>[] | undefined;
```

In the `handleMessage` callback, after each existing `setData` call for sidebar, add a corresponding `setData` call for `utils.workspace.listWithKanbanState`:

**For `snapshot_full`:**
- Get existing kanban cache to merge missing fields: call setData updater
- Filter entries where `entry.kanbanColumn !== null` (matches server behavior: READY workspaces with no sessions are hidden)
- Map each entry via `mapSnapshotEntryToKanbanWorkspace(entry, existingById.get(entry.workspaceId))`
- Use `as never` type assertion on the updater (same as sidebar pattern)

**For `snapshot_changed`:**
- If `entry.kanbanColumn === null`, remove from kanban cache (workspace no longer belongs on kanban board)
- Otherwise, upsert: find existing entry by id, replace or append
- Merge with existing cache entry for description/initErrorMessage/githubIssueNumber
- Use `as never` type assertion

**For `snapshot_removed`:**
- Filter out the removed workspace from kanban cache (same pattern as sidebar removal)
- Use `as never` type assertion

**Reduce polling in `kanban-context.tsx`:**
- Change `refetchInterval: 15_000` to `refetchInterval: 30_000`
- Change `staleTime: 10_000` to `staleTime: 25_000`

**Reduce polling in `list.tsx`:**
- Change `refetchInterval: 15_000` to `refetchInterval: 60_000`
- Change `staleTime: 10_000` to `staleTime: 50_000`

**Extend `use-project-snapshot-sync.test.ts`:**

Add a second mock `setData` for kanban: `mockKanbanSetData`. Update the trpc mock to include:
```typescript
workspace: {
  getProjectSummaryState: { setData: mockSetData },
  listWithKanbanState: { setData: mockKanbanSetData },
}
```

Add tests:
- `snapshot_full` calls kanban setData and filters out entries with null kanbanColumn
- `snapshot_changed` upserts into kanban cache (replace existing, append new)
- `snapshot_changed` removes from kanban cache when kanbanColumn is null
- `snapshot_changed` merges existing cache entry fields (description, githubIssueNumber)
- `snapshot_removed` removes from kanban cache
  </action>
  <verify>
Run `pnpm test src/frontend/hooks/use-project-snapshot-sync.test.ts` -- all tests pass (old + new).
Run `pnpm typecheck` -- no type errors.
Run `pnpm check:fix` -- no lint/format issues.
Run `pnpm test` -- full suite passes with no regressions.
  </verify>
  <done>
The `useProjectSnapshotSync` hook updates both sidebar and kanban React Query caches from the same WebSocket connection. Kanban polling reduced from 15s to 30s. Table view polling reduced from 15s to 60s. All existing and new tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm test` -- full test suite passes with no regressions
2. `pnpm typecheck` -- zero type errors
3. `pnpm check:fix` -- zero lint/format violations
4. Grep for `listWithKanbanState.setData` in use-project-snapshot-sync.ts -- confirms kanban cache updates
5. Grep for `refetchInterval: 30_000` in kanban-context.tsx -- confirms reduced polling
6. Grep for `refetchInterval: 60_000` in list.tsx -- confirms reduced table view polling
</verification>

<success_criteria>
- Kanban board's `listWithKanbanState` cache is updated from WebSocket snapshot messages (snapshot_full, snapshot_changed, snapshot_removed)
- Kanban safety-net poll runs at 30s instead of 15s
- Table view safety-net poll runs at 60s instead of 15s
- Snapshot entries with null kanbanColumn are excluded from kanban cache (matching server behavior)
- Fields not in snapshot (description, initErrorMessage, githubIssueNumber) are merged from existing cache entries
- All tests pass, no type errors, no lint violations
</success_criteria>

<output>
After completion, create `.planning/phases/17-client-integration-kanban-and-workspace-list/17-01-SUMMARY.md`
</output>

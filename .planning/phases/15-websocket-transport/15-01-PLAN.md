---
phase: 15-websocket-transport
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/routers/websocket/snapshots.handler.ts
  - src/backend/routers/websocket/snapshots.handler.test.ts
  - src/backend/routers/websocket/index.ts
  - src/backend/server.ts
autonomous: true

must_haves:
  truths:
    - "A /snapshots WebSocket endpoint exists alongside /chat, /terminal, /dev-logs using the same handler pattern"
    - "When a client connects with a projectId query param, it immediately receives the full snapshot (all workspace entries for that project)"
    - "When a workspace snapshot changes, only the changed workspace entry is pushed to clients subscribed to that project"
    - "Clients subscribed to different projects do not receive each other's updates"
    - "After disconnect and reconnect, the client receives a full snapshot to recover from missed events"
  artifacts:
    - path: "src/backend/routers/websocket/snapshots.handler.ts"
      provides: "Snapshot WebSocket upgrade handler with project-scoped connection tracking and store event fan-out"
      exports: ["createSnapshotsUpgradeHandler", "handleSnapshotsUpgrade", "snapshotConnections"]
    - path: "src/backend/routers/websocket/snapshots.handler.test.ts"
      provides: "Tests covering full snapshot on connect, delta routing, project isolation, cleanup, readyState guard, bad request rejection"
      min_lines: 80
    - path: "src/backend/routers/websocket/index.ts"
      provides: "Barrel re-export of snapshot handler"
      contains: "createSnapshotsUpgradeHandler"
    - path: "src/backend/server.ts"
      provides: "Upgrade handler registration for /snapshots, SPA fallback exclusion, endpoints log entry"
      contains: "snapshotsUpgradeHandler"
  key_links:
    - from: "src/backend/routers/websocket/snapshots.handler.ts"
      to: "workspaceSnapshotStore"
      via: "EventEmitter subscription (SNAPSHOT_CHANGED, SNAPSHOT_REMOVED)"
      pattern: "workspaceSnapshotStore\\.on\\(SNAPSHOT_(CHANGED|REMOVED)"
    - from: "src/backend/routers/websocket/snapshots.handler.ts"
      to: "workspaceSnapshotStore.getByProjectId"
      via: "Full snapshot on connect"
      pattern: "workspaceSnapshotStore\\.getByProjectId"
    - from: "src/backend/server.ts"
      to: "src/backend/routers/websocket/snapshots.handler.ts"
      via: "Import and upgrade handler registration"
      pattern: "createSnapshotsUpgradeHandler"
---

<objective>
Create the /snapshots WebSocket endpoint that pushes snapshot changes to connected clients in real time, scoped by project ID.

Purpose: This is the transport layer that connects the in-memory snapshot store (Phase 11) to browser clients. On connect, clients receive a full project snapshot. On subsequent changes, only per-workspace deltas are pushed. This replaces the need for polling in Phase 16-17 client integration.

Output: A working WebSocket handler at /snapshots with tests, wired into the server alongside existing /chat, /terminal, /dev-logs handlers.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-websocket-transport/15-RESEARCH.md
@src/backend/routers/websocket/dev-logs.handler.ts
@src/backend/routers/websocket/dev-logs.handler.test.ts
@src/backend/routers/websocket/upgrade-utils.ts
@src/backend/routers/websocket/index.ts
@src/backend/server.ts
@src/backend/services/workspace-snapshot-store.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create snapshot WebSocket handler with tests</name>
  <files>
    src/backend/routers/websocket/snapshots.handler.ts
    src/backend/routers/websocket/snapshots.handler.test.ts
  </files>
  <action>
Create `snapshots.handler.ts` following the exact pattern from `dev-logs.handler.ts`:

**Handler file (`snapshots.handler.ts`):**

1. Imports: `IncomingMessage` from `node:http`, `Duplex` from `node:stream`, `WebSocket`/`WebSocketServer` from `ws`, `WS_READY_STATE` from `@/backend/constants`, `AppContext`/`createAppContext` from `../../app-context`, `getOrCreateConnectionSet`/`markWebSocketAlive`/`sendBadRequest` from `./upgrade-utils`, snapshot store types from `@/backend/services`.

2. Export type `SnapshotConnectionsMap = Map<string, Set<WebSocket>>` (keyed by projectId, not workspaceId).

3. Export `const snapshotConnections: SnapshotConnectionsMap = new Map()`.

4. Create a module-level `let storeSubscriptionActive = false` guard and a `function ensureStoreSubscription(connections, logger)` that:
   - Returns immediately if `storeSubscriptionActive` is true (idempotent).
   - Sets `storeSubscriptionActive = true`.
   - Subscribes to `workspaceSnapshotStore.on(SNAPSHOT_CHANGED, ...)`: looks up `connections.get(event.projectId)`, if no clients returns early, pre-serializes the message once as `JSON.stringify({ type: 'snapshot_changed', workspaceId: event.workspaceId, entry: event.entry })`, iterates over the Set and calls `ws.send(message)` only if `ws.readyState === WS_READY_STATE.OPEN`.
   - Subscribes to `workspaceSnapshotStore.on(SNAPSHOT_REMOVED, ...)`: same pattern, message is `{ type: 'snapshot_removed', workspaceId: event.workspaceId }`.
   - Logs `'Snapshot WebSocket store subscription active'` at info level.

5. Export `function createSnapshotsUpgradeHandler(appContext: AppContext)`:
   - Creates logger via `appContext.services.createLogger('snapshots-handler')`.
   - Calls `ensureStoreSubscription(snapshotConnections, logger)`.
   - Returns `function handleSnapshotsUpgrade(request, socket, head, url, wss, wsAliveMap)`:
     - Reads `projectId` from `url.searchParams.get('projectId')`.
     - If missing, logs warning and calls `sendBadRequest(socket)`, returns.
     - Calls `wss.handleUpgrade(request, socket, head, (ws) => { ... })`.
     - Inside callback: logs connection, calls `markWebSocketAlive(ws, wsAliveMap)`.
     - Adds ws to connection set FIRST via `getOrCreateConnectionSet(snapshotConnections, projectId).add(ws)`.
     - THEN sends full snapshot: `ws.send(JSON.stringify({ type: 'snapshot_full', projectId, entries: workspaceSnapshotStore.getByProjectId(projectId) }))`.
     - On `ws.on('close', ...)`: logs, removes ws from `snapshotConnections.get(projectId)` set, deletes empty set from map.
     - On `ws.on('error', ...)`: logs error.

6. Export `const handleSnapshotsUpgrade = createSnapshotsUpgradeHandler(createAppContext())` (default export for testing convenience, matching dev-logs pattern).

**Test file (`snapshots.handler.test.ts`):**

Follow the exact test pattern from `dev-logs.handler.test.ts`. Use MockWebSocket class extending EventEmitter with `readyState`, `send`, `close`, `terminate` as vi.fn().

Mock `@/backend/services` module to provide a mock `workspaceSnapshotStore` with:
- `getByProjectId` as `vi.fn()` returning test entries.
- `on` as `vi.fn()` that captures event listeners for manual invocation.

Tests to write (minimum 6):
1. **Sends full snapshot on connect** -- call handler with valid projectId, verify `ws.send` called with `{ type: 'snapshot_full', projectId, entries: [...] }`.
2. **Rejects connection without projectId** -- call handler without projectId query param, verify `sendBadRequest` called (mock `upgrade-utils`).
3. **Routes snapshot_changed to correct project clients** -- connect two clients to different projects, fire SNAPSHOT_CHANGED event for project A, verify only project A's client received the message and project B's did not.
4. **Sends snapshot_removed to project clients** -- connect client, fire SNAPSHOT_REMOVED event, verify ws.send called with `{ type: 'snapshot_removed', workspaceId }`.
5. **Does not send to non-OPEN sockets** -- connect client, set readyState to CLOSED, fire event, verify ws.send NOT called.
6. **Cleans up connection set on close** -- connect client, emit close event on ws, verify snapshotConnections map no longer contains that client. If it was the last client for that project, verify the project key is deleted.
  </action>
  <verify>
Run `pnpm test src/backend/routers/websocket/snapshots.handler.test.ts` -- all tests pass.
Run `pnpm typecheck` -- no type errors in new files.
  </verify>
  <done>
Handler file exports createSnapshotsUpgradeHandler, handleSnapshotsUpgrade, snapshotConnections. All 6+ tests pass. Store events are subscribed once (not per-connection). Full snapshot sent on connect. Deltas routed by projectId. ReadyState checked before send. Connection cleanup removes empty sets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire handler into server and update barrel export</name>
  <files>
    src/backend/routers/websocket/index.ts
    src/backend/server.ts
  </files>
  <action>
**Barrel export (`src/backend/routers/websocket/index.ts`):**

Add exports for the snapshot handler, matching the existing pattern. Add these lines:
```typescript
export {
  createSnapshotsUpgradeHandler,
  handleSnapshotsUpgrade,
  snapshotConnections,
} from './snapshots.handler';
```
Update the module docstring to mention snapshots: "Exports WebSocket upgrade handlers for chat, terminal, dev logs, and snapshots connections."

**Server wiring (`src/backend/server.ts`):**

4 changes needed:

1. **Import** (line ~47-50 area): Add `createSnapshotsUpgradeHandler` to the import from `./routers/websocket`.

2. **Handler creation** (line ~88 area, after devLogsUpgradeHandler): Add:
   ```typescript
   const snapshotsUpgradeHandler = createSnapshotsUpgradeHandler(context);
   ```

3. **Upgrade handler** (line ~220-239 area): Add a new `if` block for `/snapshots` BEFORE the `socket.destroy()` fallback, matching the pattern of the other handlers:
   ```typescript
   if (url.pathname === '/snapshots') {
     snapshotsUpgradeHandler(request, socket, head, url, wss, wsAliveMap);
     return;
   }
   ```

4. **SPA fallback exclusion** (line ~170-179 area): Add `req.path === '/snapshots'` to the exclusion condition, after the existing `/dev-logs` check:
   ```typescript
   req.path === '/snapshots' ||
   ```

5. **Server endpoints log** (line ~318-325 area): Add `wsSnapshots` to the logger.info call:
   ```typescript
   wsSnapshots: `ws://localhost:${actualPort}/snapshots`,
   ```

Do NOT touch the cleanup/shutdown sequence -- the snapshot handler has no cleanup needs (EventEmitter listeners on a singleton store are fine to leave, and the WebSocket connections are closed by `wss.close()` already in the cleanup).
  </action>
  <verify>
Run `pnpm typecheck` -- no errors.
Run `pnpm test` -- full test suite passes (no regressions).
Run `pnpm check:fix` -- Biome formatting/linting passes.
Verify the import exists: grep for `createSnapshotsUpgradeHandler` in server.ts.
Verify the SPA exclusion exists: grep for `'/snapshots'` in server.ts.
  </verify>
  <done>
The /snapshots WebSocket endpoint is registered in the server's upgrade handler alongside /chat, /terminal, /dev-logs. The SPA fallback excludes /snapshots. The barrel export re-exports all three snapshot handler symbols. The endpoints log includes wsSnapshots. Full test suite passes with no regressions.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify all WSKT requirements:

- **WSKT-01**: `grep -n 'snapshots' src/backend/server.ts` shows upgrade handler registration, SPA exclusion, and endpoints log entry. Handler file exists at `src/backend/routers/websocket/snapshots.handler.ts` following the factory pattern.
- **WSKT-02**: Test confirms full snapshot sent on connect via `snapshot_full` message with entries from `getByProjectId()`.
- **WSKT-03**: Test confirms `snapshot_changed` message with single workspace entry pushed to subscribed clients.
- **WSKT-04**: Test confirms project isolation -- clients on different projects do not receive each other's events.
- **WSKT-05**: Reconnect inherently handled -- every connect sends full snapshot (no server-side distinction between connect and reconnect). Test for WSKT-02 covers this.

Run: `pnpm test src/backend/routers/websocket/snapshots.handler.test.ts && pnpm typecheck && pnpm check:fix`
</verification>

<success_criteria>
1. `src/backend/routers/websocket/snapshots.handler.ts` exists with createSnapshotsUpgradeHandler factory
2. `src/backend/routers/websocket/snapshots.handler.test.ts` exists with 6+ passing tests
3. `/snapshots` registered in server.ts upgrade handler
4. `/snapshots` excluded from SPA fallback
5. Barrel index.ts re-exports snapshot handler symbols
6. `pnpm test` passes (no regressions)
7. `pnpm typecheck` passes
8. `pnpm check:fix` passes
</success_criteria>

<output>
After completion, create `.planning/phases/15-websocket-transport/15-01-SUMMARY.md`
</output>

---
phase: 03-workspace-domain-consolidation
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts
  - src/backend/domains/workspace/worktree/worktree-lifecycle.service.test.ts
  - src/backend/domains/workspace/worktree/worktree-init.test.ts
  - src/backend/services/worktree-lifecycle.service.ts
autonomous: true

must_haves:
  truths:
    - "WorktreeLifecycleService is accessible from domains/workspace/worktree/"
    - "Module-level workspaceInitModes Map eliminated -- now instance field (DOM-04)"
    - "Module-level resumeModeLocks Map eliminated -- now instance field (DOM-04)"
    - "Module-level cachedGitHubUsername eliminated -- now instance field (DOM-04)"
    - "Free functions setWorkspaceInitMode, getWorkspaceInitMode are now methods on WorktreeLifecycleService"
    - "assertWorktreePathSafe and WorktreePathSafetyError remain standalone exports (no module state)"
    - "All existing consumers compile via re-export shim at old path"
    - "pnpm typecheck passes"
  artifacts:
    - path: "src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts"
      provides: "WorktreeLifecycleService with instance-based state (DOM-04)"
      contains: "class WorktreeLifecycleService"
    - path: "src/backend/services/worktree-lifecycle.service.ts"
      provides: "Re-export shim with wrapper functions for setWorkspaceInitMode/getWorkspaceInitMode"
  key_links:
    - from: "src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts"
      to: "@/backend/services/workspace-state-machine.service"
      via: "import through shim (intra-domain, but shim still fine during consolidation)"
      pattern: "import.*workspace-state-machine"
    - from: "src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts"
      to: "@/backend/services/session.service"
      via: "cross-domain import through session shim"
      pattern: "import.*session.service"
    - from: "src/backend/services/worktree-lifecycle.service.ts"
      to: "src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts"
      via: "re-export shim with wrapper functions"
      pattern: "worktreeLifecycleService"
---

<objective>
Move worktree-lifecycle.service.ts into `src/backend/domains/workspace/worktree/` and refactor its 3 module-level global state items to instance fields (DOM-04). This is the largest and most complex file (818 LOC) with ~10 free functions that share module-level Maps.

Purpose: This file has the most DOM-04 violations in the workspace domain (3 globals: workspaceInitModes Map, resumeModeLocks Map, cachedGitHubUsername). The free functions that reference these globals must become instance methods on WorktreeLifecycleService. assertWorktreePathSafe and WorktreePathSafetyError don't use module state and remain standalone exports.

Output: `src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts` with instance-based state. Re-export shim at old path with wrapper functions for backward compatibility.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workspace-domain-consolidation/03-RESEARCH.md
@src/backend/services/worktree-lifecycle.service.ts
@src/backend/services/worktree-lifecycle.service.test.ts
@src/backend/services/worktree-lifecycle-init.test.ts
@src/backend/domains/workspace/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move worktree-lifecycle to domain and refactor global state to instance fields (DOM-04)</name>
  <files>
    src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts
    src/backend/domains/workspace/worktree/worktree-lifecycle.service.test.ts
    src/backend/domains/workspace/worktree/worktree-init.test.ts
    src/backend/services/worktree-lifecycle.service.ts
  </files>
  <action>
    Create directory `src/backend/domains/workspace/worktree/`.

    **Copy and refactor worktree-lifecycle (818 LOC):**

    1. Copy `src/backend/services/worktree-lifecycle.service.ts` to `src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts`.

    2. **DOM-04 refactoring -- eliminate 3 module-level globals:**

       a. Move `const workspaceInitModes = new Map<string, boolean>()` (line ~25) into `WorktreeLifecycleService` class as `private readonly initModes = new Map<string, boolean>()`.

       b. Move `const resumeModeLocks = new Map<string, Promise<void>>()` (line ~28) into `WorktreeLifecycleService` class as `private readonly resumeModeLocks = new Map<string, Promise<void>>()`.

       c. Move `let cachedGitHubUsername: string | null | undefined` (line ~189) into `WorktreeLifecycleService` class as `private cachedGitHubUsername: string | null | undefined`.

    3. **Convert free functions that use module-level state to instance methods:**

       - `setWorkspaceInitMode(workspaceId, useExistingBranch, worktreeBasePath)` (line ~134): Becomes `async setInitMode(...)` method on the class. It accesses `this.initModes` instead of the module-level Map.

       - `getWorkspaceInitMode(workspaceId, worktreeBasePath)` (line ~150): Becomes `async getInitMode(...)` method on the class. It accesses `this.initModes` instead of the module-level Map.

       - `withResumeModeLock(worktreeBasePath, handler)` (line ~44): Becomes a private method on the class. It accesses `this.resumeModeLocks` instead of the module-level Map.

       - The function that reads `cachedGitHubUsername` (around line 246, likely in `getGitHubUsername` or similar): Becomes a method on the class using `this.cachedGitHubUsername`.

       - `buildInitialPromptFromGitHubIssue(...)`: Check if it uses any module-level state. If it only uses `cachedGitHubUsername` indirectly through another function that's now a method, make it a method too. If it's a pure function, it can stay standalone.

       - `startDefaultClaudeSession(...)`: Check if it uses module-level state. If it doesn't, it can remain standalone. If it does, make it a method.

       **Important:** For each free function, check whether it references `workspaceInitModes`, `resumeModeLocks`, or `cachedGitHubUsername`. Only those that do MUST become methods. Pure functions like `assertWorktreePathSafe` and the `WorktreePathSafetyError` class do NOT use module state and should remain as standalone exports.

    4. **Update imports in the new file:**
       - `../resource_accessors/workspace.accessor` -> `@/backend/resource_accessors/workspace.accessor`
       - `../resource_accessors/claude-session.accessor` -> `@/backend/resource_accessors/claude-session.accessor`
       - `./workspace-state-machine.service` -> `@/backend/services/workspace-state-machine.service` (through shim -- this will become an intra-domain import in Plan 05, but for now the shim path works and avoids needing the barrel)
       - `./session.service` -> `@/backend/services/session.service` (cross-domain, stays on shim path)
       - `./chat-message-handlers.service` -> `@/backend/services/chat-message-handlers.service` (cross-domain)
       - All other service imports (`factory-config.service`, `git-ops.service`, `github-cli.service`, `logger.service`, `run-script.service`, `startup-script.service`, `terminal.service`) -> update to `@/backend/services/` absolute paths
       - `../lib/*` imports -> `@/backend/lib/` absolute paths
       - `@/backend/domains/session/session-domain.service` -- already absolute, unchanged
       - `@/shared/*` and `@prisma-gen/*` -- unchanged

    5. **Create re-export shim at old path** -- Replace `src/backend/services/worktree-lifecycle.service.ts` with:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/workspace' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    import { worktreeLifecycleService, assertWorktreePathSafe, WorktreePathSafetyError } from '@/backend/domains/workspace/worktree/worktree-lifecycle.service';

    export { worktreeLifecycleService, assertWorktreePathSafe, WorktreePathSafetyError };

    // Backward-compatible wrapper: old code calls setWorkspaceInitMode() as a free function,
    // but it's now an instance method on worktreeLifecycleService.
    export const setWorkspaceInitMode = (
      ...args: Parameters<typeof worktreeLifecycleService.setInitMode>
    ) => worktreeLifecycleService.setInitMode(...args);

    export const getWorkspaceInitMode = (
      ...args: Parameters<typeof worktreeLifecycleService.getInitMode>
    ) => worktreeLifecycleService.getInitMode(...args);
    ```

    **Move test files:**

    6. Copy `src/backend/services/worktree-lifecycle.service.test.ts` to `src/backend/domains/workspace/worktree/worktree-lifecycle.service.test.ts`. Update import of module under test to `./worktree-lifecycle.service`. Update `vi.mock` paths for dependencies. If tests mock the free functions `setWorkspaceInitMode`/`getWorkspaceInitMode`, update to mock the class methods instead (or mock the module and access the instance methods).

    7. Copy `src/backend/services/worktree-lifecycle-init.test.ts` to `src/backend/domains/workspace/worktree/worktree-init.test.ts`. Update import from `./worktree-lifecycle.service` to `./worktree-lifecycle.service`. Update all `vi.mock` paths to absolute paths matching the new file's import paths.

    Delete old test files: `src/backend/services/worktree-lifecycle.service.test.ts`, `src/backend/services/worktree-lifecycle-init.test.ts`.

    Run `pnpm typecheck` to verify compilation. Run tests at new locations.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/workspace/worktree/` passes all tests.
    Verify DOM-04 compliance: `grep -n "^const workspaceInitModes\|^const resumeModeLocks\|^let cachedGitHubUsername" src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts` returns no results (no module-level state).
    Verify instance fields exist: `grep -n "private.*initModes\|private.*resumeModeLocks\|private.*cachedGitHubUsername" src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts` returns 3 lines.
    Shim at old path compiles. `workspace-creation.service.ts` (imports `setWorkspaceInitMode`) still compiles via wrapper in shim.
  </verify>
  <done>
    worktree-lifecycle.service.ts lives at src/backend/domains/workspace/worktree/ with instance-based state (DOM-04). Three module-level globals eliminated. Free functions that used globals are now instance methods. assertWorktreePathSafe and WorktreePathSafetyError remain standalone exports. Re-export shim at old path with backward-compatible wrapper functions. pnpm typecheck passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test src/backend/domains/workspace/worktree/` passes all tests
- No module-level Maps or mutable lets in the new file (DOM-04 satisfied for all 3 globals)
- Instance fields exist on WorktreeLifecycleService class
- Re-export shim at old path with wrapper functions for setWorkspaceInitMode/getWorkspaceInitMode
- External consumers (workspace-creation, workspace.trpc, init.trpc) compile via shim
</verification>

<success_criteria>
WorktreeLifecycleService at src/backend/domains/workspace/worktree/ with all 3 module-level globals refactored to instance fields (DOM-04). Wrapper functions in shim maintain backward compatibility. All tests pass at new location. pnpm typecheck passes.
</success_criteria>

<output>
After completion, create `.planning/phases/03-workspace-domain-consolidation/03-03-SUMMARY.md`
</output>

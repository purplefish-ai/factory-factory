---
phase: 03-workspace-domain-consolidation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/domains/workspace/lifecycle/state-machine.service.ts
  - src/backend/domains/workspace/lifecycle/state-machine.service.test.ts
  - src/backend/domains/workspace/lifecycle/data.service.ts
  - src/backend/domains/workspace/lifecycle/activity.service.ts
  - src/backend/domains/workspace/lifecycle/activity.service.test.ts
  - src/backend/services/workspace-state-machine.service.ts
  - src/backend/services/workspace-data.service.ts
  - src/backend/services/workspace-activity.service.ts
autonomous: true

must_haves:
  truths:
    - "Workspace state machine (status transitions) is accessible from domains/workspace/lifecycle/"
    - "Workspace data service (CRUD wrapper) is accessible from domains/workspace/lifecycle/"
    - "Workspace activity service (session activity tracking) is accessible from domains/workspace/lifecycle/"
    - "All existing consumers compile via re-export shims at old paths"
    - "pnpm typecheck passes after all moves"
  artifacts:
    - path: "src/backend/domains/workspace/lifecycle/state-machine.service.ts"
      provides: "workspaceStateMachine, WorkspaceStateMachineError, TransitionOptions, StartProvisioningOptions"
      contains: "workspaceStateMachine"
    - path: "src/backend/domains/workspace/lifecycle/data.service.ts"
      provides: "workspaceDataService"
      contains: "workspaceDataService"
    - path: "src/backend/domains/workspace/lifecycle/activity.service.ts"
      provides: "workspaceActivityService"
      contains: "workspaceActivityService"
    - path: "src/backend/services/workspace-state-machine.service.ts"
      provides: "Re-export shim"
    - path: "src/backend/services/workspace-data.service.ts"
      provides: "Re-export shim"
    - path: "src/backend/services/workspace-activity.service.ts"
      provides: "Re-export shim"
  key_links:
    - from: "src/backend/services/workspace-state-machine.service.ts"
      to: "src/backend/domains/workspace/lifecycle/state-machine.service.ts"
      via: "re-export shim"
      pattern: "export .* from '@/backend/domains/workspace"
    - from: "src/backend/services/workspace-data.service.ts"
      to: "src/backend/domains/workspace/lifecycle/data.service.ts"
      via: "re-export shim"
      pattern: "export .* from '@/backend/domains/workspace"
---

<objective>
Move the state machine, data, and activity services into `src/backend/domains/workspace/lifecycle/`, with co-located tests and re-export shims at old paths.

Purpose: These three services form the middle dependency layer -- they depend on resource accessors and Prisma types but NOT on other workspace services. Moving them establishes the workspace domain's `lifecycle/` subdirectory. None require DOM-04 refactoring (activity already uses instance-based state, state-machine and data have no module-level state).

Output: `src/backend/domains/workspace/lifecycle/` with three source files and two test files (data.service has no tests -- it's a 33-line thin wrapper). Re-export shims at all old paths.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workspace-domain-consolidation/03-RESEARCH.md
@src/backend/services/workspace-state-machine.service.ts
@src/backend/services/workspace-state-machine.service.test.ts
@src/backend/services/workspace-data.service.ts
@src/backend/services/workspace-activity.service.ts
@src/backend/services/workspace-activity.service.test.ts
@src/backend/domains/workspace/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move state-machine and data services to workspace domain lifecycle/</name>
  <files>
    src/backend/domains/workspace/lifecycle/state-machine.service.ts
    src/backend/domains/workspace/lifecycle/state-machine.service.test.ts
    src/backend/domains/workspace/lifecycle/data.service.ts
    src/backend/services/workspace-state-machine.service.ts
    src/backend/services/workspace-data.service.ts
  </files>
  <action>
    Create directory `src/backend/domains/workspace/lifecycle/`.

    **Move state-machine (269 LOC):**

    1. Copy `src/backend/services/workspace-state-machine.service.ts` to `src/backend/domains/workspace/lifecycle/state-machine.service.ts`. This file imports:
       - `@prisma-gen/client` -- unchanged
       - `../resource_accessors/workspace.accessor` -- update to `@/backend/resource_accessors/workspace.accessor`
       - `./logger.service` -- update to `@/backend/services/logger.service`
       Check for any other relative imports to services/ and update to absolute `@/backend/services/` paths.

    2. Copy `src/backend/services/workspace-state-machine.service.test.ts` to `src/backend/domains/workspace/lifecycle/state-machine.service.test.ts`. Update the import of the module under test from `./workspace-state-machine.service` to `./state-machine.service`. Update any `vi.mock` paths: if the test mocks `../resource_accessors/workspace.accessor`, update to `@/backend/resource_accessors/workspace.accessor`. Update all mock paths that used relative references from the old location.

    3. Replace `src/backend/services/workspace-state-machine.service.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/workspace' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export {
      workspaceStateMachine,
      WorkspaceStateMachineError,
      type TransitionOptions,
      type StartProvisioningOptions,
    } from '@/backend/domains/workspace/lifecycle/state-machine.service';
    ```

    **Move data service (33 LOC):**

    4. Copy `src/backend/services/workspace-data.service.ts` to `src/backend/domains/workspace/lifecycle/data.service.ts`. This file imports:
       - `../resource_accessors/workspace.accessor` -- update to `@/backend/resource_accessors/workspace.accessor`
       No other imports to update. This is a thin wrapper, no tests.

    5. Replace `src/backend/services/workspace-data.service.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/workspace' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export { workspaceDataService } from '@/backend/domains/workspace/lifecycle/data.service';
    ```

    Delete old test file: `src/backend/services/workspace-state-machine.service.test.ts`.

    Run `pnpm typecheck` to verify compilation. Run tests at new location.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/workspace/lifecycle/state-machine.service.test.ts` passes.
    Shims at old paths compile. External consumers (app-context, init.trpc, reconciliation, startup-script, worktree-lifecycle) still compile via shims.
    workspace-data.service shim works for its 9 consumers (admin.trpc, workspace.trpc, github.trpc, session.trpc, init.trpc, ide.trpc, workspace-helpers, git.trpc, terminal.handler).
  </verify>
  <done>
    state-machine.service.ts and data.service.ts live at src/backend/domains/workspace/lifecycle/ with co-located tests. Re-export shims at old paths. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move activity service to workspace domain lifecycle/</name>
  <files>
    src/backend/domains/workspace/lifecycle/activity.service.ts
    src/backend/domains/workspace/lifecycle/activity.service.test.ts
    src/backend/services/workspace-activity.service.ts
  </files>
  <action>
    **Move activity service (120 LOC):**

    1. Copy `src/backend/services/workspace-activity.service.ts` to `src/backend/domains/workspace/lifecycle/activity.service.ts`. This file imports:
       - `node:events` -- unchanged
       - `@prisma-gen/client` -- unchanged
       - `./logger.service` -- update to `@/backend/services/logger.service`
       Check for any other relative imports and update to absolute paths.
       Note: This class already uses instance-based state (`private workspaceStates = new Map()`), so no DOM-04 changes needed.

    2. Copy `src/backend/services/workspace-activity.service.test.ts` to `src/backend/domains/workspace/lifecycle/activity.service.test.ts`. Update the import of the module under test from `./workspace-activity.service` to `./activity.service`. Update any `vi.mock` paths.

    3. Replace `src/backend/services/workspace-activity.service.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/workspace' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export { workspaceActivityService } from '@/backend/domains/workspace/lifecycle/activity.service';
    ```

    4. Update `src/backend/services/index.ts` -- the barrel re-exports `workspaceActivityService` from `./workspace-activity.service`. This will continue to work since the shim re-exports it. No change needed to services/index.ts.

    Delete old test file: `src/backend/services/workspace-activity.service.test.ts`.

    Run `pnpm typecheck` to verify compilation. Run tests at new location.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/workspace/lifecycle/activity.service.test.ts` passes.
    Shim at old path compiles. Session domain's `chat-event-forwarder.service.ts` (imports `workspaceActivityService` via old shim path `@/backend/services/workspace-activity.service`) still compiles.
    `services/index.ts` still re-exports `workspaceActivityService` via the shim chain.
  </verify>
  <done>
    activity.service.ts lives at src/backend/domains/workspace/lifecycle/ with co-located test. Re-export shim at old path. pnpm typecheck passes. All 3 lifecycle/ files are in place (state-machine, data, activity).
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test src/backend/domains/workspace/lifecycle/` passes all tests
- Re-export shims exist at: services/workspace-state-machine.service.ts, services/workspace-data.service.ts, services/workspace-activity.service.ts
- All external consumers compile via shims (5 for state-machine, 9 for data, 2 for activity)
- No DOM-04 changes needed in this plan (none of these files have module-level state)
</verification>

<success_criteria>
Three lifecycle services (state-machine, data, activity) and their tests are established at src/backend/domains/workspace/lifecycle/. All existing code compiles via re-export shims. pnpm typecheck passes.
</success_criteria>

<output>
After completion, create `.planning/phases/03-workspace-domain-consolidation/03-02-SUMMARY.md`
</output>

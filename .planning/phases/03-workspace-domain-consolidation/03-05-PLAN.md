---
phase: 03-workspace-domain-consolidation
plan: 05
type: execute
wave: 3
depends_on: ["03-01", "03-02", "03-03", "03-04"]
files_modified:
  - src/backend/domains/workspace/index.ts
  - src/backend/domains/workspace/workspace-domain-exports.test.ts
autonomous: true

must_haves:
  truths:
    - "All workspace domain exports are accessible from '@/backend/domains/workspace'"
    - "Barrel file exports all public API items: functions, classes, instances, and types"
    - "Domain smoke test verifies every export is defined (not undefined)"
    - "pnpm typecheck passes"
    - "Full test suite passes"
  artifacts:
    - path: "src/backend/domains/workspace/index.ts"
      provides: "Complete workspace domain barrel file"
      contains: "computeKanbanColumn"
    - path: "src/backend/domains/workspace/workspace-domain-exports.test.ts"
      provides: "Barrel integrity smoke test"
      contains: "Workspace domain exports"
  key_links:
    - from: "src/backend/domains/workspace/index.ts"
      to: "src/backend/domains/workspace/state/flow-state.ts"
      via: "barrel re-export"
      pattern: "from './state/flow-state'"
    - from: "src/backend/domains/workspace/index.ts"
      to: "src/backend/domains/workspace/state/kanban-state.ts"
      via: "barrel re-export"
      pattern: "from './state/kanban-state'"
    - from: "src/backend/domains/workspace/index.ts"
      to: "src/backend/domains/workspace/lifecycle/state-machine.service.ts"
      via: "barrel re-export"
      pattern: "from './lifecycle/state-machine.service'"
    - from: "src/backend/domains/workspace/index.ts"
      to: "src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts"
      via: "barrel re-export"
      pattern: "from './worktree/worktree-lifecycle.service'"
    - from: "src/backend/domains/workspace/index.ts"
      to: "src/backend/domains/workspace/query/workspace-query.service.ts"
      via: "barrel re-export"
      pattern: "from './query/workspace-query.service'"
---

<objective>
Populate the workspace domain barrel file (`index.ts`) with all public API exports and create a domain smoke test verifying barrel integrity.

Purpose: This finalizes the workspace domain consolidation (WORK-05). The barrel file becomes the single import point for all workspace domain consumers. The smoke test ensures all exports are real (not undefined) and prevents future regressions.

Output: Complete `src/backend/domains/workspace/index.ts` barrel and `workspace-domain-exports.test.ts` smoke test.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workspace-domain-consolidation/03-RESEARCH.md

# Prior plan summaries needed: all prior plans to know exact exports
@.planning/phases/03-workspace-domain-consolidation/03-01-SUMMARY.md
@.planning/phases/03-workspace-domain-consolidation/03-02-SUMMARY.md
@.planning/phases/03-workspace-domain-consolidation/03-03-SUMMARY.md
@.planning/phases/03-workspace-domain-consolidation/03-04-SUMMARY.md

# Read the actual files to discover exact exports
@src/backend/domains/workspace/state/flow-state.ts
@src/backend/domains/workspace/state/kanban-state.ts
@src/backend/domains/workspace/state/init-policy.ts
@src/backend/domains/workspace/lifecycle/state-machine.service.ts
@src/backend/domains/workspace/lifecycle/data.service.ts
@src/backend/domains/workspace/lifecycle/activity.service.ts
@src/backend/domains/workspace/lifecycle/creation.service.ts
@src/backend/domains/workspace/worktree/worktree-lifecycle.service.ts
@src/backend/domains/workspace/query/workspace-query.service.ts
@src/backend/domains/workspace/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Populate workspace domain barrel file with complete public API</name>
  <files>
    src/backend/domains/workspace/index.ts
  </files>
  <action>
    Replace the placeholder barrel file at `src/backend/domains/workspace/index.ts` with the complete public API.

    **Read each domain file** to discover all exported names (functions, classes, types, interfaces, constants, instances). Use `grep "^export" <file>` on each of the 9 domain files to get the exact export list.

    **Structure the barrel file** following the Phase 2 session domain pattern -- grouped by subdomain with section comments, using selective named exports (not `export *`):

    ```typescript
    // Domain: workspace
    // Public API for the workspace domain module.
    // Consumers should import from '@/backend/domains/workspace' only.

    // --- State derivation (pure functions) ---
    export {
      deriveWorkspaceFlowState,
      deriveWorkspaceFlowStateFromWorkspace,
      type WorkspaceFlowPhase,
      type WorkspaceFlowState,
      type WorkspaceFlowStateInput,
      type WorkspaceFlowStateSource,
      type WorkspaceCiObservation,
    } from './state/flow-state';

    export {
      computeKanbanColumn,
      kanbanStateService,
      type KanbanStateInput,
      type WorkspaceWithKanbanState,
    } from './state/kanban-state';

    export {
      getWorkspaceInitPolicy,
      type WorkspaceInitPolicy,
      type WorkspaceInitPolicyInput,
    } from './state/init-policy';

    // --- Workspace lifecycle ---
    export {
      workspaceStateMachine,
      WorkspaceStateMachineError,
      type TransitionOptions,
      type StartProvisioningOptions,
    } from './lifecycle/state-machine.service';

    export { workspaceDataService } from './lifecycle/data.service';

    export { workspaceActivityService } from './lifecycle/activity.service';

    export {
      WorkspaceCreationService,
      type WorkspaceCreationSource,
      type WorkspaceCreationResult,
      type WorkspaceCreationDependencies,
    } from './lifecycle/creation.service';

    // --- Worktree management ---
    export {
      worktreeLifecycleService,
      assertWorktreePathSafe,
      WorktreePathSafetyError,
    } from './worktree/worktree-lifecycle.service';

    // --- Workspace query/aggregation ---
    export { workspaceQueryService } from './query/workspace-query.service';
    ```

    **Important:** The above is the expected structure from research. You MUST verify the actual exports by reading each file. If a file exports additional items, include them. If a file exports fewer items, adjust. Use selective named exports -- do NOT use `export *`.

    After writing the barrel, run `pnpm typecheck` to verify all re-exports resolve correctly. If typecheck reveals additional types that need exporting, add them.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `grep "^export" src/backend/domains/workspace/index.ts` shows all expected exports.
    The barrel does NOT use `export *` (selective exports only).
  </verify>
  <done>
    Barrel file at src/backend/domains/workspace/index.ts exports the complete workspace domain public API. Organized by subdomain with section comments. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create workspace domain smoke test and run full verification</name>
  <files>
    src/backend/domains/workspace/workspace-domain-exports.test.ts
  </files>
  <action>
    Create `src/backend/domains/workspace/workspace-domain-exports.test.ts` following the Phase 2 session domain pattern (static imports, verify each export is defined).

    ```typescript
    import { describe, expect, it } from 'vitest';
    import {
      // State derivation
      computeKanbanColumn,
      deriveWorkspaceFlowState,
      deriveWorkspaceFlowStateFromWorkspace,
      getWorkspaceInitPolicy,
      kanbanStateService,
      // Lifecycle
      workspaceStateMachine,
      WorkspaceStateMachineError,
      workspaceDataService,
      workspaceActivityService,
      WorkspaceCreationService,
      // Worktree
      worktreeLifecycleService,
      assertWorktreePathSafe,
      WorktreePathSafetyError,
      // Query
      workspaceQueryService,
    } from './index';

    describe('Workspace domain exports', () => {
      // State derivation
      it('exports computeKanbanColumn as a function', () => {
        expect(typeof computeKanbanColumn).toBe('function');
      });
      it('exports deriveWorkspaceFlowState as a function', () => {
        expect(typeof deriveWorkspaceFlowState).toBe('function');
      });
      it('exports deriveWorkspaceFlowStateFromWorkspace as a function', () => {
        expect(typeof deriveWorkspaceFlowStateFromWorkspace).toBe('function');
      });
      it('exports getWorkspaceInitPolicy as a function', () => {
        expect(typeof getWorkspaceInitPolicy).toBe('function');
      });
      it('exports kanbanStateService as an object', () => {
        expect(kanbanStateService).toBeDefined();
      });

      // Lifecycle
      it('exports workspaceStateMachine as an object', () => {
        expect(workspaceStateMachine).toBeDefined();
      });
      it('exports WorkspaceStateMachineError as a constructor', () => {
        expect(typeof WorkspaceStateMachineError).toBe('function');
      });
      it('exports workspaceDataService as an object', () => {
        expect(workspaceDataService).toBeDefined();
      });
      it('exports workspaceActivityService as an object', () => {
        expect(workspaceActivityService).toBeDefined();
      });
      it('exports WorkspaceCreationService as a constructor', () => {
        expect(typeof WorkspaceCreationService).toBe('function');
      });

      // Worktree
      it('exports worktreeLifecycleService as an object', () => {
        expect(worktreeLifecycleService).toBeDefined();
      });
      it('exports assertWorktreePathSafe as a function', () => {
        expect(typeof assertWorktreePathSafe).toBe('function');
      });
      it('exports WorktreePathSafetyError as a constructor', () => {
        expect(typeof WorktreePathSafetyError).toBe('function');
      });

      // Query
      it('exports workspaceQueryService as an object', () => {
        expect(workspaceQueryService).toBeDefined();
      });
    });
    ```

    **Important:** Adjust the import list and assertions based on the actual barrel exports (from Task 1). Every export in the barrel should have a corresponding test assertion. Use static imports only (Biome forbids `await import()`).

    After creating the smoke test, run the full verification suite:

    1. `pnpm test src/backend/domains/workspace/workspace-domain-exports.test.ts` -- smoke test passes
    2. `pnpm test src/backend/domains/workspace/` -- all domain tests pass
    3. `pnpm typecheck` -- full type checking passes
    4. `pnpm test` -- full test suite passes (no regressions)
  </action>
  <verify>
    `pnpm test src/backend/domains/workspace/workspace-domain-exports.test.ts` passes -- all exports verified defined.
    `pnpm test src/backend/domains/workspace/` passes -- all domain tests pass.
    `pnpm typecheck` passes.
    `pnpm test` passes -- no regressions across the full test suite.
  </verify>
  <done>
    Workspace domain smoke test verifies all barrel exports are real (not undefined). Full test suite passes. Phase 3 workspace domain consolidation is complete. WORK-01 through WORK-05 and DOM-04 (workspace portion) are all satisfied.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test src/backend/domains/workspace/` passes all domain tests (state, lifecycle, worktree, query, smoke test)
- `pnpm test` passes -- full test suite, no regressions
- Barrel file exports: computeKanbanColumn, deriveWorkspaceFlowState, deriveWorkspaceFlowStateFromWorkspace, getWorkspaceInitPolicy, kanbanStateService, workspaceStateMachine, WorkspaceStateMachineError, workspaceDataService, workspaceActivityService, WorkspaceCreationService, worktreeLifecycleService, assertWorktreePathSafe, WorktreePathSafetyError, workspaceQueryService (plus types)
- All re-export shims at old service paths work correctly
- No cross-domain imports from `@/backend/domains/session/` in any workspace domain file
- DOM-04: No module-level Maps or mutable lets in any workspace domain file (4 globals eliminated)
</verification>

<success_criteria>
Complete workspace domain barrel file with all public API exports. Smoke test verifies all exports. Full test suite passes with zero regressions. All Phase 3 requirements (WORK-01 through WORK-05, DOM-04) satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/03-workspace-domain-consolidation/03-05-SUMMARY.md`
</output>

---
phase: 03-workspace-domain-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/backend/domains/workspace/state/flow-state.ts
  - src/backend/domains/workspace/state/flow-state.test.ts
  - src/backend/domains/workspace/state/kanban-state.ts
  - src/backend/domains/workspace/state/kanban-state.test.ts
  - src/backend/domains/workspace/state/init-policy.ts
  - src/backend/domains/workspace/state/init-policy.test.ts
  - src/backend/services/workspace-flow-state.service.ts
  - src/backend/services/kanban-state.service.ts
  - src/backend/services/workspace-init-policy.service.ts
autonomous: true

must_haves:
  truths:
    - "Pure state derivation functions (flow-state, kanban-state, init-policy) are accessible from domains/workspace/state/"
    - "All existing consumers compile via re-export shims at old paths"
    - "Existing tests pass at new locations"
    - "pnpm typecheck passes after all moves"
  artifacts:
    - path: "src/backend/domains/workspace/state/flow-state.ts"
      provides: "deriveWorkspaceFlowState and related exports"
      contains: "deriveWorkspaceFlowState"
    - path: "src/backend/domains/workspace/state/kanban-state.ts"
      provides: "computeKanbanColumn, kanbanStateService"
      contains: "computeKanbanColumn"
    - path: "src/backend/domains/workspace/state/init-policy.ts"
      provides: "getWorkspaceInitPolicy"
      contains: "getWorkspaceInitPolicy"
    - path: "src/backend/services/workspace-flow-state.service.ts"
      provides: "Re-export shim for backward compatibility"
    - path: "src/backend/services/kanban-state.service.ts"
      provides: "Re-export shim for backward compatibility"
    - path: "src/backend/services/workspace-init-policy.service.ts"
      provides: "Re-export shim for backward compatibility"
  key_links:
    - from: "src/backend/domains/workspace/state/kanban-state.ts"
      to: "src/backend/domains/workspace/state/flow-state.ts"
      via: "relative import"
      pattern: "from './flow-state'"
    - from: "src/backend/services/workspace-flow-state.service.ts"
      to: "src/backend/domains/workspace/state/flow-state.ts"
      via: "re-export shim"
      pattern: "export .* from '@/backend/domains/workspace'"
    - from: "src/backend/services/kanban-state.service.ts"
      to: "src/backend/domains/workspace/state/kanban-state.ts"
      via: "re-export shim"
      pattern: "export .* from '@/backend/domains/workspace'"
---

<objective>
Move the three pure state-derivation files (flow-state, kanban-state, init-policy) into `src/backend/domains/workspace/state/`, with co-located tests and re-export shims at old paths.

Purpose: These are the lowest-dependency workspace files -- pure functions with no intra-workspace service dependencies. Moving them first establishes the workspace domain's `state/` subdirectory. kanban-state imports from flow-state, so both must move together.

Output: `src/backend/domains/workspace/state/` with three source files and three test files. Re-export shims at all old paths.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workspace-domain-consolidation/03-RESEARCH.md
@src/backend/services/workspace-flow-state.service.ts
@src/backend/services/workspace-flow-state.service.test.ts
@src/backend/services/kanban-state.service.ts
@src/backend/services/kanban-state.service.test.ts
@src/backend/services/workspace-init-policy.service.ts
@src/backend/services/workspace-init-policy.service.test.ts
@src/backend/domains/workspace/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move flow-state and kanban-state to workspace domain state/</name>
  <files>
    src/backend/domains/workspace/state/flow-state.ts
    src/backend/domains/workspace/state/flow-state.test.ts
    src/backend/domains/workspace/state/kanban-state.ts
    src/backend/domains/workspace/state/kanban-state.test.ts
    src/backend/services/workspace-flow-state.service.ts
    src/backend/services/kanban-state.service.ts
  </files>
  <action>
    Create directory `src/backend/domains/workspace/state/`.

    **Move flow-state (168 LOC):**

    1. Copy `src/backend/services/workspace-flow-state.service.ts` to `src/backend/domains/workspace/state/flow-state.ts`. This file imports from `@prisma-gen/client` and `../resource_accessors/workspace.accessor` only. Update the resource accessor import to `@/backend/resource_accessors/workspace.accessor` (absolute path, since the relative path changes). All other imports are external packages and remain unchanged.

    2. Copy `src/backend/services/workspace-flow-state.service.test.ts` to `src/backend/domains/workspace/state/flow-state.test.ts`. Update the import of the module under test from `./workspace-flow-state.service` to `./flow-state`. Update any `vi.mock` paths: if the test mocks `./workspace-flow-state.service`, change to `./flow-state`. If it mocks resource accessors via relative path, update to the new relative path or keep the absolute alias.

    3. Replace `src/backend/services/workspace-flow-state.service.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/workspace' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export {
      deriveWorkspaceFlowState,
      deriveWorkspaceFlowStateFromWorkspace,
      type WorkspaceFlowPhase,
      type WorkspaceFlowState,
      type WorkspaceFlowStateInput,
      type WorkspaceFlowStateSource,
      type WorkspaceCiObservation,
    } from '@/backend/domains/workspace/state/flow-state';
    ```
    Note: The shim re-exports from the direct module path (not the barrel) to avoid circular issues since the barrel is not yet populated. This will be updated to use the barrel in Plan 05.

    **Move kanban-state (185 LOC):**

    4. Copy `src/backend/services/kanban-state.service.ts` to `src/backend/domains/workspace/state/kanban-state.ts`. This file imports:
       - `@prisma-gen/client` -- unchanged
       - `./workspace-flow-state.service` -- update to `./flow-state` (intra-domain relative import, both now in state/)
       - `./session.service` -- this is a **cross-domain import** (session domain). Keep it as `@/backend/services/session.service` (absolute path through old shim, per cross-domain import pattern)
       - `../resource_accessors/workspace.accessor` -- update to `@/backend/resource_accessors/workspace.accessor`

    5. Copy `src/backend/services/kanban-state.service.test.ts` to `src/backend/domains/workspace/state/kanban-state.test.ts`. Update import of module under test from `./kanban-state.service` to `./kanban-state`. Update any `vi.mock` paths for the module and its dependencies to match the new file locations.

    6. Replace `src/backend/services/kanban-state.service.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/workspace' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export {
      computeKanbanColumn,
      kanbanStateService,
      type KanbanStateInput,
      type WorkspaceWithKanbanState,
    } from '@/backend/domains/workspace/state/kanban-state';
    ```

    Delete old test files: `src/backend/services/workspace-flow-state.service.test.ts`, `src/backend/services/kanban-state.service.test.ts` -- tests are now at the new locations.

    Run `pnpm typecheck` to verify compilation. Run tests at new locations.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/workspace/state/flow-state.test.ts` passes.
    `pnpm test src/backend/domains/workspace/state/kanban-state.test.ts` passes.
    Shims exist at old paths and compile.
  </verify>
  <done>
    flow-state.ts and kanban-state.ts live at src/backend/domains/workspace/state/ with co-located tests. kanban-state uses relative import `./flow-state` for intra-domain reference. Re-export shims at old paths. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move init-policy to workspace domain state/</name>
  <files>
    src/backend/domains/workspace/state/init-policy.ts
    src/backend/domains/workspace/state/init-policy.test.ts
    src/backend/services/workspace-init-policy.service.ts
  </files>
  <action>
    **Move init-policy (112 LOC):**

    1. Copy `src/backend/services/workspace-init-policy.service.ts` to `src/backend/domains/workspace/state/init-policy.ts`. This file imports from `@prisma-gen/client` only (pure function, no service dependencies). No import updates needed.

    2. Copy `src/backend/services/workspace-init-policy.service.test.ts` to `src/backend/domains/workspace/state/init-policy.test.ts`. Update the import of the module under test from `./workspace-init-policy.service` to `./init-policy`. Update any `vi.mock` paths accordingly.

    3. Replace `src/backend/services/workspace-init-policy.service.ts` with a re-export shim:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/workspace' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export {
      getWorkspaceInitPolicy,
      type WorkspaceInitPolicy,
      type WorkspaceInitPolicyInput,
    } from '@/backend/domains/workspace/state/init-policy';
    ```

    Delete old test file: `src/backend/services/workspace-init-policy.service.test.ts`.

    Run `pnpm typecheck` to verify compilation. Run tests at new location.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/workspace/state/init-policy.test.ts` passes.
    Shim at old path compiles. Session domain's `chat-message-handlers.service.ts` (imports via old shim path) still compiles.
  </verify>
  <done>
    init-policy.ts lives at src/backend/domains/workspace/state/ with co-located test. Re-export shim at old path. pnpm typecheck passes. All 3 state/ files are in place.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test src/backend/domains/workspace/state/` passes all tests
- Re-export shims exist at: services/workspace-flow-state.service.ts, services/kanban-state.service.ts, services/workspace-init-policy.service.ts
- All external consumers (workspace-query, workspace.trpc, app-context, pr-snapshot, chat-message-handlers, init.trpc) still compile via shims
</verification>

<success_criteria>
Three pure state-derivation files (flow-state, kanban-state, init-policy) and their tests are established at src/backend/domains/workspace/state/. Intra-domain relative imports used where applicable (kanban-state -> flow-state). All existing code compiles via re-export shims. pnpm typecheck passes.
</success_criteria>

<output>
After completion, create `.planning/phases/03-workspace-domain-consolidation/03-01-SUMMARY.md`
</output>

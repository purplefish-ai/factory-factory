---
phase: 03-workspace-domain-consolidation
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/backend/domains/workspace/lifecycle/creation.service.ts
  - src/backend/domains/workspace/lifecycle/creation.service.test.ts
  - src/backend/domains/workspace/query/workspace-query.service.ts
  - src/backend/services/workspace-creation.service.ts
  - src/backend/services/workspace-query.service.ts
autonomous: true

must_haves:
  truths:
    - "WorkspaceCreationService is accessible from domains/workspace/lifecycle/"
    - "WorkspaceQueryService is accessible from domains/workspace/query/"
    - "Dynamic import of init.trpc.ts uses absolute path alias (not broken relative path)"
    - "Module-level cachedReviewCount in workspace-query eliminated -- now instance field (DOM-04)"
    - "All existing consumers compile via re-export shims at old paths"
    - "pnpm typecheck passes"
  artifacts:
    - path: "src/backend/domains/workspace/lifecycle/creation.service.ts"
      provides: "WorkspaceCreationService"
      contains: "class WorkspaceCreationService"
    - path: "src/backend/domains/workspace/query/workspace-query.service.ts"
      provides: "workspaceQueryService"
      contains: "class WorkspaceQueryService"
    - path: "src/backend/services/workspace-creation.service.ts"
      provides: "Re-export shim"
    - path: "src/backend/services/workspace-query.service.ts"
      provides: "Re-export shim"
  key_links:
    - from: "src/backend/domains/workspace/lifecycle/creation.service.ts"
      to: "@/backend/trpc/workspace/init.trpc"
      via: "dynamic import (absolute path alias)"
      pattern: "import\\('@/backend/trpc/workspace/init.trpc'\\)"
    - from: "src/backend/domains/workspace/query/workspace-query.service.ts"
      to: "@/backend/services/session.service"
      via: "cross-domain import through session shim"
      pattern: "import.*session.service"
    - from: "src/backend/domains/workspace/query/workspace-query.service.ts"
      to: "@/backend/services/chat-event-forwarder.service"
      via: "cross-domain import through session shim"
      pattern: "import.*chat-event-forwarder"
---

<objective>
Move workspace-creation.service.ts and workspace-query.service.ts into the workspace domain, fixing the dynamic import path in creation and eliminating the cachedReviewCount global in query (DOM-04).

Purpose: These are the highest-dependency workspace files -- creation depends on worktree-lifecycle and state-machine (moved in Plans 02/03), query depends on kanban-state and flow-state (moved in Plan 01). They also have the dynamic import pitfall (creation) and one DOM-04 target (query). Moving them completes the workspace domain's source file inventory.

Output: `src/backend/domains/workspace/lifecycle/creation.service.ts` and `src/backend/domains/workspace/query/workspace-query.service.ts`. Re-export shims at old paths.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workspace-domain-consolidation/03-RESEARCH.md
@src/backend/services/workspace-creation.service.ts
@src/backend/services/workspace-creation.service.test.ts
@src/backend/services/workspace-query.service.ts
@src/backend/domains/workspace/index.ts

# Prior plan summaries needed: Plans 01-02 established the state/ and lifecycle/ subdirectories
@.planning/phases/03-workspace-domain-consolidation/03-01-SUMMARY.md
@.planning/phases/03-workspace-domain-consolidation/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move workspace-creation to domain lifecycle/ and fix dynamic import path</name>
  <files>
    src/backend/domains/workspace/lifecycle/creation.service.ts
    src/backend/domains/workspace/lifecycle/creation.service.test.ts
    src/backend/services/workspace-creation.service.ts
  </files>
  <action>
    **Move creation service (288 LOC):**

    1. Copy `src/backend/services/workspace-creation.service.ts` to `src/backend/domains/workspace/lifecycle/creation.service.ts`.

    2. **Fix critical dynamic import path (Pitfall 3 from research):**
       Find the dynamic import of `init.trpc.ts` (around line 263):
       ```typescript
       const { initializeWorkspaceWorktree } = await import('../trpc/workspace/init.trpc');
       ```
       Replace the relative path with an absolute path alias:
       ```typescript
       const { initializeWorkspaceWorktree } = await import('@/backend/trpc/workspace/init.trpc');
       ```
       This is critical because the old relative path `../trpc/workspace/init.trpc` (relative to `services/`) would break from the new location `domains/workspace/lifecycle/`. The absolute alias works regardless of file location.

    3. **Update other imports:**
       - `../claude/session` (SessionManager) -- this is a session domain file. It was moved to `@/backend/domains/session/claude/session.ts` in Phase 2. However, there should be a shim at `@/backend/claude/session`. Use `@/backend/claude/session` (the old shim path) to avoid cross-domain direct imports.
       - `../prompts/workflows` -- update to `@/backend/prompts/workflows`
       - `../resource_accessors/claude-session.accessor` -- update to `@/backend/resource_accessors/claude-session.accessor`
       - `../resource_accessors/project.accessor` -- update to `@/backend/resource_accessors/project.accessor`
       - `../resource_accessors/user-settings.accessor` -- update to `@/backend/resource_accessors/user-settings.accessor`
       - `../resource_accessors/workspace.accessor` -- update to `@/backend/resource_accessors/workspace.accessor`
       - `./config.service` (type import) -- update to `@/backend/services/config.service`
       - `./git-ops.service` -- update to `@/backend/services/git-ops.service`
       - `./logger.service` (type import) -- update to `@/backend/services/logger.service`
       - `./worktree-lifecycle.service` (imports `setWorkspaceInitMode`) -- update to `@/backend/services/worktree-lifecycle.service` (through shim, which has the wrapper function for the now-instance-method)

    4. **Create re-export shim** -- Replace `src/backend/services/workspace-creation.service.ts` with:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/workspace' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export {
      WorkspaceCreationService,
      type WorkspaceCreationSource,
      type WorkspaceCreationResult,
      type WorkspaceCreationDependencies,
    } from '@/backend/domains/workspace/lifecycle/creation.service';
    ```
    Note: Check the actual exports of the file -- the type names above are from the research. Verify and include all public exports.

    5. **Move test file:** Copy `src/backend/services/workspace-creation.service.test.ts` to `src/backend/domains/workspace/lifecycle/creation.service.test.ts`. Update:
       - Import of module under test: `./workspace-creation.service` -> `./creation.service`
       - `vi.mock` paths for all dependencies to match the new file's import paths (absolute paths)
       - The test mocks `./worktree-lifecycle.service` as `import * as worktreeLifecycleServiceModule` -- update the mock path to `@/backend/services/worktree-lifecycle.service` (the shim path) or update to mock the new domain path depending on how the source file imports it
       - All other mock paths for resource accessors, services, etc.

    Delete old test file: `src/backend/services/workspace-creation.service.test.ts`.

    Run `pnpm typecheck` and tests.
  </action>
  <verify>
    `pnpm typecheck` passes.
    `pnpm test src/backend/domains/workspace/lifecycle/creation.service.test.ts` passes.
    Verify dynamic import uses absolute path: `grep "import('@/backend/trpc/workspace/init.trpc')" src/backend/domains/workspace/lifecycle/creation.service.ts` returns a match.
    Shim at old path compiles. `workspace.trpc.ts` (imports WorkspaceCreationService) still compiles.
  </verify>
  <done>
    creation.service.ts lives at src/backend/domains/workspace/lifecycle/ with dynamic import using absolute path alias. Re-export shim at old path. pnpm typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move workspace-query to domain query/ and refactor cachedReviewCount (DOM-04)</name>
  <files>
    src/backend/domains/workspace/query/workspace-query.service.ts
    src/backend/services/workspace-query.service.ts
  </files>
  <action>
    Create directory `src/backend/domains/workspace/query/`.

    **Move and refactor workspace-query (361 LOC):**

    1. Copy `src/backend/services/workspace-query.service.ts` to `src/backend/domains/workspace/query/workspace-query.service.ts`.

    2. **DOM-04 refactoring -- eliminate 1 module-level global:**
       Move `let cachedReviewCount: { count: number; fetchedAt: number } | null = null` (line ~23) into the `WorkspaceQueryService` class (or the object that exports methods) as `private cachedReviewCount: { count: number; fetchedAt: number } | null = null`. Update all references to use `this.cachedReviewCount` instead of the bare variable.

       Also check `const gitConcurrencyLimit = pLimit(DEFAULT_GIT_CONCURRENCY)` (line ~20). This is a stateless concurrency limiter, not mutable state. It can stay as a module-level const OR be moved to an instance field for consistency. Use your judgment -- if it's cleaner as an instance field, move it; if it's cleaner as module-level (since p-limit instances are stateless limiters), keep it.

    3. **Update imports:**
       - `./kanban-state.service` (computeKanbanColumn) -- this is now an intra-domain file in state/. Update to `@/backend/services/kanban-state.service` (through shim for now, since the barrel isn't wired yet). Alternatively, if you want to use a direct intra-domain path: `../state/kanban-state` -- this is acceptable per the intra-domain relative import pattern from Phase 2.
       - `./workspace-flow-state.service` (deriveWorkspaceFlowStateFromWorkspace) -- intra-domain. Update to `../state/flow-state` (relative intra-domain import).
       - `./chat-event-forwarder.service` -- **cross-domain** (session domain). Update to `@/backend/services/chat-event-forwarder.service` (shim path).
       - `./session.service` -- **cross-domain** (session domain). Update to `@/backend/services/session.service` (shim path).
       - `./factory-config.service`, `./git-ops.service`, `./github-cli.service`, `./logger.service`, `./pr-snapshot.service` -- update to `@/backend/services/` absolute paths.
       - `../resource_accessors/project.accessor`, `../resource_accessors/workspace.accessor` -- update to `@/backend/resource_accessors/` absolute paths.
       - `@prisma-gen/client`, `p-limit`, `@/shared/*` -- unchanged.

    4. **Create re-export shim** -- Replace `src/backend/services/workspace-query.service.ts` with:
    ```typescript
    /**
     * @deprecated Import from '@/backend/domains/workspace' instead.
     * This re-export shim will be removed in Phase 9 (Import Rewiring).
     */
    export { workspaceQueryService } from '@/backend/domains/workspace/query/workspace-query.service';
    ```
    Note: Check actual exports -- workspace-query may export the class and/or instance. Include all public exports.

    Note: workspace-query.service.ts has no co-located test file (tests are inline or covered by integration tests). Do not create a test file where none exists.

    Run `pnpm typecheck` to verify compilation.
  </action>
  <verify>
    `pnpm typecheck` passes.
    Verify DOM-04 compliance: `grep -n "^let cachedReviewCount" src/backend/domains/workspace/query/workspace-query.service.ts` returns no results.
    Verify instance field exists: `grep -n "private cachedReviewCount" src/backend/domains/workspace/query/workspace-query.service.ts` returns a match.
    Shim at old path compiles. `workspace.trpc.ts` (imports workspaceQueryService) still compiles.
    Intra-domain imports to state/ files use relative paths.
  </verify>
  <done>
    workspace-query.service.ts lives at src/backend/domains/workspace/query/ with cachedReviewCount as instance field (DOM-04). Intra-domain imports use relative paths to state/. Cross-domain imports use shim paths. Re-export shim at old path. pnpm typecheck passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm test src/backend/domains/workspace/lifecycle/creation.service.test.ts` passes
- Dynamic import in creation.service.ts uses `@/backend/trpc/workspace/init.trpc` (absolute path alias)
- No module-level `let cachedReviewCount` in workspace-query (DOM-04 satisfied)
- Re-export shims exist at: services/workspace-creation.service.ts, services/workspace-query.service.ts
- Cross-domain imports (sessionService, chatEventForwarderService) use shim paths, NOT direct domain imports
</verification>

<success_criteria>
WorkspaceCreationService and WorkspaceQueryService at their domain locations. Dynamic import pitfall avoided with absolute alias. DOM-04 cachedReviewCount refactored to instance field. All existing code compiles via re-export shims. pnpm typecheck passes.
</success_criteria>

<output>
After completion, create `.planning/phases/03-workspace-domain-consolidation/03-04-SUMMARY.md`
</output>

---
phase: 16-client-integration-sidebar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/frontend/lib/snapshot-to-sidebar.ts
  - src/frontend/lib/snapshot-to-sidebar.test.ts
  - src/frontend/hooks/use-project-snapshot-sync.ts
  - src/frontend/hooks/use-project-snapshot-sync.test.ts
  - src/frontend/components/app-sidebar.tsx
  - vite.config.ts
autonomous: true

must_haves:
  truths:
    - "Sidebar workspace state updates arrive via WebSocket-pushed snapshots, not 2-second tRPC polling"
    - "React Query cache for getProjectSummaryState is updated via setData from WebSocket messages"
    - "Sidebar remains correct after WebSocket disconnection and reconnection"
    - "reviewCount is preserved in the cache across WebSocket updates"
    - "Safety-net polling continues at reduced frequency (30s)"
  artifacts:
    - path: "src/frontend/lib/snapshot-to-sidebar.ts"
      provides: "Pure mapping function from WorkspaceSnapshotEntry to ServerWorkspace"
      exports: ["mapSnapshotEntryToServerWorkspace"]
    - path: "src/frontend/hooks/use-project-snapshot-sync.ts"
      provides: "React hook that syncs /snapshots WebSocket to React Query cache"
      exports: ["useProjectSnapshotSync"]
    - path: "src/frontend/lib/snapshot-to-sidebar.test.ts"
      provides: "Tests for shape mapping function"
    - path: "src/frontend/hooks/use-project-snapshot-sync.test.ts"
      provides: "Tests for sync hook message handling"
  key_links:
    - from: "src/frontend/hooks/use-project-snapshot-sync.ts"
      to: "/snapshots WebSocket endpoint"
      via: "useWebSocketTransport + buildWebSocketUrl('/snapshots', { projectId })"
      pattern: "buildWebSocketUrl.*snapshots"
    - from: "src/frontend/hooks/use-project-snapshot-sync.ts"
      to: "React Query cache (getProjectSummaryState)"
      via: "utils.workspace.getProjectSummaryState.setData()"
      pattern: "setData"
    - from: "src/frontend/components/app-sidebar.tsx"
      to: "src/frontend/hooks/use-project-snapshot-sync.ts"
      via: "useProjectSnapshotSync(selectedProjectId)"
      pattern: "useProjectSnapshotSync"
    - from: "vite.config.ts"
      to: "/snapshots"
      via: "Vite dev server WebSocket proxy"
      pattern: "snapshots.*ws.*true"
---

<objective>
Connect the Phase 15 `/snapshots` WebSocket endpoint to the sidebar's React Query cache so workspace state updates arrive in ~200ms instead of waiting for 2-second tRPC polling.

Purpose: Replace the sidebar's aggressive 2s poll with WebSocket-pushed snapshots, completing CLNT-01 and CLNT-04 requirements. The polling query remains at 30s as a safety net.

Output: A `useProjectSnapshotSync` hook mounted in `AppSidebar` that receives `snapshot_full`, `snapshot_changed`, and `snapshot_removed` messages, maps them to the `ServerWorkspace` shape, and calls `setData` on the existing `getProjectSummaryState` React Query cache entry.
</objective>

<execution_context>
@/Users/martin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-websocket-transport/15-01-SUMMARY.md
@src/frontend/components/app-sidebar.tsx
@src/frontend/components/use-workspace-list-state.ts
@src/hooks/use-websocket-transport.ts
@src/lib/websocket-config.ts
@src/backend/services/workspace-snapshot-store.service.ts (lines 74-123 for WorkspaceSnapshotEntry type)
@src/backend/routers/websocket/snapshots.handler.ts (for server message format)
@src/components/workspace/use-dev-logs.ts (analog for receive-only WS hook pattern)
@vite.config.ts
@src/frontend/lib/providers.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create snapshot-to-sidebar mapping function and sync hook with tests</name>
  <files>
    src/frontend/lib/snapshot-to-sidebar.ts
    src/frontend/lib/snapshot-to-sidebar.test.ts
    src/frontend/hooks/use-project-snapshot-sync.ts
    src/frontend/hooks/use-project-snapshot-sync.test.ts
  </files>
  <action>
**1. Create `src/frontend/lib/snapshot-to-sidebar.ts`:**

Define the snapshot server message types (client-side) and the mapping function:

```typescript
import type { WorkspaceSnapshotEntry } from '@/backend/services/workspace-snapshot-store.service';
import type { ServerWorkspace } from '@/frontend/components/use-workspace-list-state';
```

Message types (discriminated union):
- `SnapshotFullMessage`: `{ type: 'snapshot_full'; projectId: string; entries: WorkspaceSnapshotEntry[] }`
- `SnapshotChangedMessage`: `{ type: 'snapshot_changed'; workspaceId: string; entry: WorkspaceSnapshotEntry }`
- `SnapshotRemovedMessage`: `{ type: 'snapshot_removed'; workspaceId: string }`
- `SnapshotServerMessage`: union of the above three

Export a pure function `mapSnapshotEntryToServerWorkspace(entry: WorkspaceSnapshotEntry): ServerWorkspace` that maps:
- `workspaceId` -> `id`
- `kanbanColumn` -> `cachedKanbanColumn` (cast to `string | null` since ServerWorkspace uses `string | null` not the KanbanColumn enum)
- `computedAt` -> `stateComputedAt`
- All other overlapping fields pass through directly: `name`, `createdAt`, `branchName`, `prUrl`, `prNumber`, `prState`, `prCiStatus`, `isWorking`, `gitStats`, `lastActivityAt`, `ratchetEnabled`, `ratchetState`, `sidebarStatus`, `ratchetButtonAnimated`, `flowPhase`, `ciObservation`, `runScriptStatus`, `pendingRequestType`

Do NOT include `version`, `projectId`, `status`, `prUpdatedAt`, `hasHadSessions`, `source`, `fieldTimestamps` -- these are store-internal fields not in `ServerWorkspace`.

**2. Create `src/frontend/lib/snapshot-to-sidebar.test.ts`:**

Test the mapping function:
- Maps `workspaceId` to `id`
- Maps `kanbanColumn` to `cachedKanbanColumn`
- Maps `computedAt` to `stateComputedAt`
- Passes through common fields unchanged
- Does not include store-internal fields (`version`, `fieldTimestamps`, `source`, etc.)

Use a factory helper to build a minimal `WorkspaceSnapshotEntry` for tests.

**3. Create `src/frontend/hooks/use-project-snapshot-sync.ts`:**

Follow the `use-dev-logs.ts` pattern. The hook:
- Takes `projectId: string | undefined` parameter
- Uses `trpc.useUtils()` to get `utils`
- Computes URL: `projectId ? buildWebSocketUrl('/snapshots', { projectId }) : null`
- Defines a `handleMessage` callback (wrapped in `useCallback` with deps `[projectId, utils]`) that:
  - Casts incoming `data` as `SnapshotServerMessage`
  - On `snapshot_full`: calls `utils.workspace.getProjectSummaryState.setData({ projectId: message.projectId }, (prev) => ({ workspaces: message.entries.map(mapSnapshotEntryToServerWorkspace), reviewCount: prev?.reviewCount ?? 0 }))`
  - On `snapshot_changed`: calls `setData` with `{ projectId: projectId! }`, using `(prev)` to find-and-replace the matching workspace by `id`, or push if new. Preserve `reviewCount` from prev.
  - On `snapshot_removed`: calls `setData` with `{ projectId: projectId! }`, filtering out the workspace with matching `id`. Preserve `reviewCount`.
- Calls `useWebSocketTransport({ url, onMessage: handleMessage, queuePolicy: 'drop' })`
- Returns `void` (no return value needed -- the hook's side effect is updating the cache)

**4. Create `src/frontend/hooks/use-project-snapshot-sync.test.ts`:**

Test the hook behavior using Vitest:
- Mock `useWebSocketTransport` (vi.mock) to capture the `onMessage` callback
- Mock `trpc.useUtils()` to return a mock `utils` with `workspace.getProjectSummaryState.setData` as a vi.fn()
- Test `snapshot_full` message: verify `setData` is called with the correct input key and mapped entries, reviewCount preserved from prev
- Test `snapshot_changed` message: verify existing workspace is replaced (upsert), new workspace is appended
- Test `snapshot_removed` message: verify workspace is filtered out
- Test that URL is null when projectId is undefined (deferred connection)
  </action>
  <verify>
Run `pnpm test src/frontend/lib/snapshot-to-sidebar.test.ts src/frontend/hooks/use-project-snapshot-sync.test.ts` -- all tests pass.
Run `pnpm typecheck` -- no type errors in new files.
  </verify>
  <done>
`mapSnapshotEntryToServerWorkspace` correctly maps all 19 fields from `WorkspaceSnapshotEntry` to `ServerWorkspace` shape. `useProjectSnapshotSync` hook processes all three message types and updates the React Query cache via `setData`. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire sync hook into AppSidebar and add Vite proxy</name>
  <files>
    src/frontend/components/app-sidebar.tsx
    vite.config.ts
  </files>
  <action>
**1. Update `src/frontend/components/app-sidebar.tsx`:**

Add import at top:
```typescript
import { useProjectSnapshotSync } from '@/frontend/hooks/use-project-snapshot-sync';
```

Mount the hook after the existing `getProjectSummaryState` query (around line 301, after `const projectState = ...`):
```typescript
// Sync workspace snapshots from WebSocket to React Query cache (CLNT-01, CLNT-04)
useProjectSnapshotSync(selectedProjectId && !isMocked ? selectedProjectId : undefined);
```

Change the `refetchInterval` on `getProjectSummaryState.useQuery` from `2000` to `30_000`:
```typescript
{ enabled: !!selectedProjectId && !isMocked, refetchInterval: isMocked ? false : 30_000 }
```

This keeps the safety-net poll at 30 seconds (per project decision: "event-driven + safety-net poll").

**2. Update `vite.config.ts`:**

Add `/snapshots` proxy entry alongside the existing `/chat`, `/terminal`, `/dev-logs` entries:
```typescript
'/snapshots': {
  target: backendUrl.replace(/^http/, 'ws'),
  ws: true,
},
```

Place it after the `/dev-logs` entry to maintain alphabetical-ish ordering of WebSocket proxies.
  </action>
  <verify>
Run `pnpm typecheck` -- no type errors.
Run `pnpm check:fix` -- no lint/format issues.
Run `pnpm test` -- full test suite passes (no regressions).
  </verify>
  <done>
`AppSidebar` mounts `useProjectSnapshotSync` to receive WebSocket snapshots and update the React Query cache. The tRPC polling interval is reduced from 2s to 30s as a safety net. The Vite dev server proxies `/snapshots` WebSocket connections to the backend.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no errors
2. `pnpm check:fix` passes with no lint issues
3. `pnpm test` passes with no regressions
4. New test files pass: `pnpm test src/frontend/lib/snapshot-to-sidebar.test.ts src/frontend/hooks/use-project-snapshot-sync.test.ts`
5. `vite.config.ts` has `/snapshots` proxy entry with `ws: true`
6. `app-sidebar.tsx` calls `useProjectSnapshotSync` and has `refetchInterval: 30_000` (not 2000)
</verification>

<success_criteria>
- Snapshot-to-sidebar mapping function correctly transforms all WorkspaceSnapshotEntry fields to ServerWorkspace shape
- Sync hook handles all three message types (snapshot_full, snapshot_changed, snapshot_removed) and updates React Query cache via setData
- reviewCount is preserved across all WebSocket-driven cache updates
- AppSidebar mounts the sync hook with the selected project ID
- Safety-net polling continues at 30s instead of 2s
- Vite proxy forwards /snapshots WebSocket connections in development
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-client-integration-sidebar/16-01-SUMMARY.md`
</output>

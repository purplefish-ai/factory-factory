# Requirements Archive: v1.2 ACP Cutover

**Archived:** 2026-02-14
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: Factory Factory

**Defined:** 2026-02-13
**Core Value:** Every domain object has exactly one owner module, and any operation touching that domain flows through a single, traceable path.

## v1.2 Requirements

Requirements for ACP-only cutover. Each maps to roadmap phases.

### ACP Runtime

- [x] **RUNTIME-01**: ACP subprocess spawned per FF session using `@zed-industries/claude-code-acp` or `@zed-industries/codex-acp` binaries with stdio pipes — Phase 19
- [x] **RUNTIME-02**: ClientSideConnection wired from subprocess stdio via `ndJsonStream` from `@agentclientprotocol/sdk` — Phase 19
- [x] **RUNTIME-03**: Initialize handshake exchanges protocol version, client capabilities, and agent capabilities — Phase 19
- [x] **RUNTIME-04**: `session/new` creates ACP session with workspace cwd, returns sessionId stored as providerSessionId — Phase 19
- [x] **RUNTIME-05**: `session/prompt` sends user messages and receives streaming response via `session/update` notifications — Phase 19
- [x] **RUNTIME-06**: `session/cancel` halts ongoing prompt turn, agent responds with cancelled stop reason — Phase 19
- [x] **RUNTIME-07**: `session/load` resumes a previous session when agent advertises `loadSession` capability — Phase 21
- [x] **RUNTIME-08**: Unified AcpRuntimeManager replaces both ClaudeRuntimeManager and CodexAppServerManager — Phase 21
- [x] **RUNTIME-09**: Process cleanup on session stop (SIGTERM then SIGKILL after grace period) with orphan prevention via non-detached spawn — Phase 19

### Event Translation

- [x] **EVENT-01**: ACP `session/update` notification variants mapped to FF WebSocket delta events — Phase 20
- [x] **EVENT-02**: Tool call status lifecycle rendered in chat UI (pending, in_progress, completed/failed) with title, kind, and content — Phase 20
- [x] **EVENT-03**: Agent thought/reasoning content rendered in collapsible sections separate from message content — Phase 20
- [x] **EVENT-04**: Plan updates rendered as structured task view with status indicators — Phase 20
- [x] **EVENT-05**: Slash commands from `available_commands_update` forwarded to frontend — Phase 20
- [x] **EVENT-06**: ACP events logged to session file logger for debugging — Phase 19
- [x] **EVENT-07**: Tool call file locations tracked for click-to-open navigation — Phase 20

### Permissions

- [x] **PERM-01**: `Client.requestPermission()` callback implemented, receiving tool call details and options array — Phase 20
- [x] **PERM-02**: Frontend permission UI renders ACP permission options as distinct choices instead of binary allow/deny — Phase 20
- [x] **PERM-03**: Permission responses carry selected optionId back to agent via `RequestPermissionResponse` — Phase 20

### Configuration

- [x] **CONFIG-01**: Agent-provided `configOptions` array parsed after `session/new` and `config_options_update` notifications — Phase 21
- [x] **CONFIG-02**: `session/set_config_option` sends user-selected config values to agent — Phase 21
- [x] **CONFIG-03**: Frontend config option UI renders selectors grouped by category — Phase 21
- [x] **CONFIG-04**: Agent-pushed `config_options_update` notifications reactively update frontend UI — Phase 21
- [x] **CONFIG-05**: Capability-gated features conditionally shown in UI — Phase 21

### Cleanup

- [x] **CLEAN-01**: Claude protocol stack removed — Phase 22
- [x] **CLEAN-02**: Codex protocol stack removed — Phase 22
- [x] **CLEAN-03**: Obsolete env/config knobs tied to legacy protocols removed — Phase 22
- [x] **CLEAN-04**: Superseded tests removed and ACP-focused integration tests added — Phase 22
- [x] **CLEAN-05**: Admin/health process reporting updated for ACP-per-session process model — Phase 22
- [x] **CLEAN-06**: Contributor docs updated to reflect ACP-only architecture — Phase 22

## Future Requirements

### Session Management

- **SESSION-01**: `unstable_listSessions` for session picker UI (deferred until ACP stabilizes)
- **SESSION-02**: `unstable_resumeSession` for warm session resume (deferred until ACP stabilizes)
- **SESSION-03**: `unstable_forkSession` for branching conversations (deferred until ACP stabilizes)

## Out of Scope

| Feature | Reason |
|---------|--------|
| Backward compatibility with old WebSocket message contracts | Pre-release breaking change per issue #996 |
| Legacy provider wire implementations behind flags | Doubles maintenance surface and test matrix |
| Custom `set_thinking_budget` control | Replaced by ACP configOptions with thought_level category |
| Custom `rewind_files` support | Claude-specific control not part of ACP |
| MCP server configuration UI | Passthrough only, agents handle MCP internally |
| Remote/HTTP agent transport | FF runs agents as local subprocesses, stdio only |
| Terminal management via ACP | FF has its own terminal domain, agents manage terminals internally |
| File system operations via ACP | Agents handle files internally via built-in MCP servers |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| RUNTIME-01 | Phase 19 | ✓ Complete |
| RUNTIME-02 | Phase 19 | ✓ Complete |
| RUNTIME-03 | Phase 19 | ✓ Complete |
| RUNTIME-04 | Phase 19 | ✓ Complete |
| RUNTIME-05 | Phase 19 | ✓ Complete |
| RUNTIME-06 | Phase 19 | ✓ Complete |
| RUNTIME-07 | Phase 21 | ✓ Complete |
| RUNTIME-08 | Phase 21 | ✓ Complete |
| RUNTIME-09 | Phase 19 | ✓ Complete |
| EVENT-01 | Phase 20 | ✓ Complete |
| EVENT-02 | Phase 20 | ✓ Complete |
| EVENT-03 | Phase 20 | ✓ Complete |
| EVENT-04 | Phase 20 | ✓ Complete |
| EVENT-05 | Phase 20 | ✓ Complete |
| EVENT-06 | Phase 19 | ✓ Complete |
| EVENT-07 | Phase 20 | ✓ Complete |
| PERM-01 | Phase 20 | ✓ Complete |
| PERM-02 | Phase 20 | ✓ Complete |
| PERM-03 | Phase 20 | ✓ Complete |
| CONFIG-01 | Phase 21 | ✓ Complete |
| CONFIG-02 | Phase 21 | ✓ Complete |
| CONFIG-03 | Phase 21 | ✓ Complete |
| CONFIG-04 | Phase 21 | ✓ Complete |
| CONFIG-05 | Phase 21 | ✓ Complete |
| CLEAN-01 | Phase 22 | ✓ Complete |
| CLEAN-02 | Phase 22 | ✓ Complete |
| CLEAN-03 | Phase 22 | ✓ Complete |
| CLEAN-04 | Phase 22 | ✓ Complete |
| CLEAN-05 | Phase 22 | ✓ Complete |
| CLEAN-06 | Phase 22 | ✓ Complete |

**Coverage:**
- v1.2 requirements: 30 total
- Mapped to phases: 30
- Unmapped: 0

---
*Requirements defined: 2026-02-13*
*Last updated: 2026-02-13 after roadmap creation -- all 30 requirements mapped to phases 19-22*

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "sqlite"
}

// Enums

enum WorkspaceStatus {
  NEW          // Workspace created, nothing started
  PROVISIONING // Git worktree being created, startup script running
  READY        // Successfully initialized
  FAILED       // Initialization failed
  ARCHIVED     // Workspace archived
}

enum SessionStatus {
  IDLE
  RUNNING
  PAUSED
  COMPLETED
  FAILED
}

enum SessionProvider {
  CLAUDE
  CODEX
}

enum SessionPermissionPreset {
  STRICT
  RELAXED
  YOLO
}

enum WorkspaceProviderSelection {
  WORKSPACE_DEFAULT
  CLAUDE
  CODEX
}

enum PRState {
  NONE
  DRAFT
  OPEN
  CHANGES_REQUESTED
  APPROVED
  MERGED
  CLOSED
}

enum CIStatus {
  UNKNOWN   // No CI configured or not yet fetched
  PENDING   // CI is running
  SUCCESS   // All checks passed
  FAILURE   // One or more checks failed
}

enum KanbanColumn {
  WORKING
  WAITING
  DONE
}

enum RatchetState {
  IDLE              // No PR or ratchet not active for this workspace
  CI_RUNNING        // CI checks in progress
  CI_FAILED         // CI checks failed
  REVIEW_PENDING    // Has unaddressed review comments
  READY             // Ready to merge (CI green, no conflicts, no pending reviews)
  MERGED            // PR has been merged
}

enum WorkspaceCreationSource {
  MANUAL          // Created manually by user
  RESUME_BRANCH   // Created from existing branch
  GITHUB_ISSUE    // Created from GitHub issue
  LINEAR_ISSUE    // Created from Linear issue
}

enum IssueProvider {
  GITHUB
  LINEAR
}

enum RunScriptStatus {
  IDLE       // No run script or not started
  STARTING   // Run script is starting
  RUNNING    // Run script is actively running
  STOPPING   // Run script is stopping
  COMPLETED  // Run script completed successfully
  FAILED     // Run script failed
}


// Models
model Project {
  id                String      @id @default(cuid())
  name              String
  slug              String      @unique
  repoPath          String
  worktreeBasePath  String
  defaultBranch     String      @default("main")
  githubOwner       String?
  githubRepo        String?
  isArchived        Boolean     @default(false)

  // Issue provider configuration
  issueProvider         IssueProvider @default(GITHUB)
  issueTrackerConfig    Json?         // Typed blob â€” see IssueTrackerConfigSchema

  // Startup script configuration
  startupScriptCommand  String?   // Inline shell command
  startupScriptPath     String?             // Path to script in repo
  startupScriptTimeout  Int       @default(300)  // Timeout in seconds

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  workspaces        Workspace[]

  @@index([slug])
  @@index([isArchived])
}

model DecisionLog {
  id                String      @id @default(cuid())
  agentId           String      // Can be sessionId or any identifier
  decision          String
  reasoning         String
  context           String?
  timestamp         DateTime    @default(now())

  @@index([agentId, timestamp])
  @@index([timestamp])
}

model Workspace {
  id                  String            @id @default(cuid())
  projectId           String
  project             Project           @relation(fields: [projectId], references: [id])
  name                String
  description         String?
  status              WorkspaceStatus   @default(NEW)
  worktreePath        String?
  branchName          String?
  isAutoGeneratedBranch Boolean         @default(false)  // True if branch was auto-generated at creation time

  // Workspace creation tracking
  creationSource      WorkspaceCreationSource  @default(MANUAL)  // How this workspace was created
  creationMetadata    Json?                                      // Additional creation context (nullable for flexibility)

  // Initialization tracking (used by NEW, PROVISIONING, FAILED states)
  initErrorMessage    String?
  initOutput          String?           // Accumulated stdout/stderr from startup script
  initStartedAt       DateTime?
  initCompletedAt     DateTime?
  initRetryCount      Int                 @default(0)

  // Run script tracking (from factory-factory.json)
  runScriptCommand        String?           // The run script command to execute
  runScriptPostRunCommand String?           // The postRun script command to execute after run is RUNNING
  runScriptCleanupCommand String?           // The cleanup script command to execute on stop
  runScriptPid            Int?              // Process ID of running script
  runScriptPort           Int?              // Allocated port for the running script
  runScriptStartedAt      DateTime?         // When the run script was started
  runScriptStatus         RunScriptStatus   @default(IDLE)  // Run script runtime status

  prUrl               String?
  githubIssueNumber   Int?
  githubIssueUrl      String?
  linearIssueId         String?   // Linear issue UUID
  linearIssueIdentifier String?   // Human-readable e.g. "ENG-123"
  linearIssueUrl        String?   // URL to Linear issue
  defaultSessionProvider WorkspaceProviderSelection @default(WORKSPACE_DEFAULT)
  ratchetSessionProvider WorkspaceProviderSelection @default(WORKSPACE_DEFAULT)
  agentSessions       AgentSession[]
  terminalSessions    TerminalSession[]
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // PR tracking (cached from GitHub)
  prNumber            Int?
  prState             PRState           @default(NONE)
  prReviewState       String?           // Raw GitHub review state
  prCiStatus          CIStatus          @default(UNKNOWN)  // CI check status
  prUpdatedAt         DateTime?         // Last PR sync time

  // CI failure tracking
  prCiFailedAt        DateTime?         // When CI first failed (cleared on success)
  prCiLastNotifiedAt  DateTime?         // Last time we notified about CI failure

  // PR Review tracking
  prReviewLastCheckedAt   DateTime?     // When PR review comments were last checked
  prReviewLastCommentId   String?       // ID of the last processed review comment

  // Ratchet tracking (centralized PR progression)
  ratchetEnabled          Boolean       @default(true)    // Workspace-level ratchet toggle
  ratchetState            RatchetState  @default(IDLE)    // Current state in the ratchet progression
  ratchetLastCheckedAt    DateTime?                       // When ratchet last checked this workspace
  ratchetActiveSessionId  String?                         // ID of active fixer session (if any)
  ratchetLastCiRunId      String?                         // Track which CI run we processed

  // Activity tracking
  hasHadSessions      Boolean           @default(false)

  // Cached kanban column (for list performance)
  cachedKanbanColumn  KanbanColumn      @default(WAITING)
  stateComputedAt     DateTime?         // Last kanban column computation

  @@index([projectId])
  @@index([status])
  @@index([cachedKanbanColumn])
  // Composite indexes for common query patterns
  @@index([projectId, status])
  @@index([projectId, cachedKanbanColumn])
}

model AgentSession {
  id                  String        @id @default(cuid())
  workspaceId         String
  workspace           Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name                String?
  workflow            String // "explore", "implement", "test"
  model               String        @default("sonnet")
  status              SessionStatus @default(IDLE)
  provider            SessionProvider
  providerSessionId   String?
  providerProjectPath String?
  providerProcessPid  Int?
  providerMetadata    Json?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([workspaceId])
  @@index([status])
  @@index([provider])
  @@index([workspaceId, provider])
}

model TerminalSession {
  id              String        @id @default(cuid())
  workspaceId     String
  workspace       Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name            String?
  status          SessionStatus @default(IDLE)
  pid             Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([workspaceId])
  @@index([status])
}

model UserSettings {
  id                    String   @id @default(cuid())
  userId                String   @default("default") @unique  // Single user for now, expandable later

  // IDE Settings
  preferredIde          String   @default("cursor")  // "cursor" | "vscode" | "custom"
  customIdeCommand      String?  // For custom IDE, supports placeholders like {workspace}

  // Notification Settings
  playSoundOnComplete   Boolean  @default(true)   // Play sound when workspace completes
  notificationSoundPath String?                   // Path to custom notification sound file

  // Sidebar Settings
  workspaceOrder      Json?    // { [projectId]: string[] } - ordered workspace IDs per project

  // Cached slash commands (from Claude CLI initialize response)
  cachedSlashCommands   Json?

  // Ratchet Settings (unified PR progression)
  ratchetEnabled            Boolean  @default(false)  // Default for new GitHub-issue-created workspaces
  defaultSessionProvider    SessionProvider @default(CLAUDE)
  defaultWorkspacePermissions SessionPermissionPreset @default(STRICT) // Default execution-mode preset for non-ratchet sessions
  ratchetPermissions        SessionPermissionPreset @default(YOLO) // Default execution-mode preset for ratchet sessions

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
}

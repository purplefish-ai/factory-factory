// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

// Enums

enum WorkspaceStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum SessionStatus {
  IDLE
  RUNNING
  PAUSED
  COMPLETED
  FAILED
}

enum PRState {
  NONE
  DRAFT
  OPEN
  CHANGES_REQUESTED
  APPROVED
  MERGED
  CLOSED
}

enum KanbanColumn {
  BACKLOG
  IN_PROGRESS
  WAITING
  PR_OPEN
  APPROVED
  MERGED
  DONE
}

enum WorkspaceInitStatus {
  PENDING       // Initial state after DB record creation
  INITIALIZING  // Startup script is running
  READY         // Successfully initialized
  FAILED        // Script execution failed
}

// Models
model Project {
  id                String      @id @default(cuid())
  name              String
  slug              String      @unique
  repoPath          String
  worktreeBasePath  String
  defaultBranch     String      @default("main")
  githubOwner       String?
  githubRepo        String?
  isArchived        Boolean     @default(false)

  // Startup script configuration
  startupScriptCommand  String?   @db.Text  // Inline shell command
  startupScriptPath     String?             // Path to script in repo
  startupScriptTimeout  Int       @default(300)  // Timeout in seconds

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  workspaces        Workspace[]

  @@index([slug])
  @@index([isArchived])
}

model DecisionLog {
  id                String      @id @default(cuid())
  agentId           String      // Can be sessionId or any identifier
  decision          String      @db.Text
  reasoning         String      @db.Text
  context           String?     @db.Text
  timestamp         DateTime    @default(now())

  @@index([agentId, timestamp])
  @@index([timestamp])
}

model Workspace {
  id                  String            @id @default(cuid())
  projectId           String
  project             Project           @relation(fields: [projectId], references: [id])
  name                String
  description         String?
  status              WorkspaceStatus   @default(ACTIVE)
  worktreePath        String?
  branchName          String?

  // Initialization tracking
  initStatus          WorkspaceInitStatus @default(PENDING)
  initErrorMessage    String?             @db.Text
  initStartedAt       DateTime?
  initCompletedAt     DateTime?

  prUrl               String?
  githubIssueNumber   Int?
  githubIssueUrl      String?
  claudeSessions      ClaudeSession[]
  terminalSessions    TerminalSession[]
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // PR tracking (cached from GitHub)
  prNumber            Int?
  prState             PRState           @default(NONE)
  prReviewState       String?           // Raw GitHub review state
  prUpdatedAt         DateTime?         // Last PR sync time

  // Activity tracking
  hasHadSessions      Boolean           @default(false)

  // Cached kanban column (for list performance)
  cachedKanbanColumn  KanbanColumn      @default(BACKLOG)
  stateComputedAt     DateTime?         // Last kanban column computation

  @@index([projectId])
  @@index([status])
  @@index([cachedKanbanColumn])
}

model ClaudeSession {
  id               String        @id @default(cuid())
  workspaceId      String
  workspace        Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name             String?
  workflow         String        // "explore", "implement", "test"
  model            String        @default("sonnet")
  status           SessionStatus @default(IDLE)
  claudeSessionId  String?       // For resume
  claudeProcessPid Int?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([workspaceId])
  @@index([status])
}

model TerminalSession {
  id              String        @id @default(cuid())
  workspaceId     String
  workspace       Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name            String?
  status          SessionStatus @default(IDLE)
  pid             Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([workspaceId])
  @@index([status])
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "sqlite"
}

// Enums

enum WorkspaceStatus {
  NEW          // Workspace created, nothing started
  PROVISIONING // Git worktree being created, startup script running
  READY        // Successfully initialized
  FAILED       // Initialization failed
  ARCHIVED     // Workspace archived
}

enum SessionStatus {
  IDLE
  RUNNING
  PAUSED
  COMPLETED
  FAILED
}

enum PRState {
  NONE
  DRAFT
  OPEN
  CHANGES_REQUESTED
  APPROVED
  MERGED
  CLOSED
}

enum CIStatus {
  UNKNOWN   // No CI configured or not yet fetched
  PENDING   // CI is running
  SUCCESS   // All checks passed
  FAILURE   // One or more checks failed
}

enum KanbanColumn {
  BACKLOG
  IN_PROGRESS
  WAITING
  PR_OPEN
  APPROVED
  MERGED
  DONE
}


// Models
model Project {
  id                String      @id @default(cuid())
  name              String
  slug              String      @unique
  repoPath          String
  worktreeBasePath  String
  defaultBranch     String      @default("main")
  githubOwner       String?
  githubRepo        String?
  isArchived        Boolean     @default(false)

  // Startup script configuration
  startupScriptCommand  String?   // Inline shell command
  startupScriptPath     String?             // Path to script in repo
  startupScriptTimeout  Int       @default(300)  // Timeout in seconds

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  workspaces        Workspace[]

  @@index([slug])
  @@index([isArchived])
}

model DecisionLog {
  id                String      @id @default(cuid())
  agentId           String      // Can be sessionId or any identifier
  decision          String
  reasoning         String
  context           String?
  timestamp         DateTime    @default(now())

  @@index([agentId, timestamp])
  @@index([timestamp])
}

model Workspace {
  id                  String            @id @default(cuid())
  projectId           String
  project             Project           @relation(fields: [projectId], references: [id])
  name                String
  description         String?
  status              WorkspaceStatus   @default(NEW)
  worktreePath        String?
  branchName          String?

  // Initialization tracking (used by NEW, PROVISIONING, FAILED states)
  initErrorMessage    String?
  initStartedAt       DateTime?
  initCompletedAt     DateTime?
  initRetryCount      Int                 @default(0)

  // Run script tracking (from factory-factory.json)
  runScriptCommand        String?           // The run script command to execute
  runScriptCleanupCommand String?           // The cleanup script command to execute on stop
  runScriptPid            Int?              // Process ID of running script
  runScriptPort           Int?              // Allocated port for the running script
  runScriptStartedAt      DateTime?         // When the run script was started
  runScriptStatus         SessionStatus     @default(IDLE)  // IDLE, RUNNING, FAILED, etc.

  prUrl               String?
  githubIssueNumber   Int?
  githubIssueUrl      String?
  claudeSessions      ClaudeSession[]
  terminalSessions    TerminalSession[]
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // PR tracking (cached from GitHub)
  prNumber            Int?
  prState             PRState           @default(NONE)
  prReviewState       String?           // Raw GitHub review state
  prCiStatus          CIStatus          @default(UNKNOWN)  // CI check status
  prUpdatedAt         DateTime?         // Last PR sync time

  // CI failure tracking
  prCiFailedAt        DateTime?         // When CI first failed (cleared on success)
  prCiLastNotifiedAt  DateTime?         // Last time we notified about CI failure

  // Activity tracking
  hasHadSessions      Boolean           @default(false)

  // Cached kanban column (for list performance)
  cachedKanbanColumn  KanbanColumn      @default(BACKLOG)
  stateComputedAt     DateTime?         // Last kanban column computation

  @@index([projectId])
  @@index([status])
  @@index([cachedKanbanColumn])
  // Composite indexes for common query patterns
  @@index([projectId, status])
  @@index([projectId, cachedKanbanColumn])
}

model ClaudeSession {
  id               String        @id @default(cuid())
  workspaceId      String
  workspace        Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name             String?
  workflow         String        // "explore", "implement", "test"
  model            String        @default("sonnet")
  status           SessionStatus @default(IDLE)
  claudeSessionId  String?       // For resume
  claudeProcessPid Int?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([workspaceId])
  @@index([status])
}

model TerminalSession {
  id              String        @id @default(cuid())
  workspaceId     String
  workspace       Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name            String?
  status          SessionStatus @default(IDLE)
  pid             Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([workspaceId])
  @@index([status])
}

model UserSettings {
  id                    String   @id @default(cuid())
  userId                String   @default("default") @unique  // Single user for now, expandable later

  // IDE Settings
  preferredIde          String   @default("cursor")  // "cursor" | "vscode" | "custom"
  customIdeCommand      String?  // For custom IDE, supports placeholders like {workspace}

  // Notification Settings
  playSoundOnComplete   Boolean  @default(true)   // Play sound when workspace completes
  notificationSoundPath String?                   // Path to custom notification sound file

  // Cached slash commands (from Claude CLI initialize response)
  cachedSlashCommands   Json?

  // CI Settings
  autoFixCiIssues       Boolean  @default(false)  // Global toggle for CI auto-fixing

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
}
